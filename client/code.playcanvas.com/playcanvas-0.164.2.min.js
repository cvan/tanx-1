/*
 PlayCanvas Engine v0.164.2
 revision 94e23cd

 http://playcanvas.com
 Copyright 2011-2014 PlayCanvas Ltd. All rights reserved.
 Do not distribute.
 Contains: https://github.com/tildeio/rsvp.js - see page for license information
*/
var pc={config:{},common:{},apps:{},data:{},unpack:function(){console.warn("pc.unpack has been deprecated and will be removed shortly. Please update your code.")},makeArray:function(e){var a,b=[],c=e.length;for(a=0;a<c;++a)b.push(e[a]);return b},type:function(e){if(null===e)return"null";var a=typeof e;return"undefined"==a||"number"==a||"string"==a||"boolean"==a?a:_typeLookup[Object.prototype.toString.call(e)]},extend:function(e,a){var b,c;for(b in a)c=a[b],e[b]="object"==pc.type(c)?pc.extend({},c):
"array"==pc.type(c)?pc.extend([],c):c;return e},isDefined:function(e){return void 0!==e}},_typeLookup=function(){var e={},a,b="Array Object Function Date RegExp Float32Array".split(" ");for(a=0;a<b.length;++a)e["[object "+b[a]+"]"]=b[a].toLowerCase();return e}();"undefined"!==typeof exports&&(exports.pc=pc);(function(){if("undefined"!==typeof document){var e=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenchange",!0,!1,null);document.dispatchEvent(a)},a=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("fullscreenerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitfullscreenchange",e,!1);document.addEventListener("mozfullscreenchange",e,!1);document.addEventListener("MSFullscreenChange",e,!1);document.addEventListener("webkitfullscreenerror",
a,!1);document.addEventListener("mozfullscreenerror",a,!1);document.addEventListener("MSFullscreenError",a,!1);Element.prototype.requestFullscreen=Element.prototype.mozRequestFullScreen?function(){this.mozRequestFullScreen()}:Element.prototype.requestFullscreen||Element.prototype.webkitRequestFullscreen||Element.prototype.msRequestFullscreen||function(){};document.exitFullscreen=document.exitFullscreen||document.webkitExitFullscreen||document.mozCancelFullScreen||document.msExitFullscreen;document.fullscreenElement||
Object.defineProperty(document,"fullscreenElement",{enumerable:!0,configurable:!1,get:function(){return document.webkitCurrentFullScreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement}});document.fullscreenEnabled||Object.defineProperty(document,"fullscreenEnabled",{enumerable:!0,configurable:!1,get:function(){return document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled}})}})();pc.extend(pc,function(){var e=function(){this.data=new Float32Array(4);3<=arguments.length?(this.data[0]=arguments[0],this.data[1]=arguments[1],this.data[2]=arguments[2],this.data[3]=4<=arguments.length?arguments[3]:1):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=1)};e.prototype={clone:function(){return new pc.Color(this.r,this.g,this.b,this.a)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},set:function(a,b,c,d){var g=this.data;g[0]=a;
g[1]=b;g[2]=c;g[3]=void 0===d?1:d;return this},fromString:function(a){var b=parseInt(a.replace("#","0x"));7<a.length?a=pc.math.intToBytes32(b):(a=pc.math.intToBytes24(b),a[3]=255);this.set(a[0]/255,a[1]/255,a[2]/255,a[3]/255);return this},toString:function(a){var b="#"+(16777216+(parseInt(255*this.r)<<16)+(parseInt(255*this.g)<<8)+parseInt(255*this.b)).toString(16).slice(1);!0===a&&(a=parseInt(255*this.a).toString(16),b=this.a<16/255?b+("0"+a):b+a);return b}};Object.defineProperty(e.prototype,"r",
{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(e.prototype,"g",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(e.prototype,"b",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(e.prototype,"a",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});return{Color:e}}());pc.guid=function(){return{create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var a=16*Math.random()|0;return("x"==e?a:a&3|8).toString(16)})}}}();pc.extend(pc,function(){var e=function(){this._isRunning=!1;this._b=this._a=0};e.prototype={start:function(){this._isRunning=!0;this._a=(new Date).getTime()},stop:function(){this._isRunning=!1;this._b=(new Date).getTime()},getMilliseconds:function(){return this._b-this._a}};return{Timer:e,now:function(){return(new Date).getTime()}}}());pc.extend(pc,function(){return{createURI:function(e){var a="";if((e.authority||e.scheme)&&(e.host||e.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(e.host&&e.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(e.path&&e.hostpath)throw Error("Can't have 'path' and 'hostpath' option");e.scheme&&(a+=e.scheme+":");e.authority&&(a+="//"+e.authority);e.host&&(a+=e.host);e.path&&(a+=e.path);e.hostpath&&(a+=e.hostpath);e.query&&(a+="?"+e.query);
e.fragment&&(a+="#"+e.fragment);return a},URI:function(e){e=e.match(/^(([^:\/?\#]+):)?(\/\/([^\/?\#]*))?([^?\#]*)(\?([^\#]*))?(\#(.*))?/);this.scheme=e[2];this.authority=e[4];this.path=e[5];this.query=e[7];this.fragment=e[9];this.toString=function(){var a="";this.scheme&&(a+=this.scheme+":");this.authority&&(a+="//"+this.authority);a+=this.path;this.query&&(a+="?"+this.query);this.fragment&&(a+="#"+this.fragment);return a};this.getQuery=function(){var a,b,c={};this.query&&(a=decodeURIComponent(this.query).split("&"),
a.forEach(function(a){b=a.split("=");c[b[0]]=b[1]},this));return c};this.setQuery=function(a){q="";for(var b in a)a.hasOwnProperty(b)&&(""!==q&&(q+="&"),q+=encodeURIComponent(b)+"="+encodeURIComponent(a[b]));this.query=q}}}}());pc.extend(pc,function(){return{log:{write:function(e){console.log(e)},open:function(){pc.log.write(Date())},info:function(e){console.info("INFO:    "+e)},debug:function(e){console.debug("DEBUG:   "+e)},error:function(e){console.error("ERROR:   "+e)},warning:function(e){console.warn("WARNING: "+e)},alert:function(e){pc.log.write("ALERT:   "+e);alert(e)},assert:function(e,a){!1===e&&(pc.log.write("ASSERT:  "+a),alert("ASSERT failed: "+a))}}}}());
var logINFO=pc.log.info,logDEBUG=pc.log.debug,logWARNING=pc.log.warning,logERROR=pc.log.error,logALERT=pc.log.alert,logASSERT=pc.log.assert;Function.prototype.extendsFrom=function(e){var a,b,c=function(){};a=this;b=function(){e.apply(this,arguments);a.apply(this,arguments);this.constructor=a};b._super=e.prototype;c.prototype=e.prototype;b.prototype=new c;return b};pc.extend(pc,function(){return{inherits:function(e,a){var b=function(){},c=function(){a.apply(this,arguments);e.apply(this,arguments)};c._super=a.prototype;b.prototype=a.prototype;c.prototype=new b;return c}}}());Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!==typeof this)throw new TypeError("Function.prototype.bind - what is trying to be fBound is not callable");var a=Array.prototype.slice.call(arguments,1),b=this,c=function(){},d=function(){return b.apply(this instanceof c?this:e||window,a.concat(Array.prototype.slice.call(arguments)))};c.prototype=this.prototype;d.prototype=new c;return d});pc.path=function(){return{delimiter:"/",join:function(){var e,a=arguments.length,b=arguments[0];for(e=0;e<a-1;++e){var c=arguments[e],d=arguments[e+1];if(!pc.isDefined(c)||!pc.isDefined(d))throw Error("undefined argument to pc.path.join");b=d[0]===pc.path.delimiter?d:c&&d&&c[c.length-1]!==pc.path.delimiter&&d[0]!==pc.path.delimiter?b+(pc.path.delimiter+d):b+d}return b},split:function(e){var e=e.split(pc.path.delimiter),a=e.slice(e.length-1)[0];return[e.slice(0,e.length-1).join(pc.path.delimiter),
a]},getBasename:function(e){return pc.path.split(e)[1]},getDirectory:function(e){e=e.split(pc.path.delimiter);return e.slice(0,e.length-1).join(pc.path.delimiter)},getExtension:function(e){var a=e.split(".").pop();return a!==e?"."+a:""},isRelativePath:function(e){return"/"!==e.charAt(0)&&null===e.match(/:\/\//)},extractPath:function(e){var a=".",b=e.split("/"),c=0;if(1<b.length){!1===pc.path.isRelativePath(e)&&(a="");for(c=0;c<b.length-1;++c)a+="/"+b[c]}return a}}}();pc.string=function(){return{ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:this.ASCII_LOWERCASE+this.ASCII_UPPERCASE,format:function(e){var a=0,b,c=pc.makeArray(arguments);c.shift();for(a=0;a<c.length;a++)b=RegExp("\\{"+a+"\\}","gi"),e=e.replace(b,c[a]);return e},startsWith:function(e,a){return 0===e.indexOf(a)},endsWith:function(e,a){return-1!==e.lastIndexOf(a,e.length-a.length)},toBool:function(e,a){if("true"===e)return!0;if(a){if("false"===
e)return!1;throw Error("Not a boolean string");}return!1}}}();pc.extend(pc,function(){return{json:{parse:function(e,a){return JSON.parse(e,a)},stringify:function(e,a,b){return JSON.stringify(e,function(b,d){this[b]instanceof Float32Array&&(d=pc.makeArray(this[b]));return a?a(b,d):d},b)}}}}());pc.cookie=function(){return{set:function(e,a,b){b=b||{};e=e+"="+a;b.path&&(e+=";path="+b.path);b.domain&&(e+=";domain="+b.domain);b.path&&(e+=";path="+b.path);b.secure&&(e+=";secure");e=b.lifetime?e+(";max-age="+86400*b.lifetime):e+";max-age=86400";document.cookie=e},get:function(e){var a,b=document.cookie.split(";"),c,d=b.length;for(c=0;c<d;c++)if(a=b[c].trim(),pc.string.startsWith(a,e))return a.split("=")[1]},remove:function(e,a){a.lifetime=0;pc.cookie.set(e,"",a)}}}();pc.debug=function(){var e=null,a=null,b=null,c=null;return{display:function(d){e||(e=document.createElement("table"),a=document.createElement("tr"),b=document.createElement("td"),c=document.createElement("td"),e.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",e.style.top="0px",e.style.left="0px",e.style.border="thin solid #cccccc",document.body.appendChild(e));e.innerHTML="";for(var g in d){var f=a.cloneNode(),k=b.cloneNode(),m=c.cloneNode();k.textContent=g;m.textContent=
d[g];f.appendChild(k);f.appendChild(m);e.appendChild(f)}}}}();pc.extend(pc,function(){var e=function(a,c){this.objects=[];this.ctor=a;this.name=c.name;this.useNew=void 0===c.useNew||c.useNew;if(this.metrics=c.metrics)this.used=this.total=0};e.prototype={_construct:function(a,c){function d(){return a.apply(this,c)}d.prototype=a.prototype;return new d},allocate:function(){var a;this.objects.length?(a=this.objects.pop(),this.ctor.apply(a,arguments),this.metrics&&this.used++):(a=this.useNew?this._construct(this.ctor,arguments):this.ctor.apply(this,arguments),this.metrics&&
(this.total++,this.used++));return a},free:function(a){this.objects.push(a);this.metrics&&this.used--;if(a.onFree)a.onFree()},usage:function(){return pc.string.format("{0} - total: {1}, used: {2}",this.name,this.total,this.used)}};var a=function(a,c){this._constructor=a;this._pool=[];this._count=0;this._resize(c)};a.prototype={_resize:function(a){if(a>this._pool.length)for(var c=this._pool.length;c<a;c++)this._pool[c]=new this._constructor},allocate:function(){this._count>=this._pool.length&&this._resize(2*
this._pool.length);return this._pool[this._count++]},freeAll:function(){this._count=0}};return{AllocatePool:a,ObjectPool:e}}());pc.events=function(){var e={attach:function(a){var b=pc.events;a.on=b.on;a.off=b.off;a.fire=b.fire;a.hasEvent=b.hasEvent;a.bind=b.on;a.unbind=b.off;return a},on:function(a,b,c){if("string"!=pc.type(a))throw new TypeError("Event name must be a string");var d=this._callbacks||(this._callbacks={});(d[a]||(d[a]=[])).push({callback:b,scope:c||this});return this},off:function(a,b,c){var d=this._callbacks;if(d){if(b){a=d[a];if(!a)return this;for(d=0;d<a.length;d++)if(a[d].callback===b&&(!c||c===a[d].scope))a.splice(d,
1),d--}else d[a]=[];return this}},fire:function(a){var b,c,d,g;if(this._callbacks&&this._callbacks[a]&&(c=this._callbacks[a].length)){d=pc.makeArray(arguments);d.shift();g=this._callbacks[a].slice();for(b=0;b<c;++b)g[b].callback.apply(g[b].scope,d)}return this},hasEvent:function(a){return void 0!==this._callbacks&&void 0!==this._callbacks[a]&&0<this._callbacks[a].length}};e.bind=e.on;e.unbind=e.off;return e}();pc.dom=function(){return{getWidth:function(e){return e.offsetWidth},getHeight:function(e){return e.offsetHeight},setText:function(e,a){e.textContent?e.textContent=a:e.innerText&&(e.innerText=a)},getText:function(e){return e.textContent||e.innerText}}}();pc.math={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,INV_LOG2:1/Math.log(2),clamp:function(e,a,b){return e>=b?b:e<=a?a:e},intToBytes24:function(e){return[e>>16&255,e>>8&255,e&255]},intToBytes32:function(e){return[e>>24&255,e>>16&255,e>>8&255,e&255]},bytesToInt24:function(e,a,b){e.length&&(b=e[2],a=e[1],e=e[0]);return e<<16|a<<8|b},bytesToInt32:function(e,a,b,c){e.length&&(c=e[3],b=e[2],a=e[1],e=e[0]);return(e<<24|a<<16|b<<8|c)>>>32},lerp:function(e,a,b){return e+(a-e)*pc.math.clamp(b,0,1)},lerpAngle:function(e,
a,b){180<a-e&&(a-=360);-180>a-e&&(a+=360);return pc.math.lerp(e,a,pc.math.clamp(b,0,1))},powerOfTwo:function(e){return 0!==e&&!(e&e-1)},nextPowerOfTwo:function(e){e--;e|=e>>1;e|=e>>2;e|=e>>4;e|=e>>8;e|=e>>16;e++;return e},random:function(e,a){return Math.random()*(a-e)+e},smoothstep:function(e,a,b){if(b<=e)return 0;if(b>=a)return 1;b=(b-e)/(a-e);return b*b*(3-2*b)},smootherstep:function(e,a,b){if(b<=e)return 0;if(b>=a)return 1;b=(b-e)/(a-e);return b*b*b*(b*(6*b-15)+10)}};pc.math.intToBytes=pc.math.intToBytes32;
pc.math.bytesToInt=pc.math.bytesToInt32;Math.log2||(Math.log2=function(e){return Math.log(e)*this.INV_LOG2});pc.extend(pc,function(){var e=function(){this.data=new Float32Array(2);2===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0)};e.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];return this},add2:function(a,b){var c=a.data,d=b.data,g=this.data;g[0]=c[0]+d[0];g[1]=c[1]+d[1];return this},clone:function(){return(new e).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*
a[0]+b[1]*a[1]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]},lerp:function(a,b,c){var a=a.data,b=b.data,d=this.data;d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];return this},mul2:function(a,b){var c=a.data,d=b.data,g=this.data;g[0]=c[0]*d[0];g[1]=c[1]*d[1];
return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;return this},set:function(a,b){var c=this.data;c[0]=a;c[1]=b;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];return this},sub2:function(a,b){var c=a.data,d=b.data,g=this.data;g[0]=c[0]-d[0];g[1]=c[1]-d[1];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+"]"}};Object.defineProperty(e.prototype,"x",{get:function(){return this.data[0]},
set:function(a){this.data[0]=a}});Object.defineProperty(e.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(e,"ONE",{get:function(){var a=new e(1,1);return function(){return a}}()});Object.defineProperty(e,"RIGHT",{get:function(){var a=new e(1,0);return function(){return a}}()});Object.defineProperty(e,"UP",{get:function(){var a=new e(0,1);return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0);return function(){return a}}()});
return{Vec2:e}}());pc.extend(pc,function(){var e=function(){this.data=new Float32Array(3);3===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0)};e.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];return this},add2:function(a,b){var c=a.data,d=b.data,g=this.data;g[0]=c[0]+d[0];g[1]=c[1]+d[1];g[2]=c[2]+d[2];return this},clone:function(){return(new e).copy(this)},copy:function(a){var b=this.data,a=a.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];return this},
cross:function(a,b){var c,d,g,f,e,m,h;c=a.data;d=b.data;g=this.data;f=c[0];e=c[1];c=c[2];m=d[0];h=d[1];d=d[2];g[0]=e*d-h*c;g[1]=c*m-d*f;g[2]=f*h-m*e;return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]},lerp:function(a,
b,c){var a=a.data,b=b.data,d=this.data;d[0]=a[0]+c*(b[0]-a[0]);d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];return this},mul2:function(a,b){var c=a.data,d=b.data,g=this.data;g[0]=c[0]*d[0];g[1]=c[1]*d[1];g[2]=c[2]*d[2];return this},normalize:function(){return this.scale(1/this.length())},project:function(a){var b=this.data,a=a.data,c=(b[0]*a[0]+b[1]*a[1]+b[2]*a[2])/(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]);b[0]=a[0]*c;
b[1]=a[1]*c;b[2]=a[2]*c;return this},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;return this},set:function(a,b,c){var d=this.data;d[0]=a;d[1]=b;d[2]=c;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];return this},sub2:function(a,b){var c=a.data,d=b.data,g=this.data;g[0]=c[0]-d[0];g[1]=c[1]-d[1];g[2]=c[2]-d[2];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+"]"}};Object.defineProperty(e.prototype,"x",{get:function(){return this.data[0]},
set:function(a){this.data[0]=a}});Object.defineProperty(e.prototype,"y",{get:function(){return this.data[1]},set:function(a){this.data[1]=a}});Object.defineProperty(e.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(e,"BACK",{get:function(){var a=new e(0,0,1);return function(){return a}}()});Object.defineProperty(e,"DOWN",{get:function(){var a=new e(0,-1,0);return function(){return a}}()});Object.defineProperty(e,"FORWARD",{get:function(){var a=
new e(0,0,-1);return function(){return a}}()});Object.defineProperty(e,"LEFT",{get:function(){var a=new e(-1,0,0);return function(){return a}}()});Object.defineProperty(e,"ONE",{get:function(){var a=new e(1,1,1);return function(){return a}}()});Object.defineProperty(e,"RIGHT",{get:function(){var a=new e(1,0,0);return function(){return a}}()});Object.defineProperty(e,"UP",{get:function(){var a=new e(0,1,0);return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,
0,0);return function(){return a}}()});return{Vec3:e}}());pc.extend(pc,function(){var e=function(){this.data=new Float32Array(4);4===arguments.length?this.data.set(arguments):(this.data[0]=0,this.data[1]=0,this.data[2]=0,this.data[3]=0)};e.prototype={add:function(a){var b=this.data,a=a.data;b[0]+=a[0];b[1]+=a[1];b[2]+=a[2];b[3]+=a[3];return this},add2:function(a,b){var c=a.data,d=b.data,g=this.data;g[0]=c[0]+d[0];g[1]=c[1]+d[1];g[2]=c[2]+d[2];g[3]=c[3]+d[3];return this},clone:function(){return(new e).copy(this)},copy:function(a){var b=this.data,a=a.data;
b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];return this},dot:function(a){var b=this.data,a=a.data;return b[0]*a[0]+b[1]*a[1]+b[2]*a[2]+b[3]*a[3]},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]},length:function(){var a=this.data;return Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3])},lengthSq:function(){var a=this.data;return a[0]*a[0]+a[1]*a[1]+a[2]*a[2]+a[3]*a[3]},lerp:function(a,b,c){var a=a.data,b=b.data,d=this.data;d[0]=a[0]+c*(b[0]-a[0]);
d[1]=a[1]+c*(b[1]-a[1]);d[2]=a[2]+c*(b[2]-a[2]);d[3]=a[3]+c*(b[3]-a[3]);return this},mul:function(a){var b=this.data,a=a.data;b[0]*=a[0];b[1]*=a[1];b[2]*=a[2];b[3]*=a[3];return this},mul2:function(a,b){var c=a.data,d=b.data,g=this.data;g[0]=c[0]*d[0];g[1]=c[1]*d[1];g[2]=c[2]*d[2];g[3]=c[3]*d[3];return this},normalize:function(){return this.scale(1/this.length())},scale:function(a){var b=this.data;b[0]*=a;b[1]*=a;b[2]*=a;b[3]*=a;return this},set:function(a,b,c,d){var g=this.data;g[0]=a;g[1]=b;g[2]=
c;g[3]=d;return this},sub:function(a){var b=this.data,a=a.data;b[0]-=a[0];b[1]-=a[1];b[2]-=a[2];b[3]-=a[3];return this},sub2:function(a,b){var c=a.data,d=b.data,g=this.data;g[0]=c[0]-d[0];g[1]=c[1]-d[1];g[2]=c[2]-d[2];g[3]=c[3]-d[3];return this},toString:function(){return"["+this.data[0]+", "+this.data[1]+", "+this.data[2]+", "+this.data[3]+"]"}};Object.defineProperty(e.prototype,"x",{get:function(){return this.data[0]},set:function(a){this.data[0]=a}});Object.defineProperty(e.prototype,"y",{get:function(){return this.data[1]},
set:function(a){this.data[1]=a}});Object.defineProperty(e.prototype,"z",{get:function(){return this.data[2]},set:function(a){this.data[2]=a}});Object.defineProperty(e.prototype,"w",{get:function(){return this.data[3]},set:function(a){this.data[3]=a}});Object.defineProperty(e,"ONE",{get:function(){var a=new e(1,1,1,1);return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0,0,0);return function(){return a}}()});return{Vec4:e}}());pc.extend(pc,function(){var e=function(){this.data=new Float32Array(9);9===arguments.length?this.data.set(arguments):this.setIdentity()};e.prototype={clone:function(){return(new pc.Mat3).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];return this},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===
a[8]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&1===a[4]&&0===a[5]&&0===a[6]&&0===a[7]&&1===a[8]},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=1;a[5]=0;a[6]=0;a[7]=0;a[8]=1;return this},toString:function(){for(var a="[",b=0;9>b;b++)a+=this.data[b],a+=9!==b?", ":"";return a+"]"},transpose:function(){var a=this.data,b;b=a[1];a[1]=a[3];a[3]=b;b=a[2];a[2]=a[6];a[6]=b;b=a[5];a[5]=a[7];a[7]=b;return this}};Object.defineProperty(e,"IDENTITY",
{get:function(){var a=new e;return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat3:e}}());pc.extend(pc,function(){var e=function(){this.data=new Float32Array(16);16===arguments.length?this.data.set(arguments):this.setIdentity()},a,b,c;a=new pc.Vec3;b=new pc.Vec3;c=new pc.Vec3;var d,g,f;d=new pc.Vec3;g=new pc.Vec3;f=new pc.Vec3;var k=new pc.Vec3;e.prototype={add2:function(a,b){var c=a.data,d=b.data,f=this.data;f[0]=c[0]+d[0];f[1]=c[1]+d[1];f[2]=c[2]+d[2];f[3]=c[3]+d[3];f[4]=c[4]+d[4];f[5]=c[5]+d[5];f[6]=c[6]+d[6];f[7]=c[7]+d[7];f[8]=c[8]+d[8];f[9]=c[9]+d[9];f[10]=c[10]+d[10];f[11]=c[11]+
d[11];f[12]=c[12]+d[12];f[13]=c[13]+d[13];f[14]=c[14]+d[14];f[15]=c[15]+d[15];return this},add:function(a){return this.add2(this,a)},clone:function(){return(new pc.Mat4).copy(this)},copy:function(a){var a=a.data,b=this.data;b[0]=a[0];b[1]=a[1];b[2]=a[2];b[3]=a[3];b[4]=a[4];b[5]=a[5];b[6]=a[6];b[7]=a[7];b[8]=a[8];b[9]=a[9];b[10]=a[10];b[11]=a[11];b[12]=a[12];b[13]=a[13];b[14]=a[14];b[15]=a[15];return this},equals:function(a){var b=this.data,a=a.data;return b[0]===a[0]&&b[1]===a[1]&&b[2]===a[2]&&b[3]===
a[3]&&b[4]===a[4]&&b[5]===a[5]&&b[6]===a[6]&&b[7]===a[7]&&b[8]===a[8]&&b[9]===a[9]&&b[10]===a[10]&&b[11]===a[11]&&b[12]===a[12]&&b[13]===a[13]&&b[14]===a[14]&&b[15]===a[15]},isIdentity:function(){var a=this.data;return 1===a[0]&&0===a[1]&&0===a[2]&&0===a[3]&&0===a[4]&&1===a[5]&&0===a[6]&&0===a[7]&&0===a[8]&&0===a[9]&&1===a[10]&&0===a[11]&&0===a[12]&&0===a[13]&&0===a[14]&&1===a[15]},mul2:function(a,b){var c,d,f,g,e,k,y,s,w,A,x,z,H,G,K,I,F,D,B,E;I=a.data;var L=b.data,J=this.data;c=I[0];d=I[1];f=I[2];
g=I[3];e=I[4];k=I[5];y=I[6];s=I[7];w=I[8];A=I[9];x=I[10];z=I[11];H=I[12];G=I[13];K=I[14];I=I[15];F=L[0];D=L[1];B=L[2];E=L[3];J[0]=c*F+e*D+w*B+H*E;J[1]=d*F+k*D+A*B+G*E;J[2]=f*F+y*D+x*B+K*E;J[3]=g*F+s*D+z*B+I*E;F=L[4];D=L[5];B=L[6];E=L[7];J[4]=c*F+e*D+w*B+H*E;J[5]=d*F+k*D+A*B+G*E;J[6]=f*F+y*D+x*B+K*E;J[7]=g*F+s*D+z*B+I*E;F=L[8];D=L[9];B=L[10];E=L[11];J[8]=c*F+e*D+w*B+H*E;J[9]=d*F+k*D+A*B+G*E;J[10]=f*F+y*D+x*B+K*E;J[11]=g*F+s*D+z*B+I*E;F=L[12];D=L[13];B=L[14];E=L[15];J[12]=c*F+e*D+w*B+H*E;J[13]=d*F+
k*D+A*B+G*E;J[14]=f*F+y*D+x*B+K*E;J[15]=g*F+s*D+z*B+I*E;return this},mul:function(a){return this.mul2(this,a)},transformPoint:function(a,b){var c=this.data,d=a.data,b=void 0===b?new pc.Vec3:b;return b.set(d[0]*c[0]+d[1]*c[4]+d[2]*c[8]+c[12],d[0]*c[1]+d[1]*c[5]+d[2]*c[9]+c[13],d[0]*c[2]+d[1]*c[6]+d[2]*c[10]+c[14])},transformVector:function(a,b){var c=this.data,d=a.data,b=void 0===b?new pc.Vec3:b;return b.set(d[0]*c[0]+d[1]*c[4]+d[2]*c[8],d[0]*c[1]+d[1]*c[5]+d[2]*c[9],d[0]*c[2]+d[1]*c[6]+d[2]*c[10])},
setLookAt:function(d,f,g){c.sub2(d,f).normalize();b.copy(g).normalize();a.cross(b,c).normalize();b.cross(c,a);f=this.data;f[0]=a.x;f[1]=a.y;f[2]=a.z;f[3]=0;f[4]=b.x;f[5]=b.y;f[6]=b.z;f[7]=0;f[8]=c.x;f[9]=c.y;f[10]=c.z;f[11]=0;f[12]=d.x;f[13]=d.y;f[14]=d.z;f[15]=1;return this},setFrustum:function(a,b,c,d,f,g){var e,k,y,s,w;e=2*f;k=b-a;y=d-c;s=g-f;w=this.data;w[0]=e/k;w[1]=0;w[2]=0;w[3]=0;w[4]=0;w[5]=e/y;w[6]=0;w[7]=0;w[8]=(b+a)/k;w[9]=(d+c)/y;w[10]=(-g-f)/s;w[11]=-1;w[12]=0;w[13]=0;w[14]=-e*g/s;w[15]=
0;return this},setPerspective:function(a,b,c,d){a=c*Math.tan(a*Math.PI/360);b*=a;return this.setFrustum(-b,b,-a,a,c,d)},setOrtho:function(a,b,c,d,f,g){var e=this.data;e[0]=2/(b-a);e[1]=0;e[2]=0;e[3]=0;e[4]=0;e[5]=2/(d-c);e[6]=0;e[7]=0;e[8]=0;e[9]=0;e[10]=-2/(g-f);e[11]=0;e[12]=-(b+a)/(b-a);e[13]=-(d+c)/(d-c);e[14]=-(g+f)/(g-f);e[15]=1;return this},setFromAxisAngle:function(a,b){var c,d,f,g,e,k,y,s,w,b=b*pc.math.DEG_TO_RAD;c=a.x;d=a.y;f=a.z;g=Math.cos(b);e=Math.sin(b);k=1-g;y=k*c;s=k*d;w=this.data;
w[0]=y*c+g;w[1]=y*d+e*f;w[2]=y*f-e*d;w[3]=0;w[4]=y*d-e*f;w[5]=s*d+g;w[6]=s*f+e*c;w[7]=0;w[8]=y*f+e*d;w[9]=s*f-c*e;w[10]=k*f*f+g;w[11]=0;w[12]=0;w[13]=0;w[14]=0;w[15]=1;return this},setTranslate:function(a,b,c){var d=this.data;d[0]=1;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=1;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=1;d[11]=0;d[12]=a;d[13]=b;d[14]=c;d[15]=1;return this},setScale:function(a,b,c){var d=this.data;d[0]=a;d[1]=0;d[2]=0;d[3]=0;d[4]=0;d[5]=b;d[6]=0;d[7]=0;d[8]=0;d[9]=0;d[10]=c;d[11]=0;d[12]=0;d[13]=0;d[14]=
0;d[15]=1;return this},invert:function(){var a,b,c,d,f,g,e,k,y,s,w,A,x,z,H,G,K,I,F,D,B,E,L,J,O,P,R,Q,M,N;N=this.data;a=N[0];b=N[1];c=N[2];d=N[3];f=N[4];g=N[5];e=N[6];k=N[7];y=N[8];s=N[9];w=N[10];A=N[11];x=N[12];z=N[13];H=N[14];G=N[15];K=a*g-b*f;I=a*e-c*f;F=a*k-d*f;D=b*e-c*g;B=b*k-d*g;E=c*k-d*e;L=y*z-s*x;J=y*H-w*x;O=y*G-A*x;P=s*H-w*z;R=s*G-A*z;Q=w*G-A*H;M=1/(K*Q-I*R+F*P+D*O-B*J+E*L);N[0]=(g*Q-e*R+k*P)*M;N[1]=(-b*Q+c*R-d*P)*M;N[2]=(z*E-H*B+G*D)*M;N[3]=(-s*E+w*B-A*D)*M;N[4]=(-f*Q+e*O-k*J)*M;N[5]=(a*
Q-c*O+d*J)*M;N[6]=(-x*E+H*F-G*I)*M;N[7]=(y*E-w*F+A*I)*M;N[8]=(f*R-g*O+k*L)*M;N[9]=(-a*R+b*O-d*L)*M;N[10]=(x*B-z*F+G*K)*M;N[11]=(-y*B+s*F-A*K)*M;N[12]=(-f*P+g*J-e*L)*M;N[13]=(a*P-b*J+c*L)*M;N[14]=(-x*D+z*I-H*K)*M;N[15]=(y*D-s*I+w*K)*M;return this},setIdentity:function(){var a=this.data;a[0]=1;a[1]=0;a[2]=0;a[3]=0;a[4]=0;a[5]=1;a[6]=0;a[7]=0;a[8]=0;a[9]=0;a[10]=1;a[11]=0;a[12]=0;a[13]=0;a[14]=0;a[15]=1;return this},setTRS:function(a,b,c){var d,f,g,e,k,y,s,w,A,x,z,H,G;d=a.x;f=a.y;a=a.z;g=b.x;e=b.y;k=
b.z;y=b.w;b=c.x;s=c.y;c=c.z;w=g+g;A=e+e;x=k+k;z=g*w;H=g*A;g*=x;G=e*A;e*=x;k*=x;w*=y;A*=y;y*=x;x=this.data;x[0]=(1-(G+k))*b;x[1]=(H+y)*b;x[2]=(g-A)*b;x[3]=0;x[4]=(H-y)*s;x[5]=(1-(z+k))*s;x[6]=(e+w)*s;x[7]=0;x[8]=(g+A)*c;x[9]=(e-w)*c;x[10]=(1-(z+G))*c;x[11]=0;x[12]=d;x[13]=f;x[14]=a;x[15]=1;return this},transpose:function(){var a,b=this.data;a=b[1];b[1]=b[4];b[4]=a;a=b[2];b[2]=b[8];b[8]=a;a=b[3];b[3]=b[12];b[12]=a;a=b[6];b[6]=b[9];b[9]=a;a=b[7];b[7]=b[13];b[13]=a;a=b[11];b[11]=b[14];b[14]=a;return this},
invertTo3x3:function(a){var b,c,d,f,g,e,k,y,s,w;s=this.data;w=a.data;a=s[10]*s[5]-s[6]*s[9];b=-s[10]*s[1]+s[2]*s[9];c=s[6]*s[1]-s[2]*s[5];d=-s[10]*s[4]+s[6]*s[8];f=s[10]*s[0]-s[2]*s[8];g=-s[6]*s[0]+s[2]*s[4];e=s[9]*s[4]-s[5]*s[8];k=-s[9]*s[0]+s[1]*s[8];y=s[5]*s[0]-s[1]*s[4];s=s[0]*a+s[1]*d+s[2]*e;if(0===s)return console.warn("pc.Mat4#invertTo3x3: Matrix not invertible"),this;s=1/s;w[0]=s*a;w[1]=s*b;w[2]=s*c;w[3]=s*d;w[4]=s*f;w[5]=s*g;w[6]=s*e;w[7]=s*k;w[8]=s*y;return this},getTranslation:function(a){a=
void 0===a?new pc.Vec3:a;return a.set(this.data[12],this.data[13],this.data[14])},getX:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[0],this.data[1],this.data[2])},getY:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[4],this.data[5],this.data[6])},getZ:function(a){a=void 0===a?new pc.Vec3:a;return a.set(this.data[8],this.data[9],this.data[10])},getScale:function(a){a=void 0===a?new pc.Vec3:a;this.getX(d);this.getY(g);this.getZ(f);a.set(d.length(),g.length(),f.length());
return a},setFromEulerAngles:function(a,b,c){var d,f,g,e,a=a*pc.math.DEG_TO_RAD,b=b*pc.math.DEG_TO_RAD,c=c*pc.math.DEG_TO_RAD;d=Math.sin(-a);a=Math.cos(-a);f=Math.sin(-b);b=Math.cos(-b);g=Math.sin(-c);c=Math.cos(-c);e=this.data;e[0]=b*c;e[1]=-b*g;e[2]=f;e[3]=0;e[4]=a*g+c*d*f;e[5]=a*c-d*f*g;e[6]=-b*d;e[7]=0;e[8]=d*g-a*c*f;e[9]=c*d+a*f*g;e[10]=a*b;e[11]=0;e[12]=0;e[13]=0;e[14]=0;e[15]=1;return this},getEulerAngles:function(a){var b,c,d,f,g,e,a=void 0===a?new pc.Vec3:a;this.getScale(k);d=k.x;b=k.y;f=
k.z;g=this.data;c=Math.asin(-g[2]/d);e=0.5*Math.PI;c<e?c>-e?(b=Math.atan2(g[6]/b,g[10]/f),d=Math.atan2(g[1]/d,g[0]/d)):(d=0,b=-Math.atan2(g[4]/b,g[5]/b)):(d=0,b=Math.atan2(g[4]/b,g[5]/b));return a.set(b,c,d).scale(pc.math.RAD_TO_DEG)},toString:function(){var a,b;b="[";for(a=0;16>a;a+=1)b+=this.data[a],b+=15!==a?", ":"";return b+"]"}};Object.defineProperty(e,"IDENTITY",{get:function(){var a=new e;return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0,0,0,0,
0,0,0,0,0,0,0,0,0,0,0);return function(){return a}}()});return{Mat4:e}}());pc.extend(pc,function(){var e=function(a,b,c,d){this.x=void 0===a?0:a;this.y=void 0===b?0:b;this.z=void 0===c?0:c;this.w=void 0===d?1:d};e.prototype={clone:function(){return new pc.Quat(this.x,this.y,this.z,this.w)},conjugate:function(){this.x*=-1;this.y*=-1;this.z*=-1;return this},copy:function(a){this.x=a.x;this.y=a.y;this.z=a.z;this.w=a.w;return this},equals:function(a){return this.x===a.x&&this.y===a.y&&this.z===a.z&&this.w===a.w},getEulerAngles:function(a){var b,c,d,g,f,e,a=void 0===a?new pc.Vec3:
a;d=this.x;g=this.y;f=this.z;e=this.w;c=2*(e*g-d*f);-0.99999>=c?(b=2*Math.atan2(d,e),c=-Math.PI/2,d=0):0.99999<=c?(b=2*Math.atan2(d,e),c=Math.PI/2,d=0):(b=Math.atan2(2*(e*d+g*f),1-2*(d*d+g*g)),c=Math.asin(c),d=Math.atan2(2*(e*f+d*g),1-2*(g*g+f*f)));return a.set(b,c,d).scale(pc.math.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){var a,b,c,d;a=this.x;b=this.y;c=this.z;d=this.w;return Math.sqrt(a*a+b*b+c*c+d*d)},lengthSq:function(){var a=this.data;return a[0]*a[0]+
a[1]*a[1]+a[2]*a[2]},mul:function(a){var b,c,d,g,f,e,m;b=this.x;c=this.y;d=this.z;g=this.w;f=a.x;e=a.y;m=a.z;a=a.w;this.x=g*f+b*a+c*m-d*e;this.y=g*e+c*a+d*f-b*m;this.z=g*m+d*a+b*e-c*f;this.w=g*a-b*f-c*e-d*m;return this},mul2:function(a,b){var c,d,g,f,e,m,h,n;c=a.x;d=a.y;g=a.z;f=a.w;e=b.x;m=b.y;h=b.z;n=b.w;this.x=f*e+c*n+d*h-g*m;this.y=f*m+d*n+g*e-c*h;this.z=f*h+g*n+c*m-d*e;this.w=f*n-c*e-d*m-g*h;return this},normalize:function(){var a=this.length();0===a?(this.x=this.y=this.z=0,this.w=1):(a=1/a,this.x*=
a,this.y*=a,this.z*=a,this.w*=a);return this},set:function(a,b,c,d){this.x=a;this.y=b;this.z=c;this.w=d;return this},setFromAxisAngle:function(a,b){var c,d,b=b*0.5*pc.math.DEG_TO_RAD;c=Math.sin(b);d=Math.cos(b);this.x=c*a.x;this.y=c*a.y;this.z=c*a.z;this.w=d;return this},setFromEulerAngles:function(a,b,c){var d,g,f;d=0.5*pc.math.DEG_TO_RAD;a*=d;b*=d;c*=d;d=Math.sin(a);a=Math.cos(a);g=Math.sin(b);b=Math.cos(b);f=Math.sin(c);c=Math.cos(c);this.x=d*b*c-a*g*f;this.y=a*g*c+d*b*f;this.z=a*b*f-d*g*c;this.w=
a*b*c+d*g*f;return this},setFromMat4:function(a){var b,c,d,g,f,e,m,h,n,l,r,a=a.data;b=a[0];c=a[1];d=a[2];g=a[4];f=a[5];e=a[6];m=a[8];h=a[9];a=a[10];n=1/Math.sqrt(b*b+c*c+d*d);l=1/Math.sqrt(g*g+f*f+e*e);r=1/Math.sqrt(m*m+h*h+a*a);b*=n;c*=n;d*=n;g*=l;f*=l;e*=l;m*=r;h*=r;a*=r;n=b+f+a;0<=n?(b=Math.sqrt(n+1),this.w=0.5*b,b=0.5/b,this.x=(e-h)*b,this.y=(m-d)*b,this.z=(c-g)*b):b>f?b>a?(b=Math.sqrt(b-(f+a)+1),this.x=0.5*b,b=0.5/b,this.w=(e-h)*b,this.y=(c+g)*b,this.z=(d+m)*b):(b=Math.sqrt(a-(b+f)+1),this.z=
0.5*b,b=0.5/b,this.w=(c-g)*b,this.x=(m+d)*b,this.y=(h+e)*b):f>a?(b=Math.sqrt(f-(a+b)+1),this.y=0.5*b,b=0.5/b,this.w=(m-d)*b,this.z=(e+h)*b,this.x=(g+c)*b):(b=Math.sqrt(a-(b+f)+1),this.z=0.5*b,b=0.5/b,this.w=(c-g)*b,this.x=(m+d)*b,this.y=(h+e)*b);return this},slerp:function(a,b,c){var d,g,f,e,m,h;d=a.x;g=a.y;f=a.z;a=a.w;e=b.x;m=b.y;h=b.z;var b=b.w,n=a*b+d*e+g*m+f*h;0>n&&(b=-b,e=-e,m=-m,h=-h,n=-n);if(1<=Math.abs(n))return this.w=a,this.x=d,this.y=g,this.z=f,this;var l=Math.acos(n),r=Math.sqrt(1-n*n);
if(0.001>Math.abs(r))return this.w=0.5*a+0.5*b,this.x=0.5*d+0.5*e,this.y=0.5*g+0.5*m,this.z=0.5*f+0.5*h,this;n=Math.sin((1-c)*l)/r;c=Math.sin(c*l)/r;this.w=a*n+b*c;this.x=d*n+e*c;this.y=g*n+m*c;this.z=f*n+h*c;return this},transformVector:function(a,b){void 0===b&&(b=new pc.Vec3);var c=a.x,d=a.y,g=a.z,f=this.x,e=this.y,m=this.z,h=this.w,n=h*c+e*g-m*d,l=h*d+m*c-f*g,r=h*g+f*d-e*c,c=-f*c-e*d-m*g;b.x=n*h+c*-f+l*-m-r*-e;b.y=l*h+c*-e+r*-f-n*-m;b.z=r*h+c*-m+n*-e-l*-f;return b},toString:function(){return"["+
this.x+", "+this.y+", "+this.z+", "+this.w+"]"}};Object.defineProperty(e,"IDENTITY",{get:function(){var a=new e;return function(){return a}}()});Object.defineProperty(e,"ZERO",{get:function(){var a=new e(0,0,0,0);return function(){return a}}()});return{Quat:e}}());pc.extend(pc,function(){var e=function(a){this.keys=[];this.type=1;this.tension=0.5;if(a)for(var b=0;b<a.length-1;b+=2)this.keys.push([a[b],a[b+1]]);this.sort()};e.prototype={add:function(a,b){for(var c=this.keys,d=c.length,g=0;g<d&&!(c[g][0]>a);g++);c=[a,b];this.keys.splice(g,0,c);return c},get:function(a){return this.keys[a]},sort:function(){this.keys.sort(function(a,b){return a[0]-b[0]})},value:function(a){var b=this.keys;if(!b.length)return 0;if(a<b[0][0])return b[0][1];if(a>b[b.length-1][0])return b[b.length-
1][1];for(var c=0,d=b.length?b[0][1]:0,g=1,f=0,e=0,m=b.length;e<m;e++){if(b[e][0]===a)return b[e][1];f=b[e][1];if(a<b[e][0]){g=b[e][0];break}c=b[e][0];d=b[e][1]}m=g-c;a=0===m?0:(a-c)/m;if(1===this.type)a*=a*(3-2*a);else if(2===this.type||3===this.type){var m=d+(d-f),h=f+(f-d),n=g=c=g-c;0<e&&(e-=1);0<e&&(m=b[e-1][1],g=b[e][0]-b[e-1][0]);b.length>e+1&&(c=b[e+1][0]-b[e][0]);b.length>e+2&&(n=b[e+2][0]-b[e+1][0],h=b[e+2][1]);m=d+(m-d)*c/g;h=f+(h-f)*c/n;return 2===this.type?this._interpolateCatmullRom(m,
d,f,h,a):this._interpolateCardinal(m,d,f,h,a,this.tension)}return pc.math.lerp(d,f,a)},_interpolateHermite:function(a,b,c,d,g){var f=g*g,e=g*g*g;return a*(2*e-3*f+1)+b*(-2*e+3*f)+c*(e-2*f+g)+d*(e-f)},_interpolateCardinal:function(a,b,c,d,g,f){return this._interpolateHermite(b,c,f*(c-a),f*(d-b),g)},_interpolateCatmullRom:function(a,b,c,d,g){return this._interpolateCardinal(a,b,c,d,g,0.5)},closest:function(a){for(var b=this.keys,c=b.length,d=2,g=null,f=0;f<c;f++){var e=Math.abs(a-b[f][0]);if(d>=e)d=
e,g=b[f];else break}return g},clone:function(){var a=new pc.Curve;a.keys=pc.extend(a.keys,this.keys);a.type=this.type;return a},quantize:function(a){for(var a=Math.max(a,2),b=new Float32Array(a),c=1/(a-1),d=0;d<a;d++){var g=this.value(c*d);b[d]=g}return b}};Object.defineProperty(e.prototype,"length",{get:function(){return this.keys.length}});return{Curve:e,CURVE_LINEAR:0,CURVE_SMOOTHSTEP:1,CURVE_CATMULL:2,CURVE_CARDINAL:3}}());pc.extend(pc,function(){var e=function(){var a;this.curves=[];this._type=pc.CURVE_SMOOTHSTEP;if(1<arguments.length)for(a=0;a<arguments.length;a++)this.curves.push(new pc.Curve(arguments[a]));else if(0===arguments.length)this.curves.push(new pc.Curve);else{var b=arguments[0];if("number"===pc.type(b))for(a=0;a<b;a++)this.curves.push(new pc.Curve);else for(a=0;a<b.length;a++)this.curves.push(new pc.Curve(b[a]))}};e.prototype={get:function(a){return this.curves[a]},value:function(a,b){var c=this.curves.length,
b=b||[];b.length=c;for(var d=0;d<c;d++)b[d]=this.curves[d].value(a);return b},clone:function(){var a=new pc.CurveSet;a.curves=[];for(var b=0;b<this.curves.length;b++)a.curves.push(this.curves[b].clone());a._type=this._type;return a},quantize:function(a){for(var a=Math.max(a,2),b=this.curves.length,c=new Float32Array(a*b),d=1/(a-1),g=[],f=0;f<a;f++){var e=this.value(d*f,g);if(1==b)c[f]=e[0];else for(var m=0;m<b;m++)c[f*b+m]=e[m]}return c}};Object.defineProperty(e.prototype,"length",{get:function(){return this.curves.length}});
Object.defineProperty(e.prototype,"type",{get:function(){return this._type},set:function(a){this._type=a;for(var b=0;b<this.curves.length;b++)this.curves[b].type=a}});return{CurveSet:e}}());pc.shape=function(){var e=function(){};e.prototype={containsPoint:function(){throw Error("Shape hasn't implemented containsPoint");}};return{Shape:e,Type:{CAPSULE:"Capsule",CONE:"Cone",CYLINDER:"Cylinder",CIRCLE:"Circle",RECT:"Rect"}}}();pc.shape.intersection=function(){return{aabbAabb:function(e,a){var b=e.getMax(),c=e.getMin(),d=a.getMax(),g=a.getMin();return c[0]<=d[0]&&b[0]>=g[0]&&c[1]<=d[1]&&b[1]>=g[1]&&c[2]<=d[2]&&b[2]>=g[2]},rayAabb:function(e,a,b){var c=new pc.Vec3,d,g=new pc.Vec3;d=new pc.Vec3;c.sub2(e,b.center);e=new pc.Vec3(Math.abs(c.x),Math.abs(c.y),Math.abs(c.z));d.mul2(c,a);if(e.x>b.halfExtents.x&&0<=d.x||e.y>b.halfExtents.y&&0<=d.y||e.z>b.halfExtents.z&&0<=d.z)return!1;d=new pc.Vec3(Math.abs(a.x),Math.abs(a.y),Math.abs(a.z));
g.cross(a,c);g.set(Math.abs(g.x),Math.abs(g.y),Math.abs(g.z));return g.x>b.halfExtents.y*d.z+b.halfExtents.z*d.y||g.y>b.halfExtents.x*d.z+b.halfExtents.z*d.x||g.z>b.halfExtents.x*d.y+b.halfExtents.y*d.x?!1:!0},raySphere:function(e,a,b,c){var d=new pc.Vec3,g=0,f=0,k=0,k=0,c=c||{};d.sub2(e,b.center);if(d.dot(d)<b.radius*b.radius)return c.success=!0,c.t=0,!0;g=a.dot(a);f=2*a.dot(d);k=b.center.dot(b.center);k+=e.dot(e);k-=2*b.center.dot(e);k-=b.radius*b.radius;k=f*f-4*g*k;if(0>k)return c.success=!1,c.t=
0,!1;c.success=!0;c.t=(-f-Math.sqrt(k))/(2*g);return!0},rayTriangle:function(e,a,b,c){var d=e.clone().sub(b.v0),d=-b.n.dot(d),g=b.n.dot(a);if(1E-8>Math.fabs(g))return 0===d?2:0;d/=g;if(0>d)return 0;a=a.clone().scale(d);c.add2(e,a);c=(new pc.Vec3).sub2(c,b.v0);e=c.dot(b.u);c=c.dot(b.v);a=(b.uv*c-b.vv*e)/b.d;if(0>a||1<a)return 0;b=(b.uv*e-b.uu*c)/b.d;return 0>b||1<a+b?0:1}}}();pc.extend(pc.shape,function(){pc.shape.Type.AABB="Aabb";var e=function(a,b){this.center=a||new pc.Vec3(0,0,0);this.halfExtents=b||new pc.Vec3(0.5,0.5,0.5);this.type=pc.shape.Type.AABB},e=pc.inherits(e,pc.shape.Shape);e.prototype.add=function(a){var b=this.center,c=this.halfExtents,d=b.x-c.x,g=b.x+c.x,f=b.y-c.y,e=b.y+c.y,m=b.z-c.z,h=b.z+c.z,n=a.center,l=a.halfExtents,a=n.x-l.x,r=n.x+l.x,v=n.y-l.y,u=n.y+l.y,C=n.z-l.z,n=n.z+l.z;a<d&&(d=a);r>g&&(g=r);v<f&&(f=v);u>e&&(e=u);C<m&&(m=C);n>h&&(h=n);b.set(d+
g,f+e,m+h).scale(0.5);c.set(g-d,e-f,h-m).scale(0.5)};e.prototype.copy=function(a){this.center.copy(a.center);this.halfExtents.copy(a.halfExtents);this.type=a.type};e.prototype.setMinMax=function(a,b){this.center.add2(b,a).scale(0.5);this.halfExtents.sub2(b,a).scale(0.5)};e.prototype.getMin=function(){return this.center.clone().sub(this.halfExtents)};e.prototype.getMax=function(){return this.center.clone().add(this.halfExtents)};e.prototype.containsPoint=function(a){var b=this.getMin(),c=this.getMax(),
d;for(d=0;3>d;++d)if(a.data[d]<b.data[d]||a.data[d]>c.data[d])return!1;return!0};e.prototype.setFromTransformedAabb=function(a,b){var c=this.center,d=this.halfExtents,g=a.center.data,f=a.halfExtents.data,b=b.data,e=b[0],m=b[4],h=b[8],n=b[1],l=b[5],r=b[9],v=b[2],u=b[6],C=b[10],y=Math.abs(e),s=Math.abs(m),w=Math.abs(h),A=Math.abs(n),x=Math.abs(l),z=Math.abs(r),H=Math.abs(v),G=Math.abs(u),K=Math.abs(C);c.set(b[12]+e*g[0]+m*g[1]+h*g[2],b[13]+n*g[0]+l*g[1]+r*g[2],b[14]+v*g[0]+u*g[1]+C*g[2]);d.set(y*f[0]+
s*f[1]+w*f[2],A*f[0]+x*f[1]+z*f[2],H*f[0]+G*f[1]+K*f[2])};e.prototype.compute=function(a){for(var b=new pc.Vec3(a[0],a[1],a[2]),c=new pc.Vec3(a[0],a[1],a[2]),d=a.length/3,g=1;g<d;g++){var f=a[3*g+0],e=a[3*g+1],m=a[3*g+2];f<b.x&&(b.x=f);e<b.y&&(b.y=e);m<b.z&&(b.z=m);f>c.x&&(c.x=f);e>c.y&&(c.y=e);m>c.z&&(c.z=m)}this.setMinMax(b,c)};return{Aabb:e}}());pc.extend(pc.shape,function(){function e(a,b){this.transform=void 0===a?new pc.Mat4:a;this.halfExtents=void 0===b?new pc.Vec3(0.5,0.5,0.5):b;this.type=pc.shape.Type.BOX}pc.shape.Type.BOX="Box";var a=new pc.Vec3,b=new pc.Vec3,c=new pc.Mat4,d=new pc.Mat4,e=pc.inherits(e,pc.shape.Shape);e.prototype.containsPoint=function(g){this.transform.getTranslation(a);var f=this.getHalfExtents();c.copy(this.transform);b.copy(f).scale(2);d.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,b);c.mul(d).invert();c.transformPoint(g,
b);return-0.5>b.x||0.5<b.x||-0.5>b.y||0.5<b.y||-0.5>b.z||0.5<b.z?!1:!0};e.prototype.getHalfExtents=function(){return this.halfExtents};return{Box:e}}());pc.extend(pc,function(){var e=new pc.Mat4,a=function(a,c){a=a||(new pc.Mat4).setPerspective(90,16/9,0.1,1E3);c=c||new pc.Mat4;this.planes=[];for(var d=0;6>d;d++)this.planes[d]=[];this.update(a,c)};a.prototype={update:function(a,c){e.mul2(a,c);var d=e.data;this.planes[0][0]=d[3]-d[0];this.planes[0][1]=d[7]-d[4];this.planes[0][2]=d[11]-d[8];this.planes[0][3]=d[15]-d[12];t=Math.sqrt(this.planes[0][0]*this.planes[0][0]+this.planes[0][1]*this.planes[0][1]+this.planes[0][2]*this.planes[0][2]);this.planes[0][0]/=
t;this.planes[0][1]/=t;this.planes[0][2]/=t;this.planes[0][3]/=t;this.planes[1][0]=d[3]+d[0];this.planes[1][1]=d[7]+d[4];this.planes[1][2]=d[11]+d[8];this.planes[1][3]=d[15]+d[12];t=Math.sqrt(this.planes[1][0]*this.planes[1][0]+this.planes[1][1]*this.planes[1][1]+this.planes[1][2]*this.planes[1][2]);this.planes[1][0]/=t;this.planes[1][1]/=t;this.planes[1][2]/=t;this.planes[1][3]/=t;this.planes[2][0]=d[3]+d[1];this.planes[2][1]=d[7]+d[5];this.planes[2][2]=d[11]+d[9];this.planes[2][3]=d[15]+d[13];t=
Math.sqrt(this.planes[2][0]*this.planes[2][0]+this.planes[2][1]*this.planes[2][1]+this.planes[2][2]*this.planes[2][2]);this.planes[2][0]/=t;this.planes[2][1]/=t;this.planes[2][2]/=t;this.planes[2][3]/=t;this.planes[3][0]=d[3]-d[1];this.planes[3][1]=d[7]-d[5];this.planes[3][2]=d[11]-d[9];this.planes[3][3]=d[15]-d[13];t=Math.sqrt(this.planes[3][0]*this.planes[3][0]+this.planes[3][1]*this.planes[3][1]+this.planes[3][2]*this.planes[3][2]);this.planes[3][0]/=t;this.planes[3][1]/=t;this.planes[3][2]/=t;
this.planes[3][3]/=t;this.planes[4][0]=d[3]-d[2];this.planes[4][1]=d[7]-d[6];this.planes[4][2]=d[11]-d[10];this.planes[4][3]=d[15]-d[14];t=Math.sqrt(this.planes[4][0]*this.planes[4][0]+this.planes[4][1]*this.planes[4][1]+this.planes[4][2]*this.planes[4][2]);this.planes[4][0]/=t;this.planes[4][1]/=t;this.planes[4][2]/=t;this.planes[4][3]/=t;this.planes[5][0]=d[3]+d[2];this.planes[5][1]=d[7]+d[6];this.planes[5][2]=d[11]+d[10];this.planes[5][3]=d[15]+d[14];t=Math.sqrt(this.planes[5][0]*this.planes[5][0]+
this.planes[5][1]*this.planes[5][1]+this.planes[5][2]*this.planes[5][2]);this.planes[5][0]/=t;this.planes[5][1]/=t;this.planes[5][2]/=t;this.planes[5][3]/=t},containsPoint:function(a){for(var c=0;6>c;c++)if(0>=this.planes[c][0]*a.x+this.planes[c][1]*a.y+this.planes[c][2]*a.z+this.planes[c][3])return!1;return!0},containsSphere:function(a){var c=0,d;for(p=0;6>p;p++){d=this.planes[p][0]*a.center.x+this.planes[p][1]*a.center.y+this.planes[p][2]*a.center.z+this.planes[p][3];if(d<=-a.radius)return 0;d>
a.radius&&c++}return 6===c?2:1}};return{Frustum:a}}());pc.extend(pc.shape,function(){pc.shape.Type.PLANE="Plane";var e=function(a,b){this.normal=b||new pc.Vec3(0,0,1);this.point=a||new pc.Vec3(0,0,0);this.d=-this.normal.dot(this.point);this.type=pc.shape.Type.PLANE},e=pc.inherits(e,pc.shape.Shape);e.prototype.containsPoint=function(){return!1};e.prototype.distance=function(a){return this.normal.dot(a)+this.d};e.prototype.intersect=function(a,b){var c=this.distance(a),d=this.distance(b);return c/(c-d)};e.prototype.intersectPosition=function(a,b){var c=
this.intersect(a,b),d=new pc.Vec3;d.lerp(a,b,c);return d};return{Plane:e}}());pc.extend(pc.shape,function(){function e(a,b){this.center=void 0===a?new pc.Vec3(0,0,0):a;this.radius=void 0===b?1:b;this.type=pc.shape.Type.SPHERE}pc.shape.Type.SPHERE="Sphere";var e=pc.inherits(e,pc.shape.Shape),a=e.prototype,b=new pc.Vec3;a.containsPoint=function(a){var a=b.sub2(a,this.center).lengthSq(),d=this.radius;return a<d*d};e.prototype.compute=function(a){var b,g=a.length/3,f=new pc.Vec3(0,0,0),e=new pc.Vec3(0,0,0),m=new pc.Vec3(0,0,0);for(b=0;b<g;b++)f.set(a[3*b],a[3*b+1],a[3*b+2]),m.addSelf(f),
0===b%100&&(m.scale(1/g),e.add(m),m.set(0,0,0));m.scale(1/g);e.add(m);this.center.copy(e);e=0;m=new pc.Vec3(0,0,0);for(b=0;b<g;b++)f.set(a[3*b],a[3*b+1],a[3*b+2]),m.sub2(f,this.center),e=Math.max(m.lengthSq(),e);this.radius=Math.sqrt(e)};e.prototype.intersectRay=function(a,b){var g=a.clone().sub(this.center),f=g.dot(b),g=g.dot(g)-this.radius*this.radius;if(0<g&&0<f)return null;g=f*f-g;if(0>g)return null;t=Math.abs(-f-Math.sqrt(g));return b.clone().scale(t).add(a)};return{Sphere:e}}());pc.extend(pc.shape,function(){pc.shape.Type.TORUS="Torus";var e=function(a,b,c){this.transform=a;this.iradius=b;this.oradius=c;this.type=pc.shape.Type.TORUS},e=pc.inherits(e,pc.shape.Shape);e.prototype.containsPoint=function(){throw Error("Not implemented yet");};return{Torus:e}}());(function(){var e={ADDRESS_REPEAT:0,ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BLENDEQUATION_ADD:0,BLENDEQUATION_SUBTRACT:1,BLENDEQUATION_REVERSE_SUBTRACT:2,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CLEARFLAG_COLOR:1,
CLEARFLAG_DEPTH:2,CLEARFLAG_STENCIL:4,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_A8:0,PIXELFORMAT_L8:1,
PIXELFORMAT_L8_A8:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R5_G5_B5_A1:4,PIXELFORMAT_R4_G4_B4_A4:5,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PIXELFORMAT_DXT1:8,PIXELFORMAT_DXT3:9,PIXELFORMAT_DXT5:10,PIXELFORMAT_RGB16F:11,PIXELFORMAT_RGBA16F:12,PIXELFORMAT_RGB32F:13,PIXELFORMAT_RGBA32F:14,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_TANGENT:"TANGENT",
SEMANTIC_BLENDWEIGHT:"BLENDWEIGHT",SEMANTIC_BLENDINDICES:"BLENDINDICES",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_TEXCOORD2:"TEXCOORD2",SEMANTIC_TEXCOORD3:"TEXCOORD3",SEMANTIC_TEXCOORD4:"TEXCOORD4",SEMANTIC_TEXCOORD5:"TEXCOORD5",SEMANTIC_TEXCOORD6:"TEXCOORD6",SEMANTIC_TEXCOORD7:"TEXCOORD7",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",SEMANTIC_ATTR4:"ATTR4",SEMANTIC_ATTR5:"ATTR5",SEMANTIC_ATTR6:"ATTR6",
SEMANTIC_ATTR7:"ATTR7",SEMANTIC_ATTR8:"ATTR8",SEMANTIC_ATTR9:"ATTR9",SEMANTIC_ATTR10:"ATTR10",SEMANTIC_ATTR11:"ATTR11",SEMANTIC_ATTR12:"ATTR12",SEMANTIC_ATTR13:"ATTR13",SEMANTIC_ATTR14:"ATTR14",SEMANTIC_ATTR15:"ATTR15",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,UNIFORMTYPE_BOOL:0,UNIFORMTYPE_INT:1,UNIFORMTYPE_FLOAT:2,UNIFORMTYPE_VEC2:3,UNIFORMTYPE_VEC3:4,UNIFORMTYPE_VEC4:5,UNIFORMTYPE_IVEC2:6,UNIFORMTYPE_IVEC3:7,UNIFORMTYPE_IVEC4:8,UNIFORMTYPE_BVEC2:9,UNIFORMTYPE_BVEC3:10,UNIFORMTYPE_BVEC4:11,UNIFORMTYPE_MAT2:12,
UNIFORMTYPE_MAT3:13,UNIFORMTYPE_MAT4:14,UNIFORMTYPE_TEXTURE2D:15,UNIFORMTYPE_TEXTURECUBE:16};pc.extend(pc,e);pc.gfx={};pc.extend(pc.gfx,e)})();pc.extend(pc,function(){var e=function(a){this.name=a;this.value=null;this.versionObject=new pc.VersionedObject};e.prototype={setValue:function(a){this.value=a;this.versionObject.increment()},getValue:function(){return this.value}};return{ScopeId:e}}());pc.extend(pc,function(){var e=function(a){this.name=a;this.variables={};this.namespaces={}};e.prototype={resolve:function(a){!1===this.variables.hasOwnProperty(a)&&(this.variables[a]=new pc.ScopeId(a));return this.variables[a]},getSubSpace:function(a){!1===this.namespaces.hasOwnProperty(a)&&(this.namespaces[a]=new pc.ScopeSpace(a),logDEBUG("Added ScopeSpace: "+a));return this.namespaces[a]}};return{ScopeSpace:e}}());pc.extend(pc,function(){var e=function(){this.revision=this.globalId=0};e.prototype={equals:function(a){return this.globalId===a.globalId&&this.revision===a.revision},notequals:function(a){return this.globalId!==a.globalId||this.revision!==a.revision},copy:function(a){this.globalId=a.globalId;this.revision=a.revision},reset:function(){this.revision=this.globalId=0}};return{Version:e}}());pc.extend(pc,function(){var e=0,a=function(){e++;this.version=new pc.Version;this.version.globalId=e};a.prototype={increment:function(){this.version.revision++}};return{VersionedObject:a}}());pc.extend(pc,function(){function e(f,g){this.index=0;switch(g.dataType){case pc.ELEMENTTYPE_INT8:this.array=new Int8Array(f,g.offset);break;case pc.ELEMENTTYPE_UINT8:this.array=new Uint8Array(f,g.offset);break;case pc.ELEMENTTYPE_INT16:this.array=new Int16Array(f,g.offset);break;case pc.ELEMENTTYPE_UINT16:this.array=new Uint16Array(f,g.offset);break;case pc.ELEMENTTYPE_INT32:this.array=new Int32Array(f,g.offset);break;case pc.ELEMENTTYPE_UINT32:this.array=new Uint32Array(f,g.offset);break;case pc.ELEMENTTYPE_FLOAT32:this.array=
new Float32Array(f,g.offset)}switch(g.numComponents){case 1:this.set=a;break;case 2:this.set=b;break;case 3:this.set=c;break;case 4:this.set=d}}function a(a){this.array[this.index]=a}function b(a,b){this.array[this.index]=a;this.array[this.index+1]=b}function c(a,b,c){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c}function d(a,b,c,d){this.array[this.index]=a;this.array[this.index+1]=b;this.array[this.index+2]=c;this.array[this.index+3]=d}function g(a){this.vertexBuffer=
a;this.buffer=this.vertexBuffer.lock();this.setters=[];this.element={};for(var a=this.vertexBuffer.getFormat(),b=0;b<a.elements.length;b++){var c=a.elements[b];this.setters[b]=new e(this.buffer,c);this.element[c.name]=this.setters[b]}}g.prototype={next:function(){for(var a=0,b=this.setters,c=this.setters.length,d=this.vertexBuffer.getFormat();a<c;){var g=b[a++];g.index+=d.size/g.array.constructor.BYTES_PER_ELEMENT}},end:function(){this.vertexBuffer.unlock()}};return{VertexIterator:g}}());pc.extend(pc,function(){var e=[];e[pc.ELEMENTTYPE_INT8]=1;e[pc.ELEMENTTYPE_UINT8]=1;e[pc.ELEMENTTYPE_INT16]=2;e[pc.ELEMENTTYPE_UINT16]=2;e[pc.ELEMENTTYPE_INT32]=4;e[pc.ELEMENTTYPE_UINT32]=4;e[pc.ELEMENTTYPE_FLOAT32]=4;return{VertexFormat:function(a,b){var c;this.elements=[];c=this.size=0;for(var d=b.length;c<d;c++){var g=b[c],g={name:g.semantic,offset:0,stride:0,stream:-1,scopeId:a.scope.resolve(g.semantic),dataType:g.type,numComponents:g.components,normalize:void 0===g.normalize?!1:g.normalize,size:g.components*
e[g.type]};this.elements.push(g);this.size+=g.size}var f=0;c=0;for(d=this.elements.length;c<d;c++)g=this.elements[c],g.offset=f,g.stride=this.size,f+=g.size}}}());pc.extend(pc,function(){var e=function(a,b,c,d){this.usage=d||pc.BUFFER_STATIC;this.format=b;this.numVertices=c;this.numBytes=b.size*c;this.device=a;this.bufferId=this.device.gl.createBuffer();this.storage=new ArrayBuffer(this.numBytes)};e.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId)},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var a=
this.device.gl,b;switch(this.usage){case pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ARRAY_BUFFER,this.bufferId);a.bufferData(a.ARRAY_BUFFER,this.storage,b)}};return{VertexBuffer:e}}());pc.extend(pc,function(){var e=function(a,b,c,d){this.usage=d||pc.BUFFER_STATIC;this.format=b;this.numIndices=c;this.device=a;a=this.device.gl;this.bufferId=a.createBuffer();var g;b===pc.INDEXFORMAT_UINT8?(g=1,this.glFormat=a.UNSIGNED_BYTE):b===pc.INDEXFORMAT_UINT16?(g=2,this.glFormat=a.UNSIGNED_SHORT):b===pc.INDEXFORMAT_UINT32&&(g=4,this.glFormat=a.UNSIGNED_INT);this.storage=new ArrayBuffer(this.numIndices*g)};e.prototype={destroy:function(){this.device.gl.deleteBuffer(this.bufferId)},getFormat:function(){return this.format},
getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var a=this.device.gl,b;switch(this.usage){case pc.BUFFER_STATIC:b=a.STATIC_DRAW;break;case pc.BUFFER_DYNAMIC:b=a.DYNAMIC_DRAW;break;case pc.BUFFER_STREAM:b=a.STREAM_DRAW}a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,this.bufferId);a.bufferData(a.ELEMENT_ARRAY_BUFFER,this.storage,b)}};return{IndexBuffer:e}}());pc.extend(pc,function(){var e=function(a,b){this.device=a;var c=4,d=4,g=pc.PIXELFORMAT_R8_G8_B8_A8,f=!1,e=!0,m=!1,h=!1,n=!1;void 0!==b&&(c=void 0!==b.width?b.width:c,d=void 0!==b.height?b.height:d,g=void 0!==b.format?b.format:g,f=void 0!==b.cubemap?b.cubemap:f,e=void 0!==b.autoMipmap?b.autoMipmap:e,m=void 0!==b.rgbm?b.rgbm:m,n=void 0!==b.hdr?b.hdr:n,h=void 0!==b.fixCubemapSeams?b.fixCubemapSeams:h);this.name=null;this.autoMipmap=e;this.rgbm=m;this.fixCubemapSeams=h;this.hdr=n;this._cubemap=f;this._format=
g;this._compressed=g===pc.PIXELFORMAT_DXT1||g===pc.PIXELFORMAT_DXT3||g===pc.PIXELFORMAT_DXT5;this._width=c||4;this._height=d||4;this._addressV=this._addressU=pc.ADDRESS_REPEAT;this._minFilter=pc.math.powerOfTwo(this._width)&&pc.math.powerOfTwo(this._height)?pc.FILTER_LINEAR_MIPMAP_LINEAR:pc.FILTER_LINEAR;this._magFilter=pc.FILTER_LINEAR;this._anisotropy=1;this._levels=f?[[null,null,null,null,null,null]]:[null];this._lockedLevel=-1;this._needsUpload=!0};Object.defineProperty(e.prototype,"minFilter",
{get:function(){return this._minFilter},set:function(a){if(!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))a===pc.FILTER_NEAREST||a===pc.FILTER_LINEAR||(logWARNING("Invalid minification filter mode set on non power of two texture. Forcing linear addressing."),a=pc.FILTER_LINEAR);this._minFilter=a}});Object.defineProperty(e.prototype,"magFilter",{get:function(){return this._magFilter},set:function(a){a===pc.FILTER_NEAREST||a===pc.FILTER_LINEAR||logWARNING("Invalid magnification filter mode. Must be set to FILTER_NEAREST or FILTER_LINEAR.");
this._magFilter=a}});Object.defineProperty(e.prototype,"addressU",{get:function(){return this._addressU},set:function(a){if((!pc.math.powerOfTwo(this._width)||!pc.math.powerOfTwo(this._height))&&a!==pc.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in U set on non power of two texture. Forcing clamp to edge addressing."),a=pc.ADDRESS_CLAMP_TO_EDGE;this._addressU=a}});Object.defineProperty(e.prototype,"addressV",{get:function(){return this._addressV},set:function(a){if((!pc.math.powerOfTwo(this._width)||
!pc.math.powerOfTwo(this._height))&&a!==pc.ADDRESS_CLAMP_TO_EDGE)logWARNING("Invalid address mode in V set on non power of two texture. Forcing clamp to edge addressing."),a=pc.ADDRESS_CLAMP_TO_EDGE;this._addressV=a}});Object.defineProperty(e.prototype,"anisotropy",{get:function(){return this._anisotropy},set:function(a){this._anisotropy=a}});Object.defineProperty(e.prototype,"width",{get:function(){return this._width}});Object.defineProperty(e.prototype,"height",{get:function(){return this._height}});
Object.defineProperty(e.prototype,"format",{get:function(){return this._format}});Object.defineProperty(e.prototype,"cubemap",{get:function(){return this._cubemap}});pc.extend(e.prototype,{bind:function(){},destroy:function(){this._glTextureId&&this.device.gl.deleteTexture(this._glTextureId)},lock:function(a){a=a||{level:0,face:0,mode:pc.TEXTURELOCK_WRITE};void 0===a.level&&(a.level=0);void 0===a.face&&(a.face=0);void 0===a.mode&&(a.mode=pc.TEXTURELOCK_WRITE);this._lockedLevel=a.level;if(null===this._levels[a.level])switch(this._format){case pc.PIXELFORMAT_A8:case pc.PIXELFORMAT_L8:this._levels[a.level]=
new Uint8Array(this._width*this._height);break;case pc.PIXELFORMAT_L8_A8:this._levels[a.level]=new Uint8Array(2*this._width*this._height);break;case pc.PIXELFORMAT_R5_G6_B5:case pc.PIXELFORMAT_R5_G5_B5_A1:case pc.PIXELFORMAT_R4_G4_B4_A4:this._levels[a.level]=new Uint16Array(this._width*this._height);break;case pc.PIXELFORMAT_R8_G8_B8:this._levels[a.level]=new Uint8Array(3*this._width*this._height);break;case pc.PIXELFORMAT_R8_G8_B8_A8:this._levels[a.level]=new Uint8Array(4*this._width*this._height);
break;case pc.PIXELFORMAT_DXT1:this._levels[a.level]=new Uint8Array(8*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case pc.PIXELFORMAT_DXT3:case pc.PIXELFORMAT_DXT5:this._levels[a.level]=new Uint8Array(16*Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4));break;case pc.PIXELFORMAT_RGB16F:case pc.PIXELFORMAT_RGB32F:this._levels[a.level]=new Float32Array(3*this._width*this._height);break;case pc.PIXELFORMAT_RGBA16F:case pc.PIXELFORMAT_RGBA32F:this._levels[a.level]=
new Float32Array(4*this._width*this._height)}return this._levels[a.level]},recover:function(){},load:function(a,b){if(this._cubemap){var c=a.map(function(a){return new pc.resources.ImageRequest(a)});b.request(c).then(function(a){this.setSource(a)}.bind(this))}else c=new pc.resources.ImageRequest(a),b.request(c).then(function(a){this.setSource(a[0])}.bind(this))},setSource:function(a){if(this._cubemap){logASSERT("[object Array]"===Object.prototype.toString.apply(a),"pc.Texture: setSource: supplied source is not an array");
logASSERT(6===a.length,"pc.Texture: setSource: supplied source does not have 6 entries.");for(var b=0,c=!0,d=a[0].width,g=a[0].height,f=0;6>f;f++)(a[f]instanceof HTMLCanvasElement||a[f]instanceof HTMLImageElement||a[f]instanceof HTMLVideoElement)&&b++,a[f].width!==d&&(c=!1),a[f].height!==g&&(c=!1);logASSERT(6===b,"pc.Texture: setSource: Not all supplied source elements are of required type (canvas, image or video).");logASSERT(c,"pc.Texture: setSource: Not all supplied source elements share the same dimensions.");
this._width=a[0].width;this._height=a[0].height}else logASSERT(a instanceof HTMLCanvasElement||a instanceof HTMLImageElement||a instanceof HTMLVideoElement,"pc.Texture: setSource: supplied source is not an instance of HTMLCanvasElement, HTMLImageElement or HTMLVideoElement."),this._width=a.width,this._height=a.height;this._levels[0]=a;this.upload();this.minFilter=this._minFilter;this.magFilter=this._magFilter;this.addressu=this._addressu;this.addressv=this._addressv},getSource:function(){return this._levels[0]},
unlock:function(){logASSERT(-1!==this._lockedLevel,"Attempting to unlock a texture that is not locked");this.upload();this._lockedLevel=-1},upload:function(){this._needsUpload=!0},getDDS:function(){this.format!=pc.PIXELFORMAT_R8_G8_B8_A8&&console.error("This format is not implemented yet");for(var a=128,b=0,c,d;this._levels[b];){if(this.cubemap)for(d=0;6>d;d++){c=this._levels[b][d].length;if(!c){console.error("No byte array for mip "+b+", face "+d);return}a+=c}else{c=this._levels[b].length;if(!c){console.error("No byte array for mip "+
b);return}a+=c}a+=this._levels[b].length;b++}a=new ArrayBuffer(a);d=new Uint32Array(a,0,32);b=528391;1<this._levels.length&&(b|=131072);c=4096;1<this._levels.length&&(c|=4194304);if(1<this._levels.length||this.cubemap)c|=8;var g=this.cubemap?65024:0;d[0]=542327876;d[1]=124;d[2]=b;d[3]=this.height;d[4]=this.width;d[5]=4*this.width*this.height;d[6]=0;d[7]=this._levels.length;for(b=0;11>b;b++)d[8+b]=0;d[19]=32;d[20]=65;d[21]=0;d[22]=32;d[23]=16711680;d[24]=65280;d[25]=255;d[26]=4278190080;d[27]=c;d[28]=
g;d[29]=0;d[30]=0;d[31]=0;g=128;if(this.cubemap)for(d=0;6>d;d++)for(b=0;b<this._levels.length;b++){f=this._levels[b][d];e=new Uint8Array(a,g,f.length);for(c=0;c<f.length;c++)e[c]=f[c];g+=f.length}else for(b=0;b<this._levels.length;b++){var f=this._levels[b],e=new Uint8Array(a,g,f.length);for(c=0;c<f.length;c++)e[c]=f[c];g+=f.length}return a}});return{Texture:e}}());pc.extend(pc,function(){var e={depth:!0,face:0},a=function(a,c,d){this._device=a;this._colorBuffer=c;d=void 0!==d?d:e;this._face=void 0!==d.face?d.face:0;this._depth=void 0!==d.depth?d.depth:!0};a.prototype={bind:function(){},destroy:function(){var a=this._device.gl;a.deleteFramebuffer(this._frameBuffer);this._depthBuffer&&a.deleteRenderbuffer(this._depthBuffer)},unbind:function(){}};Object.defineProperty(a.prototype,"colorBuffer",{get:function(){return this._colorBuffer}});Object.defineProperty(a.prototype,
"face",{get:function(){return this._face}});Object.defineProperty(a.prototype,"width",{get:function(){return this._colorBuffer.width}});Object.defineProperty(a.prototype,"height",{get:function(){return this._colorBuffer.height}});return{RenderTarget:a}}());pc.extend(pc,function(){return{ShaderInput:function(e,a,b,c){this.locationId=c;this.scopeId=e.scope.resolve(a);this.version=new pc.Version;this.dataType=b;this.array=[]}}}());pc.extend(pc,function(){function e(a,c,d){var g=a.createShader(c);a.shaderSource(g,d);a.compileShader(g);if(!a.getShaderParameter(g,a.COMPILE_STATUS)){for(var f=a.getShaderInfoLog(g),e=logERROR,a="Failed to compile "+(c===a.VERTEX_SHADER?"vertex":"fragment")+" shader:\n\n",d=d.split("\n"),c=0,m=d.length;c<m;c++)d[c]=c+1+":\t"+d[c];d=d.join("\n");e(a+d+"\n\n"+f)}return g}var a=function(a,c){this.device=a;this.definition=c;var d=this.device.gl,g=e(d,d.VERTEX_SHADER,c.vshader),f=e(d,d.FRAGMENT_SHADER,
c.fshader),k=d.createProgram();d.attachShader(k,g);d.attachShader(k,f);d.linkProgram(k);if(!d.getProgramParameter(k,d.LINK_STATUS)){var m=d.getProgramInfoLog(k);logERROR("Failed to link shader program. Error: "+m)}this.program=k;d.deleteShader(g);d.deleteShader(f);this.attributes=[];this.uniforms=[];this.samplers=[];g=0;f={};f[d.BOOL]=pc.UNIFORMTYPE_BOOL;f[d.INT]=pc.UNIFORMTYPE_INT;f[d.FLOAT]=pc.UNIFORMTYPE_FLOAT;f[d.FLOAT_VEC2]=pc.UNIFORMTYPE_VEC2;f[d.FLOAT_VEC3]=pc.UNIFORMTYPE_VEC3;f[d.FLOAT_VEC4]=
pc.UNIFORMTYPE_VEC4;f[d.INT_VEC2]=pc.UNIFORMTYPE_IVEC2;f[d.INT_VEC3]=pc.UNIFORMTYPE_IVEC3;f[d.INT_VEC4]=pc.UNIFORMTYPE_IVEC4;f[d.BOOL_VEC2]=pc.UNIFORMTYPE_BVEC2;f[d.BOOL_VEC3]=pc.UNIFORMTYPE_BVEC3;f[d.BOOL_VEC4]=pc.UNIFORMTYPE_BVEC4;f[d.FLOAT_MAT2]=pc.UNIFORMTYPE_MAT2;f[d.FLOAT_MAT3]=pc.UNIFORMTYPE_MAT3;f[d.FLOAT_MAT4]=pc.UNIFORMTYPE_MAT4;f[d.SAMPLER_2D]=pc.UNIFORMTYPE_TEXTURE2D;f[d.SAMPLER_CUBE]=pc.UNIFORMTYPE_TEXTURECUBE;for(var h=d.getProgramParameter(this.program,d.ACTIVE_ATTRIBUTES);g<h;)k=d.getActiveAttrib(this.program,
g++),m=d.getAttribLocation(this.program,k.name),void 0===c.attributes[k.name]&&console.error('Vertex shader attribute "'+k.name+'" is not mapped to a semantic in shader definition.'),k=new pc.ShaderInput(a,c.attributes[k.name],f[k.type],m),this.attributes.push(k);g=0;for(h=d.getProgramParameter(this.program,d.ACTIVE_UNIFORMS);g<h;)k=d.getActiveUniform(this.program,g++),m=d.getUniformLocation(this.program,k.name),k.type===d.SAMPLER_2D||k.type===d.SAMPLER_CUBE?this.samplers.push(new pc.ShaderInput(a,
k.name,f[k.type],m)):this.uniforms.push(new pc.ShaderInput(a,k.name,f[k.type],m))};a.prototype={destroy:function(){this.device.gl.deleteProgram(this.program)}};return{Shader:a}}());pc.extend(pc,function(){var e=function(a){this._device=a;this._cache={};this._generators={}};e.prototype.register=function(a,b){this.isRegistered(a)||(this._generators[a]=b)};e.prototype.unregister=function(a){this.isRegistered(a)&&delete this._generators[a]};e.prototype.isRegistered=function(a){return void 0!==this._generators[a]};e.prototype.getProgram=function(a,b){var c=this._generators[a];if(void 0===c)return logERROR("No program library functions registered for: "+a),null;var d=c.generateKey(g,
b),g=this._cache[d];if(!g)var g=this._device,c=c.createShaderDefinition(g,b),g=this._cache[d]=new pc.Shader(g,c);return g};return{ProgramLibrary:e}}());pc.extend(pc,function(){function e(a){this.name="UnsupportedBrowserError";this.message=a||""}function a(a){this.name="ContextCreationError";this.message=a||""}e.prototype=Error.prototype;a.prototype=Error.prototype;var b=function(){logWARNING("Context lost.")},c=function(){logINFO("Context restored.")},d=function(a,b){var c=a.width,d=a.height;if(c>b||d>b){var g=b/Math.max(c,d),e=Math.floor(c*g),g=Math.floor(d*g);console.warn("Image dimensions larger than max supported texture size of "+b+". Resizing from "+
c+", "+d+" to "+e+", "+g+".");var r=document.createElement("canvas");r.width=e;r.height=g;r.getContext("2d").drawImage(a,0,0,c,d,0,0,e,g);return r}return a},g=function(a){this.gl=void 0;this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision="highp";this.attributesInvalidated=!0;this.boundBuffer=null;this.enabledAttributes={};this.textureUnits=[];this.commitFunction={};if(!window.WebGLRenderingContext)throw new pc.UnsupportedBrowserError;for(var d=["webgl","experimental-webgl"],
g=null,e=0;e<d.length;e++){try{g=a.getContext(d[e],void 0)}catch(n){}if(g)break}var l=this.gl=g;if(!this.gl)throw new pc.ContextCreationError;a.addEventListener("webglcontextlost",b,!1);a.addEventListener("webglcontextrestored",c,!1);this.canvas=a;this.indexBuffer=this.shader=null;this.vertexBuffers=[];this.precision="highp";this.maxTextureSize=l.getParameter(l.MAX_TEXTURE_SIZE);this.maxCubeMapSize=l.getParameter(l.MAX_CUBE_MAP_TEXTURE_SIZE);a=l.getShaderPrecisionFormat(l.VERTEX_SHADER,l.HIGH_FLOAT);
g=l.getShaderPrecisionFormat(l.VERTEX_SHADER,l.MEDIUM_FLOAT);l.getShaderPrecisionFormat(l.VERTEX_SHADER,l.LOW_FLOAT);d=l.getShaderPrecisionFormat(l.FRAGMENT_SHADER,l.HIGH_FLOAT);e=l.getShaderPrecisionFormat(l.FRAGMENT_SHADER,l.MEDIUM_FLOAT);l.getShaderPrecisionFormat(l.FRAGMENT_SHADER,l.LOW_FLOAT);l.getShaderPrecisionFormat(l.VERTEX_SHADER,l.HIGH_INT);l.getShaderPrecisionFormat(l.VERTEX_SHADER,l.MEDIUM_INT);l.getShaderPrecisionFormat(l.VERTEX_SHADER,l.LOW_INT);l.getShaderPrecisionFormat(l.FRAGMENT_SHADER,
l.HIGH_INT);l.getShaderPrecisionFormat(l.FRAGMENT_SHADER,l.MEDIUM_INT);l.getShaderPrecisionFormat(l.FRAGMENT_SHADER,l.LOW_INT);g=0<g.precision&&0<e.precision;0<a.precision&&0<d.precision||(g?(this.precision="mediump",console.warn("WARNING: highp not supported, using mediump")):(this.precision="lowp",console.warn("WARNING: highp and mediump not supported, using lowp")));this.defaultClearOptions={color:[0,0,0,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.glAddress=[l.REPEAT,l.CLAMP_TO_EDGE,
l.MIRRORED_REPEAT];this.glBlendEquation=[l.FUNC_ADD,l.FUNC_SUBTRACT,l.FUNC_REVERSE_SUBTRACT];this.glBlendFunction=[l.ZERO,l.ONE,l.SRC_COLOR,l.ONE_MINUS_SRC_COLOR,l.DST_COLOR,l.ONE_MINUS_DST_COLOR,l.SRC_ALPHA,l.SRC_ALPHA_SATURATE,l.ONE_MINUS_SRC_ALPHA,l.DST_ALPHA,l.ONE_MINUS_DST_ALPHA];this.glClearFlag=[0,l.COLOR_BUFFER_BIT,l.DEPTH_BUFFER_BIT,l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT,l.STENCIL_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.COLOR_BUFFER_BIT,l.STENCIL_BUFFER_BIT|l.DEPTH_BUFFER_BIT,l.STENCIL_BUFFER_BIT|
l.COLOR_BUFFER_BIT|l.DEPTH_BUFFER_BIT];this.glFilter=[l.NEAREST,l.LINEAR,l.NEAREST_MIPMAP_NEAREST,l.NEAREST_MIPMAP_LINEAR,l.LINEAR_MIPMAP_NEAREST,l.LINEAR_MIPMAP_LINEAR];this.glPrimitive=[l.POINTS,l.LINES,l.LINE_LOOP,l.LINE_STRIP,l.TRIANGLES,l.TRIANGLE_STRIP,l.TRIANGLE_FAN];this.glType=[l.BYTE,l.UNSIGNED_BYTE,l.SHORT,l.UNSIGNED_SHORT,l.INT,l.UNSIGNED_INT,l.FLOAT];this.extTextureFloat=l.getExtension("OES_texture_float");this.extTextureFloatLinear=l.getExtension("OES_texture_float_linear");this.extTextureHalfFloat=
l.getExtension("OES_texture_half_float");this.maxVertexTextures=l.getParameter(l.MAX_VERTEX_TEXTURE_IMAGE_UNITS);this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures;this.extTextureFloatRenderable=!!this.extTextureFloat;this.extTextureFloat&&(a=l.createTexture(),l.bindTexture(l.TEXTURE_2D,a),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MIN_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_MAG_FILTER,l.NEAREST),l.texParameteri(l.TEXTURE_2D,l.TEXTURE_WRAP_S,l.CLAMP_TO_EDGE),l.texParameteri(l.TEXTURE_2D,
l.TEXTURE_WRAP_T,l.CLAMP_TO_EDGE),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,2,2,0,l.RGBA,l.FLOAT,null),d=l.createFramebuffer(),l.bindFramebuffer(l.FRAMEBUFFER,d),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,a,0),l.bindTexture(l.TEXTURE_2D,null),l.checkFramebufferStatus(l.FRAMEBUFFER)!=l.FRAMEBUFFER_COMPLETE&&(this.extTextureFloatRenderable=!1));this.extTextureLod=l.getExtension("EXT_shader_texture_lod");this.fragmentUniformsCount=l.getParameter(l.MAX_FRAGMENT_UNIFORM_VECTORS);this.samplerCount=
l.getParameter(l.MAX_TEXTURE_IMAGE_UNITS);this.extDepthTexture=null;(this.extStandardDerivatives=l.getExtension("OES_standard_derivatives"))&&l.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,l.NICEST);this.extTextureFilterAnisotropic=l.getExtension("EXT_texture_filter_anisotropic");this.extTextureFilterAnisotropic||(this.extTextureFilterAnisotropic=l.getExtension("WEBKIT_EXT_texture_filter_anisotropic"));this.extCompressedTextureS3TC=l.getExtension("WEBGL_compressed_texture_s3tc");
this.extCompressedTextureS3TC||(this.extCompressedTextureS3TC=l.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"));if(a=this.extCompressedTextureS3TC)a=window.navigator.userAgent.indexOf("MSIE "),d=navigator.userAgent.match(/Trident.*rv\:11\./),a=0<a||!!d;a&&(this.extCompressedTextureS3TC=!1);if(this.extCompressedTextureS3TC){a=l.getParameter(l.COMPRESSED_TEXTURE_FORMATS);for(d=0;d<a.length;d++);}this.maxDrawBuffers=(this.extDrawBuffers=l.getExtension("EXT_draw_buffers"))?l.getParameter(this.extDrawBuffers.MAX_DRAW_BUFFERS_EXT):
1;this.maxColorAttachments=this.extDrawBuffers?l.getParameter(this.extDrawBuffers.MAX_COLOR_ATTACHMENTS_EXT):1;this.renderTarget=null;this.scope=new pc.ScopeSpace("Device");this.commitFunction={};this.commitFunction[pc.UNIFORMTYPE_BOOL]=function(a,b){l.uniform1i(a,b)};this.commitFunction[pc.UNIFORMTYPE_INT]=function(a,b){l.uniform1i(a,b)};this.commitFunction[pc.UNIFORMTYPE_FLOAT]=function(a,b){"number"==typeof b?l.uniform1f(a,b):l.uniform1fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC2]=function(a,
b){l.uniform2fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC3]=function(a,b){l.uniform3fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_VEC4]=function(a,b){l.uniform4fv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC2]=function(a,b){l.uniform2iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC2]=function(a,b){l.uniform2iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC3]=function(a,b){l.uniform3iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC3]=function(a,b){l.uniform3iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_IVEC4]=
function(a,b){l.uniform4iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_BVEC4]=function(a,b){l.uniform4iv(a,b)};this.commitFunction[pc.UNIFORMTYPE_MAT2]=function(a,b){l.uniformMatrix2fv(a,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT3]=function(a,b){l.uniformMatrix3fv(a,!1,b)};this.commitFunction[pc.UNIFORMTYPE_MAT4]=function(a,b){l.uniformMatrix4fv(a,!1,b)};this.setBlending(!1);this.setBlendFunction(pc.BLENDMODE_ONE,pc.BLENDMODE_ZERO);this.setBlendEquation(pc.BLENDEQUATION_ADD);this.setColorWrite(!0,
!0,!0,!0);this.setCullMode(pc.CULLFACE_BACK);this.setDepthTest(!0);this.setDepthWrite(!0);this.setClearDepth(1);this.setClearColor(0,0,0,0);l.enable(l.SCISSOR_TEST);this.programLib=new pc.ProgramLibrary(this);for(var r in pc.programlib)this.programLib.register(r,pc.programlib[r]);r=l.getParameter(l.MAX_VERTEX_UNIFORM_VECTORS);r=r-16-8;r-=1;r-=16;this.boneLimit=Math.floor(r/4);110<this.boneLimit&&(this.boneLimit=110);pc.events.attach(this);this.boundBuffer=null;this.textureUnits=[];this.attributesInvalidated=
!0;this.enabledAttributes={};r=l.createBuffer();a=new ArrayBuffer(16);l.bindBuffer(l.ARRAY_BUFFER,r);l.bufferData(l.ARRAY_BUFFER,a,l.STATIC_DRAW);l.getError();l.vertexAttribPointer(0,4,l.UNSIGNED_BYTE,!1,4,0);this.supportsUnsignedByte=0===l.getError();l.deleteBuffer(r)};g.prototype={setViewport:function(a,b,c,d){this.gl.viewport(a,b,c,d)},setScissor:function(a,b,c,d){this.gl.scissor(a,b,c,d)},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(a){this.programLib=a},updateBegin:function(){var a=
this.gl;this.indexBuffer=this.boundBuffer=null;var b=this.renderTarget;if(b)if(b._glFrameBuffer)a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer);else switch(b._glFrameBuffer=a.createFramebuffer(),a.bindFramebuffer(a.FRAMEBUFFER,b._glFrameBuffer),b._colorBuffer._glTextureId||this.setTexture(b._colorBuffer,0),a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,b._colorBuffer._cubemap?a.TEXTURE_CUBE_MAP_POSITIVE_X+b._face:a.TEXTURE_2D,b._colorBuffer._glTextureId,0),b._depth&&(b._glDepthBuffer||
(b._glDepthBuffer=a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,b._glDepthBuffer),a.renderbufferStorage(a.RENDERBUFFER,a.DEPTH_COMPONENT16,b.width,b.height),a.bindRenderbuffer(a.RENDERBUFFER,null),a.framebufferRenderbuffer(a.FRAMEBUFFER,a.DEPTH_ATTACHMENT,a.RENDERBUFFER,b._glDepthBuffer)),a.checkFramebufferStatus(a.FRAMEBUFFER)){case a.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case a.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");
break;case a.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case a.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}else a.bindFramebuffer(a.FRAMEBUFFER,null);for(a=0;16>a;a++)this.textureUnits[a]=null},updateEnd:function(){var a=this.gl;this.renderTarget&&a.bindFramebuffer(a.FRAMEBUFFER,null)},initializeTexture:function(a){var b=this.gl;a._glTextureId=b.createTexture();a._glTarget=a._cubemap?b.TEXTURE_CUBE_MAP:b.TEXTURE_2D;
switch(a._format){case pc.PIXELFORMAT_A8:a._glFormat=b.ALPHA;a._glInternalFormat=b.ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8:a._glFormat=b.LUMINANCE;a._glInternalFormat=b.LUMINANCE;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_L8_A8:a._glFormat=b.LUMINANCE_ALPHA;a._glInternalFormat=b.LUMINANCE_ALPHA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R5_G6_B5:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_SHORT_5_6_5;break;case pc.PIXELFORMAT_R5_G5_B5_A1:a._glFormat=
b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_5_5_5_1;break;case pc.PIXELFORMAT_R4_G4_B4_A4:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_SHORT_4_4_4_4;break;case pc.PIXELFORMAT_R8_G8_B8:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_R8_G8_B8_A8:a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=b.UNSIGNED_BYTE;break;case pc.PIXELFORMAT_DXT1:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGB;
a._glInternalFormat=ext.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case pc.PIXELFORMAT_DXT3:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case pc.PIXELFORMAT_DXT5:ext=this.extCompressedTextureS3TC;a._glFormat=b.RGBA;a._glInternalFormat=ext.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case pc.PIXELFORMAT_RGB16F:ext=this.extTextureHalfFloat;a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=ext.HALF_FLOAT_OES;break;case pc.PIXELFORMAT_RGBA16F:ext=
this.extTextureHalfFloat;a._glFormat=b.RGBA;a._glInternalFormat=b.RGBA;a._glPixelType=ext.HALF_FLOAT_OES;break;case pc.PIXELFORMAT_RGB32F:a._glFormat=b.RGB;a._glInternalFormat=b.RGB;a._glPixelType=b.FLOAT;break;case pc.PIXELFORMAT_RGBA32F:a._glFormat=b.RGBA,a._glInternalFormat=b.RGBA,a._glPixelType=b.FLOAT}},uploadTexture:function(a){for(var b=this.gl,c=0,g;a._levels[c]||0==c;){g=a._levels[c];1==c&&!a._compressed&&b.generateMipmap(a._glTarget);if(a._cubemap){var e;b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,
!1);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1);if(g[0]instanceof HTMLCanvasElement||g[0]instanceof HTMLImageElement||g[0]instanceof HTMLVideoElement)for(e=0;6>e;e++){var l=g[e];if(l instanceof HTMLImageElement&&(l.width>this.maxCubeMapSize||l.height>this.maxCubeMapSize))l=d(l,this.maxCubeMapSize);b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+e,c,a._glInternalFormat,a._glFormat,a._glPixelType,l)}else{l=1/Math.pow(2,c);for(e=0;6>e;e++)a._compressed?this.extCompressedTextureS3TC&&b.compressedTexImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+
e,c,a._glInternalFormat,Math.max(a._width*l,1),Math.max(a._height*l,1),0,g[e]):b.texImage2D(b.TEXTURE_CUBE_MAP_POSITIVE_X+e,c,a._glInternalFormat,Math.max(a._width*l,1),Math.max(a._height*l,1),0,a._glFormat,a._glPixelType,g[e])}}else if(g instanceof HTMLCanvasElement||g instanceof HTMLImageElement||g instanceof HTMLVideoElement){if(g instanceof HTMLImageElement&&(g.width>this.maxTextureSize||g.height>this.maxTextureSize))g=d(g,this.maxTextureSize);b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!0);b.pixelStorei(b.UNPACK_PREMULTIPLY_ALPHA_WEBGL,
!1);b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,a._glFormat,a._glPixelType,g)}else b.pixelStorei(b.UNPACK_FLIP_Y_WEBGL,!1),l=1/Math.pow(2,c),a._compressed?this.extCompressedTextureS3TC&&b.compressedTexImage2D(b.TEXTURE_2D,c,a._glInternalFormat,Math.max(a._width*l,1),Math.max(a._height*l,1),0,g):b.texImage2D(b.TEXTURE_2D,c,a._glInternalFormat,Math.max(a._width*l,1),Math.max(a._height*l,1),0,a._glFormat,a._glPixelType,g);c++}a.autoMipmap&&(pc.math.powerOfTwo(a._width)&&pc.math.powerOfTwo(a._height)&&
1===a._levels.length&&!a._compressed)&&b.generateMipmap(a._glTarget)},setTexture:function(a,b){var c=this.gl;a._glTextureId||this.initializeTexture(a);c.activeTexture(c.TEXTURE0+b);this.textureUnits[b]!==a&&(c.bindTexture(a._glTarget,a._glTextureId),this.textureUnits[b]=a);c.texParameteri(a._glTarget,c.TEXTURE_MIN_FILTER,this.glFilter[a._minFilter]);c.texParameteri(a._glTarget,c.TEXTURE_MAG_FILTER,this.glFilter[a._magFilter]);c.texParameteri(a._glTarget,c.TEXTURE_WRAP_S,this.glAddress[a._addressU]);
c.texParameteri(a._glTarget,c.TEXTURE_WRAP_T,this.glAddress[a._addressV]);var d=this.extTextureFilterAnisotropic;if(d){var g=a.anisotropy,g=Math.min(g,this.maxAnisotropy);c.texParameterf(a._glTarget,d.TEXTURE_MAX_ANISOTROPY_EXT,g)}a._needsUpload&&(this.uploadTexture(a),a._needsUpload=!1)},draw:function(a){var b=this.gl,c,d,g,e,r,v,u;c=this.shader;u=c.samplers;var C=c.uniforms;if(this.attributesInvalidated){v=c.attributes;c=0;for(g=v.length;c<g;c++)d=v[c],e=d.scopeId.value,null!==e&&(r=this.vertexBuffers[e.stream],
this.boundBuffer!==r.bufferId&&(b.bindBuffer(b.ARRAY_BUFFER,r.bufferId),this.boundBuffer=r.bufferId),this.enabledAttributes[d.locationId]||(b.enableVertexAttribArray(d.locationId),this.enabledAttributes[d.locationId]=!0),b.vertexAttribPointer(d.locationId,e.numComponents,this.glType[e.dataType],e.normalize,e.stride,e.offset));this.attributesInvalidated=!1}c=textureUnit=0;for(g=u.length;c<g;c++)if(e=u[c],r=e.scopeId.value,r instanceof pc.Texture)v=r,this.setTexture(v,textureUnit),e.slot!==textureUnit&&
(b.uniform1i(e.locationId,textureUnit),e.slot=textureUnit),textureUnit++;else{e.array.length=0;numTexures=r.length;for(d=0;d<numTexures;d++)v=r[d],this.setTexture(v,textureUnit),e.array[d]=textureUnit,textureUnit++;b.uniform1iv(e.locationId,e.array)}c=0;for(g=C.length;c<g;c++)if(u=C[c],d=u.scopeId,e=u.version,r=d.versionObject.version,e.globalId!==r.globalId||e.revision!==r.revision)if(e.globalId=r.globalId,e.revision=r.revision,null!==d.value)this.commitFunction[u.dataType](u.locationId,d.value);
a.indexed?b.drawElements(this.glPrimitive[a.type],a.count,this.indexBuffer.glFormat,2*a.base):b.drawArrays(this.glPrimitive[a.type],a.base,a.count)},clear:function(a){var b=this.defaultClearOptions,a=a||b,c=void 0===a.flags?b.flags:a.flags;if(0!==c){var d=this.gl;if(c&pc.CLEARFLAG_COLOR){var g=void 0===a.color?b.color:a.color;this.setClearColor(g[0],g[1],g[2],g[3])}c&pc.CLEARFLAG_DEPTH&&(this.setClearDepth(void 0===a.depth?b.depth:a.depth),this.depthWrite||d.depthMask(!0));d.clear(this.glClearFlag[c]);
c&pc.CLEARFLAG_DEPTH&&(this.depthWrite||d.depthMask(!1))}},readPixels:function(a,b,c,d,g){var e=this.gl;e.readPixels(a,b,c,d,e.RGBA,e.UNSIGNED_BYTE,g)},setClearDepth:function(a){a!==this.clearDepth&&(this.gl.clearDepth(a),this.clearDepth=a)},setClearColor:function(a,b,c,d){if(a!==this.clearRed||b!==this.clearGreen||c!==this.clearBlue||d!==this.clearAlpha)this.gl.clearColor(a,b,c,d),this.clearRed=a,this.clearGreen=b,this.clearBlue=c,this.clearAlpha=d},setRenderTarget:function(a){this.renderTarget=
a},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(a){if(this.depthTest!==a){var b=this.gl;a?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST);this.depthTest=a}},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(a){this.depthWrite!==a&&(this.gl.depthMask(a),this.depthWrite=a)},setColorWrite:function(a,b,c,d){if(this.writeRed!==a||this.writeGreen!==b||this.writeBlue!==c||this.writeAlpha!==d)this.gl.colorMask(a,
b,c,d),this.writeRed=a,this.writeGreen=b,this.writeBlue=c,this.writeAlpha=d},getBlending:function(){return this.blending},setBlending:function(a){if(this.blending!==a){var b=this.gl;a?b.enable(b.BLEND):b.disable(b.BLEND);this.blending=a}},setBlendFunction:function(a,b){if(this.blendSrc!==a||this.blendDst!==b)this.gl.blendFunc(this.glBlendFunction[a],this.glBlendFunction[b]),this.blendSrc=a,this.blendDst=b},setBlendEquation:function(a){this.blendEquation!==a&&(this.gl.blendEquation(this.glBlendEquation[a]),
this.blendEquation=a)},setCullMode:function(a){if(this.cullMode!==a){var b=this.gl;switch(a){case pc.CULLFACE_NONE:b.disable(b.CULL_FACE);break;case pc.CULLFACE_FRONT:b.enable(b.CULL_FACE);b.cullFace(b.FRONT);break;case pc.CULLFACE_BACK:b.enable(b.CULL_FACE);b.cullFace(b.BACK);break;case pc.CULLFACE_FRONTANDBACK:b.enable(b.CULL_FACE),b.cullFace(b.FRONT_AND_BACK)}this.cullMode=a}},setIndexBuffer:function(a){if(this.indexBuffer!==a){this.indexBuffer=a;var b=this.gl;b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,
a?a.bufferId:null)}},setVertexBuffer:function(a,b){if(this.vertexBuffers[b]!==a){this.vertexBuffers[b]=a;for(var c=0,d=a.getFormat().elements,g=d.length;c<g;){var e=d[c++];e.stream=b;e.scopeId.setValue(e)}this.attributesInvalidated=!0}},setShader:function(a){a!==this.shader&&(this.shader=a,this.gl.useProgram(a.program),this.attributesInvalidated=!0)},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(a){this.boneLimit=a},enableValidation:function(){console.warn("enableValidation: This function is deprecated and will be removed shortly.")},
validate:function(){console.warn("validate: This function is deprecated and will be removed shortly.")},resizeCanvas:function(a,b){this.canvas.width=a;this.canvas.height=b;this.fire("resizecanvas",a,b)}};Object.defineProperty(g.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}});Object.defineProperty(g.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}});Object.defineProperty(g.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},
set:function(a){a?this.gl.canvas.requestFullscreen():document.exitFullscreen()}});Object.defineProperty(g.prototype,"maxAnisotropy",{get:function(){var a;return function(){if(void 0===a){a=1;var b=this.gl,c=this.extTextureFilterAnisotropic;c&&(a=b.getParameter(c.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}return a}}()});return{UnsupportedBrowserError:e,ContextCreationError:a,GraphicsDevice:g,precalculatedTangents:!0}}());pc.extend(pc,function(){var e={},a={};e.collectAttribs=function(a){for(var c={},d=0,g=a.indexOf("attribute");0<=g;){var e=a.indexOf(";",g),k=a.lastIndexOf(" ",e),e=a.substr(k+1,e-(k+1));"aPosition"==e?c.aPosition=pc.SEMANTIC_POSITION:(c[e]="ATTR"+d,d++);g=a.indexOf("attribute",g+1)}return c};e.createShader=function(a,c,d){c=e[c];d=pc.programlib.getSnippet(a,"fs_precision")+"\n"+e[d];attribs=this.collectAttribs(c);return new pc.Shader(a,{attributes:attribs,vshader:c,fshader:d})};e.createShaderFromCode=
function(b,c,d,g){var e=a[g];if(void 0!=e)return e;d=pc.programlib.getSnippet(b,"fs_precision")+"\n"+d;attribs=this.collectAttribs(c);a[g]=new pc.Shader(b,{attributes:attribs,vshader:c,fshader:d});return a[g]};return{shaderChunks:e}}());pc.extend(pc,function(){var e=null;return{drawQuadWithShader:function(a,b,c){if(null==e){var d=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.ELEMENTTYPE_FLOAT32}]);e=new pc.VertexBuffer(a,d,4);d=new pc.VertexIterator(e);d.element[pc.SEMANTIC_POSITION].set(-1,-1);d.next();d.element[pc.SEMANTIC_POSITION].set(1,-1);d.next();d.element[pc.SEMANTIC_POSITION].set(-1,1);d.next();d.element[pc.SEMANTIC_POSITION].set(1,1);d.end()}a.setRenderTarget(b);a.updateBegin();d=null!==b?b.width:
a.width;b=null!==b?b.height:a.height;a.setViewport(0,0,d,b);a.setScissor(0,0,d,b);b=a.getDepthTest();d=a.getDepthWrite();a.setDepthTest(!1);a.setDepthWrite(!1);a.setVertexBuffer(e,0);a.setShader(c);a.draw({type:pc.PRIMITIVE_TRISTRIP,base:0,count:4,indexed:!1});a.setDepthTest(b);a.setDepthWrite(d);a.updateEnd()}}}());pc.extend(pc,function(){function e(){for(var a=Date.now()+10;Date.now()<a;);}function a(a,c,d){var g=c._colorBuffer;if(g.format==pc.PIXELFORMAT_R8_G8_B8_A8){var e=new Uint8Array(4*g.width*g.height),a=a.gl;a.bindFramebuffer(a.FRAMEBUFFER,c._glFrameBuffer);a.readPixels(0,0,g.width,g.height,a.RGBA,a.UNSIGNED_BYTE,e);g._levels||(g._levels=[]);g._levels[0]||(g._levels[0]=[]);g._levels[0][d]=e}}return{prefilterCubemap:function(b){var c=b.device,d=b.sourceCubemap,g=b.method,f=b.samples,k=b.cpuSync,m=b.chromeFix,
h=pc.shaderChunks,f=h.createShaderFromCode(c,h.fullscreenQuadVS,h.rgbmPS+h.prefilterCubemapPS.replace(/\$METHOD/g,0===g?"cos":"phong").replace(/\$NUMSAMPLES/g,f),"prefilter"+g+""+f),n=h.createShaderFromCode(c,h.fullscreenQuadVS,h.outputCubemapPS),l=c.scope.resolve("source"),r=c.scope.resolve("params"),v=new pc.Vec4,u=d.width,C=d.rgbm,y=d.format,s=[[],b.filteredFixed,b.filteredRGBM,b.filteredFixedRGBM],w=0===g?[0.9,0.85,0.7,0.4,0.25]:[512,128,32,8,2],A=[64,32,16,8,4],h=5,x,z,H;if(y===pc.PIXELFORMAT_R8_G8_B8&&
k){var y=pc.PIXELFORMAT_R8_G8_B8_A8,G=new pc.gfx.Texture(c,{cubemap:!0,rgbm:C,format:y,width:u,height:u,autoMipmap:!1});G.minFilter=pc.FILTER_LINEAR;G.magFilter=pc.FILTER_LINEAR;G.addressU=pc.ADDRESS_CLAMP_TO_EDGE;G.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(H=0;6>H;H++)x=new pc.RenderTarget(c,G,{face:H,depth:!1}),v.x=H,l.setValue(d),r.setValue(v.data),m&&e(),pc.drawQuadWithShader(c,x,n),a(c,x,H);d=G}if(128<u){z=Math.round(Math.log2(128));var K=Math.round(Math.log2(u))-z;for(z=0;z<K;z++){var u=0.5*d.width,
I=0===g?1:Math.pow(2,Math.round(Math.log2(w[0])+2*(K-z))),G=new pc.gfx.Texture(c,{cubemap:!0,rgbm:C,format:y,width:u,height:u,autoMipmap:!1});G.minFilter=pc.FILTER_LINEAR;G.magFilter=pc.FILTER_LINEAR;G.addressU=pc.ADDRESS_CLAMP_TO_EDGE;G.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(H=0;6>H;H++)x=new pc.RenderTarget(c,G,{face:H,depth:!1}),v.x=H,v.y=I,v.z=u,v.w=0,l.setValue(d),r.setValue(v.data),m&&e(),pc.drawQuadWithShader(c,x,n),z===K-1&&k&&a(c,x,H);d=G}}b.sourceCubemap=d;u=0===g?1:2048;x=0===g?0:-1;s[x]=
[];for(z=0;z<h;z++)for(n=x;n<s.length;n++)null!=s[n]&&(s[n][z]=new pc.gfx.Texture(c,{cubemap:!0,rgbm:2>n?C:!0,format:2>n?y:pc.PIXELFORMAT_R8_G8_B8_A8,fixCubemapSeams:1===n||3===n,width:A[z],height:A[z],autoMipmap:!1}),s[n][z].minFilter=pc.FILTER_LINEAR,s[n][z].magFilter=pc.FILTER_LINEAR,s[n][z].addressU=pc.ADDRESS_CLAMP_TO_EDGE,s[n][z].addressV=pc.ADDRESS_CLAMP_TO_EDGE);for(n=x;n<s.length;n++)if(null!=s[n])if(1<n&&C)s[n]=s[n-2];else for(z=0;z<h;z++)for(H=0;6>H;H++)x=new pc.RenderTarget(c,s[n][z],
{face:H,depth:!1}),v.x=H,v.y=0>n?u:w[z],v.z=A[z],v.w=n,l.setValue(0===z?d:0===g?s[0][z-1]:s[-1][z-1]),r.setValue(v.data),m&&e(),pc.drawQuadWithShader(c,x,f),k&&a(c,x,H);b.filtered=s[0];if(k&&b.singleFilteredFixed){h=[d,b.filteredFixed[0],b.filteredFixed[1],b.filteredFixed[2],b.filteredFixed[3],b.filteredFixed[4]];c=new pc.gfx.Texture(c,{cubemap:!0,rgbm:C,fixCubemapSeams:!0,format:y,width:128,height:128,autoMipmap:!1});for(z=0;6>z;z++)c._levels[z]=h[z]._levels[0];c.upload();c.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;
c.magFilter=pc.FILTER_LINEAR;c._prefilteredMips=!0;b.singleFilteredFixed=c}}}}());pc.shaderChunks.particle_halflambertPS="\n    vec3 negNormal = normal*0.5+0.5;\n    vec3 posNormal = -normal*0.5+0.5;\n    negNormal *= negNormal;\n    posNormal *= posNormal;\n\n\n";pc.shaderChunks.normalVS="vec3 getNormal(inout vsInternalData data) {\n    data.normalMatrix = matrix_normal;\n    return normalize(data.normalMatrix * vertex_normal);\n}\n\n";pc.shaderChunks.particle_blendNormalPS="\n    if (a < 0.01) discard;\n";pc.shaderChunks.normalMapPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpMapFactor;\nvoid getNormal(inout psInternalData data) {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    data.normalMap = normalMap;\n    data.normalW = data.TBN * normalMap;\n}\n\n";
pc.shaderChunks.reflectionPrefilteredCubeLodPS="#extension GL_EXT_shader_texture_lod : enable\n\nuniform samplerCube texture_prefilteredCubeMap128;\nuniform float material_reflectionFactor;\n\nvoid addCubemapReflection(inout psInternalData data) {\n\n    float bias = saturate(1.0 - data.glossiness) * 5.0; // multiply by max mip level\n    vec3 fixedReflDir = fixSeams(data.reflDirW, bias);\n\n    vec3 refl = $DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb;\n\n    data.reflection += vec4(refl, material_reflectionFactor);\n}\n\n";
pc.shaderChunks.particle_blendMultiplyPS="\n    rgb = mix(vec3(1.0), rgb, vec3(a));\n    if (rgb.r + rgb.g + rgb.b > 2.99) discard;\n\n";pc.shaderChunks.particle_meshVS="\n    vec3 localPos = meshLocalPos;\n    localPos.xy = rotate(localPos.xy, angle, rotMatrix);\n    localPos.yz = rotate(localPos.yz, angle, rotMatrix);\n\n    billboard(particlePos, quadXY, localMat);\n\n\n";pc.shaderChunks.opacityConstPS="uniform float material_opacity;\nvoid getOpacity(inout psInternalData data) {\n    data.alpha = material_opacity;\n}\n\n";
pc.shaderChunks.combineDiffuseSpecularNoReflPS="vec3 combineColor(inout psInternalData data) {\n    return data.albedo * data.diffuseLight + data.specularLight * data.specularity;\n}\n\n";pc.shaderChunks.glossConstPS="uniform float material_shininess;\nvoid getGlossiness(inout psInternalData data) {\n    data.glossiness = material_shininess;\n}\n\n";pc.shaderChunks.gamma1_0PS="vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    return texture2D(tex, uv);\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    return textureCube(tex, uvw);\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return color;\n}\n\nvec3 gammaCorrectInput(vec3 color) {\n    return color;\n}\n\nfloat gammaCorrectInput(float color) {\n    return color;\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return color;\n}\n\n";
pc.shaderChunks.emissiveTexPS="uniform sampler2D texture_emissiveMap;\nvec3 getEmission(inout psInternalData data) {\n    return texture2D(texture_emissiveMap, $UV).$CH;\n}\n\n";pc.shaderChunks.combineDiffuseSpecularNoReflSeparateAmbientPS="uniform vec3 material_ambient;\nvec3 combineColor(inout psInternalData data) {\n    return (data.diffuseLight - light_globalAmbient) * data.albedo + data.specularLight * data.specularity + material_ambient * light_globalAmbient;\n}\n\n";
pc.shaderChunks.reflectionSpherePS="uniform mat4 matrix_view;\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectionFactor;\nvoid addSpheremapReflection(inout psInternalData data) {\n\n    vec3 reflDirV = (mat3(matrix_view) * data.reflDirW).xyz;\n\n    float m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n    vec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\n    data.reflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectionFactor);\n}\n\n\n";
pc.shaderChunks.specularAaToksvigPS="float antiAliasGlossiness(inout psInternalData data, float power) {\n    float rlen = 1.0 / saturate(length(data.normalMap));\n    float toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n    return power * toksvig;\n}\n\n";pc.shaderChunks.fixCubemapSeamsStretchPS="uniform float material_cubemapSize;\nvec3 fixSeams(vec3 vec, float mipmapIndex) {\n    float scale = 1.0 - exp2(mipmapIndex) / material_cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    float scale = 1.0 - 1.0 / material_cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    float scale = invRecMipSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\n";
pc.shaderChunks.fresnelComplexPS="// More physically-based Fresnel\nuniform float material_fresnelFactor; // should be IOR\nvoid getFresnel(inout psInternalData data) {\n    float cosThetaI = max(dot(data.normalW, data.viewDirW), 0.0);\n    float n = material_fresnelFactor;\n\n    float cosThetaT = sqrt(max(0.0, 1.0 - (1.0 - cosThetaI * cosThetaI) / (n * n)));\n    float nCosThetaT = n * cosThetaT;\n    float nCosThetaI = n * cosThetaI;\n\n    float rS = abs((cosThetaI - nCosThetaT) / (cosThetaI + nCosThetaT));\n    float rP = abs((cosThetaT - nCosThetaI) / (cosThetaT + nCosThetaI));\n    rS *= rS;\n    rP *= rP;\n\n    data.specularity *= (rS + rP) / 2.0;\n}\n\n";
pc.shaderChunks.ambientPrefilteredCubeLodPS="void addAmbient(inout psInternalData data) {\n    vec3 fixedReflDir = fixSeamsStatic(data.normalW, 1.0 - 1.0 / 4.0);\n    data.diffuseLight = $DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb;\n}\n\n";pc.shaderChunks.particle_endPS="    rgb = addFog(data, rgb);\n    rgb = toneMap(rgb);\n    rgb = gammaCorrectOutput(rgb);\n    gl_FragColor = vec4(rgb, a);\n}\n";pc.shaderChunks.particleUpdaterSpherePS="uniform float spawnBounds;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    float rnd4 = fract(rndFactor * 1000.0);\n    return emitterPos + normalize(inBounds.xyz - vec3(0.5)) * rnd4 * spawnBounds;\n}\n\nvoid addInitialVelocity(out vec3 localVelocity, vec3 inBounds) {\n    localVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n\n";
pc.shaderChunks.particleVS="attribute vec4 particle_vertexData; // XYZ = particle position, W = particle ID + random factor\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform mat4 matrix_view;\n\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nvarying vec4 texCoordsAlphaLife;\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc) {\n    return mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\n\nvec4 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex,tc);\n    vec4 b = texture2D(tex,tc + graphSampleSize);\n    float c = fract(tc.x*graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a, b, c);\n}\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY, out mat3 localMat) {\n    vec3 viewUp = matrix_viewInverse[1].xyz;\n    vec3 posCam = matrix_viewInverse[3].xyz;\n\n    mat3 billMat;\n    billMat[2] = normalize(InstanceCoords - posCam);\n    billMat[0] = normalize(cross(viewUp, billMat[2]));\n    billMat[1] = -viewUp;\n    vec3 pos = billMat * vec3(quadXY, 0);\n\n    localMat = billMat;\n\n    return pos;\n}\n\nvoid main(void) {\n    vec3 meshLocalPos = particle_vertexData.xyz;\n    float id = floor(particle_vertexData.w);\n\n    float rndFactor = fract(sin(id + 1.0 + seed));\n    vec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\n    vec4 particleTex = texture2D(particleTexOUT, vec2(id / numParticlesPot, 0.125));\n    vec3 pos = particleTex.xyz;\n    float angle = particleTex.w;\n\n    vec4 particleTex2 = texture2D(particleTexOUT, vec2(id / numParticlesPot, 0.375));\n    vec3 particleVelocity = particleTex2.xyz;\n    vec2 velocityV = normalize((mat3(matrix_view) * particleVelocity).xy); // should be removed by compiler if align/stretch is not used\n    float life = particleTex2.w;\n\n    float particleLifetime = lifetime;\n\n    if (life <= 0.0 || life > particleLifetime) meshLocalPos = vec3(0.0);\n    vec2 quadXY = meshLocalPos.xy;\n    float nlife = clamp(life / particleLifetime, 0.0, 1.0);\n\n    vec3 paramDiv;\n    vec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n    float scale = params.y;\n    float scaleDiv = paramDiv.x;\n    float alphaDiv = paramDiv.z;\n\n    scale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5,    (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0),    nlife);\n\n    vec3 particlePos = pos;\n    vec3 particlePosMoved = vec3(0.0);\n\n    mat2 rotMatrix;\n    mat3 localMat;\n\n\n";
pc.shaderChunks.lightSpecularPhongPS="float getLightSpecular(inout psInternalData data) {\n    float specPow = data.glossiness;\n\n    specPow = antiAliasGlossiness(data, specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    return pow(max(dot(data.reflDirW, -data.lightDirNormW), 0.0), specPow + 0.0001);\n}\n\n";pc.shaderChunks.particle_pointAlongVS="    angle = atan(velocityV.x, velocityV.y); // not the fastest way, but easier to plug in; TODO: create rot matrix right from vectors\n\n";
pc.shaderChunks.fogExpPS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(inout psInternalData data, vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.opacityTexPS="uniform sampler2D texture_opacityMap;\nvoid getOpacity(inout psInternalData data) {\n    data.alpha = texture2D(texture_opacityMap, $UV).$CH;\n}\n\n";
pc.shaderChunks.particle_wrapVS="\n    vec3 origParticlePos = particlePos;\n    particlePos -= matrix_model[3].xyz;\n    particlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n    particlePos += matrix_model[3].xyz;\n    particlePosMoved = particlePos - origParticlePos;\n\n\n";pc.shaderChunks.particle_TBNVS="\n    mat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0,        rotMatrix[1][0], rotMatrix[1][1], 0.0,        0.0, 0.0, 1.0);\n    localMat[2] *= -1.0;\n    ParticleMat = localMat * rot3;\n\n\n\n\n";
pc.shaderChunks.particle_lambertPS="\n    vec3 negNormal = max(normal, vec3(0.0));\n    vec3 posNormal = max(-normal, vec3(0.0));\n\n\n";pc.shaderChunks.normalVertexPS="void getNormal(inout psInternalData data) {\n    data.normalW = normalize(vNormalW);\n}\n\n";pc.shaderChunks.specularAaNonePS="float antiAliasGlossiness(inout psInternalData data, float power) {\n    return power;\n}\n\n";pc.shaderChunks.shadowPS="float unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    return dot(rgbaDepth, bitShift);\n}\n\nvoid _getShadowCoordOrtho(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.z += shadowParams.z;\n    data.shadowCoord = projPos.xyz;\n}\n\nvoid _getShadowCoordPersp(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n    vec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n    projPos.xyz /= projPos.w;\n    projPos.z += shadowParams.z;\n    data.shadowCoord = projPos.xyz;\n}\n\nvoid getShadowCoordOrtho(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordOrtho(data, shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPersp(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams) {\n    _getShadowCoordPersp(data, shadowMatrix, shadowParams, vPositionW);\n}\n\nvoid getShadowCoordPerspNormalOffset(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams) {\n    float distScale = abs(dot(vPositionW - data.lightPosW, data.lightDirNormW)); // fov?\n    vec3 wPos = vPositionW + vNormalW * shadowParams.y * clamp(1.0 - dot(vNormalW, -data.lightDirNormW), 0.0, 1.0) * distScale;\n\n    _getShadowCoordPersp(data, shadowMatrix, shadowParams, wPos);\n}\n\nvoid getShadowCoordOrthoNormalOffset(inout psInternalData data, mat4 shadowMatrix, vec3 shadowParams) {\n    vec3 wPos = vPositionW + vNormalW * shadowParams.y * clamp(1.0 - dot(vNormalW, -data.lightDirNormW), 0.0, 1.0); //0.08\n\n    _getShadowCoordOrtho(data, shadowMatrix, shadowParams, wPos);\n}\n\nbool shadowContained(psInternalData data) {\n    bvec4 containedVec = bvec4(data.shadowCoord.x >= 0.0, data.shadowCoord.x <= 1.0, data.shadowCoord.y >= 0.0, data.shadowCoord.y <= 1.0);\n    return all(bvec2(all(containedVec), data.shadowCoord.z <= 1.0));\n}\n\nfloat getShadow(inout psInternalData data, sampler2D shadowMap, vec3 shadowParams) {\n    if (shadowContained(data)) {\n        float depth = unpackFloat(texture2D(shadowMap, data.shadowCoord.xy));\n        return (depth < data.shadowCoord.z) ? 0.0 : 1.0;\n    }\n    return 1.0;\n}\n\nvec3 lessThan2(vec3 a, vec3 b) {\n    return clamp((b - a)*1000.0, 0.0, 1.0); // softer version\n}\n\nvec3 greaterThan2(vec3 a, vec3 b) {\n    return clamp((a - b)*1000.0, 0.0, 1.0); // softer version\n}\n\nfloat getShadowPCF3x3(inout psInternalData data, sampler2D shadowMap, vec3 shadowParams) {\n    if (shadowContained(data)) {\n        float shadowAccum = 0.0;\n        vec3 shadowCoord = data.shadowCoord;\n\n        float xoffset = 1.0 / shadowParams.x; // 1/shadow map width\n        float dx0 = -xoffset;\n        float dx1 = xoffset;\n\n        mat3 shadowKernel;\n        mat3 depthKernel;\n\n        depthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n        depthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n        depthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n        depthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n        depthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n        depthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n        depthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n        depthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n        depthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\n        vec3 shadowZ = vec3(shadowCoord.z);\n        shadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n        shadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n        shadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\n        vec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\n        shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n        shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n        vec4 shadowValues;\n        shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n        shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n        shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n        shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n        shadowAccum = dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n\n        return shadowAccum;\n    }\n    return 1.0;\n}\n\n/*float getShadowPoint(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams) {\n    return float(unpackFloat(textureCube(shadowMap, data.lightDirNormW)) > (length(data.lightDirW)/shadowParams.w + shadowParams.z));\n}*/\n\nfloat _getShadowPoint(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\n    vec3 tc = normalize(dir);\n    vec3 tcAbs = abs(tc);\n\n    vec4 dirX = vec4(1,0,0, tc.x);\n    vec4 dirY = vec4(0,1,0, tc.y);\n    float majorAxisLength = tc.z;\n    if ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n        dirX = vec4(0,0,1, tc.z);\n        dirY = vec4(0,1,0, tc.y);\n        majorAxisLength = tc.x;\n    } else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n        dirX = vec4(1,0,0, tc.x);\n        dirY = vec4(0,0,1, tc.z);\n        majorAxisLength = tc.y;\n    }\n\n    float shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\n    vec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n    vec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n    vec3 dx0 = -xoffset;\n    vec3 dy0 = -yoffset;\n    vec3 dx1 = xoffset;\n    vec3 dy1 = yoffset;\n\n    mat3 shadowKernel;\n    mat3 depthKernel;\n\n    depthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n    depthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n    depthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n    depthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n    depthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n    depthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n    depthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n    depthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n    depthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\n    vec3 shadowZ = vec3(length(dir) / shadowParams.w + shadowParams.z);\n\n    shadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n    shadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n    shadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\n    vec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\n    vec2 fractionalCoord = fract( uv * shadowParams.x );\n\n    shadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n    shadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\n    vec4 shadowValues;\n    shadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n    shadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n    shadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n    shadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\n    return 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\n\nfloat getShadowPoint(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams) {\n    return _getShadowPoint(data, shadowMap, shadowParams, data.lightDirW);\n}\n\nfloat getShadowPointNormalOffset(inout psInternalData data, samplerCube shadowMap, vec4 shadowParams) {\n    float distScale = length(data.lightDirW);\n    vec3 wPos = vPositionW + vNormalW * shadowParams.y * clamp(1.0 - dot(vNormalW, -data.lightDirNormW), 0.0, 1.0) * distScale; //0.02\n    vec3 dir = wPos - data.lightPosW;\n\n    return _getShadowPoint(data, shadowMap, shadowParams, dir);\n}\n\n";
pc.shaderChunks.particle_normalVS="\n    Normal = normalize(localPos - localMat[2]);\n\n\n";pc.shaderChunks.normalXYZPS="vec3 unpackNormal(vec4 nmap) {\n    return nmap.xyz * 2.0 - 1.0;\n}\n\n";pc.shaderChunks.diffuseConstPS="uniform vec3 material_diffuse;\nvoid getAlbedo(inout psInternalData data) {\n    data.albedo = material_diffuse.rgb;\n}\n\n";pc.shaderChunks.reflectionSphereLowPS="uniform sampler2D texture_sphereMap;\nuniform float material_reflectionFactor;\nvoid addSpheremapReflection(inout psInternalData data) {\n\n    vec3 reflDirV = vNormalV;\n\n    vec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n    data.reflection += vec4($texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb, material_reflectionFactor);\n}\n\n";
pc.shaderChunks.rgbmPS="vec3 decodeRGBM(vec4 rgbm) {\n    vec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n    return color * color;\n}\n\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n    return decodeRGBM(texture2D(tex, uv));\n}\n\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n    return decodeRGBM(textureCube(tex, uvw));\n}\n\n";pc.shaderChunks.endPS="   gl_FragColor.rgb = combineColor(data);\n   gl_FragColor.rgb += getEmission(data);\n   gl_FragColor.rgb = addFog(data, gl_FragColor.rgb);\n   gl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n   gl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n   gl_FragColor.a = data.alpha;\n";
pc.shaderChunks.startPS="\nvoid main(void) {\n    psInternalData data;\n\tdata.diffuseLight = vec3(0);\n\tdata.specularLight = vec3(0);\n    data.reflection = vec4(0);\n\n\n";pc.shaderChunks.particleUpdaterRespawnPS="    life = life > particleLifetime? -particleRate * gl_FragCoord.x : life;\n\n";pc.shaderChunks.uv1VS="\nvec2 getUv1(inout vsInternalData data) {\n    return vertex_texCoord1;\n}\n";pc.shaderChunks.fresnelSimplePS="// Easily tweakable but not very correct Fresnel\nuniform float material_fresnelFactor;\nvoid getFresnel(inout psInternalData data) {\n    float fresnel = 1.0 - max(dot(data.normalW, data.viewDirW), 0.0);\n    data.specularity *= pow(fresnel, material_fresnelFactor);\n}\n\n";
pc.shaderChunks.particle_billboardVS="\n    quadXY = rotate(quadXY, angle, rotMatrix);\n    vec3 localPos = billboard(particlePos, quadXY, localMat);\n\n";pc.shaderChunks.particle_cpuVS="attribute vec4 particle_vertexData;     // XYZ = world pos, W = life\nattribute vec4 particle_vertexData2;     // X = angle, Y = scale, Z = alpha, W = velocity.x\nattribute vec4 particle_vertexData3;     // XYZ = particle local pos, W = velocity.y\nattribute vec2 particle_vertexData4;     // X = velocity.z, W = particle ID\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat4 matrix_view;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\n//uniform float graphSampleSize;\n//uniform float graphNumSamples;\nuniform vec3 wrapBounds, emitterScale;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nvarying vec4 texCoordsAlphaLife;\n\n\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n    float c = cos(pRotation);\n    float s = sin(pRotation);\n    //vec4 rotationMatrix = vec4(c, -s, s, c);\n\n    mat2 m = mat2(c, -s, s, c);\n    rotMatrix = m;\n\n    return m * quadXY;\n}\n\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY, out mat3 localMat)\n{\n    vec3 viewUp = matrix_viewInverse[1].xyz;\n    vec3 posCam = matrix_viewInverse[3].xyz;\n\n    mat3 billMat;\n    billMat[2] = normalize(InstanceCoords - posCam);\n    billMat[0] = normalize(cross(viewUp, billMat[2]));\n    billMat[1] = -viewUp;\n    vec3 pos = billMat * vec3(quadXY, 0);\n\n    localMat = billMat;\n\n    return pos;\n}\n\n\nvoid main(void)\n{\n    vec3 particlePos = particle_vertexData.xyz;\n    vec3 pos = particlePos;\n    vec3 vertPos = particle_vertexData3.xyz;\n    vec3 particleVelocity = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData4.x);\n    vec2 velocityV = normalize((mat3(matrix_view) * particleVelocity).xy); // should be removed by compiler if align/stretch is not used\n\n    vec2 quadXY = vertPos.xy;\n    texCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n\n    mat2 rotMatrix;\n    mat3 localMat;\n\n    float angle = particle_vertexData2.x;\n    vec3 particlePosMoved = vec3(0.0);\n    vec3 meshLocalPos = particle_vertexData3.xyz;\n\n";
pc.shaderChunks.aoBakedPS="uniform sampler2D texture_aoMap;\nvoid applyAO(inout psInternalData data) {\n    data.ao = texture2D(texture_aoMap, $UV).$CH;\n    data.diffuseLight *= data.ao;\n}\n\nvoid occludeSpecular(inout psInternalData data) {\n    // fake specular occlusion from AO\n    float specPow = exp2(data.glossiness * 4.0); // 0 - 128\n    specPow = max(specPow, 0.0001);\n    float specOcc = saturate(pow(data.ao * (data.glossiness + 1.0), specPow));\n\n    data.specularLight *= specOcc;\n    data.reflection *= specOcc;\n}\n\n";
pc.shaderChunks.fogExp2PS="uniform vec3 fog_color;\nuniform float fog_density;\nvec3 addFog(inout psInternalData data, vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    return mix(fog_color, color, fogFactor);\n}\n";pc.shaderChunks.glossTexPS="uniform sampler2D texture_glossMap;\nvoid getGlossiness(inout psInternalData data) {\n    data.glossiness = texture2D(texture_glossMap, $UV).$CH;\n}\n\n";
pc.shaderChunks.tangentBinormalVS="\nvec3 getTangent(inout vsInternalData data) {\n    return normalize(data.normalMatrix * vertex_tangent.xyz);\n}\n\nvec3 getBinormal(inout vsInternalData data) {\n    return cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\n\n";pc.shaderChunks.normalSkinnedVS="vec3 getNormal(inout vsInternalData data) {\n    data.normalMatrix = mat3(data.modelMatrix[0].xyz, data.modelMatrix[1].xyz, data.modelMatrix[2].xyz);\n    return normalize(data.normalMatrix * vertex_normal);\n}\n\n";
pc.shaderChunks.lightDiffuseLambertPS="float getLightDiffuse(inout psInternalData data) {\n    return max(dot(data.normalW, -data.lightDirNormW), 0.0);\n}\n\n";pc.shaderChunks.skyboxHDRPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    vec3 color = $textureCubeSAMPLE(texture_cubeMap, fixSeams(vViewDir)).rgb;\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n";pc.shaderChunks.skyboxPS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvoid main(void) {\n    gl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n\n";
pc.shaderChunks.specularTexPS="uniform sampler2D texture_specularMap;\nvoid getSpecularity(inout psInternalData data) {\n    data.specularity = texture2D(texture_specularMap, $UV).$CH;\n}\n\n";pc.shaderChunks.glossTexConstPS="uniform sampler2D texture_glossMap;\nuniform float material_shininess;\nvoid getGlossiness(inout psInternalData data) {\n    data.glossiness = material_shininess * texture2D(texture_glossMap, $UV).$CH;\n}\n\n";pc.shaderChunks.particleUpdaterStartPS="float saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nvec3 unpack3NFloats(float src) {\n    float r = fract(src);\n    float g = fract(src * 256.0);\n    float b = fract(src * 65536.0);\n    return vec3(r, g, b);\n}\n\nvec3 tex1Dlod_lerp(sampler2D tex, vec2 tc, out vec3 w) {\n    vec4 a = texture2D(tex, tc);\n    vec4 b = texture2D(tex, tc + graphSampleSize);\n    float c = fract(tc.x * graphNumSamples);\n\n    vec3 unpackedA = unpack3NFloats(a.w);\n    vec3 unpackedB = unpack3NFloats(b.w);\n    w = mix(unpackedA, unpackedB, c);\n\n    return mix(a.xyz, b.xyz, c);\n}\n\nvoid main(void)\n{\n    if (gl_FragCoord.x > numParticles) discard;\n    float outMask0 = gl_FragCoord.y < 1.0? 1.0 : 0.0;\n    float outMask1 = (gl_FragCoord.y < 2.0 && gl_FragCoord.y >= 1.0)? 1.0 : 0.0;\n    float outMask2 = (gl_FragCoord.y < 3.0 && gl_FragCoord.y >= 2.0)? 1.0 : 0.0;\n\n    vec4 tex = texture2D(particleTexIN, vec2(vUv0.x, 0.125));\n    vec4 tex2 = texture2D(particleTexIN, vec2(vUv0.x, 0.375));\n    vec4 texR = texture2D(particleTexIN, vec2(vUv0.x, 0.625));\n\n    vec4 rndFactor = texR;\n    float particleLifetime = lifetime;\n    float life = tex2.w + delta;\n    float particleRate = rate + rateDiv * rndFactor.x;\n\n        float nlife = clamp(life / particleLifetime, 0.0, 1.0);\n        vec3 localVelocityDiv;\n        vec3 velocityDiv;\n        vec3 paramDiv;\n        vec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n        vec3 velocity =      tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n        vec3 params =        tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n        float rotSpeed = params.x;\n        float rotSpeedDiv = paramDiv.y;\n\n        localVelocity +=    (localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n        velocity +=         (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.zxy;\n        rotSpeed +=         (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\n        addInitialVelocity(localVelocity, rndFactor.xyz);\n\n        vec3 outVelocity = emitterMatrix * localVelocity.xyz + velocity.xyz * emitterScale;\n        vec3 outPosition = tex.xyz + outVelocity * delta;\n        float outRotation = tex.w + rotSpeed * delta;\n\n        bool respawn = life <= 0.0 || life > particleLifetime;\n        outPosition = respawn? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : outPosition;\n        outRotation = respawn? mix(startAngle, startAngle2, rndFactor.x) : outRotation;\n        outVelocity = respawn? vec3(0.0) : outVelocity;\n\n";
pc.shaderChunks.specularTexConstPS="uniform sampler2D texture_specularMap;\nuniform vec3 material_specular;\nvoid getSpecularity(inout psInternalData data) {\n    data.specularity = texture2D(texture_specularMap, $UV).$CH * material_specular;\n}\n\n";pc.shaderChunks.viewNormalVS="\nuniform mat4 matrix_view;\nvec3 getViewNormal(inout vsInternalData data) {\n    return mat3(matrix_view) * vNormalW;\n}\n";pc.shaderChunks.transformVS="mat4 getModelMatrix(inout vsInternalData data) {\n    return matrix_model;\n}\n\nvec4 getPosition(inout vsInternalData data) {\n    data.modelMatrix = getModelMatrix(data);\n    vec4 posW = data.modelMatrix * vec4(vertex_position, 1.0);\n    data.positionW = posW.xyz;\n    return matrix_viewProjection * posW;\n}\n\nvec3 getWorldPosition(inout vsInternalData data) {\n    return data.positionW;\n}\n\n";
pc.shaderChunks.opacityTexConstPS="uniform sampler2D texture_opacityMap;\nuniform float material_opacity;\nvoid getOpacity(inout psInternalData data) {\n    data.alpha = texture2D(texture_opacityMap, $UV).$CH * material_opacity;\n}\n\n";pc.shaderChunks.uv0VS="\nvec2 getUv0(inout vsInternalData data) {\n    return vertex_texCoord0;\n}\n";pc.shaderChunks.fixCubemapSeamsNonePS="vec3 fixSeams(vec3 vec, float mipmapIndex) {\n    return vec;\n}\n\nvec3 fixSeams(vec3 vec) {\n    return vec;\n}\n\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n    return vec;\n}\n";
pc.shaderChunks.diffuseTexPS="uniform sampler2D texture_diffuseMap;\nvoid getAlbedo(inout psInternalData data) {\n    data.albedo = texture2DSRGB(texture_diffuseMap, $UV).$CH;\n}\n\n";pc.shaderChunks.emissiveConstPS="uniform vec3 material_emissive;\nvec3 getEmission(inout psInternalData data) {\n    return material_emissive;\n}\n\n";pc.shaderChunks.particleUpdaterAABBPS="uniform mat3 spawnBounds;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n    return emitterPos + spawnBounds * (inBounds - vec3(0.5));\n}\n\nvoid addInitialVelocity(out vec3 localVelocity, vec3 inBounds) {\n    localVelocity -= vec3(0, 0, initialVelocity);\n}\n\n";
pc.shaderChunks.particle_normalMapPS="\n    vec3 normalMap         = normalize( texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0 );\n    vec3 normal = ParticleMat * normalMap;\n\n\n\n\n";pc.shaderChunks.emissiveTexConstPS="uniform sampler2D texture_emissiveMap;\nuniform vec3 material_emissive;\nvec3 getEmission(inout psInternalData data) {\n    return texture2D(texture_emissiveMap, $UV).$CH * material_emissive;\n}\n\n";pc.shaderChunks.tonemappingLinearPS="uniform float exposure;\nvec3 toneMap(vec3 color) {\n    return color * exposure;\n}\n\n";
pc.shaderChunks.particleUpdaterOnStopPS="    life = life < 0.0? particleLifetime + 1.0 : life;\n\n";pc.shaderChunks.baseVS="\n// Compiler should remove unneeded stuff\nattribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\n\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\n\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\nvarying vec3 vTangentW;\nvarying vec3 vBinormalW;\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec4 vVertexColor;\nvarying vec3 vNormalV;\n\nstruct vsInternalData {\n    vec3 positionW;\n    mat4 modelMatrix;\n    mat3 normalMatrix;\n};\n\n";
pc.shaderChunks.particleUpdaterEndPS="\n    tex = vec4(outPosition, outRotation) * outMask0 +\n          vec4(outVelocity, life) * outMask1 +\n          texR * outMask2;\n\n    gl_FragColor = tex;\n}\n\n";pc.shaderChunks.combineDiffuseSpecularNoConservePS="vec3 combineColor(inout psInternalData data) {\n    return data.albedo * data.diffuseLight + (data.specularLight + data.reflection.rgb * data.reflection.a) * data.specularity;\n}\n\n";pc.shaderChunks.particle_softPS="\n    vec2 screenTC = gl_FragCoord.xy / screenSize.xy;\n    float depth = unpackFloat( texture2D(uDepthMap, screenTC) ) * camera_far;\n    float particleDepth = gl_FragCoord.z / gl_FragCoord.w;\n    float depthDiff = saturate(abs(particleDepth - depth) * softening);\n    a *= depthDiff;\n\n";
pc.shaderChunks.basePS="\n// Compiler should remove unneeded stuff\nuniform vec3 view_position;\n\nuniform vec3 light_globalAmbient;\n\nvarying vec3 vPositionW;\nvarying vec3 vNormalW;\nvarying vec3 vTangentW;\nvarying vec3 vBinormalW;\nvarying vec2 vUv0;\nvarying vec2 vUv1;\nvarying vec4 vVertexColor;\nvarying vec3 vNormalV;\n\nstruct psInternalData {\n    vec3 albedo;\n    vec3 specularity;\n    float glossiness;\n    vec3 emission;\n    vec3 normalW;\n    mat3 TBN;\n    vec3 viewDirW;\n    vec3 reflDirW;\n    vec3 diffuseLight;\n    vec3 specularLight;\n    vec4 reflection;\n    float alpha;\n    vec3 lightDirNormW;\n    vec3 lightDirW;\n    vec3 lightPosW;\n    float atten;\n    vec3 shadowCoord;\n    vec2 uvOffset;\n    vec3 normalMap;\n    float ao;\n};\n\nvoid getViewDir(inout psInternalData data) {\n    data.viewDirW = normalize(view_position - vPositionW);\n}\n\nvoid getReflDir(inout psInternalData data) {\n    data.reflDirW = normalize(-reflect(data.viewDirW, data.normalW));\n}\n\nvoid getLightDirPoint(inout psInternalData data, vec3 lightPosW) {\n    data.lightDirW = vPositionW - lightPosW;\n    data.lightDirNormW = normalize(data.lightDirW);\n    data.lightPosW = lightPosW;\n}\n\nfloat getFalloffLinear(inout psInternalData data, float lightRadius) {\n    float d = length(data.lightDirW);\n    return max(((lightRadius - d) / lightRadius), 0.0);\n}\n\nfloat square(float x) {\n    return x*x;\n}\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat getFalloffInvSquared(inout psInternalData data, float lightRadius) {\n    float sqrDist = dot(data.lightDirW, data.lightDirW);\n    float falloff = 1.0 / (sqrDist + 1.0);\n    float invRadius = 1.0 / lightRadius;\n\n    falloff *= 16.0;\n    falloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\n    return falloff;\n}\n\nfloat getSpotEffect(inout psInternalData data, vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n    float cosAngle = dot(data.lightDirNormW, lightSpotDirW);\n    return smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n\n";
pc.shaderChunks.combineDiffuseSpecularPS="vec3 combineColor(inout psInternalData data) {\n    return mix(data.albedo * data.diffuseLight, data.specularLight + data.reflection.rgb * data.reflection.a, data.specularity);\n}\n\n";pc.shaderChunks.outputCubemapPS="varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params;\n\nvoid main(void) {\n\n    vec2 st = vUv0 * 2.0 - 1.0;\n    float face = params.x;\n\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n\n    gl_FragColor = textureCube(source, vec);\n}\n\n";
pc.shaderChunks.particlePS="varying vec4 texCoordsAlphaLife;\n\nuniform sampler2D colorMap;\nuniform sampler2D internalTex3;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform vec4 screenSize;\nuniform float camera_far;\nuniform float softening;\nuniform float colorMult;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat unpackFloat(vec4 rgbaDepth) {\n    const vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n    float depth = dot(rgbaDepth, bitShift);\n    return depth;\n}\n\nvoid main(void) {\n    psInternalData data;\n    vec4 tex         = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n    vec4 ramp     = texture2DSRGB(internalTex3, vec2(texCoordsAlphaLife.w, 0.0));\n    ramp.rgb *= colorMult;\n\n    ramp.a += texCoordsAlphaLife.z;\n\n    vec3 rgb =     tex.rgb * ramp.rgb;\n    float a =         tex.a * ramp.a;\n\n";
pc.shaderChunks.combineDiffusePS="vec3 combineColor(inout psInternalData data) {\n    return data.albedo * data.diffuseLight;\n}\n\n";pc.shaderChunks.lightSpecularBlinnPS="// Energy-conserving (hopefully) Blinn-Phong\nfloat getLightSpecular(inout psInternalData data) {\n    vec3 h = normalize( -data.lightDirNormW + data.viewDirW );\n    float nh = max( dot( h, data.normalW ), 0.0 );\n\n    float specPow = exp2(data.glossiness * 11.0); // glossiness is linear, power is not; 0 - 2048\n    specPow = antiAliasGlossiness(data, specPow);\n\n    // Hack: On Mac OS X, calling pow with zero for the exponent generates hideous artifacts so bias up a little\n    specPow = max(specPow, 0.0001);\n\n    return pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\n\n";
pc.shaderChunks.TBNPS="void getTBN(inout psInternalData data) {\n    data.TBN = mat3(normalize(vTangentW), normalize(vBinormalW), normalize(vNormalW));\n}\n\n";pc.shaderChunks.normalXYPS="vec3 unpackNormal(vec4 nmap) {\n    vec3 normal;\n    normal.xy = nmap.wy * 2.0 - 1.0;\n    normal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n    return normal;\n}\n\n";pc.shaderChunks.diffuseTexConstPS="uniform sampler2D texture_diffuseMap;\nuniform vec3 material_diffuse;\nvoid getAlbedo(inout psInternalData data) {\n    data.albedo = texture2DSRGB(texture_diffuseMap, $UV).$CH * material_diffuse;\n}\n\n";
pc.shaderChunks.gamma2_2PS="vec3 gammaCorrectInput(vec3 color) {\n    return pow(color, vec3(2.2));\n}\n\nfloat gammaCorrectInput(float color) {\n    return pow(color, 2.2);\n}\n\nvec4 gammaCorrectInput(vec4 color) {\n    return vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\n\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n    vec4 rgba = texture2D(tex, uv);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n    vec4 rgba = textureCube(tex, uvw);\n    rgba.rgb = gammaCorrectInput(rgba.rgb);\n    return rgba;\n}\n\nvec3 gammaCorrectOutput(vec3 color) {\n    return pow(color, vec3(0.45));\n}\n\n";
pc.shaderChunks.transformSkinnedVS="mat4 getModelMatrix(inout vsInternalData data) {\n    return             vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n}\n\nvec4 getPosition(inout vsInternalData data) {\n    data.modelMatrix = getModelMatrix(data);\n    vec4 posW = data.modelMatrix * vec4(vertex_position, 1.0);\n    data.positionW = posW.xyz / posW.w;\n    return matrix_viewProjection * posW;\n}\n\nvec3 getWorldPosition(inout vsInternalData data) {\n    return data.positionW;\n}\n\n";
pc.shaderChunks.normalMapFloatPS="uniform sampler2D texture_normalMap;\nuniform float material_bumpMapFactor;\nvoid getNormal(inout psInternalData data) {\n    vec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n    data.normalMap = normalMap;\n    normalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpMapFactor));\n    data.normalW = data.TBN * normalMap;\n}\n\n";pc.shaderChunks.reflectionPrefilteredCubePS="uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\nuniform samplerCube texture_prefilteredCubeMap4;\nuniform float material_reflectionFactor;\n\nvoid addCubemapReflection(inout psInternalData data) {\n\n    // Unfortunately, WebGL doesn't allow us using textureCubeLod. Therefore bunch of nasty workarounds is required.\n    // We fix mip0 to 128x128, so code is rather static.\n    // Mips smaller than 4x4 aren't great even for diffuse. Don't forget that we don't have bilinear filtering between different faces.\n\n    float bias = saturate(1.0 - data.glossiness) * 5.0; // multiply by max mip level\n    int index1 = int(bias);\n    int index2 = int(min(bias + 1.0, 7.0));\n\n    vec3 fixedReflDir = fixSeams(data.reflDirW, bias);\n\n    vec4 cubes[6];\n    cubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n    cubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n    cubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n    cubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n    cubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n    cubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n\n    // Also we don't have dynamic indexing in PS, so...\n    vec4 cube[2];\n    for(int i = 0; i < 6; i++) {\n        if (i == index1) {\n            cube[0] = cubes[i];\n        }\n        if (i == index2) {\n            cube[1] = cubes[i];\n        }\n    }\n\n    // another variant\n    /*if (index1==0){ cube[0]=cubes[0];\n    }else if (index1==1){ cube[0]=cubes[1];\n    }else if (index1==2){ cube[0]=cubes[2];\n    }else if (index1==3){ cube[0]=cubes[3];\n    }else if (index1==4){ cube[0]=cubes[4];\n    }else if (index1==5){ cube[0]=cubes[5];}\n\n    if (index2==0){ cube[1]=cubes[0];\n    }else if (index2==1){ cube[1]=cubes[1];\n    }else if (index2==2){ cube[1]=cubes[2];\n    }else if (index2==3){ cube[1]=cubes[3];\n    }else if (index2==4){ cube[1]=cubes[4];\n    }else if (index2==5){ cube[1]=cubes[5];}*/\n\n    vec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n    vec3 refl = $DECODE(cubeFinal).rgb;\n\n    data.reflection += vec4(refl, material_reflectionFactor);\n}\n\n";
pc.shaderChunks.particle_lightingPS="\n    vec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n                        negNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n                        negNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\n\n    rgb *= light;\n\n\n";pc.shaderChunks.fogNonePS="vec3 addFog(inout psInternalData data, vec3 color) {\n    return color;\n}\n\n\n";pc.shaderChunks.skyboxPrefilteredCubePS="varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\n\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n    float scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n    float M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n    if (abs(vec.x) != M) vec.x *= scale;\n    if (abs(vec.y) != M) vec.y *= scale;\n    if (abs(vec.z) != M) vec.z *= scale;\n    return vec;\n}\n\nvoid main(void) {\n    vec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n    color = toneMap(color);\n    color = gammaCorrectOutput(color);\n    gl_FragColor = vec4(color, 1.0);\n}\n\n";
pc.shaderChunks.specularConstPS="uniform vec3 material_specular;\nvoid getSpecularity(inout psInternalData data) {\n    data.specularity = material_specular;\n}\n\n";pc.shaderChunks.particle_blendAddPS="\n    rgb *= gammaCorrectInput(a);\n    if ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n\n";pc.shaderChunks.fogLinearPS="uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nvec3 addFog(inout psInternalData data, vec3 color) {\n    float depth = gl_FragCoord.z / gl_FragCoord.w;\n    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n    fogFactor = clamp(fogFactor, 0.0, 1.0);\n    fogFactor = gammaCorrectInput(fogFactor);\n    return mix(fog_color, color, fogFactor);\n}\n";
pc.shaderChunks.ambientPrefilteredCubePS="void addAmbient(inout psInternalData data) {\n    vec3 fixedReflDir = fixSeamsStatic(data.normalW, 1.0 - 1.0 / 4.0);\n    data.diffuseLight = $DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb;\n}\n\n";pc.shaderChunks.ambientConstantPS="\nvoid addAmbient(inout psInternalData data) {\n    data.diffuseLight = light_globalAmbient;\n}\n";pc.shaderChunks.startVS="\nvoid main(void) {\n    vsInternalData data;\n\n    gl_Position = getPosition(data);\n";
pc.shaderChunks.particle_cpu_endVS="\n    localPos *= particle_vertexData2.y * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n}\n\n";pc.shaderChunks.combineDiffuseSpecularOldPS="vec3 combineColor(inout psInternalData data) {\n    return mix(data.albedo * data.diffuseLight + data.specularLight * data.specularity, data.reflection.rgb, data.reflection.a);\n}\n\n";pc.shaderChunks.lightmapSinglePS="uniform sampler2D texture_lightMap;\nvoid addAmbient(inout psInternalData data) {\n    data.diffuseLight = texture2D(texture_lightMap, $UV).$CH;\n}\n\n";
pc.shaderChunks.reflectionCubePS="uniform samplerCube texture_cubeMap;\nuniform float material_reflectionFactor;\nvoid addCubemapReflection(inout psInternalData data) {\n    data.reflection += vec4($textureCubeSAMPLE(texture_cubeMap, fixSeams(data.reflDirW)).rgb, material_reflectionFactor);\n}\n\n";pc.shaderChunks.fullscreenQuadVS="attribute vec2 aPosition;\n\nvarying vec2 vUv0;\n\nvoid main(void)\n{\n    gl_Position = vec4(aPosition, 0.5, 1.0);\n    vUv0 = aPosition.xy*0.5+0.5;\n}\n\n";
pc.shaderChunks.particle_endVS="\n    localPos *= scale * emitterScale;\n    localPos += particlePos;\n\n    gl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n}\n";pc.shaderChunks.particleUpdaterInitPS="varying vec2 vUv0;\n\nuniform sampler2D particleTexIN;\nuniform sampler2D internalTex0;\nuniform sampler2D internalTex1;\nuniform sampler2D internalTex2;\n\nuniform mat3 emitterMatrix;\nuniform vec3 emitterScale;\n\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\n\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n\n";
pc.shaderChunks.tonemappingFilmicPS="const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\n\nuniform float exposure;\n\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\n\nvec3 toneMap(vec3 color) {\n    color = uncharted2Tonemap(color * exposure);\n    vec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n    color = color * whiteScale;\n\n    return color;\n}\n\n";
pc.shaderChunks.tonemappingNonePS="vec3 toneMap(vec3 color) {\n    return color;\n}\n\n";pc.shaderChunks.parallaxPS="uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax(inout psInternalData data) {\n    float parallaxScale = material_heightMapFactor;\n    const float parallaxBias = 0.01;\n\n    float height = texture2D(texture_heightMap, $UV).r * parallaxScale - parallaxBias;\n    vec3 viewDirT = data.viewDirW * data.TBN;\n\n    data.uvOffset = min(height * viewDirT.xy, vec2(parallaxBias));\n}\n\n";
pc.shaderChunks.prefilterCubemapPS="varying vec2 vUv0;\n\nuniform samplerCube source;\nuniform vec4 params;\n\nfloat saturate(float x) {\n    return clamp(x, 0.0, 1.0);\n}\n\nfloat rnd(vec2 uv) {\n    return fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\n\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) { // cos + lerped cone size (better than just lerped)\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = sqrt(1.0 - uv.x);\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\n\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n    float phi = uv.y * 2.0 * PI;\n    float cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n    float sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n    vec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n    return vecSpace * sampleDir;\n}\n\nmat3 matrixFromVector(vec3 n) { // frisvad\n    float a = 1.0 / (1.0 + n.z);\n    float b = -n.x * n.y * a;\n    vec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n    vec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n    return mat3(b1, b2, n);\n}\n\nvec4 encodeRGBM(vec4 color) { // modified RGBM\n    color.rgb = pow(color.rgb, vec3(0.5));\n    color.rgb *= 1.0 / 8.0;\n\n    color.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n    color.a = ceil(color.a * 255.0) / 255.0;\n\n    color.rgb /= color.a;\n    return color;\n}\n\nvoid main(void) {\n\n    vec2 st = vUv0 * 2.0 - 1.0;\n\n    if (params.w==1.0 || params.w==3.0) {\n        st = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n    }\n\n    float face = params.x;\n\n    vec3 vec;\n    if (face==0.0) {\n        vec = vec3(1, -st.y, -st.x);\n    } else if (face==1.0) {\n        vec = vec3(-1, -st.y, st.x);\n    } else if (face==2.0) {\n        vec = vec3(st.x, 1, st.y);\n    } else if (face==3.0) {\n        vec = vec3(st.x, -1, -st.y);\n    } else if (face==4.0) {\n        vec = vec3(st.x, -st.y, 1);\n    } else {\n        vec = vec3(-st.x, -st.y, -1);\n    }\n\n    mat3 vecSpace = matrixFromVector(normalize(vec));\n\n    vec4 color = vec4(0.0);\n    const int samples = $NUMSAMPLES;\n    vec3 vect;\n    for(int i=0; i<samples; i++) {\n        float sini = sin(float(i));\n        float cosi = cos(float(i));\n        float rand = rnd(vec2(sini, cosi));\n\n        vect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\n        color += textureCube(source, vect);\n    }\n    color /= float(samples);\n\n    gl_FragColor = params.w < 2.0? color : encodeRGBM(color);\n}\n";
pc.shaderChunks.fresnelSchlickPS="// Schlick's approximation\nuniform float material_fresnelFactor; // unused\nvoid getFresnel(inout psInternalData data) {\n    float fresnel = 1.0 - max(dot(data.normalW, data.viewDirW), 0.0);\n    float fresnel2 = fresnel * fresnel;\n    fresnel *= fresnel2 * fresnel2;\n    fresnel *= data.glossiness * data.glossiness;\n    data.specularity = data.specularity + (1.0 - data.specularity) * fresnel;\n}\n\n";pc.shaderChunks.particle_stretchVS="    vec3 moveDir = particleVelocity * stretch;\n    vec3 posPrev = pos - moveDir;\n    posPrev += particlePosMoved;\n\n    vec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\n    float interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\n    particlePos = mix(particlePos, posPrev, interpolation);\n\n";pc.extend(pc.shaderChunks,function(){return{defaultGamma:pc.shaderChunks.gamma1_0PS,defaultTonemapping:pc.shaderChunks.tonemappingLinearPS}}());pc.programlib={getSnippet:function(e,a){var b="";switch(a){case "common_main_begin":b+="void main(void)\n{\n";break;case "common_main_end":b+="}\n";break;case "fs_alpha_test_decl":b+="uniform float alpha_ref;\n";break;case "fs_alpha_test":b+="    if (gl_FragColor.a < alpha_ref) discard;\n\n";break;case "fs_clamp":b+="    gl_FragColor = clamp(gl_FragColor, 0.0, 1.0);\n";break;case "fs_flat_color_decl":b+="uniform vec4 uColor;\n";break;case "fs_flat_color":b+="    gl_FragColor = uColor;\n";break;case "fs_fog_linear_decl":case "fs_fog_exp_decl":case "fs_fog_exp2_decl":b+=
"uniform vec3 fog_color;\n";b="fs_fog_linear_decl"===a?b+"uniform float fog_start;\nuniform float fog_end;\n\n":b+"uniform float fog_density;\n\n";break;case "fs_fog_linear":case "fs_fog_exp":case "fs_fog_exp2":b+="    float depth = gl_FragCoord.z / gl_FragCoord.w;\n";b="fs_fog_linear"===a?b+"    float fogFactor = (fog_end - depth) / (fog_end - fog_start);\n":"fs_fog_exp"===a?b+"    float fogFactor = exp(-depth * fog_density);\n":b+"    float fogFactor = exp(-depth * depth * fog_density * fog_density);\n";
b+="    fogFactor = clamp(fogFactor, 0.0, 1.0);\n";b+="    gl_FragColor.rgb = mix(fog_color, gl_FragColor.rgb, fogFactor);\n";break;case "fs_precision":b+="precision "+e.precision+" float;\n\n";break;case "fs_height_map_funcs":b+="vec3 perturb_normal( vec3 N, vec3 p, vec2 uv )\n";b+="{\n";b+="    vec3 dp1 = dFdx( p );\n";b+="    vec3 dp2 = dFdy( p );\n";b+="    vec2 duv1 = dFdx( uv );\n";b+="    vec2 duv2 = dFdy( uv );\n\n";b+="    vec3 dp2perp = cross( dp2, N );\n";b+="    vec3 dp1perp = cross( N, dp1 );\n\n";
b+="    const float bumpScale = 0.125;\n";b+="    float Hll = bumpScale * texture2D( texture_heightMap, uv ).x;\n";b+="    float dBx = bumpScale * texture2D( texture_heightMap, uv + duv1 ).x - Hll;\n";b+="    float dBy = bumpScale * texture2D( texture_heightMap, uv + duv2 ).x - Hll;\n\n";b+="    float fDet = dot( dp1, dp2perp );\n";b+="    vec3 vGrad = sign( fDet ) * ( dBx * dp2perp + dBy * dp1perp );\n";b+="    return normalize( abs( fDet ) * N - vGrad );\n";b+="}\n\n";break;case "fs_normal_map_funcs":pc.precalculatedTangents||
(b+="mat3 cotangent_frame( vec3 N, vec3 p, vec2 uv )\n",b+="{\n",b+="    vec3 dp1 = dFdx( p );\n",b+="    vec3 dp2 = dFdy( p );\n",b+="    vec2 duv1 = dFdx( uv );\n",b+="    vec2 duv2 = dFdy( uv );\n\n",b+="    vec3 dp2perp = cross( dp2, N );\n",b+="    vec3 dp1perp = cross( N, dp1 );\n",b+="    vec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n",b+="    vec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\n",b+="    float invmax = inversesqrt( max( dot(T,T), dot(B,B) ) );\n",b+="    return mat3( T * invmax, B * invmax, N );\n",
b+="}\n\n",b+="vec3 perturb_normal( vec3 N, vec3 V, vec2 uv )\n",b+="{\n",b+="    vec3 map = texture2D( texture_normalMap, uv ).xyz;\n",b+="    map = map * 255./127. - 128./127.;\n",b+="    map.xy = map.xy * material_bumpMapFactor;\n",b+="    mat3 TBN = cotangent_frame( N, -V, uv );\n",b+="    return normalize( TBN * map );\n",b+="}\n\n");break;case "vs_skin_decl":b=e.supportsBoneTextures?b+"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n\nuniform sampler2D texture_poseMap;\nuniform vec2 texture_poseMapSize;\n\nmat4 getBoneMatrix(const in float i)\n{\n    float j = i * 4.0;\n    float x = mod(j, float(texture_poseMapSize.x));\n    float y = floor(j / float(texture_poseMapSize.x));\n\n    float dx = 1.0 / float(texture_poseMapSize.x);\n    float dy = 1.0 / float(texture_poseMapSize.y);\n\n    y = dy * (y + 0.5);\n\n    vec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n    vec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n    vec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n    vec4 v4 = texture2D(texture_poseMap, vec2(dx * (x + 3.5), y));\n\n    mat4 bone = mat4(v1, v2, v3, v4);\n\n    return bone;\n}":
b+["attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\n","uniform mat4 matrix_pose["+e.getBoneLimit()+"];","\nmat4 getBoneMatrix(const in float i)\n{\n    mat4 bone = matrix_pose[int(i)];\n\n    return bone;\n}"].join("\n");b+="\n\n";break;case "vs_transform_decl":b+="attribute vec3 vertex_position;\n",b+="uniform mat4 matrix_model;\n",b+="uniform mat4 matrix_viewProjection;\n\n"}return b}};pc.programlib.basic={generateKey:function(e,a){var b="basic";a.fog&&(b+="_fog");a.alphaTest&&(b+="_atst");a.vertexColors&&(b+="_vcol");a.diffuseMap&&(b+="_diff");return b},createShaderDefinition:function(e,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.vertexColors&&(b.vertex_color=pc.SEMANTIC_COLOR);a.diffuseMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var c=pc.programlib.getSnippet,d;d=""+
c(e,"vs_transform_decl");a.skin&&(d+=c(e,"vs_skin_decl"));a.vertexColors&&(d+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n");a.diffuseMap&&(d+="attribute vec2 vertex_texCoord0;\n",d+="varying vec2 vUv0;\n");d+=c(e,"common_main_begin");a.skin?(d+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",d+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",d+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",
d+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):d+="    mat4 modelMatrix = matrix_model;\n";d+="\n";d+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";d+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.vertexColors&&(d+="    vColor = vertex_color;\n");a.diffuseMap&&(d+="    vUv0 = vertex_texCoord0;\n");var g=d+=c(e,"common_main_end");d=c(e,"fs_precision");d=a.vertexColors?d+"varying vec4 vColor;\n":d+"uniform vec4 uColor;\n";
a.diffuseMap&&(d+="varying vec2 vUv0;\n",d+="uniform sampler2D texture_diffuseMap;\n");a.fog&&(d+=c(e,"fs_fog_decl"));a.alphatest&&(d+=c(e,"fs_alpha_test_decl"));d+=c(e,"common_main_begin");d=a.vertexColors?d+"    gl_FragColor = vColor;\n":d+"    gl_FragColor = uColor;\n";a.diffuseMap&&(d+="    gl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n");a.alphatest&&(d+=c(e,"fs_alpha_test"));d+=c(e,"fs_clamp");a.fog&&(d+=c(e,"fs_fog"));d+=c(e,"common_main_end");return{attributes:b,vshader:g,fshader:d}}};pc.programlib.depth={generateKey:function(e,a){var b="depth";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam");return b},createShaderDefinition:function(e,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var c=pc.programlib.getSnippet,d;d=""+c(e,"vs_transform_decl");a.skin&&(d+=c(e,"vs_skin_decl"));a.opacityMap&&(d+="attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");
d+=c(e,"common_main_begin");a.skin?(d+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",d+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",d+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",d+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):d+="    mat4 modelMatrix = matrix_model;\n";d+="\n";d+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";
d+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.opacityMap&&(d+="    vUv0 = vertex_texCoord0;\n");var g=d+=c(e,"common_main_end");d=c(e,"fs_precision");d+="uniform float camera_near;\n";d+="uniform float camera_far;\n";d+="vec4 packFloat(float depth)\n";d+="{\n";d+="    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n";d+="    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n";d+="    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n";
d+="    res -= res.xxyz * bit_mask;\n";d+="    return res;\n";d+="}\n\n";d+=c(e,"common_main_begin");d+="float depth = gl_FragCoord.z / gl_FragCoord.w;\n";d+="gl_FragColor = packFloat(depth / camera_far);\n";d+=c(e,"common_main_end");return{attributes:b,vshader:g,fshader:d}}};pc.programlib.depthrgba={generateKey:function(e,a){var b="depthrgba";a.skin&&(b+="_skin");a.opacityMap&&(b+="_opam");a.point&&(b+="_pnt");return b},createShaderDefinition:function(e,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);a.opacityMap&&(b.vertex_texCoord0=pc.SEMANTIC_TEXCOORD0);var c=pc.programlib.getSnippet,d;d=""+c(e,"vs_transform_decl");a.skin&&(d+=c(e,"vs_skin_decl"));a.opacityMap&&(d+=
"attribute vec2 vertex_texCoord0;\n\nvarying vec2 vUv0;\n\n");a.point&&(d+="varying vec3 worldPos;\n\n");d+=c(e,"common_main_begin");a.skin?(d+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n",d+="                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",d+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",d+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):
d+="    mat4 modelMatrix = matrix_model;\n";d+="\n";d+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";d+="    gl_Position = matrix_viewProjection * positionW;\n\n";a.opacityMap&&(d+="    vUv0 = vertex_texCoord0;\n");a.point&&(d+="    worldPos = positionW.xyz;\n");var g=d+=c(e,"common_main_end");d=c(e,"fs_precision");a.opacityMap&&(d+="varying vec2 vUv0;\n\n",d+="uniform sampler2D texture_opacityMap;\n\n");a.point&&(d+="varying vec3 worldPos;\n\n",d+="uniform vec3 view_position;\n\n",
d+="uniform float light_radius;\n\n");d+="vec4 packFloat(float depth)\n";d+="{\n";d+="    const vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n";d+="    const vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n";d+="    vec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n";d+="    res -= res.xxyz * bit_mask;\n";d+="    return res;\n";d+="}\n\n";d+=c(e,"common_main_begin");a.opacityMap&&(d+="    if (texture2D(texture_opacityMap, vUv0).r < 0.25) discard;\n\n");
d=a.point?d+"   gl_FragData[0] = packFloat(distance(view_position, worldPos) / light_radius);\n":d+"    gl_FragData[0] = packFloat(gl_FragCoord.z);\n";d+=c(e,"common_main_end");return{attributes:b,vshader:g,fshader:d}}};pc.programlib.particle={generateKey:function(e,a){var b="particle";for(prop in a)a.hasOwnProperty(prop)&&(b+=a[prop]);return b},createShaderDefinition:function(e,a){var b=pc.programlib.getSnippet,c=pc.shaderChunks,d="",b=b(e,"fs_precision")+"\n";a.useCpu?(1==a.normal&&(d+="\nvarying vec3 Normal;\n"),2==a.normal&&(d+="\nvarying mat3 ParticleMat;\n"),d+=c.particle_cpuVS,a.alignToMotion&&(d+=c.particle_pointAlongVS),d+=a.mesh?c.particle_meshVS:c.particle_billboardVS,1==a.normal&&(d+=c.particle_normalVS),
2==a.normal&&(d+=c.particle_TBNVS),0<a.stretch&&(d+=c.particle_stretchVS),d+=c.particle_cpu_endVS):(1==a.normal&&(d+="\nvarying vec3 Normal;\n"),2==a.normal&&(d+="\nvarying mat3 ParticleMat;\n"),d+=c.particleVS,a.wrap&&(d+=c.particle_wrapVS),a.alignToMotion&&(d+=c.particle_pointAlongVS),d+=a.mesh?c.particle_meshVS:c.particle_billboardVS,1==a.normal&&(d+=c.particle_normalVS),2==a.normal&&(d+=c.particle_TBNVS),0<a.stretch&&(d+=c.particle_stretchVS),d+=c.particle_endVS);0<a.normal&&(1==a.normal?b+="\nvarying vec3 Normal;\n":
2==a.normal&&(b+="\nvarying mat3 ParticleMat;\n"),b+="\nuniform vec3 lightCube[6];\n");0==a.normal&&"none"==a.fog&&(a.srgb=!1);b+=a.srgb?c.gamma2_2PS:c.gamma1_0PS;b=b+"struct psInternalData {float dummy;};\n"+c.defaultTonemapping;b="linear"===a.fog?b+c.fogLinearPS:"exp"===a.fog?b+c.fogExpPS:"exp2"===a.fog?b+c.fogExp2PS:b+c.fogNonePS;2==a.normal&&(b+="\nuniform sampler2D normalMap;\n");0<a.soft&&(b+="\nuniform sampler2D uDepthMap;\n");b+=c.particlePS;0<a.soft&&(b+=c.particle_softPS);1==a.normal&&(b+=
"\nvec3 normal = Normal;\n");2==a.normal&&(b+=c.particle_normalMapPS);0<a.normal&&(b+=a.halflambert?c.particle_halflambertPS:c.particle_lambertPS);0<a.normal&&(b+=c.particle_lightingPS);a.blend==pc.BLEND_NORMAL?b+=c.particle_blendNormalPS:a.blend==pc.BLEND_ADDITIVE?b+=c.particle_blendAddPS:a.blend==pc.BLEND_MULTIPLICATIVE&&(b+=c.particle_blendMultiplyPS);b+=c.particle_endPS;return{attributes:pc.shaderChunks.collectAttribs(d),vshader:d,fshader:b}}};pc.programlib.phong={generateKey:function(e,a){var b=[],c="phong";for(prop in a)if("lights"===prop)for(var d=0;d<a.lights.length;d++)b.push(a.lights[d].getType()+"_"+(a.lights[d].getCastShadows()?1:0)+"_"+a.lights[d].getFalloffMode()+"_"+!!a.lights[d].getNormalOffsetBias());else a[prop]&&b.push(prop);b.sort();for(prop in b)c+="_"+b[prop]+":"+a[b[prop]];return c},_setMapTransform:function(e,a,b,c){e[0]+="uniform vec4 texture_"+a+"MapTransform;\n";var d=b+100*c;e[3][d]||(e[1]+="varying vec2 vUv"+c+
"_"+b+";\n",e[2]+="   vUv"+c+"_"+b+" = uv"+c+" * texture_"+a+"MapTransform.xy + texture_"+a+"MapTransform.zw;\n",e[3][d]=!0);return e},_uvSource:function(e,a){return 0==e?"vUv"+a:"vUv"+a+"_"+e},_addMap:function(e,a,b,c,d){var g=e+"Map";if(a[g]){var f=g+"Channel",c=this._uvSource(a[g+"Transform"],a[g+"Uv"])+c;d||(d=a[e+"Tint"]?b[e+"TexConstPS"]:b[e+"TexPS"]);return d.replace(/\$UV/g,c).replace(/\$CH/g,a[f])}return b[e+"ConstPS"]},createShaderDefinition:function(e,a){var b,c=0<a.lights.length,d=a.cubeMap||
a.prefilteredCubemap,g=a.sphereMap||d,f=pc.precalculatedTangents,k=a.useTexCubeLod;if(a.cubeMap||a.prefilteredCubemap)a.sphereMap=null;a.useSpecular||(a.specularMap=a.glossMap=null);a.shadingModel===pc.SPECULAR_PHONG?(a.fresnelModel=0,a.specularAA=!1):a.fresnelModel=0===a.fresnelModel?pc.FRESNEL_SCHLICK:a.fresnelModel;this.options=a;var m=pc.programlib.getSnippet,h,n,l="",r=pc.shaderChunks;h=""+r.baseVS;var v={vertex_position:pc.SEMANTIC_POSITION};n="   vPositionW    = getWorldPosition(data);\n";
if(c||g)v.vertex_normal=pc.SEMANTIC_NORMAL,n+="   vNormalW    = getNormal(data);\n",a.sphereMap&&16>=e.fragmentUniformsCount&&(h+=r.viewNormalVS,n+="   vNormalV    = getViewNormal(data);\n"),a.normalMap&&f&&(v.vertex_tangent=pc.SEMANTIC_TANGENT,h+=r.tangentBinormalVS,n+="   vTangentW   = getTangent(data);\n   vBinormalW  = getBinormal(data);\n");var u=[],C=[],y;for(y in pc._matTex2D){var s=y+"Map";if(a[s]){var w=s+"Transform",A=s+"Uv",x=s+"Channel";a[A]=Math.min(a[A],1);if(0<pc._matTex2D[y])if(pc._matTex2D[y]<
a[x].length)a[x]=a[x].substring(0,pc._matTex2D[y]);else if(pc._matTex2D[y]>a[x].length){var z=a[x],H=z.charAt(z.length-1),G=pc._matTex2D[y]-z.length;for(b=0;b<G;b++)z+=H;a[x]=z}b=a[A];u[b]=!0;C[b]=C[b]||a[s]&&!a[w]}}for(b=0;2>b;b++)u[b]&&(v["vertex_texCoord"+b]=pc["SEMANTIC_TEXCOORD"+b],h+=r["uv"+b+"VS"],n+="   vec2 uv"+b+" = getUv"+b+"(data);\n"),C[b]&&(n+="   vUv"+b+" = uv"+b+";\n");b=[h,l,n,[]];for(y in pc._matTex2D)s=y+"Map",a[s]&&(w=s+"Transform",a[w]&&(A=s+"Uv",this._setMapTransform(b,y,a[w],
a[A])));h=b[0]+b[1];l=b[1];n=b[2];a.vertexColors&&(v.vertex_color=pc.SEMANTIC_COLOR);if(a.skin){if(v.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,v.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES,h+=m(e,"vs_skin_decl"),h+=r.transformSkinnedVS,c||g)h+=r.normalSkinnedVS}else if(h+=r.transformVS,c||g)h+=r.normalVS;h=h+"\n"+r.startVS;h+=n;y=h+="}";h=m(e,"fs_precision");h+=r.basePS;h+=l;for(b=l=0;b<a.lights.length;b++)s=a.lights[b].getType(),h+="uniform vec3 light"+b+"_color;\n",s==pc.LIGHTTYPE_DIRECTIONAL?
h+="uniform vec3 light"+b+"_direction;\n":(h+="uniform vec3 light"+b+"_position;\n",h+="uniform float light"+b+"_radius;\n",s==pc.LIGHTTYPE_SPOT&&(h+="uniform vec3 light"+b+"_spotDirection;\n",h+="uniform float light"+b+"_innerConeAngle;\n",h+="uniform float light"+b+"_outerConeAngle;\n")),a.lights[b].getCastShadows()&&(h+="uniform mat4 light"+b+"_shadowMatrix;\n",h=s==pc.LIGHTTYPE_POINT?h+("uniform vec4 light"+b+"_shadowParams;\n"):h+("uniform vec3 light"+b+"_shadowParams;\n"),h=s==pc.LIGHTTYPE_POINT?
h+("uniform samplerCube light"+b+"_shadowMap;\n"):h+("uniform sampler2D light"+b+"_shadowMap;\n"),l++);a.alphaTest&&(h+=m(e,"fs_alpha_test_decl"));h+="\n";b=a.heightMap?" + data.uvOffset":"";a.normalMap&&f?(h+=a.packedNormal?r.normalXYPS:r.normalXYZPS,f=this._uvSource(a.normalMapTransform,a.normalMapUv)+b,h+=r.normalMapFloatPS.replace(/\$UV/g,f),h+=r.TBNPS):h+=r.normalVertexPS;h+=r.defaultGamma;h+=r.defaultTonemapping;h="linear"===a.fog?h+r.fogLinearPS:"exp"===a.fog?h+r.fogExpPS:"exp2"===a.fog?h+
r.fogExp2PS:h+r.fogNonePS;a.rgbmReflection&&(h+=r.rgbmPS);d&&(h+=a.fixSeams?r.fixCubemapSeamsStretchPS:r.fixCubemapSeamsNonePS);h+=this._addMap("diffuse",a,r,b);h+=this._addMap("opacity",a,r,b);h+=this._addMap("emissive",a,r,b);a.useSpecular&&(h=a.specularAA&&a.normalMap?h+r.specularAaToksvigPS:h+r.specularAaNonePS,h+=this._addMap("specular",a,r,b),h+=this._addMap("gloss",a,r,b),0<a.fresnelModel&&(a.fresnelModel===pc.FRESNEL_SIMPLE?h+=r.fresnelSimplePS:a.fresnelModel===pc.FRESNEL_SCHLICK?h+=r.fresnelSchlickPS:
a.fresnelModel===pc.FRESNEL_COMPLEX&&(h+=r.fresnelComplexPS)));a.heightMap&&(a.normalMap||(h+=r.TBNPS),h+=this._addMap("height",a,r,"",r.parallaxPS));a.aoMap&&(h+=this._addMap("ao",a,r,b,r.aoBakedPS));d=a.rgbmReflection?"decodeRGBM":a.hdrReflection?"":"gammaCorrectInput";a.cubeMap&&(h=a.prefilteredCubemap?k?h+r.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,d):h+r.reflectionPrefilteredCubePS.replace(/\$DECODE/g,d):h+r.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,a.rgbmReflection?"textureCubeRGBM":
a.hdrReflection?"textureCube":"textureCubeSRGB"));a.sphereMap&&(f=16<e.fragmentUniformsCount?r.reflectionSpherePS:r.reflectionSphereLowPS,f=f.replace(/\$texture2DSAMPLE/g,a.rgbmReflection?"texture2DRGBM":a.hdrReflection?"texture2D":"texture2DSRGB"),h+=f);h=a.lightMap?h+this._addMap("light",a,r,b,r.lightmapSinglePS):a.prefilteredCubemap?k?h+r.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,d):h+r.ambientPrefilteredCubePS.replace(/\$DECODE/g,d):h+r.ambientConstantPS;a.modulateAmbient&&(h+="uniform vec3 material_ambient;\n");
0<l&&(h+=r.shadowPS);h+=r.lightDiffuseLambertPS;a.useSpecular?(h+=a.shadingModel===pc.SPECULAR_PHONG?r.lightSpecularPhongPS:r.lightSpecularBlinnPS,h=a.sphereMap||a.cubeMap||0<a.fresnelModel?0<a.fresnelModel?a.conserveEnergy?h+r.combineDiffuseSpecularPS:h+r.combineDiffuseSpecularNoConservePS:h+r.combineDiffuseSpecularOldPS:a.diffuseMap?h+r.combineDiffuseSpecularNoReflPS:h+r.combineDiffuseSpecularNoReflSeparateAmbientPS):h+=r.combineDiffusePS;h+=r.startPS;if(c||g){h+="   getViewDir(data);\n";if(a.heightMap||
a.normalMap)h+="   getTBN(data);\n";a.heightMap&&(h+="   getParallax(data);\n");h+="   getNormal(data);\n";a.useSpecular&&(h+="   getReflDir(data);\n")}h+="   getAlbedo(data);\n";if(c&&a.useSpecular||g)h+="   getSpecularity(data);\n",h+="   getGlossiness(data);\n",0<a.fresnelModel&&(h+="   getFresnel(data);\n");h+="   getOpacity(data);\n";a.alphaTest&&(h+="   if (data.alpha < alpha_ref) discard;");h+="   addAmbient(data);\n";a.modulateAmbient&&(h+="   data.diffuseLight *= material_ambient;\n");a.aoMap&&
(h+="    applyAO(data);\n");if(c||g){a.cubeMap?h+="   addCubemapReflection(data);\n":a.sphereMap&&(h+="   addSpheremapReflection(data);\n");for(b=0;b<a.lights.length;b++)s=a.lights[b].getType(),s==pc.LIGHTTYPE_DIRECTIONAL?(h+="   data.lightDirNormW = light"+b+"_direction;\n",h+="   data.atten = 1.0;\n"):(h+="   getLightDirPoint(data, light"+b+"_position);\n",h=a.lights[b].getFalloffMode()==pc.LIGHTFALLOFF_LINEAR?h+("   data.atten = getFalloffLinear(data, light"+b+"_radius);\n"):h+("   data.atten = getFalloffInvSquared(data, light"+
b+"_radius);\n"),s==pc.LIGHTTYPE_SPOT&&(h+="   data.atten *= getSpotEffect(data, light"+b+"_spotDirection, light"+b+"_innerConeAngle, light"+b+"_outerConeAngle);\n")),h+="   data.atten *= getLightDiffuse(data);\n",a.lights[b].getCastShadows()&&(s==pc.LIGHTTYPE_POINT?(c="(data, light"+b+"_shadowMap, light"+b+"_shadowParams);\n",h=a.lights[b].getNormalOffsetBias()?h+("   data.atten *= getShadowPointNormalOffset"+c):h+("   data.atten *= getShadowPoint"+c)):(c="(data, light"+b+"_shadowMatrix, light"+
b+"_shadowParams);\n",h=a.lights[b].getNormalOffsetBias()?s==pc.LIGHTTYPE_SPOT?h+("   getShadowCoordPerspNormalOffset"+c):h+("   getShadowCoordOrthoNormalOffset"+c):s==pc.LIGHTTYPE_SPOT?h+("   getShadowCoordPersp"+c):h+("   getShadowCoordOrtho"+c),h+="   data.atten *= getShadowPCF3x3(data, light"+b+"_shadowMap, light"+b+"_shadowParams);\n")),h+="   data.diffuseLight += data.atten * light"+b+"_color;\n",a.useSpecular&&(h+="   data.atten *= getLightSpecular(data);\n",h+="   data.specularLight += data.atten * light"+
b+"_color;\n"),h+="\n"}h+="\n";a.aoMap&&a.occludeSpecular&&(h+="    occludeSpecular(data);\n");h+=r.endPS;h+=m(e,"fs_clamp");h+=m(e,"common_main_end");return{attributes:v,vshader:y,fshader:h}}};pc.programlib.pick={generateKey:function(e,a){var b="pick";a.skin&&(b+="_skin");return b},createShaderDefinition:function(e,a){var b={vertex_position:pc.SEMANTIC_POSITION};a.skin&&(b.vertex_boneWeights=pc.SEMANTIC_BLENDWEIGHT,b.vertex_boneIndices=pc.SEMANTIC_BLENDINDICES);var c=pc.programlib.getSnippet,d;d=""+c(e,"vs_transform_decl");a.skin&&(d+=c(e,"vs_skin_decl"));d+=c(e,"common_main_begin");a.skin?(d+="    mat4 modelMatrix = vertex_boneWeights.x * getBoneMatrix(vertex_boneIndices.x) +\n                       vertex_boneWeights.y * getBoneMatrix(vertex_boneIndices.y) +\n",
d+="                       vertex_boneWeights.z * getBoneMatrix(vertex_boneIndices.z) +\n",d+="                       vertex_boneWeights.w * getBoneMatrix(vertex_boneIndices.w);\n"):d+="    mat4 modelMatrix = matrix_model;\n";d+="\n";d+="    vec4 positionW = modelMatrix * vec4(vertex_position, 1.0);\n";d+="    gl_Position = matrix_viewProjection * positionW;\n\n";var g=d+=c(e,"common_main_end");d=c(e,"fs_precision");d+=c(e,"fs_flat_color_decl");d+=c(e,"common_main_begin");d+=c(e,"fs_flat_color");
d+=c(e,"common_main_end");return{attributes:b,vshader:g,fshader:d}}};pc.programlib.skybox={generateKey:function(e,a){return"skybox"+a.rgbm+" "+a.hdr+" "+a.fixSeams+""+a.toneMapping+""+a.gamma},createShaderDefinition:function(e,a){var b=pc.programlib.getSnippet,c=pc.shaderChunks;return{attributes:{aPosition:pc.SEMANTIC_POSITION},vshader:"attribute vec3 aPosition;\n\nuniform mat4 matrix_view;\nuniform mat4 matrix_projection;\n\nvarying vec3 vViewDir;\n\nvoid main(void)\n{\n    mat4 view = matrix_view;\n    view[3][0] = view[3][1] = view[3][2] = 0.0;\n    gl_Position = matrix_projection * view * vec4(aPosition, 1.0);\n    gl_Position.z = gl_Position.w - 0.00001;\n    vViewDir = aPosition;\n}",
fshader:b(e,"fs_precision")+(a.fixSeams?c.fixCubemapSeamsStretchPS:c.fixCubemapSeamsNonePS)+(a.hdr?c.defaultGamma+c.defaultTonemapping+c.rgbmPS+c.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,a.rgbm?"textureCubeRGBM":a.hdr?"textureCube":"textureCubeSRGB"):c.skyboxPS)}}};pc.extend(pc,function(){var e=function(a){this.device=a;this.depthMap=this.shader=null;this.vertexBuffer=pc.createFullscreenQuad(a);this.needsDepthBuffer=!1};e.prototype={render:function(){}};return{PostEffect:e,createFullscreenQuad:function(a){var b=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:2,type:pc.ELEMENTTYPE_FLOAT32}]),a=new pc.VertexBuffer(a,b,4),b=new pc.VertexIterator(a);b.element[pc.SEMANTIC_POSITION].set(-1,-1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,-1);b.next();
b.element[pc.SEMANTIC_POSITION].set(-1,1);b.next();b.element[pc.SEMANTIC_POSITION].set(1,1);b.end();return a},drawFullscreenQuad:function(a,b,c,d,g){a.setRenderTarget(b);a.updateBegin();var e=null!==b?b.width:a.width,b=null!==b?b.height:a.height,k=0,m=0;g&&(k=g.x*e,m=g.y*b,e*=g.z,b*=g.w);a.setViewport(k,m,e,b);a.setScissor(k,m,e,b);g=a.getBlending();e=a.getDepthTest();b=a.getDepthWrite();a.setBlending(!1);a.setDepthTest(!1);a.setDepthWrite(!1);a.setVertexBuffer(c,0);a.setShader(d);a.draw({type:pc.PRIMITIVE_TRISTRIP,
base:0,count:4,indexed:!1});a.setBlending(g);a.setDepthTest(e);a.setDepthWrite(b);a.updateEnd()}}}());pc.extend(pc,function(){function e(a,b){this.app=a;this.camera=b;this.effects=[];this.enabled=!1;this.depthTarget=null;this.renderTargetScale=1;this.resizeTimeout=null;b.on("set_rect",this.onCameraRectChanged,this)}e.prototype={_createOffscreenTarget:function(a){var b=this.camera.rect,b=new pc.Texture(this.app.graphicsDevice,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:Math.floor(b.z*this.app.graphicsDevice.width*this.renderTargetScale),height:Math.floor(b.w*this.app.graphicsDevice.height*this.renderTargetScale)});
b.minFilter=pc.FILTER_NEAREST;b.magFilter=pc.FILTER_NEAREST;b.addressU=pc.ADDRESS_CLAMP_TO_EDGE;b.addressV=pc.ADDRESS_CLAMP_TO_EDGE;return new pc.RenderTarget(this.app.graphicsDevice,b,{depth:a})},_setDepthTarget:function(a){this.depthTarget!==a&&(this.depthTarget&&this.depthTarget.destroy(),this.depthTarget=a);this.camera.camera._depthTarget=a},setRenderTargetScale:function(a){this.renderTargetScale=a;this.resizeRenderTargets()},addEffect:function(a){var b=0===this.effects.length,c=this.effects,
d={effect:a,inputTarget:this._createOffscreenTarget(b),outputTarget:null};a.needsDepthBuffer&&(this.depthTarget||this._setDepthTarget(this._createOffscreenTarget(!0)),a.depthMap=this.depthTarget.colorBuffer);b&&(this.camera.renderTarget=d.inputTarget);c.push(d);a=c.length;1<a&&(c[a-2].outputTarget=d.inputTarget);this.enable()},removeEffect:function(a){for(var b=-1,c=0,d=this.effects.length;c<d;c++)if(this.effects[c].effect===a){b=c;break}0<=b&&(0<b?this.effects[b-1].outputTarget=b+1<this.effects.length?
this.effects[b+1].inputTarget:null:1<this.effects.length&&(this.effects[1].inputTarget._depth||(this.effects[1].inputTarget.destroy(),this.effects[1].inputTarget=this._createOffscreenTarget(!0)),this.camera.renderTarget=this.effects[1].inputTarget),this.effects[b].inputTarget.destroy(),this.effects.splice(b,1));if(this.depthTarget){a=!1;c=0;for(d=this.effects.length;c<d;c++)if(this.effects[c].effect.needsDepthBuffer){a=!0;break}a||this._setDepthTarget(null)}0===this.effects.length&&this.disable()},
destroy:function(){this.depthTarget&&(this.depthTarget.destroy(),this.depthTarget=null);for(var a=0,b=this.effects.length;a<b;a++)this.effects[a].inputTarget.destroy();this.effects.length=0;this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var a=this.effects,b=this.camera;this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this);b.camera.setRect(0,0,1,1);this.command=new pc.Command(pc.LAYER_FX,pc.BLEND_NONE,function(){if(this.enabled&&b.data.isRendering){var c=
null,d=a.length;if(d){b.renderTarget=a[0].inputTarget;this._setDepthTarget(this.depthTarget);for(var e=0;e<d;e++){var f=a[e];e===d-1&&(c=b.rect);f.effect.render(f.inputTarget,f.outputTarget,c)}}}}.bind(this));this.app.scene.drawCalls.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1;this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this);this.camera.renderTarget=null;this.camera.camera._depthTarget=null;var a=this.camera.rect;this.camera.camera.setRect(a.x,a.y,
a.z,a.w);a=this.app.scene.drawCalls.indexOf(this.command);0<=a&&this.app.scene.drawCalls.splice(a,1)}},_onCanvasResized:function(){this.resizeTimeout&&clearTimeout(this.resizeTimeout);this.resizeTimeout=setTimeout(this.resizeRenderTargets.bind(this),500)},resizeRenderTargets:function(){var a=this.camera.rect,b=Math.floor(a.z*this.app.graphicsDevice.width*this.renderTargetScale),a=Math.floor(a.w*this.app.graphicsDevice.height*this.renderTargetScale),c=this.effects;this.depthTarget&&(this.depthTarget.width!==
b&&this.depthTarget.height!==a)&&this._setDepthTarget(this._createOffscreenTarget(!0));for(var d=0,e=c.length;d<e;d++){var f=c[d];if(f.inputTarget.width!==b||f.inputTarget.height!==a)f.inputTarget.destroy(),f.inputTarget=this._createOffscreenTarget(f.effect.needsDepthBuffer||0===d),f.effect.needsDepthBuffer&&(f.depthMap=this.depthTarget),0<d?c[d-1].outputTarget=f.inputTarget:this.camera.renderTarget=f.inputTarget}},onCameraRectChanged:function(){this.enabled&&(this.camera.camera.setRect(0,0,1,1),
this.resizeRenderTargets())}};return{PostEffectQueue:e}}());(function(){var e={BLEND_SUBTRACTIVE:0,BLEND_ADDITIVE:1,BLEND_NORMAL:2,BLEND_NONE:3,BLEND_PREMULTIPLIED:4,BLEND_MULTIPLICATIVE:5,FOG_NONE:"none",FOG_LINEAR:"linear",FOG_EXP:"exp",FOG_EXP2:"exp2",FRESNEL_NONE:0,FRESNEL_SIMPLE:1,FRESNEL_SCHLICK:2,FRESNEL_COMPLEX:3,LAYER_HUD:0,LAYER_GIZMO:1,LAYER_FX:2,LAYER_WORLD:3,LIGHTTYPE_DIRECTIONAL:0,LIGHTTYPE_POINT:1,LIGHTTYPE_SPOT:2,LIGHTFALLOFF_LINEAR:0,LIGHTFALLOFF_INVERSESQUARED:1,PARTICLESORT_NONE:0,PARTICLESORT_DISTANCE:1,PARTICLESORT_NEWER_FIRST:2,PARTICLESORT_OLDER_FIRST:3,
PARTICLEMODE_GPU:0,PARTICLEMODE_CPU:1,EMITTERSHAPE_BOX:0,EMITTERSHAPE_SPHERE:1,PROJECTION_PERSPECTIVE:0,PROJECTION_ORTHOGRAPHIC:1,RENDERSTYLE_SOLID:0,RENDERSTYLE_WIREFRAME:1,RENDERSTYLE_POINTS:2,SPECULAR_PHONG:0,SPECULAR_BLINN:1,TONEMAP_LINEAR:0,TONEMAP_FILMIC:1};pc.extend(pc,e);pc.scene={};pc.extend(pc.scene,e)})();
pc.extend(pc,function(){var e=function(){this.drawCalls=[];this.shadowCasters=[];this.fog=pc.FOG_NONE;this.fogColor=new pc.Color(0,0,0);this.fogStart=1;this.fogEnd=1E3;this.fogDensity=0;this.ambientLight=new pc.Color(0,0,0);this._gammaCorrection=!1;this._toneMapping=0;this.exposure=1;this._skyboxModel=this._skyboxCubeMap=this._prefilteredCubeMap4=this._prefilteredCubeMap8=this._prefilteredCubeMap16=this._prefilteredCubeMap32=this._prefilteredCubeMap64=this._prefilteredCubeMap128=null;this._models=
[];this._lights=[];this._globalLights=[];this._localLights=[[],[]];this.updateShaders=!0};Object.defineProperty(e.prototype,"fog",{get:function(){return this._fog},set:function(a){a!==this._fog&&(this._fog=a,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(a){a!==this._gammaCorrection&&(this._gammaCorrection=a,pc.shaderChunks.defaultGamma=a?pc.shaderChunks.gamma2_2PS:pc.shaderChunks.gamma1_0PS,this.updateShaders=
!0)}});Object.defineProperty(e.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(a){a!==this._toneMapping&&(this._toneMapping=a,pc.shaderChunks.defaultTonemapping=a?pc.shaderChunks.tonemappingFilmicPS:pc.shaderChunks.tonemappingLinearPS,this.updateShaders=!0)}});Object.defineProperty(e.prototype,"skybox",{get:function(){return this._skyboxCubeMap},set:function(a){a!==this._skyboxCubeMap&&(this._skyboxCubeMap=a,this._skyboxModel&&this.containsModel(this._skyboxModel)&&
this.removeModel(this._skyboxModel),this._skyboxModel=null,this.updateShaders=!0)}});e.prototype._updateShaders=function(a){var b;if(this._skyboxCubeMap&&!this._skyboxModel){var c=new pc.Material,d=this;c.updateShader=function(){var b=a.getProgramLibrary().getProgram("skybox",{rgbm:d._skyboxCubeMap.rgbm,hdr:d._skyboxCubeMap.rgbm||d._skyboxCubeMap.format===pc.PIXELFORMAT_RGBA32F,fixSeams:d._skyboxCubeMap.fixCubemapSeams,gamma:d.gammaCorrection,toneMapping:d.toneMapping});this.setShader(b)};c.updateShader();
c.setParameter("texture_cubeMap",this._skyboxCubeMap);c.setParameter("material_cubemapSize",this._skyboxCubeMap.width);c.cull=pc.CULLFACE_NONE;b=new pc.GraphNode;var e=pc.createBox(a),c=new pc.MeshInstance(b,e,c),e=new pc.Model;e.graph=b;e.meshInstances=[c];this._skyboxModel=e;this.addModel(e)}c=[];e=this.drawCalls;for(b=0;b<e.length;b++){var f=e[b];void 0!==f.material&&-1===c.indexOf(f.material)&&c.push(f.material)}for(b=0;b<c.length;b++)c[b].updateShader(a,this)};e.prototype.getModels=function(){return this._models};
e.prototype.addModel=function(a){var b;if(-1===this._models.indexOf(a)){this._models.push(a);var c=a.getMaterials();for(b=0;b<c.length;b++)c[b].scene=this;var d=a.meshInstances.length;for(b=0;b<d;b++)c=a.meshInstances[b],-1===this.drawCalls.indexOf(c)&&this.drawCalls.push(c),c.castShadow&&-1===this.shadowCasters.indexOf(c)&&this.shadowCasters.push(c);a=a.getLights();b=0;for(len=a.length;b<len;b++)this.addLight(a[b])}};e.prototype.removeModel=function(a){var b,c=this._models.indexOf(a);if(-1!==c){this._models.splice(c,
1);c=a.getMaterials();for(b=0;b<c.length;b++)c[b].scene=null;var d,e=a.meshInstances.length;for(b=0;b<e;b++)d=a.meshInstances[b],c=this.drawCalls.indexOf(d),-1!==c&&this.drawCalls.splice(c,1),d.castShadow&&(c=this.shadowCasters.indexOf(d),-1!==c&&this.shadowCasters.splice(c,1));a=a.getLights();b=0;for(len=a.length;b<len;b++)this.removeLight(a[b])}};e.prototype.containsModel=function(a){return 0<=this._models.indexOf(a)};e.prototype.addLight=function(a){-1!==this._lights.indexOf(a)?console.warn("pc.Scene#addLight: light is already in the scene"):
(this._lights.push(a),a._scene=this,this.updateShaders=!0)};e.prototype.removeLight=function(a){var b=this._lights.indexOf(a);-1===b?console.warn("pc.Scene#removeLight: light is not in the scene"):(this._lights.splice(b,1),a._scene=null,this.updateShaders=!0)};e.prototype.update=function(){for(var a=0,b=this._models.length;a<b;a++)this._models[a].getGraph().syncHierarchy()};return{Scene:e}}());pc.extend(pc,function(){function e(a,b){return a.distSqr&&b.distSqr?b.distSqr-a.distSqr:b.key-a.key}function a(a,b){var c;if(b.getType()===pc.LIGHTTYPE_POINT){c=b._shadowResolution;c=new pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:c,height:c,cubemap:!0,autoMipmap:!1});c.minFilter=pc.FILTER_NEAREST;c.magFilter=pc.FILTER_NEAREST;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;for(var d=[],e=0;6>e;e++){var g=new pc.RenderTarget(a,c,{face:e,depth:!0});d.push(g)}c=d;b._shadowCamera.setRenderTarget(c[0]);
b._shadowCubeMap=c}else c=new pc.Texture(a,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:b._shadowResolution,height:b._shadowResolution,autoMipmap:!1}),c.minFilter=pc.FILTER_NEAREST,c.magFilter=pc.FILTER_NEAREST,c.addressU=pc.ADDRESS_CLAMP_TO_EDGE,c.addressV=pc.ADDRESS_CLAMP_TO_EDGE,c=new pc.RenderTarget(a,c,!0),b._shadowCamera.setRenderTarget(c)}function b(a){this.device=a;a=this.device.getProgramLibrary();this._depthProgStatic=a.getProgram("depthrgba",{skin:!1,opacityMap:!1});this._depthProgSkin=a.getProgram("depthrgba",
{skin:!0,opacityMap:!1});this._depthProgStaticOp=a.getProgram("depthrgba",{skin:!1,opacityMap:!0});this._depthProgSkinOp=a.getProgram("depthrgba",{skin:!0,opacityMap:!0});this._depthShaderStatic=a.getProgram("depth",{skin:!1});this._depthShaderSkin=a.getProgram("depth",{skin:!0});this._depthProgStaticPoint=a.getProgram("depthrgba",{skin:!1,opacityMap:!1,point:!0});this._depthProgSkinPoint=a.getProgram("depthrgba",{skin:!0,opacityMap:!1,point:!0});this._depthProgStaticOpPoint=a.getProgram("depthrgba",
{skin:!1,opacityMap:!0,point:!0});this._depthProgSkinOpPoint=a.getProgram("depthrgba",{skin:!0,opacityMap:!0,point:!0});a=this.device.scope;this.projId=a.resolve("matrix_projection");this.viewId=a.resolve("matrix_view");this.viewId3=a.resolve("matrix_view3");this.viewInvId=a.resolve("matrix_viewInverse");this.viewProjId=a.resolve("matrix_viewProjection");this.viewPosId=a.resolve("view_position");this.nearClipId=a.resolve("camera_near");this.farClipId=a.resolve("camera_far");this.lightRadiusId=a.resolve("light_radius");
this.fogColorId=a.resolve("fog_color");this.fogStartId=a.resolve("fog_start");this.fogEndId=a.resolve("fog_end");this.fogDensityId=a.resolve("fog_density");this.modelMatrixId=a.resolve("matrix_model");this.normalMatrixId=a.resolve("matrix_normal");this.poseMatrixId=a.resolve("matrix_pose[0]");this.boneTextureId=a.resolve("texture_poseMap");this.boneTextureSizeId=a.resolve("texture_poseMapSize");this.alphaTestId=a.resolve("alpha_ref");this.shadowEnableId=a.resolve("shadow_enable");this._shadowAabb=
new pc.shape.Aabb;this._sceneAabb=new pc.shape.Aabb;this._shadowState={blend:!1};this.centroid=new pc.Vec3;this.fogColor=new Float32Array(3);this.ambientColor=new Float32Array(3)}var c=(new pc.Mat4).setScale(0.5,0.5,0.5),d=(new pc.Mat4).setTranslate(0.5,0.5,0.5),g=(new pc.Mat4).mul2(d,c),f=(new pc.Mat4).setFromAxisAngle(pc.Vec3.RIGHT,-90),k=new pc.Mat4,m=new pc.Mat4,h=new pc.Mat4,n=new pc.Mat4,l=new pc.Mat4,r=new pc.Mat3,v=new pc.Mat4,u=new pc.Mat4,C=[];for(i=0;8>i;i++)C.push(new pc.Vec3);pc.extend(b.prototype,
{setCamera:function(a){var b=a.getProjectionMatrix();this.projId.setValue(b.data);var c=a._node.getPosition(),d=a._node.getRotation();n.setTRS(c,d,pc.Vec3.ONE);this.viewInvId.setValue(n.data);l.copy(n).invert();this.viewId.setValue(l.data);r.data[0]=l.data[0];r.data[1]=l.data[1];r.data[2]=l.data[2];r.data[3]=l.data[4];r.data[4]=l.data[5];r.data[5]=l.data[6];r.data[6]=l.data[8];r.data[7]=l.data[9];r.data[8]=l.data[10];this.viewId3.setValue(r.data);v.mul2(b,l);this.viewProjId.setValue(v.data);this.viewPosId.setValue(a._node.getPosition().data);
this.nearClipId.setValue(a.getNearClip());this.farClipId.setValue(a.getFarClip());a._frustum.update(b,l);b=this.device;d=a.getRenderTarget();b.setRenderTarget(d);b.updateBegin();var c=a.getRect(),e=d?d.width:b.width,g=d?d.height:b.height,d=Math.floor(c.x*e),f=Math.floor(c.y*g),e=Math.floor(c.width*e),c=Math.floor(c.height*g);b.setViewport(d,f,e,c);b.setScissor(d,f,e,c);b.clear(a.getClearOptions())},dispatchGlobalLights:function(a){var b=a._globalLights,c=b.length,d,e=this.device.scope;this.ambientColor[0]=
a.ambientLight.r;this.ambientColor[1]=a.ambientLight.g;this.ambientColor[2]=a.ambientLight.b;if(a.gammaCorrection)for(d=0;3>d;d++)this.ambientColor[d]=Math.pow(this.ambientColor[d],2.2);e.resolve("light_globalAmbient").setValue(this.ambientColor);e.resolve("exposure").setValue(a.exposure);for(d=0;d<c;d++){var g=b[d],f=g._node.getWorldTransform(),h="light"+d;e.resolve(h+"_color").setValue(a.gammaCorrection?g._linearFinalColor.data:g._finalColor.data);f.getY(g._direction).scale(-1);e.resolve(h+"_direction").setValue(g._direction.normalize().data);
g.getCastShadows()&&(f=this.device.extDepthTexture?g._shadowCamera._renderTarget._depthTexture:g._shadowCamera._renderTarget.colorBuffer,e.resolve(h+"_shadowMap").setValue(f),e.resolve(h+"_shadowMatrix").setValue(g._shadowMatrix.data),e.resolve(h+"_shadowParams").setValue([g._shadowResolution,g._normalOffsetBias,g._shadowBias]))}},dispatchLocalLights:function(a){var b,c,d,e,g;b=a._localLights;e=b[pc.LIGHTTYPE_POINT-1];var f=b[pc.LIGHTTYPE_SPOT-1],h=a._globalLights.length,k=e.length,m=f.length,l=this.device.scope;
for(b=0;b<k;b++)d=e[b],c=d._node.getWorldTransform(),g="light"+(h+b),l.resolve(g+"_radius").setValue(d._attenuationEnd),l.resolve(g+"_color").setValue(a.gammaCorrection?d._linearFinalColor.data:d._finalColor.data),c.getTranslation(d._position),l.resolve(g+"_position").setValue(d._position.data),d.getCastShadows()&&(c=this.device.extDepthTexture?d._shadowCamera._renderTarget._depthTexture:d._shadowCamera._renderTarget.colorBuffer,l.resolve(g+"_shadowMap").setValue(c),l.resolve(g+"_shadowMatrix").setValue(d._shadowMatrix.data),
l.resolve(g+"_shadowParams").setValue([d._shadowResolution,d._normalOffsetBias,d._shadowBias,d.getAttenuationEnd()]));for(b=0;b<m;b++)e=f[b],c=e._node.getWorldTransform(),g="light"+(h+k+b),l.resolve(g+"_innerConeAngle").setValue(e._innerConeAngleCos),l.resolve(g+"_outerConeAngle").setValue(e._outerConeAngleCos),l.resolve(g+"_radius").setValue(e._attenuationEnd),l.resolve(g+"_color").setValue(a.gammaCorrection?e._linearFinalColor.data:e._finalColor.data),c.getTranslation(e._position),l.resolve(g+"_position").setValue(e._position.data),
c.getY(e._direction).scale(-1),l.resolve(g+"_spotDirection").setValue(e._direction.data),e.getCastShadows()&&(c=this.device.extDepthTexture?e._shadowCamera._renderTarget._depthTexture:e._shadowCamera._renderTarget.colorBuffer,l.resolve(g+"_shadowMap").setValue(c),l.resolve(g+"_shadowMatrix").setValue(e._shadowMatrix.data),l.resolve(g+"_shadowParams").setValue([e._shadowResolution,e._normalOffsetBias,e._shadowBias]))},render:function(b,c){var d=this.device,l=d.scope;b._activeCamera=c;b.updateShaders&&
(b._updateShaders(d),b.updateShaders=!1);var n=b._lights,r=b.drawCalls,v=b.shadowCasters,G,K,I,F,D,B,E,L=null;G=0;for(numDrawCalls=b.drawCalls.length;G<numDrawCalls;G++)F=b.drawCalls[G],F.skinInstance&&F.skinInstance.updateMatrixPalette();b._globalLights.length=0;b._localLights[0].length=0;for(G=b._localLights[1].length=0;G<n.length;G++){var J=n[G];J.getEnabled()&&(J.getType()===pc.LIGHTTYPE_DIRECTIONAL?b._globalLights.push(J):b._localLights[J.getType()===pc.LIGHTTYPE_POINT?0:1].push(J))}J=c._node.getPosition();
G=0;for(numDrawCalls=r.length;G<numDrawCalls;G++)if(F=r[G],!F.command&&(D=F,D.layer===pc.LAYER_WORLD))if(D.material.blendType===pc.BLEND_NORMAL||D.material.blendType===pc.BLEND_PREMULTIPLIED){D.syncAabb();var O=D.aabb.center,P=O.x-J.x;F=O.y-J.y;O=O.z-J.z;D.distSqr=P*P+F*F+O*O}else void 0!==D.distSqr&&delete D.distSqr;r.sort(e);if(c._depthTarget){J=c.getRenderTarget();c.setRenderTarget(c._depthTarget);this.setCamera(c);P=d.getBlending();d.setBlending(!1);G=0;for(numDrawCalls=r.length;G<numDrawCalls;G++){F=
r[G];if(!F.command&&F.drawToDepth){D=F;B=D.mesh;this.modelMatrixId.setValue(D.node.worldTransform.data);if(D.skinInstance){if(d.supportsBoneTextures){this.boneTextureId.setValue(D.skinInstance.boneTexture);var R=D.skinInstance.boneTexture.width,Q=D.skinInstance.boneTexture.height;this.boneTextureSizeId.setValue([R,Q])}else this.poseMatrixId.setValue(D.skinInstance.matrixPalette);d.setShader(this._depthShaderSkin)}else d.setShader(this._depthShaderStatic);D=D.renderStyle;d.setVertexBuffer(B.vertexBuffer,
0);d.setIndexBuffer(B.indexBuffer[D]);d.draw(B.primitive[D])}c.setRenderTarget(J)}d.setBlending(P)}for(G=0;G<n.length;G++)if(J=n[G],P=J.getType(),J.getCastShadows()&&J.getEnabled()){F=d;O=J;D=O._shadowCamera;K=void 0;null===D?(D=O,K=pc.CLEARFLAG_DEPTH,F.extDepthTexture||(K|=pc.CLEARFLAG_COLOR),B=new pc.Camera,B.setClearOptions({color:[1,1,1,1],depth:1,flags:K}),B._node=new pc.GraphNode,D=D._shadowCamera=B,a(F,O)):(K=D.getRenderTarget(),(K.width!==O._shadowResolution||K.height!==O._shadowResolution)&&
a(F,O));F=D;var O=1,M;if(P===pc.LIGHTTYPE_DIRECTIONAL){K=J.getShadowDistance();D=c;B=this.centroid;B.set(0,0,0.5*-(K+D._nearClip));D._node.getWorldTransform().transformPoint(B,B);F._node.setPosition(this.centroid);F._node.setRotation(J._node.getRotation());F._node.rotateLocal(-90,0,0);D=c;B=C;I=D;E=I.getNearClip();R=I.getFov()*Math.PI/180;Q=I.getAspectRatio();I=I.getProjection();var N=M=void 0,N=I===pc.PROJECTION_PERSPECTIVE?Math.tan(R/2)*E:D._orthoHeight;M=N*Q;B[0].x=M;B[0].y=-N;B[0].z=-E;B[1].x=
M;B[1].y=N;B[1].z=-E;B[2].x=-M;B[2].y=N;B[2].z=-E;B[3].x=-M;B[3].y=-N;B[3].z=-E;I===pc.PROJECTION_PERSPECTIVE&&(N=Math.tan(R/2)*K,M=N*Q);B[4].x=M;B[4].y=-N;B[4].z=-K;B[5].x=M;B[5].y=N;B[5].z=-K;B[6].x=-M;B[6].y=N;B[6].z=-K;B[7].x=-M;B[7].y=-N;B[7].z=-K;k.copy(F._node.getWorldTransform());D=k.invert();u.mul2(D,c._node.worldTransform);for(K=0;8>K;K++)u.transformPoint(C[K],C[K]);D=B=E=1E6;R=Q=I=-1E6;for(K=0;8>K;K++)M=C[K],M.x<D&&(D=M.x),M.x>R&&(R=M.x),M.y<B&&(B=M.y),M.y>Q&&(Q=M.y),M.z<E&&(E=M.z),M.z>
I&&(I=M.z);F._node.translateLocal(0.5*-(R+D),0.5*(Q+B),I+0.25*(I-E));k.copy(F._node.getWorldTransform());F.setProjection(pc.PROJECTION_ORTHOGRAPHIC);F.setNearClip(0);F.setFarClip(1.5*(I-E));F.setAspectRatio((R-D)/(Q-B));F.setOrthoHeight(0.5*(Q-B))}else P===pc.LIGHTTYPE_SPOT?(F.setProjection(pc.PROJECTION_PERSPECTIVE),F.setNearClip(J.getAttenuationEnd()/1E3),F.setFarClip(J.getAttenuationEnd()),F.setAspectRatio(1),F.setFov(2*J.getOuterConeAngle()),k.mul2(J._node.worldTransform,f)):P===pc.LIGHTTYPE_POINT&&
(F.setProjection(pc.PROJECTION_PERSPECTIVE),F.setNearClip(J.getAttenuationEnd()/1E3),F.setFarClip(J.getAttenuationEnd()),F.setAspectRatio(1),F.setFov(90),O=6,this.viewPosId.setValue(F._node.getPosition().data),this.lightRadiusId.setValue(J.getAttenuationEnd()));P!=pc.LIGHTTYPE_POINT&&(m.copy(k).invert(),h.mul2(F.getProjectionMatrix(),m),J._shadowMatrix.mul2(g,h),F._node.worldTransform.copy(k));for(M=0;M<O;M++){P===pc.LIGHTTYPE_POINT&&(0===M?F._node.setEulerAngles(0,90,180):1===M?F._node.setEulerAngles(0,
-90,180):2===M?F._node.setEulerAngles(90,0,0):3===M?F._node.setEulerAngles(-90,0,0):4===M?F._node.setEulerAngles(0,180,180):5===M&&F._node.setEulerAngles(0,0,180),F._node.setPosition(J._node.getPosition()),F.setRenderTarget(J._shadowCubeMap[M]));this.setCamera(F);d.setBlending(!1);d.setColorWrite(!0,!0,!0,!0);d.setDepthWrite(!0);d.setDepthTest(!0);d.extDepthTexture&&d.setColorWrite(!1,!1,!1,!1);K=0;for(I=v.length;K<I;K++)D=v[K],B=D.mesh,E=D.material,d.setCullMode(E.cull),this.modelMatrixId.setValue(D.node.worldTransform.data),
E.opacityMap&&l.resolve("texture_opacityMap").setValue(E.opacityMap),D.skinInstance?(d.supportsBoneTextures?(this.boneTextureId.setValue(D.skinInstance.boneTexture),R=D.skinInstance.boneTexture.width,Q=D.skinInstance.boneTexture.height,this.boneTextureSizeId.setValue([R,Q])):this.poseMatrixId.setValue(D.skinInstance.matrixPalette),P===pc.LIGHTTYPE_POINT?d.setShader(E.opacityMap?this._depthProgSkinOpPoint:this._depthProgSkinPoint):d.setShader(E.opacityMap?this._depthProgSkinOp:this._depthProgSkin)):
P===pc.LIGHTTYPE_POINT?d.setShader(E.opacityMap?this._depthProgStaticOpPoint:this._depthProgStaticPoint):d.setShader(E.opacityMap?this._depthProgStaticOp:this._depthProgStatic),D=D.renderStyle,d.setVertexBuffer(B.vertexBuffer,0),d.setIndexBuffer(B.indexBuffer[D]),d.draw(B.primitive[D])}}this.setCamera(c);this.dispatchGlobalLights(b);this.dispatchLocalLights(b);if(b.fog!==pc.FOG_NONE){this.fogColor[0]=b.fogColor.r;this.fogColor[1]=b.fogColor.g;this.fogColor[2]=b.fogColor.b;if(b.gammaCorrection)for(G=
0;3>G;G++)this.fogColor[G]=Math.pow(this.fogColor[G],2.2);this.fogColorId.setValue(this.fogColor);b.fog===pc.FOG_LINEAR?(this.fogStartId.setValue(b.fogStart),this.fogEndId.setValue(b.fogEnd)):this.fogDensityId.setValue(b.fogDensity)}G=0;for(numDrawCalls=r.length;G<numDrawCalls;G++)if(F=r[G],F.command)F.command();else{D=F;B=D.mesh;E=D.material;l=D.node.worldTransform;n=D.normalMatrix;l.invertTo3x3(n);n.transpose();this.modelMatrixId.setValue(l.data);this.normalMatrixId.setValue(n.data);D.skinInstance&&
(d.supportsBoneTextures?(this.boneTextureId.setValue(D.skinInstance.boneTexture),R=D.skinInstance.boneTexture.width,Q=D.skinInstance.boneTexture.height,this.boneTextureSizeId.setValue([R,Q])):this.poseMatrixId.setValue(D.skinInstance.matrixPalette));this.shadowEnableId.setValue(D.receiveShadow);if(E!==L){E.shader||E.updateShader(d,b);d.setShader(E.shader);var L=E.parameters,U;for(U in L)l=L[U],l.scopeId||(l.scopeId=d.scope.resolve(U)),l.scopeId.setValue(l.data);this.alphaTestId.setValue(E.alphaTest);
d.setBlending(E.blend);d.setBlendFunction(E.blendSrc,E.blendDst);d.setBlendEquation(E.blendEquation);d.setColorWrite(E.redWrite,E.greenWrite,E.blueWrite,E.alphaWrite);d.setCullMode(E.cull);d.setDepthWrite(E.depthWrite);d.setDepthTest(E.depthTest)}d.setVertexBuffer(B.vertexBuffer,0);D=D.renderStyle;d.setIndexBuffer(B.indexBuffer[D]);d.draw(B.primitive[D]);L=E}}});return{ForwardRenderer:b}}());pc.extend(pc,function(){var e=function(){this.name="Untitled";this._labels={};this.localPosition=new pc.Vec3(0,0,0);this.localRotation=new pc.Quat(0,0,0,1);this.localScale=new pc.Vec3(1,1,1);this.localEulerAngles=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.rotation=new pc.Quat(0,0,0,1);this.eulerAngles=new pc.Vec3(0,0,0);this.localTransform=new pc.Mat4;this.dirtyLocal=!1;this.worldTransform=new pc.Mat4;this.dirtyWorld=!1;this._right=new pc.Vec3;this._up=new pc.Vec3;this._forward=new pc.Vec3;
this._parent=null;this._children=[];this._enabledInHierarchy=this._enabled=!0};Object.defineProperty(e.prototype,"right",{get:function(){return this.getWorldTransform().getX(this._right).normalize()}});Object.defineProperty(e.prototype,"up",{get:function(){return this.getWorldTransform().getY(this._up).normalize()}});Object.defineProperty(e.prototype,"forward",{get:function(){return this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}});Object.defineProperty(e.prototype,"forwards",
{get:function(){console.log("pc.GraphNode#forwards is DEPRECATED. Use pc.GraphNode#forward instead.");return this.forward}});Object.defineProperty(e.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(a){this._enabled!==a&&(this._enabled=a,(!this._parent||this._parent.enabled)&&this._notifyHierarchyStateChanged(this,a))}});pc.extend(e.prototype,{_notifyHierarchyStateChanged:function(a,b){a._onHierarchyStateChanged(b);for(var c=a._children,d=0,e=c.length;d<
e;d++)c[d]._enabled&&this._notifyHierarchyStateChanged(c[d],b)},_onHierarchyStateChanged:function(a){this._enabledInHierarchy=a},_cloneInternal:function(a){a.name=this.name;a._labels=pc.extend(this._labels,{});a.localPosition.copy(this.localPosition);a.localRotation.copy(this.localRotation);a.localScale.copy(this.localScale);a.localEulerAngles.copy(this.localEulerAngles);a.position.copy(this.position);a.rotation.copy(this.rotation);a.eulerAngles.copy(this.eulerAngles);a.localTransform.copy(this.localTransform);
a.dirtyLocal=this.dirtyLocal;a.worldTransform.copy(this.worldTransform);a.dirtyWorld=this.dirtyWorld;a._enabled=this._enabled;a._enabledInHierarchy=this._enabledInHierarchy},clone:function(){var a=new pc.GraphNode;this._cloneInternal(a);return a},find:function(a,b){var c,d=this.getChildren(),e=d.length,f=[];this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b&&f.push(this));for(c=0;c<e;++c)f=f.concat(d[c].find(a,b));return f},findOne:function(a,b){var c,d=this.getChildren(),e=d.length,f=
null;if(this[a]&&(c=this[a]instanceof Function?this[a]():this[a],c===b))return this;for(c=0;c<e;++c)if(f=d[c].findOne(a,b),null!==f)return f;return null},findByName:function(a){if(this.name===a)return this;for(var b=0;b<this._children.length;b++){var c=this._children[b].findByName(a);if(null!==c)return c}return null},findByPath:function(a){for(var a=a.split("/"),b=this,c=null,d=0,e=a.length;d<e&&b;d++){for(var f=a[d],c=null,b=b._children,k=0,m=b.length;k<m;k++)if(b[k].name==f){c=b[k];break}b=c}return c},
getPath:function(){var a=this._parent;if(a){for(var b=this.name;a&&a._parent;)b=pc.string.format("{0}/{1}",a.name,b),a=a._parent;return b}return""},getRoot:function(){var a=this.getParent();if(!a)return this;for(;a.getParent();)a=a.getParent();return a},getParent:function(){return this._parent},getChildren:function(){return this._children},getEulerAngles:function(){this.getWorldTransform().getEulerAngles(this.eulerAngles);return this.eulerAngles},getLocalEulerAngles:function(){this.localRotation.getEulerAngles(this.localEulerAngles);
return this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=!0);return this.localTransform},getName:function(){return this.name},getPosition:function(){this.getWorldTransform().getTranslation(this.position);return this.position},
getRotation:function(){this.rotation.setFromMat4(this.getWorldTransform());return this.rotation},getWorldTransform:function(){var a=[];return function(){var b=this;for(a.length=0;null!==b;)a.push(b),b=b._parent;for(b=a.length-1;0<=b;b--)a[b].sync();return this.worldTransform}}(),reparent:function(a,b){var c=this.getParent();c&&c.removeChild(this);a&&(0<=b?a.insertChild(this,b):a.addChild(this))},setLocalEulerAngles:function(){var a,b,c;switch(arguments.length){case 1:a=arguments[0].x;b=arguments[0].y;
c=arguments[0].z;break;case 3:a=arguments[0],b=arguments[1],c=arguments[2]}this.localRotation.setFromEulerAngles(a,b,c);this.dirtyLocal=!0},setLocalPosition:function(){1===arguments.length?this.localPosition.copy(arguments[0]):this.localPosition.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setLocalRotation:function(a){1===arguments.length?this.localRotation.copy(arguments[0]):this.localRotation.set(arguments[0],arguments[1],arguments[2],arguments[3]);this.dirtyLocal=!0},setLocalScale:function(){1===
arguments.length?this.localScale.copy(arguments[0]):this.localScale.set(arguments[0],arguments[1],arguments[2]);this.dirtyLocal=!0},setName:function(a){this.name=a},setPosition:function(){var a=new pc.Vec3,b=new pc.Mat4;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2]);null===this._parent?this.localPosition.copy(a):(b.copy(this._parent.getWorldTransform()).invert(),b.transformPoint(a,this.localPosition));this.dirtyLocal=!0}}(),setRotation:function(){var a=
new pc.Quat,b=new pc.Quat;return function(){1===arguments.length?a.copy(arguments[0]):a.set(arguments[0],arguments[1],arguments[2],arguments[3]);if(null===this._parent)this.localRotation.copy(a);else{var c=this._parent.getRotation();b.copy(c).invert();this.localRotation.copy(b).mul(a)}this.dirtyLocal=!0}}(),setEulerAngles:function(){var a=new pc.Quat;return function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0],c=arguments[1],
d=arguments[2]}this.localRotation.setFromEulerAngles(b,c,d);null!==this._parent&&(b=this._parent.getRotation(),a.copy(b).invert(),this.localRotation.mul2(a,this.localRotation));this.dirtyLocal=!0}}(),addChild:function(a){if(null!==a.getParent())throw Error("GraphNode is already parented");this._children.push(a);this._onInsertChild(a)},addChildAndSaveTransform:function(a){var b=a.getPosition(),c=a.getRotation(),d=a.getParent();d&&d.removeChild(a);void 0==this.tmpMat4&&(this.tmpMat4=new pc.Mat4,this.tmpQuat=
new pc.Quat);a.setPosition(this.tmpMat4.copy(this.worldTransform).invert().transformPoint(b));a.setRotation(this.tmpQuat.copy(this.getRotation()).invert().mul(c));this._children.push(a);this._onInsertChild(a)},insertChild:function(a,b){if(null!==a.getParent())throw Error("GraphNode is already parented");this._children.splice(b,0,a);this._onInsertChild(a)},_onInsertChild:function(a){a._parent=this;var b=a._enabled&&this.enabled;a._enabledInHierarchy!==b&&(a._enabledInHierarchy=b,a._notifyHierarchyStateChanged(a,
b));a.dirtyWorld=!0},removeChild:function(a){var b,c=this._children.length;a._parent=null;for(b=0;b<c;++b)if(this._children[b]===a){this._children.splice(b,1);break}},addLabel:function(a){this._labels[a]=!0},getLabels:function(){return Object.keys(this._labels)},hasLabel:function(a){return!!this._labels[a]},removeLabel:function(a){delete this._labels[a]},findByLabel:function(a,b){var c,d=this._children.length,b=b||[];this.hasLabel(a)&&b.push(this);for(c=0;c<d;++c)b=this._children[c].findByLabel(a,
b);return b},sync:function(){this.dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this.dirtyLocal=!1,this.dirtyWorld=!0);if(this.dirtyWorld){null===this._parent?this.worldTransform.copy(this.localTransform):this.worldTransform.mul2(this._parent.worldTransform,this.localTransform);this.dirtyWorld=!1;for(var a=0,b=this._children.length;a<b;a++)this._children[a].dirtyWorld=!0}},syncHierarchy:function(){var a=function(){if(this._enabled){this.sync();for(var b=
this._children,c=0,d=b.length;c<d;c++)a.call(b[c])}};return a}(),lookAt:function(){var a=new pc.Mat4,b=new pc.Vec3,c=new pc.Vec3,d=new pc.Quat;return function(){switch(arguments.length){case 1:b.copy(arguments[0]);c.copy(pc.Vec3.UP);break;case 2:b.copy(arguments[0]);c.copy(arguments[1]);break;case 3:b.set(arguments[0],arguments[1],arguments[2]);c.copy(pc.Vec3.UP);break;case 6:b.set(arguments[0],arguments[1],arguments[2]),c.set(arguments[3],arguments[4],arguments[5])}a.setLookAt(this.getPosition(),
b,c);d.setFromMat4(a);this.setRotation(d)}}(),translate:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}a.add(this.getPosition());this.setPosition(a)}}(),translateLocal:function(){var a=new pc.Vec3;return function(){switch(arguments.length){case 1:a.copy(arguments[0]);break;case 3:a.set(arguments[0],arguments[1],arguments[2])}this.localRotation.transformVector(a,a);this.localPosition.add(a);
this.dirtyLocal=!0}}(),rotate:function(){var a=new pc.Quat,b=new pc.Quat;return function(){var c,d,e;switch(arguments.length){case 1:c=arguments[0].x;d=arguments[0].y;e=arguments[0].z;break;case 3:c=arguments[0],d=arguments[1],e=arguments[2]}a.setFromEulerAngles(c,d,e);null===this._parent?this.localRotation.mul2(a,this.localRotation):(c=this.getRotation(),d=this._parent.getRotation(),b.copy(d).invert(),a.mul2(b,a),this.localRotation.mul2(a,c));this.dirtyLocal=!0}}(),rotateLocal:function(){var a=new pc.Quat;
return function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0],c=arguments[1],d=arguments[2]}a.setFromEulerAngles(b,c,d);this.localRotation.mul(a);this.dirtyLocal=!0}}()});return{GraphNode:e}}());pc.extend(pc,function(){var e=function(){this._projection=pc.PROJECTION_PERSPECTIVE;this._nearClip=0.1;this._farClip=1E4;this._fov=45;this._orthoHeight=10;this._aspect=16/9;this._projMatDirty=!0;this._projMat=new pc.Mat4;this._viewMat=new pc.Mat4;this._viewProjMat=new pc.Mat4;this._rect={x:0,y:0,width:1,height:1};this._frustum=new pc.Frustum(this._projMat,this._viewMat);this._renderTarget=null;this._clearOptions={color:[186/255,186/255,177/255,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};
this._node=null};e.prototype={clone:function(){var a=new pc.Camera;a.setProjection(this.getProjection());a.setNearClip(this.getNearClip());a.setFarClip(this.getFarClip());a.setFov(this.getFov());a.setAspectRatio(this.getAspectRatio());a.setRenderTarget(this.getRenderTarget());a.setClearOptions(this.getClearOptions());return a},worldToScreen:function(a,b,c,d){void 0===d&&(d=new pc.Vec3);var e=this.getProjectionMatrix(),f=this._node.getWorldTransform();this._viewMat.copy(f).invert();this._viewProjMat.mul2(e,
this._viewMat);this._viewProjMat.transformPoint(a,d);a=a.data;e=this._viewProjMat.data;a=a[0]*e[3]+a[1]*e[7]+a[2]*e[11]+1*e[15];d.x=0.5*(d.x/a+1)*b;d.y=0.5*(1-d.y/a)*c;return d},screenToWorld:function(a,b,c,d,e,f){void 0===f&&(f=new pc.Vec3);var k=this.getProjectionMatrix(),m=this._node.getWorldTransform();this._viewMat.copy(m).invert();this._viewProjMat.mul2(k,this._viewMat);k=this._viewProjMat.clone().invert();this._projection===pc.PROJECTION_PERSPECTIVE?(b=new pc.Vec3(2*(a/d)-1,2*((e-b)/e)-1,1),
a=k.transformPoint(b),a.scale(1/(b.x*k.data[3]+b.y*k.data[7]+b.z*k.data[11]+k.data[15])),c/=this._farClip,f.lerp(this._node.getPosition(),a,c)):(c=new pc.Vec3(2*(a/d)-1,2*((e-b)/e)-1,2*((this._farClip-c)/(this._farClip-this._nearClip))-1),k.transformPoint(c,f));return f},getAspectRatio:function(){return this._aspect},getClearOptions:function(){return this._clearOptions},getFarClip:function(){return this._farClip},getFov:function(){return this._fov},getFrustum:function(){return this._frustum},getNearClip:function(){return this._nearClip},
getOrthoHeight:function(){return this._orthoHeight},getProjection:function(){return this._projection},getProjectionMatrix:function(){if(this._projMatDirty){if(this._projection===pc.PROJECTION_PERSPECTIVE)this._projMat.setPerspective(this._fov,this._aspect,this._nearClip,this._farClip);else{var a=this._orthoHeight,b=a*this._aspect;this._projMat.setOrtho(-b,b,-a,a,this._nearClip,this._farClip)}this._projMatDirty=!1}return this._projMat},getRect:function(){return this._rect},getRenderTarget:function(){return this._renderTarget},
setAspectRatio:function(a){this._aspect=a;this._projMatDirty=!0},setClearOptions:function(a){this._clearOptions=a},setFarClip:function(a){this._farClip=a;this._projMatDirty=!0},setFov:function(a){this._fov=a;this._projMatDirty=!0},setNearClip:function(a){this._nearClip=a;this._projMatDirty=!0},setOrthoHeight:function(a){this._orthoHeight=a;this._projMatDirty=!0},setProjection:function(a){this._projection=a;this._projMatDirty=!0},setRect:function(a,b,c,d){this._rect.x=a;this._rect.y=b;this._rect.width=
c;this._rect.height=d},setRenderTarget:function(a){this._renderTarget=a}};return{Camera:e}}());pc.extend(pc,function(){var e=function(){this._type=pc.LIGHTTYPE_DIRECTIONAL;this._color=new pc.Color(0.8,0.8,0.8);this._intensity=1;this._enabled=this._castShadows=!1;this._attenuationEnd=this._attenuationStart=10;this._falloffMode=0;this._innerConeAngle=40;this._outerConeAngle=45;this._finalColor=new pc.Vec3(0.8,0.8,0.8);this._linearFinalColor=new pc.Vec3;this._position=new pc.Vec3(0,0,0);this._direction=new pc.Vec3(0,0,0);this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180);this._outerConeAngleCos=
Math.cos(this._outerConeAngle*Math.PI/180);this._shadowCamera=null;this._shadowMatrix=new pc.Mat4;this._shadowDistance=40;this._shadowResolution=1024;this._shadowBias=-5E-4;this._normalOffsetBias=0;this._node=this._scene=null};e.prototype={clone:function(){var a=new pc.Light;a.setType(this.getType());a.setColor(this.getColor());a.setIntensity(this.getIntensity());a.setCastShadows(this.getCastShadows());a.setEnabled(this.getEnabled());a.setAttenuationStart(this.getAttenuationStart());a.setAttenuationEnd(this.getAttenuationEnd());
a.setFalloffMode(this.getFalloffMode());a.setInnerConeAngle(this.getInnerConeAngle());a.setOuterConeAngle(this.getOuterConeAngle());a.setShadowBias(this.getShadowBias());a.setNormalOffsetBias(this.getNormalOffsetBias());a.setShadowResolution(this.getShadowResolution());a.setShadowDistance(this.getShadowDistance());return a},getAttenuationEnd:function(){return this._attenuationEnd},getAttenuationStart:function(){return this._attenuationStart},getFalloffMode:function(){return this._falloffMode},getCastShadows:function(){return this._castShadows},
getColor:function(){return this._color},getEnabled:function(){return this._enabled},getInnerConeAngle:function(){return this._innerConeAngle},getIntensity:function(){return this._intensity},getOuterConeAngle:function(){return this._outerConeAngle},getShadowBias:function(){return this._shadowBias},getNormalOffsetBias:function(){return this._normalOffsetBias},getShadowDistance:function(){return this._shadowDistance},getShadowResolution:function(){return this._shadowResolution},getType:function(){return this._type},
setAttenuationEnd:function(a){this._attenuationEnd=a},setAttenuationStart:function(a){this._attenuationStart=a},setFalloffMode:function(a){this._falloffMode=a;null!==this._scene&&(this._scene.updateShaders=!0)},setCastShadows:function(a){this._castShadows=a;null!==this._scene&&(this._scene.updateShaders=!0)},setColor:function(){var a,b,c;1===arguments.length?(a=arguments[0].r,b=arguments[0].g,c=arguments[0].b):3===arguments.length&&(a=arguments[0],b=arguments[1],c=arguments[2]);this._color.set(a,
b,c);var d=this._intensity;this._finalColor.set(a*d,b*d,c*d);for(a=0;3>a;a++)this._linearFinalColor.data[a]=1<=d?Math.pow(this._finalColor.data[a]/d,2.2)*d:Math.pow(this._finalColor.data[a],2.2)},setEnabled:function(a){this._enabled!==a&&(this._enabled=a,null!==this._scene&&(this._scene.updateShaders=!0))},setInnerConeAngle:function(a){this._innerConeAngle=a;this._innerConeAngleCos=Math.cos(a*Math.PI/180)},setIntensity:function(a){this._intensity=a;var b=this._color,a=this._intensity;this._finalColor.set(b.r*
a,b.g*a,b.b*a);for(b=0;3>b;b++)this._linearFinalColor.data[b]=1<=a?Math.pow(this._finalColor.data[b]/a,2.2)*a:Math.pow(this._finalColor.data[b],2.2)},setOuterConeAngle:function(a){this._outerConeAngle=a;this._outerConeAngleCos=Math.cos(a*Math.PI/180)},setShadowBias:function(a){this._shadowBias=a},setNormalOffsetBias:function(a){if(!this._normalOffsetBias&&a||this._normalOffsetBias&&!a)this._scene.updateShaders=!0;this._normalOffsetBias=a},setShadowDistance:function(a){this._shadowDistance=a},setShadowResolution:function(a){this._shadowResolution=
a},setType:function(a){this._type=a}};return{Light:e}}());pc.extend(pc,function(){var e=0,a=function(){this.name="Untitled";this.id=e++;this.shader=null;this.parameters={};this.alphaTest=0;this.blend=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;this.cull=pc.CULLFACE_BACK;this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=this.depthWrite=this.depthTest=!0;this.meshInstances=[]};Object.defineProperty(a.prototype,"blendType",{get:function(){return!this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&
this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_NONE:this.blend&&this.blendSrc===pc.BLENDMODE_SRC_ALPHA&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_NORMAL:this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_ADDITIVE:this.blend&&this.blendSrc===pc.BLENDMODE_DST_COLOR&&this.blendDst===pc.BLENDMODE_ZERO&&this.blendEquation===pc.BLENDEQUATION_ADD?
pc.BLEND_MULTIPLICATIVE:this.blend&&this.blendSrc===pc.BLENDMODE_ONE&&this.blendDst===pc.BLENDMODE_ONE_MINUS_SRC_ALPHA&&this.blendEquation===pc.BLENDEQUATION_ADD?pc.BLEND_PREMULTIPLIED:pc.BLEND_NORMAL},set:function(a){switch(a){case pc.BLEND_NONE:this.blend=!1;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ZERO;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_NORMAL:this.blend=!0;this.blendSrc=pc.BLENDMODE_SRC_ALPHA;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=
pc.BLENDEQUATION_ADD;break;case pc.BLEND_PREMULTIPLIED:this.blend=!0;this.blendSrc=pc.BLENDMODE_ONE;this.blendDst=pc.BLENDMODE_ONE_MINUS_SRC_ALPHA;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_ADDITIVE:this.blend=!0;this.blendDst=this.blendSrc=pc.BLENDMODE_ONE;this.blendEquation=pc.BLENDEQUATION_ADD;break;case pc.BLEND_MULTIPLICATIVE:this.blend=!0,this.blendSrc=pc.BLENDMODE_DST_COLOR,this.blendDst=pc.BLENDMODE_ZERO,this.blendEquation=pc.BLENDEQUATION_ADD}this._updateMeshInstanceKeys()}});
a.prototype._cloneInternal=function(a){a.name=this.name;a.id=e++;a.shader=null;a.parameters={};a.alphaTest=this.alphaTest;a.blend=this.blend;a.blendSrc=this.blendSrc;a.blendDst=this.blendDst;a.blendEquation=this.blendEquation;a.cull=this.cull;a.depthTest=this.depthTest;a.depthWrite=this.depthWrite;a.redWrite=this.redWrite;a.greenWrite=this.greenWrite;a.blueWrite=this.blueWrite;a.alphaWrite=this.alphaWrite;a.meshInstances=[]};a.prototype.clone=function(){var a=new pc.Material;this._cloneInternal(a);
return a};a.prototype._updateMeshInstanceKeys=function(){var a,c=this.meshInstances;for(a=0;a<c.length;a++)c[a].updateKey()};a.prototype.updateShader=function(){};a.prototype.getName=function(){return this.name};a.prototype.setName=function(a){this.name=a};a.prototype.clearParameters=function(){this.parameters={}};a.prototype.getParameters=function(){return this.parameters};a.prototype.getParameter=function(a){return this.parameters[a]};a.prototype.setParameter=function(a,c){var d=this.parameters[a];
d?d.data=c:this.parameters[a]={scopeId:null,data:c}};a.prototype.deleteParameter=function(a){this.parameters[a]&&delete this.parameters[a]};a.prototype.setParameters=function(){for(var a in this.parameters){var c=this.parameters[a];c.scopeId||(c.scopeId=device.scope.resolve(a));c.scopeId.setValue(c.data)}};a.prototype.getShader=function(){return this.shader};a.prototype.setShader=function(a){this.shader=a};a.prototype.update=function(){throw Error("Not Implemented in base class");};a.prototype.init=
function(){throw Error("Not Implemented in base class");};return{Material:a}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.update()},pc.Material);pc.extend(e.prototype,{clone:function(){var a=new pc.BasicMaterial;Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.colorMap=this.colorMap;a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data);this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(a){var b=
{skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("basic",b)}});return{BasicMaterial:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){},pc.Material);pc.extend(e.prototype,{clone:function(){var a=new pc.DepthMaterial;Material.prototype._cloneInternal.call(this,a);a.update();return a},update:function(){},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("depth",b)}});return{DepthMaterial:e}}());pc.extend(pc,function(){new pc.Vec3;new pc.Vec3;var e,a=function(a,c,d,e){a[c+"Map"]=null;a[c+"MapTiling"]=new pc.Vec2(1,1);a[c+"MapOffset"]=new pc.Vec2(0,0);a[c+"MapTransform"]=null;a[c+"MapUv"]=d;0<e&&(a[c+"MapChannel"]=1<e?"rgb":"g");pc._matTex2D||(pc._matTex2D=[]);pc._matTex2D[c]=e};e=pc.inherits(function(){this.reset();this.update()},pc.Material);pc.extend(e.prototype,{reset:function(){if(!pc._matSerialProps){this._tempProps=[];for(var b in this)this.hasOwnProperty(b)&&(this._tempProps[b]=!0)}this.ambient=
new pc.Color(0.7,0.7,0.7);this.diffuse=new pc.Color(1,1,1);this.specular=new pc.Color(0,0,0);this.shininess=25;this.emissive=new pc.Color(0,0,0);this.opacity=1;this.blendType=pc.BLEND_NONE;this.heightMapFactor=this.bumpiness=1;a(this,"diffuse",0,3);a(this,"specular",0,3);a(this,"emissive",0,3);a(this,"normal",0,-1);a(this,"gloss",0,1);a(this,"opacity",0,1);a(this,"height",0,1);a(this,"ao",0,1);a(this,"light",1,3);this.sphereMap=this.prefilteredCubeMap4=this.prefilteredCubeMap8=this.prefilteredCubeMap16=
this.prefilteredCubeMap32=this.prefilteredCubeMap64=this.prefilteredCubeMap128=this.cubeMap=null;this.reflectivity=1;this.aoUvSet=0;this.blendMapsWithColors=!0;this.specularAntialias=!1;this.occludeSpecular=this.conserveEnergy=!0;this.shadingModel=pc.SPECULAR_PHONG;this.fresnelModel=pc.FRESNEL_NONE;this.fresnelFactor=0;this.emissiveMapTint=this.specularMapTint=this.diffuseMapTint=this.ambientTint=!1;this.emissiveIntensity=1;if(!pc._matSerialProps){pc._matSerialProps=[];for(var c in this)this.hasOwnProperty(c)&&
!this._tempProps[c]&&pc._matSerialProps.push(c)}this.ambientUniform=new Float32Array(3);this.diffuseUniform=new Float32Array(3);this.specularUniform=new Float32Array(3);this.emissiveUniform=new Float32Array(3)},clone:function(){var a=new pc.PhongMaterial;pc.Material.prototype._cloneInternal.call(this,a);for(var c,d=0;d<pc._matSerialProps.length;d++)c=pc._matSerialProps[d],void 0!==this[c]&&(this[c]&&this[c].copy?a[c].copy(this[c]):a[c]=this[c]);a.update();return a},init:function(a){this.reset();this.name=
a.name;for(var c=0;c<a.parameters.length;c++){var d=a.parameters[c];if("vec3"===d.type)this[d.name]=new pc.Color(d.data[0],d.data[1],d.data[2]);else if("vec2"===d.type)this[d.name]=new pc.Vec2(d.data[0],d.data[1]);else if("texture"===d.type){var e=d.name;if(d.data)if(d.data instanceof pc.Texture)d=d.data;else throw Error("PhongMaterial.init() expects textures to already be created");else d=null;this[e]=d}else"bumpMapFactor"===d.name?this.bumpiness=d.data:this[d.name]=d.data}this.update()},_updateMapTransform:function(a,
c,d){a=a||new pc.Vec4;a.set(c.x,c.y,d.x,d.y);return 1==a.x&&1==a.y&&0==a.z&&0==a.w?null:a},_collectLights:function(a,c,d){for(var e=0;e<c.length;e++)c[e].getEnabled()&&c[e].getType()==a&&d.push(c[e])},_updateMap:function(a){a+="Map";if(this[a]){this.setParameter("texture_"+a,this[a]);var c=a+"Transform";this[c]=this._updateMapTransform(this[c],this[a+"Tiling"],this[a+"Offset"]);this[c]&&this.setParameter("texture_"+c,this[c].data)}},update:function(){this.clearParameters();this.ambientUniform[0]=
this.ambient.r;this.ambientUniform[1]=this.ambient.g;this.ambientUniform[2]=this.ambient.b;this.setParameter("material_ambient",this.ambientUniform);if(!this.diffuseMap||this.diffuseMapTint)this.diffuseUniform[0]=this.diffuse.r,this.diffuseUniform[1]=this.diffuse.g,this.diffuseUniform[2]=this.diffuse.b,this.setParameter("material_diffuse",this.diffuseUniform);if(!this.specularMap||this.specularMapTint)this.specularUniform[0]=this.specular.r,this.specularUniform[1]=this.specular.g,this.specularUniform[2]=
this.specular.b,this.setParameter("material_specular",this.specularUniform);this.shadingModel===pc.SPECULAR_PHONG?this.setParameter("material_shininess",Math.pow(2,0.11*this.shininess)):this.setParameter("material_shininess",0.01*this.shininess);if(!this.emissiveMap||this.emissiveMapTint)this.emissiveUniform[0]=this.emissive.r*this.emissiveIntensity,this.emissiveUniform[1]=this.emissive.g*this.emissiveIntensity,this.emissiveUniform[2]=this.emissive.b*this.emissiveIntensity,this.setParameter("material_emissive",
this.emissiveUniform);this.setParameter("material_opacity",this.opacity);this._updateMap("diffuse");this._updateMap("specular");this._updateMap("gloss");this._updateMap("emissive");this._updateMap("opacity");this._updateMap("normal");this._updateMap("height");this._updateMap("light");this._updateMap("ao");this.normalMap&&this.setParameter("material_bumpMapFactor",this.bumpiness);this.heightMap&&this.setParameter("material_heightMapFactor",0.025*this.heightMapFactor);this.cubeMap&&(this.setParameter("texture_cubeMap",
this.cubeMap),this.setParameter("material_cubemapSize",this.cubeMap.width));this.prefilteredCubeMap128&&(this.setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128),this.setParameter("material_cubemapSize",this.prefilteredCubeMap128.width));this.prefilteredCubeMap64&&this.setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64);this.prefilteredCubeMap32&&this.setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32);this.prefilteredCubeMap16&&this.setParameter("texture_prefilteredCubeMap16",
this.prefilteredCubeMap16);this.prefilteredCubeMap8&&this.setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8);this.prefilteredCubeMap4&&this.setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4);this.sphereMap&&this.setParameter("texture_sphereMap",this.sphereMap);this.setParameter("material_reflectionFactor",this.reflectivity);0<this.fresnelFactor&&this.setParameter("material_fresnelFactor",this.fresnelFactor);this.shader=null},_getMapTransformID:function(a,c){if(!a)return 0;
this._mapXForms[c]||(this._mapXForms[c]=[]);var d,e,f;for(d=0;d<this._mapXForms[c].length;d++){f=!0;for(e=0;e<a.data.length;e++)if(this._mapXForms[c][d][e]!=a.data[e]){f=!1;break}if(f)return d+1}d=this._mapXForms[c].length;this._mapXForms[c][d]=[];for(e=0;e<a.data.length;e++)this._mapXForms[c][d][e]=a.data[e];return d+1},updateShader:function(a,c){var d,e=c._lights;this._mapXForms=[];var f=this.prefilteredCubeMap128?this.prefilteredCubeMap128:c._prefilteredCubeMap128;d=this.prefilteredCubeMap64?this.prefilteredCubeMap64:
c._prefilteredCubeMap64;var k=this.prefilteredCubeMap32?this.prefilteredCubeMap32:c._prefilteredCubeMap32,m=this.prefilteredCubeMap16?this.prefilteredCubeMap16:c._prefilteredCubeMap16,h=this.prefilteredCubeMap8?this.prefilteredCubeMap8:c._prefilteredCubeMap8,n=this.prefilteredCubeMap4?this.prefilteredCubeMap4:c._prefilteredCubeMap4,l=f&&d&&k&&m&&h&&n,r=a.extTextureLod&&16>a.samplerCount,k=[f,d,k,m,h,n];if(l&&r&&!f._prefilteredMips){f.autoMipmap=!1;for(d=1;6>d;d++)f._levels[d]=k[d]._levels[0];f.upload();
f.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;f.magFilter=pc.FILTER_LINEAR;f._prefilteredMips=!0}f&&f===c._prefilteredCubeMap128&&(this.setParameter("texture_prefilteredCubeMap128",c._prefilteredCubeMap128),this.setParameter("texture_prefilteredCubeMap64",c._prefilteredCubeMap64),this.setParameter("texture_prefilteredCubeMap32",c._prefilteredCubeMap32),this.setParameter("texture_prefilteredCubeMap16",c._prefilteredCubeMap16),this.setParameter("texture_prefilteredCubeMap8",c._prefilteredCubeMap8),this.setParameter("texture_prefilteredCubeMap4",
c._prefilteredCubeMap4),this.setParameter("material_cubemapSize",c._prefilteredCubeMap128.width));if(l)for(d=0;d<k.length;d++)k[d].hdr&&(k[d].rgbm=k[d].fixCubemapSeams=!0);var f={fog:c.fog,gamma:c.gammaCorrection,toneMap:c.toneMapping,blendMapsWithColors:this.blendMapsWithColors,skin:!!this.meshInstances[0].skinInstance,modulateAmbient:this.ambientTint,diffuseTint:(1!=this.diffuse.r||1!=this.diffuse.g||1!=this.diffuse.b)&&this.diffuseMapTint,specularTint:(1!=this.specular.r||1!=this.specular.g||1!=
this.specular.b)&&this.specularMapTint,glossTint:!0,emissiveTint:(1!=this.emissive.r||1!=this.emissive.g||1!=this.emissive.b||1!=this.emissiveIntensity)&&this.emissiveMapTint,opacityTint:1!=this.opacity,needsNormalFloat:!0,sphereMap:!!this.sphereMap,cubeMap:!!this.cubeMap||l,useSpecular:!!this.specularMap||!(0===this.specular.r&&0===this.specular.g&&0===this.specular.b)||!!this.sphereMap||!!this.cubeMap||l,rgbmReflection:l?f.rgbm:this.cubeMap?this.cubeMap.rgbm:this.sphereMap?this.sphereMap.rgbm:!1,
hdrReflection:l?f.rgbm||f.format===pc.PIXELFORMAT_RGBA32F:this.cubeMap?this.cubeMap.rgbm||this.cubeMap.format===pc.PIXELFORMAT_RGBA32F:this.sphereMap?this.sphereMap.rgbm||this.sphereMap.format===pc.PIXELFORMAT_RGBA32F:!1,fixSeams:l?f.fixCubemapSeams:this.cubeMap?this.cubeMap.fixCubemapSeams:!1,prefilteredCubemap:l,specularAA:this.specularAntialias,conserveEnergy:this.conserveEnergy,occludeSpecular:this.occludeSpecular,shadingModel:this.shadingModel,fresnelModel:this.fresnelModel,packedNormal:this.normalMap?
this.normalMap._compressed:!1,useTexCubeLod:r},v;for(v in pc._matTex2D)d=v+"Map",f[d]=!!this[d],f[d]&&(l=d+"Transform",r=d+"Channel",d+="Uv",f[l]=this._getMapTransformID(this[l],this[d]),f[r]=this[r],f[d]=this[d]);f.aoMapUv=f.aoMapUv||this.aoUvSet;this._mapXForms=null;v=[];this._collectLights(pc.LIGHTTYPE_DIRECTIONAL,e,v);this._collectLights(pc.LIGHTTYPE_POINT,e,v);this._collectLights(pc.LIGHTTYPE_SPOT,e,v);f.lights=v;if(c.gammaCorrection)for(d=0;3>d;d++)this.ambientUniform[d]=Math.pow(this.ambient.data[d],
2.2),this.diffuseUniform[d]=Math.pow(this.diffuse.data[d],2.2),this.specularUniform[d]=Math.pow(this.specular.data[d],2.2),this.emissiveUniform[d]=Math.pow(this.emissive.data[d],2.2)*this.emissiveIntensity;this.shader=a.getProgramLibrary().getProgram("phong",f)}});return{PhongMaterial:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.color=new pc.Color(1,1,1,1);this.colorMap=null;this.update()},pc.Material);pc.extend(e.prototype,{clone:function(){var a=new pc.PickMaterial;Material.prototype._cloneInternal.call(this,a);a.color.copy(this.color);a.update();return a},update:function(){this.clearParameters();this.setParameter("uColor",this.color.data)},updateShader:function(a){var b={skin:!!this.meshInstances[0].skinInstance};this.shader=a.getProgramLibrary().getProgram("pick",
b)}});return{PickMaterial:e}}());pc.extend(pc,function(){var e=function(a,b,c){this.node=a;this.mesh=b;this.material=c;this.layer=pc.LAYER_WORLD;this.renderStyle=pc.RENDERSTYLE_SOLID;this.castShadow=!1;this.drawToDepth=this.receiveShadow=!0;this.key=0;this.updateKey();this.skinInstance=null;this.aabb=new pc.shape.Aabb;this.normalMatrix=new pc.Mat3};Object.defineProperty(e.prototype,"aabb",{get:function(){this._aabb.setFromTransformedAabb(this.mesh.aabb,this.node.worldTransform);return this._aabb},set:function(a){this._aabb=a}});
Object.defineProperty(e.prototype,"material",{get:function(){return this._material},set:function(a){if(this._material){var b=this._material.meshInstances,c=b.indexOf(this);-1!==c&&b.splice(c,1)}this._material=a;this._material.meshInstances.push(this);this.updateKey()}});Object.defineProperty(e.prototype,"layer",{get:function(){return this._layer},set:function(a){this._layer=a;this.updateKey()}});pc.extend(e.prototype,{syncAabb:function(){},updateKey:function(){var a=this.material;this.key=(this.layer&
7)<<28|(a.blendType&3)<<26|0|(a.id&33554431)<<0}});return{Command:function(a,b,c){this.key=(a&7)<<28|(b&3)<<26|33554432;this.command=c},Mesh:function(){this.vertexBuffer=null;this.indexBuffer=[null];this.primitive=[{type:0,base:0,count:0}];this.skin=null;this.aabb=new pc.shape.Aabb},MeshInstance:e}}());pc.extend(pc,function(){var e=function(a){this.skin=a;this.bones=[];var c=a.inverseBindPose.length,a=a.device;a.supportsBoneTextures?(c=256<c?64:64<c?32:16<c?16:8,this.matrixPalette=new Float32Array(4*c*c),this.boneTexture=new pc.Texture(a,{width:c,height:c,format:pc.PIXELFORMAT_RGBA32F,autoMipmap:!1}),this.boneTexture.minFilter=pc.FILTER_NEAREST,this.boneTexture.magFilter=pc.FILTER_NEAREST,this.matrixPalette=this.boneTexture.lock()):this.matrixPalette=new Float32Array(16*c)},a=new pc.Mat4;e.prototype=
{updateMatrixPalette:function(){for(var b=a.data,c=this.matrixPalette,d,e=this.bones.length-1;0<=e;e--)a.mul2(this.bones[e].worldTransform,this.skin.inverseBindPose[e]),d=16*e,c[d]=b[0],c[d+1]=b[1],c[d+2]=b[2],c[d+3]=b[3],c[d+4]=b[4],c[d+5]=b[5],c[d+6]=b[6],c[d+7]=b[7],c[d+8]=b[8],c[d+9]=b[9],c[d+10]=b[10],c[d+11]=b[11],c[d+12]=b[12],c[d+13]=b[13],c[d+14]=b[14],c[d+15]=b[15];this.skin.device.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())}};return{Skin:function(a,c,d){this.device=
a;this.inverseBindPose=c;this.boneNames=d},SkinInstance:e}}());pc.extend(pc,function(){function e(){this.index=0;this.boneIndices=[0,0,0,0]}function a(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0;this.boneIndices=[];this.vertices=[];this.indices=[];this.indexMap={}}a.prototype={addVertex:function(a,c,d){var e=-1;if(void 0!==this.indexMap[c])e=this.indexMap[c],this.indices.push(e);else{for(e=0;4>e;e++)0!==d.blendWeight.data[4*c+e]&&(a.boneIndices[e]=this.getBoneRemap(d.blendIndices.data[4*a.index+e]));e=this.vertices.length;
this.indices.push(e);this.vertices.push(a);this.indexMap[c]=e}},addPrimitive:function(a,c,d,e){var f,k,m=[],h=0,n=a.length;for(f=0;f<n;f++)for(var l=a[f].index,r=0;4>r;r++)if(0<d.blendWeight.data[4*l+r]){var v=d.blendIndices.data[4*l+r],u=!0;for(k=0;k<h;k++)if(m[k]==v){u=!1;break}u&&(m[h]=v,k=this.getBoneRemap(v),h+=-1===k?1:0)}if(this.boneIndices.length+h>e)return!1;for(f=0;f<h;f++)this.boneIndices.push(m[f]);for(f=0;f<n;f++)this.addVertex(a[f],c[f],d);return!0},getBoneRemap:function(a){for(var c=
0;c<this.boneIndices.length;c++)if(this.boneIndices[c]===a)return c;return-1}};return{partitionSkin:function(b,c,d){var g,f,k,m=b.vertices,h=b.skins,n=b.meshes,l=b.meshInstances;for(g=0;g<n.length;g++)n[g].vertices=m[n[g].vertices],void 0!==n[g].skin&&(n[g].skin=h[n[g].skin]);for(g=0;g<l.length;g++)l[g].mesh=n[l[g].mesh];m=b.vertices;h=b.skins;n=b.meshes;l=b.meshInstances;for(g=h.length-1;0<=g;g--)if(h[g].boneNames.length>d){var r=h.splice(g,1)[0],v=[];for(f=0;f<n.length;f++)n[f].skin===r&&v.push(n[f]);
for(f=0;f<v.length;f++){var u=n.indexOf(v[f]);-1!==u&&n.splice(u,1)}if(0===v.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var C=v[0].vertices;for(f=1;f<v.length;f++)if(v[f].vertices!==C)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var y=[],s=function(a){var b=new e;b.index=a;return b};k=[];var w=[],A=0;for(f=0;f<v.length;f++){for(var x=v[f],z=x.indices,H=x.base;H<x.base+x.count;){u=z[H++];k[0]=
s(u);w[0]=u;u=z[H++];k[1]=s(u);w[1]=u;u=z[H++];k[2]=s(u);w[2]=u;for(var G=!1,K=A;K<y.length;K++)if(u=y[K],u.addPrimitive(k,w,C,d)){G=!0;break}G||(u=new a,u.originalMesh=x,u.addPrimitive(k,w,C,d),y.push(u))}A=y.length}x=[];v=[];for(f=0;f<y.length;f++)if(u=y[f],u.vertices.length&&u.indices.length){s=x.length;k=u.vertices.length;w=v.length;A=u.indices.length;u.partition=f;u.vertexStart=s;u.vertexCount=k;u.indexStart=w;u.indexCount=A;z=0;for(H=s;z<k;)x[H++]=u.vertices[z++];z=0;for(H=w;z<A;)v[H++]=u.indices[z++]+
s}s=[];for(f=0;f<y.length;f++){u=y[f];w=[];A=[];for(k=0;k<u.boneIndices.length;k++)w.push(r.inverseBindMatrices[u.boneIndices[k]]),A.push(r.boneNames[u.boneIndices[k]]);u={inverseBindMatrices:w,boneNames:A};s.push(u);h.push(u)}var I,r={};for(I in C)r[I]={components:C[I].components,data:[],type:C[I].type};for(I in C)if("blendIndices"===I){u=r[I].data;for(f=0;f<x.length;f++)k=x[f].boneIndices,u.push(k[0],k[1],k[2],k[3])}else{f=C[I];data=f.data;components=f.components;for(f=0;f<x.length;f++){u=x[f].index;
for(k=0;k<components;k++)r[I].data.push(data[u*components+k])}}m[m.indexOf(C)]=r;for(f=0;f<y.length;f++){u=y[f];x={aabb:{min:[0,0,0],max:[0,0,0]},vertices:r,skin:s[f],indices:v.splice(0,u.indexCount),type:"triangles",base:0,count:u.indexCount};n.push(x);for(k=l.length-1;0<=k;k--)l[k].mesh===u.originalMesh&&(l.push({mesh:x,node:l[k].node}),c&&c.push({material:c[k].material,path:c[k].path}))}for(f=0;f<y.length;f++){u=y[f];for(k=l.length-1;0<=k;k--)l[k].mesh===u.originalMesh&&(l.splice(k,1),c&&c.splice(k,
1))}}c=b.vertices;d=b.skins;I=b.meshes;g=b.meshInstances;for(b=0;b<I.length;b++)I[b].vertices=c.indexOf(I[b].vertices),void 0!==I[b].skin&&(I[b].skin=d.indexOf(I[b].skin));for(b=0;b<g.length;b++)g[b].mesh=I.indexOf(g[b].mesh)}}}());pc.extend(pc,function(){var e=function(){this.graph=null;this.meshInstances=[];this.skinInstances=[];this.cameras=[];this.lights=[]};e.prototype={getGraph:function(){return this.graph},setGraph:function(a){this.graph=a},getCameras:function(){return this.cameras},setCameras:function(a){this.cameras=a},getLights:function(){return this.lights},setLights:function(a){this.lights=a},getMaterials:function(){var a,b=[];for(a=0;a<this.meshInstances.length;a++){var c=this.meshInstances[a];-1===b.indexOf(c.material)&&
b.push(c.material)}return b},clone:function(){var a,b=[],c=[],d=function(a){var e=a.clone();b.push(a);c.push(e);for(var a=a.getChildren(),g=0;g<a.length;g++)e.addChild(d(a[g]));return e},e=d(this.graph),f=[],k=[];for(a=0;a<this.skinInstances.length;a++){var m=this.skinInstances[a].skin,h=new pc.SkinInstance(m),n=[];for(j=0;j<m.boneNames.length;j++){var l=e.findByName(m.boneNames[j]);n.push(l)}h.bones=n;k.push(h)}for(a=0;a<this.meshInstances.length;a++)m=this.meshInstances[a],h=b.indexOf(m.node),h=
new pc.MeshInstance(c[h],m.mesh,m.material),m.skinInstance&&(m=this.skinInstances.indexOf(m.skinInstance),h.skinInstance=k[m]),f.push(h);a=new pc.Model;a.graph=e;a.meshInstances=f;a.skinInstances=k;a.getGraph().syncHierarchy();return a},generateWireframe:function(){var a,b,c,d,e,f,k,m,h,n,l=[];for(a=0;a<this.meshInstances.length;a++)f=this.meshInstances[a].mesh,-1===l.indexOf(f)&&l.push(f);var r=[[0,1],[1,2],[2,0]];for(a=0;a<l.length;a++){f=l[a];k=f.primitive[pc.RENDERSTYLE_SOLID].base;m=f.primitive[pc.RENDERSTYLE_SOLID].count;
h=f.indexBuffer[pc.RENDERSTYLE_SOLID];n=new Uint16Array(h.lock());var v={},u=[];for(b=k;b<k+m;b+=3)for(c=0;3>c;c++){d=n[b+r[c][0]];e=n[b+r[c][1]];var C=d>e?e<<16|d:d<<16|e;void 0===v[C]&&(v[C]=0,u.push(d,e))}h.unlock();b=new pc.IndexBuffer(h.device,pc.INDEXFORMAT_UINT16,u.length);c=new Uint16Array(b.lock());c.set(u);b.unlock();f.primitive[pc.RENDERSTYLE_WIREFRAME]={type:pc.PRIMITIVE_LINES,base:0,count:u.length,indexed:!0};f.indexBuffer[pc.RENDERSTYLE_WIREFRAME]=b}}};return{Model:e}}());pc.extend(pc,function(){function e(a){return Math.max(Math.min(a,1),0)}function a(a,b,c,d){var e,g,f;if(void 0===c||2>c)return b*=a.length-1,e=a[Math.floor(b)],g=a[Math.ceil(b)],pc.math.lerp(e,g,b%1);b*=a.length/c-1;d||(d=[]);for(var h=0;h<c;h++)e=a[Math.floor(b)*c+h],g=a[Math.ceil(b)*c+h],f=b%1,d[h]=pc.math.lerp(e,g,f);return d}function b(a,b){J[a]=void 0!==O[a]&&null!==O[a]?O[a]:b}function c(a,b){for(var c=a.length/3,d=Array(4*c),e=0;e<c;e++)d[4*e]=a[3*e],d[4*e+1]=a[3*e+1],d[4*e+2]=a[3*e+2],d[4*
e+3]=(255*b[3*e]<<16|255*b[3*e+1]<<8|255*b[3*e+2])/16777216;return d}function d(a,b,c){for(var d=new Float32Array(b.length),e=0;e<b.length;e++)d[e]=b[e]-a[e];for(var e=c.length,g=d.length/e,a=0;a<g;a++)for(b=0;b<e;b++){var f=Math.abs(d[a*e+b]);c[b]=Math.max(c[b],f)}a=c.length;g=d.length/a;for(b=0;b<g;b++)for(e=0;e<a;e++)d[b*a+e]/=c[e],d[b*a+e]*=0.5,d[b*a+e]+=0.5;return d}function g(a,b){b.data[0]=a.data[0];b.data[1]=a.data[1];b.data[2]=a.data[2];b.data[3]=a.data[4];b.data[4]=a.data[5];b.data[5]=a.data[6];
b.data[6]=a.data[8];b.data[7]=a.data[9];b.data[8]=a.data[10]}var f=[[-1,-1],[1,-1],[1,1],[-1,1]],k=function(a,b,c,d,e,g){e||(e=pc.PIXELFORMAT_RGBA32F);a=new pc.Texture(a,{width:b,height:c,format:e,cubemap:!1,autoMipmap:!1});a.addressU=pc.ADDRESS_CLAMP_TO_EDGE;a.addressV=pc.ADDRESS_CLAMP_TO_EDGE;a.minFilter=pc.FILTER_NEAREST;a.magFilter=pc.FILTER_NEAREST;b=a.lock();if(e==pc.PIXELFORMAT_R8_G8_B8_A8){a.minFilter=pc.FILTER_LINEAR;a.magFilter=pc.FILTER_LINEAR;e=new Uint8Array(d.length);for(c=0;c<d.length;c++)e[c]=
255*d[c]*g;d=e}b.set(d);a.unlock();return a},m=new pc.Curve([0,0,1,0]),h=new pc.Curve([0,1,1,1]),n=new pc.CurveSet([0,0,1,0],[0,0,1,0],[0,0,1,0]),l=new pc.CurveSet([0,1,1,1],[0,1,1,1],[0,1,1,1]),r=null,v=new pc.Vec3,u=new pc.Vec3,C=new pc.Vec3,y=new pc.Vec3,s=new pc.Vec3,w=new pc.Vec3,A=new pc.Vec3,x=new pc.Vec3,z=new pc.Vec3,H=new pc.Mat4,G=new pc.Mat3,K=new pc.Mat3,I=1,F,D=new pc.Mat4,B=new pc.Vec3,E=new pc.Vec3,L=new pc.Vec3;new pc.Vec3;var J,O,P=function(a,c){this.graphicsDevice=a;this.precision=
32;if(!r){var d=new Float32Array(1024),g,f,v,u;for(f=0;16>f;f++)for(g=0;16>g;g++)v=g+1-8.5,u=f+1-8.5,u=e(1-e(Math.sqrt(v*v+u*u)/16)-0.5),v=16*f+g,d[4*v]=1,d[4*v+1]=1,d[4*v+2]=1,d[4*v+3]=u;r=k(a,16,16,d,pc.PIXELFORMAT_R8_G8_B8_A8,1);r.minFilter=pc.FILTER_LINEAR;r.magFilter=pc.FILTER_LINEAR}J=this;O=c;b("numParticles",1);b("rate",1);b("rate2",this.rate);b("lifetime",50);b("emitterExtents",new pc.Vec3(0,0,0));b("emitterRadius",0);b("emitterShape",pc.EMITTERSHAPE_BOX);b("initialVelocity",1);b("wrap",
!1);b("wrapBounds",null);b("colorMap",r);b("normalMap",null);b("loop",!0);b("preWarm",!1);b("sort",pc.PARTICLESORT_NONE);b("mode",pc.PARTICLEMODE_GPU);b("scene",null);b("lighting",!1);b("halfLambert",!1);b("intensity",1);b("stretch",0);b("alignToMotion",!1);b("depthSoftening",0);b("mesh",null);b("depthWrite",!1);b("blendType",pc.BLEND_NORMAL);b("node",null);b("startAngle",0);b("startAngle2",this.startAngle);this.frameRandom=new pc.Vec3(0,0,0);b("colorGraph",l);b("colorGraph2",this.colorGraph);b("scaleGraph",
h);b("scaleGraph2",this.scaleGraph);b("alphaGraph",h);b("alphaGraph2",this.alphaGraph);b("localVelocityGraph",n);b("localVelocityGraph2",this.localVelocityGraph);b("velocityGraph",n);b("velocityGraph2",this.velocityGraph);b("rotationSpeedGraph",m);b("rotationSpeedGraph2",this.rotationSpeedGraph);this.constantParticleTexIN=a.scope.resolve("particleTexIN");this.constantParticleTexOUT=a.scope.resolve("particleTexOUT");this.constantEmitterPos=a.scope.resolve("emitterPos");this.constantEmitterScale=a.scope.resolve("emitterScale");
this.constantSpawnBounds=a.scope.resolve("spawnBounds");this.constantInitialVelocity=a.scope.resolve("initialVelocity");this.constantFrameRandom=a.scope.resolve("frameRandom");this.constantDelta=a.scope.resolve("delta");this.constantRate=a.scope.resolve("rate");this.constantRateDiv=a.scope.resolve("rateDiv");this.constantLifetime=a.scope.resolve("lifetime");this.constantLightCube=a.scope.resolve("lightCube[0]");this.constantGraphSampleSize=a.scope.resolve("graphSampleSize");this.constantGraphNumSamples=
a.scope.resolve("graphNumSamples");this.constantInternalTex0=a.scope.resolve("internalTex0");this.constantInternalTex1=a.scope.resolve("internalTex1");this.constantInternalTex2=a.scope.resolve("internalTex2");this.constantEmitterMatrix=a.scope.resolve("emitterMatrix");this.constantNumParticles=a.scope.resolve("numParticles");this.constantNumParticlesPot=a.scope.resolve("numParticlesPot");this.constantLocalVelocityDivMult=a.scope.resolve("localVelocityDivMult");this.constantVelocityDivMult=a.scope.resolve("velocityDivMult");
this.constantRotSpeedDivMult=a.scope.resolve("rotSpeedDivMult");this.constantSeed=a.scope.resolve("seed");this.constantStartAngle=a.scope.resolve("startAngle");this.constantStartAngle2=a.scope.resolve("startAngle2");this.lightCube=new Float32Array(18);this.lightCubeDir=Array(6);this.lightCubeDir[0]=new pc.Vec3(-1,0,0);this.lightCubeDir[1]=new pc.Vec3(1,0,0);this.lightCubeDir[2]=new pc.Vec3(0,-1,0);this.lightCubeDir[3]=new pc.Vec3(0,1,0);this.lightCubeDir[4]=new pc.Vec3(0,0,-1);this.lightCubeDir[5]=
new pc.Vec3(0,0,1);this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.internalTex3=this.internalTex2=this.internalTex1=this.internalTex0=null;this.swapTex=!1;this.useMesh=!0;this.useCpu=!1;this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null;this.numParticleIndices=this.numParticleVerts=0;this.meshInstance=this.material=null;this.seed=0;this.rebuild()};P.prototype={onChangeCamera:function(){if(0<this.depthSoftening&&this.camera&&!this.camera._depthTarget){var a=
this.camera,b;b=this.graphicsDevice;var c=this.camera._rect,c=new pc.Texture(b,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:Math.floor(c.width*b.width),height:Math.floor(c.height*b.height)});c.minFilter=pc.FILTER_NEAREST;c.magFilter=pc.FILTER_NEAREST;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;b=new pc.RenderTarget(b,c,{depth:!0});a._depthTarget=b;this._depthTarget=this.camera._depthTarget}this.regenShader();this.resetMaterial()},rebuild:function(){var a,b=this.graphicsDevice;
this.spawnBounds=this.emitterShape===pc.EMITTERSHAPE_BOX?this.emitterExtents:this.emitterRadius;this.useCpu=this.useCpu=!0;this.vertexBuffer=void 0;this.useMesh=!1;this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):this.useMesh=!0);this.numParticlesPot=pc.math.nextPowerOfTwo(this.numParticles);this.rebuildGraphs();this.vbToSort=
Array(this.numParticles);this.particleDistance=new Float32Array(this.numParticles);this.frameRandom.x=Math.random();this.frameRandom.y=Math.random();this.frameRandom.z=Math.random();this.particleTex=new Float32Array(16*this.numParticlesPot);var c=null===this.node?pc.Vec3.ZERO:this.node.getPosition();this.emitterShape===pc.EMITTERSHAPE_BOX&&(null===this.node?D.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):D.setTRS(pc.Vec3.ZERO,this.node.getRotation(),L.copy(this.spawnBounds).mul(this.node.getLocalScale())));
for(a=0;a<this.numParticles;a++)this.calcSpawnPosition(c,a);this.particleTexStart=new Float32Array(16*this.numParticlesPot);for(a=0;a<this.particleTexStart.length;a++)this.particleTexStart[a]=this.particleTex[a];this.useCpu||(this.particleTexIN=k(b,this.numParticlesPot,4,this.particleTex),this.particleTexOUT=k(b,this.numParticlesPot,4,this.particleTex),this.particleTexStart=k(b,this.numParticlesPot,4,this.particleTexStart),this.rtParticleTexIN=new pc.RenderTarget(b,this.particleTexIN,{depth:!1}),
this.rtParticleTexOUT=new pc.RenderTarget(b,this.particleTexOUT,{depth:!1}),this.swapTex=!1);a=pc.shaderChunks;var c=a.particleUpdaterInitPS+(this.emitterShape===pc.EMITTERSHAPE_BOX?a.particleUpdaterAABBPS:a.particleUpdaterSpherePS)+a.particleUpdaterStartPS,d=c+a.particleUpdaterEndPS,e=c+a.particleUpdaterOnStopPS+a.particleUpdaterEndPS;this.shaderParticleUpdateRespawn=a.createShaderFromCode(b,a.fullscreenQuadVS,c+a.particleUpdaterRespawnPS+a.particleUpdaterEndPS,"fsQuad0");this.shaderParticleUpdateNoRespawn=
a.createShaderFromCode(b,a.fullscreenQuadVS,d,"fsQuad1");this.shaderParticleUpdateOnStop=a.createShaderFromCode(b,a.fullscreenQuadVS,e,"fsQuad2");this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4;this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6;this._allocate(this.numParticles);b=new pc.Mesh;b.vertexBuffer=this.vertexBuffer;b.indexBuffer[0]=this.indexBuffer;b.primitive[0].type=pc.PRIMITIVE_TRIANGLES;b.primitive[0].base=0;b.primitive[0].count=this.numParticles*
this.numParticleIndices;b.primitive[0].indexed=!0;this.material=new pc.Material;this.material.cullMode=pc.CULLFACE_NONE;this.material.blend=!0;this.material.blendType=this.blendType;this.material.depthWrite=this.depthWrite;this.material.emitter=this;this.regenShader();this.resetMaterial();this.meshInstance=new pc.MeshInstance(this.node,b,this.material);this.meshInstance.updateKey();this.meshInstance.drawToDepth=!1;this._initializeTextures();this.addTime(0);this.preWarm&&this.prewarm(this.lifetime);
this.resetTime()},calcSpawnPosition:function(a,b){this.particleTex[4*b+0+8*this.numParticlesPot]=Math.random();this.particleTex[4*b+1+8*this.numParticlesPot]=Math.random();this.particleTex[4*b+2+8*this.numParticlesPot]=Math.random();this.particleTex[4*b+3+8*this.numParticlesPot]=Math.random();var c=this.particleTex[4*b+0+8*this.numParticlesPot],d=this.particleTex[4*b+1+8*this.numParticlesPot],e=this.particleTex[4*b+2+8*this.numParticlesPot],g=this.particleTex[4*b+3+8*this.numParticlesPot];B.data[0]=
c-0.5;B.data[1]=d-0.5;B.data[2]=e-0.5;this.emitterShape===pc.EMITTERSHAPE_BOX?E.copy(a).add(D.transformPoint(B)):(B.normalize(),E.copy(a).add(B.scale(g*this.spawnBounds)));this.particleTex[4*b]=E.data[0];this.particleTex[4*b+1]=E.data[1];this.particleTex[4*b+2]=E.data[2];this.particleTex[4*b+3]=pc.math.lerp(this.startAngle*pc.math.DEG_TO_RAD,this.startAngle2*pc.math.DEG_TO_RAD,c);c=-pc.math.lerp(this.rate,this.rate2,c)*b;this.particleTex[4*b+3+4*this.numParticlesPot]=c},rebuildGraphs:function(){var a=
this.precision,b=this.graphicsDevice,e;this.qLocalVelocity=this.localVelocityGraph.quantize(a);this.qVelocity=this.velocityGraph.quantize(a);this.qColor=this.colorGraph.quantize(a);this.qRotSpeed=this.rotationSpeedGraph.quantize(a);this.qScale=this.scaleGraph.quantize(a);this.qAlpha=this.alphaGraph.quantize(a);this.qLocalVelocity2=this.localVelocityGraph2.quantize(a);this.qVelocity2=this.velocityGraph2.quantize(a);this.qColor2=this.colorGraph2.quantize(a);this.qRotSpeed2=this.rotationSpeedGraph2.quantize(a);
this.qScale2=this.scaleGraph2.quantize(a);this.qAlpha2=this.alphaGraph2.quantize(a);for(e=0;e<a;e++)this.qRotSpeed[e]*=pc.math.DEG_TO_RAD,this.qRotSpeed2[e]*=pc.math.DEG_TO_RAD;this.localVelocityUMax=new pc.Vec3(0,0,0);this.velocityUMax=new pc.Vec3(0,0,0);this.colorUMax=new pc.Vec3(0,0,0);this.rotSpeedUMax=[0];this.scaleUMax=[0];this.alphaUMax=[0];this.qLocalVelocityDiv=d(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax.data);this.qVelocityDiv=d(this.qVelocity,this.qVelocity2,this.velocityUMax.data);
this.qColorDiv=d(this.qColor,this.qColor2,this.colorUMax.data);this.qRotSpeedDiv=d(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax);this.qScaleDiv=d(this.qScale,this.qScale2,this.scaleUMax);this.qAlphaDiv=d(this.qAlpha,this.qAlpha2,this.alphaUMax);if(!this.useCpu){this.internalTex0=k(b,a,1,c(this.qLocalVelocity,this.qLocalVelocityDiv));this.internalTex1=k(b,a,1,c(this.qVelocity,this.qVelocityDiv));e=this.qRotSpeed;for(var g=this.qScale,f=this.qScaleDiv,h=this.qRotSpeedDiv,l=this.qAlphaDiv,m=Array(4*
e.length),n=0;n<e.length;n++)m[4*n]=e[n],m[4*n+1]=g[n],m[4*n+2]=0,m[4*n+3]=(255*f[n]<<16|255*h[n]<<8|255*l[n])/16777216;this.internalTex2=k(b,a,1,m)}e=this.qColor;g=this.qAlpha;f=Array(4*g.length);for(h=0;h<g.length;h++)f[4*h]=e[3*h],f[4*h+1]=e[3*h+1],f[4*h+2]=e[3*h+2],f[4*h+3]=g[h];this.internalTex3=k(b,a,1,f,pc.PIXELFORMAT_R8_G8_B8_A8,1)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",
this.normalMap))},_hasDepthTarget:function(){return this.camera?!!this.camera._depthTarget:!1},regenShader:function(){var a=this.graphicsDevice.getProgramLibrary(),b=null!=this.normalMap;this.normalOption=0;this.lighting&&(this.normalOption=b?2:1);this.material.updateShader=function(){var b=a.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening&&
this.emitter._hasDepthTarget(),mesh:this.emitter.useMesh,srgb:this.emitter.scene?this.emitter.scene.gammaCorrection:!1,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,blend:this.blendType});this.setShader(b)};this.material.updateShader()},resetMaterial:function(){var a=this.material,b=this.graphicsDevice;a.setParameter("stretch",this.stretch);a.setParameter("colorMult",this.intensity);
this.useCpu||(a.setParameter("internalTex0",this.internalTex0),a.setParameter("internalTex1",this.internalTex1),a.setParameter("internalTex2",this.internalTex2));a.setParameter("internalTex3",this.internalTex3);a.setParameter("numParticles",this.numParticles);a.setParameter("numParticlesPot",this.numParticlesPot);a.setParameter("lifetime",this.lifetime);a.setParameter("rate",this.rate);a.setParameter("rateDiv",this.rate2-this.rate);a.setParameter("seed",this.seed);a.setParameter("scaleDivMult",this.scaleUMax[0]);
a.setParameter("alphaDivMult",this.alphaUMax[0]);a.setParameter("graphNumSamples",this.precision);a.setParameter("graphSampleSize",1/this.precision);a.setParameter("emitterScale",pc.Vec3.ONE.data);this.wrap&&this.wrapBounds&&a.setParameter("wrapBounds",this.wrapBounds.data);this.colorMap&&a.setParameter("colorMap",this.colorMap);this.lighting&&this.normalMap&&a.setParameter("normalMap",this.normalMap);0<this.depthSoftening&&this._hasDepthTarget()&&(a.setParameter("uDepthMap",this.camera._depthTarget.colorBuffer),
a.setParameter("screenSize",(new pc.Vec4(b.width,b.height,1/b.width,1/b.height)).data),a.setParameter("softening",1/(100*this.depthSoftening*this.depthSoftening)));0<this.stretch&&(a.cull=pc.CULLFACE_NONE)},_allocate:function(a){var b=a*this.numParticleVerts,c=a*this.numParticleIndices,d;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==b){d=this.useCpu?[{semantic:pc.SEMANTIC_ATTR0,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR1,components:4,type:pc.ELEMENTTYPE_FLOAT32},
{semantic:pc.SEMANTIC_ATTR2,components:4,type:pc.ELEMENTTYPE_FLOAT32},{semantic:pc.SEMANTIC_ATTR3,components:2,type:pc.ELEMENTTYPE_FLOAT32}]:[{semantic:pc.SEMANTIC_ATTR0,components:4,type:pc.ELEMENTTYPE_FLOAT32}];d=new pc.VertexFormat(this.graphicsDevice,d);this.vertexBuffer=new pc.VertexBuffer(this.graphicsDevice,d,b,pc.BUFFER_DYNAMIC);this.indexBuffer=new pc.IndexBuffer(this.graphicsDevice,pc.INDEXFORMAT_UINT16,c);d=new Float32Array(this.vertexBuffer.lock());var e,g;this.useMesh&&(e=new Float32Array(this.mesh.vertexBuffer.lock()),
g=e.length/this.mesh.vertexBuffer.numVertices);for(c=0;c<b;c++){id=Math.floor(c/this.numParticleVerts);if(this.useMesh){var h=c%this.numParticleVerts;d[4*c]=e[h*g];d[4*c+1]=e[h*g+1];d[4*c+2]=e[h*g+2]}else h=c%4,d[4*c]=f[h][0],d[4*c+1]=f[h][1],d[4*c+2]=0;d[4*c+3]=id}this.useCpu&&(this.vbCPU=new Float32Array(d),this.vbOld=new Float32Array(this.vbCPU.length));this.vertexBuffer.unlock();this.useMesh&&this.mesh.vertexBuffer.unlock();b=0;indices=new Uint16Array(this.indexBuffer.lock());this.useMesh&&(e=
new Uint16Array(this.mesh.indexBuffer[0].lock()));for(c=0;c<a;c++)if(this.useMesh)for(g=0;g<this.numParticleIndices;g++)indices[c*this.numParticleIndices+g]=e[g]+c*this.numParticleVerts;else g=4*c,indices[b++]=g,indices[b++]=g+1,indices[b++]=g+2,indices[b++]=g,indices[b++]=g+2,indices[b++]=g+3;this.indexBuffer.unlock();this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){this.seed=Math.random();this.material.setParameter("seed",this.seed);if(this.useCpu)for(var a=0;a<this.particleTexStart.length;a++)this.particleTex[a]=
this.particleTexStart[a];else this._initializeTextures();this.resetTime();a=this.loop;this.loop=!0;this.addTime(0);this.loop=a;this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(a){for(var b=Math.min(Math.floor(a/this.lifetime*this.precision),this.precision),a=a/b,c=0;c<b;c++)this.addTime(a)},resetTime:function(){var a=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1E3*a},addTime:function(b,c){var d,f,h=this.graphicsDevice;h.setBlending(!1);h.setColorWrite(!0,
!0,!0,!0);h.setCullMode(pc.CULLFACE_NONE);h.setDepthTest(!1);h.setDepthWrite(!1);if(this.lighting){if(!this.scene){console.error("There is no scene defined for lighting particles");return}for(d=0;6>d;d++)this.lightCube[3*d]=this.scene.ambientLight.r,this.lightCube[3*d+1]=this.scene.ambientLight.g,this.lightCube[3*d+2]=this.scene.ambientLight.b;var k=this.scene._globalLights;for(d=0;d<k.length;d++)for(f=0;6>f;f++){var l=Math.max(this.lightCubeDir[f].dot(k[d]._direction),0)*k[d]._intensity;this.lightCube[3*
f]+=k[d]._color.r*l;this.lightCube[3*f+1]+=k[d]._color.g*l;this.lightCube[3*f+2]+=k[d]._color.b*l}this.constantLightCube.setValue(this.lightCube)}this.scene&&this.camera!=this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera());this.emitterShape===pc.EMITTERSHAPE_BOX&&(null===this.meshInstance.node?D.setTRS(pc.Vec3.ZERO,pc.Quat.IDENTITY,this.spawnBounds):D.setTRS(pc.Vec3.ZERO,this.meshInstance.node.getRotation(),L.copy(this.spawnBounds).mul(this.meshInstance.node.getLocalScale())));
d=null===this.meshInstance.node?pc.Vec3.ONE.data:this.meshInstance.node.getLocalScale().data;this.material.setParameter("emitterScale",d);if(this.useCpu){k=new Float32Array(this.vertexBuffer.lock());if(this.meshInstance.node){d=this.meshInstance.node.worldTransform;for(f=0;12>f;f++)H.data[f]=d.data[f];F=this.meshInstance.node.getLocalScale();I=Math.max(Math.max(F.x,F.y),F.z)}f=null===this.meshInstance.node?pc.Vec3.ZERO:this.meshInstance.node.getPosition();l=this.camera?this.camera._node.getPosition():
pc.Vec3.ZERO;for(d=0;d<this.numParticles;d++){var m=Math.floor(this.vbCPU[4*d*this.numParticleVerts+3]),n=this.particleTex[4*d+0+8*this.numParticlesPot];s.x=n;s.y=this.particleTex[4*d+1+8*this.numParticlesPot];s.z=this.particleTex[4*d+2+8*this.numParticlesPot];var r=pc.math.lerp(this.rate,this.rate2,n),E=this.lifetime,J=this.particleTex[4*m+3+4*this.numParticlesPot]+b,O=e(J/E),P=0,T=0,V=0<J&&J<E;if(V){u.data=a(this.qLocalVelocity,O,3,u.data);y.data=a(this.qLocalVelocity2,O,3,y.data);v.data=a(this.qVelocity,
O,3,v.data);C.data=a(this.qVelocity2,O,3,C.data);var S=a(this.qRotSpeed,O),T=a(this.qRotSpeed2,O),P=a(this.qScale,O),X=a(this.qScale2,O),Y=a(this.qAlpha,O),Z=a(this.qAlpha2,O);u.x=pc.math.lerp(u.x,y.x,s.x);u.y=pc.math.lerp(u.y,y.y,s.y);u.z=pc.math.lerp(u.z,y.z,s.z);0<this.initialVelocity&&(this.emitterShape===pc.EMITTERSHAPE_SPHERE?(B.copy(s).scale(2).sub(pc.Vec3.ONE).normalize(),u.add(B.scale(this.initialVelocity))):u.add(pc.Vec3.FORWARD.scale(this.initialVelocity)));v.x=pc.math.lerp(v.x,C.x,s.x);
v.y=pc.math.lerp(v.y,C.y,s.y);v.z=pc.math.lerp(v.z,C.z,s.z);S=pc.math.lerp(S,T,s.y);P=pc.math.lerp(P,X,1E4*n%1)*I;T=(Z-Y)*(1E3*n%1);this.meshInstance.node&&H.transformPoint(u,u);u.add(v.mul(F));z.copy(u);w.x=this.particleTex[4*m];w.y=this.particleTex[4*m+1];w.z=this.particleTex[4*m+2];A.copy(w).add(u.scale(b));x.copy(A);this.particleTex[4*m]=x.x;this.particleTex[4*m+1]=x.y;this.particleTex[4*m+2]=x.z;this.particleTex[4*m+3]+=S*b;this.wrap&&this.wrapBounds&&(x.sub(f),x.x=x.x-this.wrapBounds.x*Math.floor(x.x/
this.wrapBounds.x)-0.5*this.wrapBounds.x,x.y=x.y-this.wrapBounds.y*Math.floor(x.y/this.wrapBounds.y)-0.5*this.wrapBounds.y,x.z=x.z-this.wrapBounds.z*Math.floor(x.z/this.wrapBounds.z)-0.5*this.wrapBounds.z,x.add(f));0<this.sort&&(1===this.sort?(L.copy(x).sub(l),this.particleDistance[m]=-(L.x*L.x+L.y*L.y+L.z*L.z)):2===this.sort?this.particleDistance[m]=J:3===this.sort&&(this.particleDistance[m]=-J))}else this.calcSpawnPosition(f,m);J>E&&this.loop&&(J=-r*m);0>=J&&c&&(J=E+1);this.particleTex[4*m+3+4*
this.numParticlesPot]=J;for(n=0;n<this.numParticleVerts;n++)r=this.vbCPU[4*d*this.numParticleVerts+4*n],E=this.vbCPU[4*d*this.numParticleVerts+4*n+1],J=this.vbCPU[4*d*this.numParticleVerts+4*n+2],V||(r=E=J=0),S=14*d*this.numParticleVerts+14*n,k[S]=x.x,k[S+1]=x.y,k[S+2]=x.z,k[S+3]=O,k[S+4]=this.alignToMotion?0:this.particleTex[4*m+3],k[S+5]=P,k[S+6]=T,k[S+7]=z.x,k[S+8]=r,k[S+9]=E,k[S+10]=J,k[S+11]=z.y,k[S+12]=z.z}if(this.sort>pc.PARTICLESORT_NONE&&this.camera){for(d=0;d<this.numParticles;d++)this.vbToSort[d]=
[d,Math.floor(this.vbCPU[4*d*this.numParticleVerts+3])];for(d=0;d<this.vbCPU.length;d++)this.vbOld[d]=this.vbCPU[d];var W=this.particleDistance;this.vbToSort.sort(function(a,b){return W[a[1]]-W[b[1]]});for(d=0;d<this.numParticles;d++){k=this.vbToSort[d][0];for(l=0;l<this.numParticleVerts;l++)for(f=0;4>f;f++)this.vbCPU[4*d*this.numParticleVerts+4*l+f]=this.vbOld[4*k*this.numParticleVerts+4*l+f]}}this.vertexBuffer.unlock()}else this.frameRandom.x=Math.random(),this.frameRandom.y=Math.random(),this.frameRandom.z=
Math.random(),this.constantGraphSampleSize.setValue(1/this.precision),this.constantGraphNumSamples.setValue(this.precision),this.constantNumParticles.setValue(this.numParticles),this.constantNumParticlesPot.setValue(this.numParticlesPot),this.constantInternalTex0.setValue(this.internalTex0),this.constantInternalTex1.setValue(this.internalTex1),this.constantInternalTex2.setValue(this.internalTex2),f=null===this.meshInstance.node?pc.Vec3.ZERO.data:this.meshInstance.node.getPosition().data,k=null===
this.meshInstance.node?pc.Mat4.IDENTITY:this.meshInstance.node.getWorldTransform(),this.emitterShape===pc.EMITTERSHAPE_BOX?(g(D,G),this.constantSpawnBounds.setValue(G.data)):this.constantSpawnBounds.setValue(this.spawnBounds),this.constantInitialVelocity.setValue(this.initialVelocity),g(k,K),this.constantEmitterPos.setValue(f),this.constantFrameRandom.setValue(this.frameRandom.data),this.constantDelta.setValue(b),this.constantRate.setValue(this.rate),this.constantRateDiv.setValue(this.rate2-this.rate),
this.constantStartAngle.setValue(this.startAngle*pc.math.DEG_TO_RAD),this.constantStartAngle2.setValue(this.startAngle2*pc.math.DEG_TO_RAD),this.constantSeed.setValue(this.seed),this.constantLifetime.setValue(this.lifetime),this.constantEmitterScale.setValue(d),this.constantEmitterMatrix.setValue(K.data),this.constantLocalVelocityDivMult.setValue(this.localVelocityUMax.data),this.constantVelocityDivMult.setValue(this.velocityUMax.data),this.constantRotSpeedDivMult.setValue(this.rotSpeedUMax[0]),d=
this.swapTex?this.particleTexOUT:this.particleTexIN,k=this.swapTex?this.particleTexIN:this.particleTexOUT,this.constantParticleTexIN.setValue(d),c?pc.drawQuadWithShader(h,this.swapTex?this.rtParticleTexIN:this.rtParticleTexOUT,this.shaderParticleUpdateOnStop):pc.drawQuadWithShader(h,this.swapTex?this.rtParticleTexIN:this.rtParticleTexOUT,this.loop?this.shaderParticleUpdateRespawn:this.shaderParticleUpdateNoRespawn),this.constantParticleTexOUT.setValue(k),this.material.setParameter("particleTexOUT",
k),this.material.setParameter("particleTexIN",d),this.swapTex=!this.swapTex;if(!this.loop&&this.onFinished&&Date.now()>this.endTime)this.onFinished();h.setDepthTest(!0);h.setDepthWrite(!0)}};return{ParticleEmitter:P}}());pc.extend(pc,function(){var e=function(a,b,c){this.device=a;a=a.getProgramLibrary();this.pickProgStatic=a.getProgram("pick",{skin:!1});this.pickProgSkin=a.getProgram("pick",{skin:!0});this.pickColor=new Float32Array(4);this.scene=null;this.clearOptions={color:[1,1,1,1],depth:1,flags:pc.CLEARFLAG_COLOR|pc.CLEARFLAG_DEPTH};this.resize(b,c)};e.prototype.getSelection=function(a){var b=this.device;a.width=a.width||1;a.height=a.height||1;var c=b.getRenderTarget();b.setRenderTarget(this._pickBufferTarget);
b.updateBegin();var d=new Uint8Array(4*a.width*a.height);b.readPixels(a.x,a.y,a.width,a.height,d);b.updateEnd();b.setRenderTarget(c);b=[];for(c=0;c<a.width*a.height;c++){var e=d[4*c+0]<<16|d[4*c+1]<<8|d[4*c+2];16777215!==e&&(e=this.scene.drawCalls[e],-1===b.indexOf(e)&&b.push(e))}return b};e.prototype.prepare=function(a,b){var c=this.device;this.scene=b;var d=c.getRenderTarget();c.setRenderTarget(this._pickBufferTarget);c.updateBegin();c.setViewport(0,0,this._pickBufferTarget.width,this._pickBufferTarget.height);
c.setScissor(0,0,this._pickBufferTarget.width,this._pickBufferTarget.height);c.clear(this.clearOptions);var e,f,k,m,h,n=b.drawCalls,l=n.length,c=this.device;f=c.scope;var r=f.resolve("matrix_model"),v=f.resolve("texture_poseMap"),u=f.resolve("texture_poseMapSize"),C=f.resolve("matrix_pose[0]"),y=f.resolve("uColor");e=f.resolve("matrix_projection");f=f.resolve("matrix_viewProjection");m=a._node.getWorldTransform();k=a.getProjectionMatrix();m=m.clone().invert();h=new pc.Mat4;h.mul2(k,m);e.setValue(k.data);
f.setValue(h.data);for(e=0;e<l;e++)if(!n[e].command){k=n[e];f=k.mesh;m=k.material;h=f.primitive[pc.RENDERSTYLE_SOLID].type;var s=m instanceof pc.PhongMaterial||m instanceof pc.BasicMaterial;if((h===pc.PRIMITIVE_TRIANGLES||h===pc.PRIMITIVE_TRISTRIP||h===pc.PRIMITIVE_TRIFAN)&&s)c.setBlending(!1),c.setCullMode(m.cull),c.setDepthWrite(m.depthWrite),c.setDepthTest(m.depthTest),r.setValue(k.node.worldTransform.data),k.skinInstance&&(c.supportsBoneTextures?(v.setValue(k.skinInstance.boneTexture),u.setValue([k.skinInstance.boneTexture.width,
k.skinInstance.boneTexture.height])):C.setValue(k.skinInstance.matrixPalette)),this.pickColor[0]=(e>>16&255)/255,this.pickColor[1]=(e>>8&255)/255,this.pickColor[2]=(e&255)/255,this.pickColor[3]=1,y.setValue(this.pickColor),c.setShader(f.skin?this.pickProgSkin:this.pickProgStatic),c.setVertexBuffer(f.vertexBuffer,0),c.setIndexBuffer(f.indexBuffer[pc.RENDERSTYLE_SOLID]),c.draw(f.primitive[pc.RENDERSTYLE_SOLID])}c.setViewport(0,0,c.width,c.height);c.setScissor(0,0,c.width,c.height);c.updateEnd();c.setRenderTarget(d)};
e.prototype.resize=function(a,b){var c=new pc.Texture(this.device,{format:pc.PIXELFORMAT_R8_G8_B8_A8,width:a,height:b,autoMipmap:!1});c.minFilter=pc.FILTER_NEAREST;c.magFilter=pc.FILTER_NEAREST;c.addressU=pc.ADDRESS_CLAMP_TO_EDGE;c.addressV=pc.ADDRESS_CLAMP_TO_EDGE;this._pickBufferTarget=new pc.RenderTarget(this.device,c,{depth:!0})};Object.defineProperty(e.prototype,"renderTarget",{get:function(){return this._pickBufferTarget}});Object.defineProperty(e.prototype,"width",{get:function(){return this._pickBufferTarget.width}});
Object.defineProperty(e.prototype,"height",{get:function(){return this._pickBufferTarget.height}});return{Picker:e}}());pc.calculateTangents=function(e,a,b,c){var d=c.length/3,g=e.length/3,f,k,m,h,n,l,r,v,u,C,y,s,w,A,x=new pc.Vec3,z=new pc.Vec3,H=new pc.Vec3,G=new pc.Vec3,K=new pc.Vec3,I=new pc.Vec2,F=new pc.Vec2,D=new pc.Vec2,B,E=new Float32Array(3*g),L=new Float32Array(3*g),J=[];for(B=0;B<d;B++)f=c[3*B],k=c[3*B+1],m=c[3*B+2],H.set(e[3*f],e[3*f+1],e[3*f+2]),G.set(e[3*k],e[3*k+1],e[3*k+2]),K.set(e[3*m],e[3*m+1],e[3*m+2]),I.set(b[2*f],b[2*f+1]),F.set(b[2*k],b[2*k+1]),D.set(b[2*m],b[2*m+1]),h=G.x-H.x,n=K.x-H.x,l=G.y-
H.y,r=K.y-H.y,v=G.z-H.z,u=K.z-H.z,C=F.x-I.x,y=D.x-I.x,s=F.y-I.y,w=D.y-I.y,A=1/(C*w-y*s),x.set((w*h-s*n)*A,(w*l-s*r)*A,(w*v-s*u)*A),z.set((C*n-y*h)*A,(C*r-y*l)*A,(C*u-y*v)*A),E[3*f+0]+=x.x,E[3*f+1]+=x.y,E[3*f+2]+=x.z,E[3*k+0]+=x.x,E[3*k+1]+=x.y,E[3*k+2]+=x.z,E[3*m+0]+=x.x,E[3*m+1]+=x.y,E[3*m+2]+=x.z,L[3*f+0]+=z.x,L[3*f+1]+=z.y,L[3*f+2]+=z.z,L[3*k+0]+=z.x,L[3*k+1]+=z.y,L[3*k+2]+=z.z,L[3*m+0]+=z.x,L[3*m+1]+=z.y,L[3*m+2]+=z.z;s=new pc.Vec3;w=new pc.Vec3;e=new pc.Vec3;b=new pc.Vec3;for(B=0;B<g;B++)e.set(a[3*
B],a[3*B+1],a[3*B+2]),s.set(E[3*B],E[3*B+1],E[3*B+2]),w.set(L[3*B],L[3*B+1],L[3*B+2]),c=e.dot(s),b.copy(e).scale(c),b.sub2(s,b).normalize(),J[4*B]=b.x,J[4*B+1]=b.y,J[4*B+2]=b.z,b.cross(e,s),J[4*B+3]=0>b.dot(w)?-1:1;return J};
pc.createMesh=function(e,a,b){var c=b&&void 0!==b.normals?b.normals:null,d=b&&void 0!==b.tangents?b.tangents:null,g=b&&void 0!==b.uvs?b.uvs:null,b=b&&void 0!==b.indices?b.indices:null,f=[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}];null!==c&&f.push({semantic:pc.SEMANTIC_NORMAL,components:3,type:pc.ELEMENTTYPE_FLOAT32});null!==d&&f.push({semantic:pc.SEMANTIC_TANGENT,components:4,type:pc.ELEMENTTYPE_FLOAT32});null!==g&&f.push({semantic:pc.SEMANTIC_TEXCOORD0,components:2,
type:pc.ELEMENTTYPE_FLOAT32});for(var k=new pc.VertexFormat(e,f),f=a.length/3,k=new pc.VertexBuffer(e,k,f),m=new pc.VertexIterator(k),h=0;h<f;h++)m.element[pc.SEMANTIC_POSITION].set(a[3*h],a[3*h+1],a[3*h+2]),null!==c&&m.element[pc.SEMANTIC_NORMAL].set(c[3*h],c[3*h+1],c[3*h+2]),null!==d&&m.element[pc.SEMANTIC_TANGENT].set(d[4*h],d[4*h+1],d[4*h+2],d[4*h+3]),null!==g&&m.element[pc.SEMANTIC_TEXCOORD0].set(g[2*h],g[2*h+1]),m.next();m.end();c=null;if(d=null!==b)c=new pc.IndexBuffer(e,pc.INDEXFORMAT_UINT16,
b.length),(new Uint16Array(c.lock())).set(b),c.unlock();e=new pc.shape.Aabb;e.compute(a);a=new pc.Mesh;a.vertexBuffer=k;a.indexBuffer[0]=c;a.primitive[0].type=pc.PRIMITIVE_TRIANGLES;a.primitive[0].base=0;a.primitive[0].count=d?b.length:f;a.primitive[0].indexed=d;a.aabb=e;return a};
pc.createTorus=function(e,a){var b=a&&void 0!==a.tubeRadius?a.tubeRadius:0.2,c=a&&void 0!==a.ringRadius?a.ringRadius:0.3,d=a&&void 0!==a.segments?a.segments:30,g=a&&void 0!==a.sides?a.sides:20,f,k,m,h,n,l,r,v,u,C,y=[],s=[],w=[],A=[];for(f=0;f<=g;f++)for(k=0;k<=d;k++)m=Math.cos(2*Math.PI*k/d)*(c+b*Math.cos(2*Math.PI*f/g)),h=Math.sin(2*Math.PI*f/g)*b,n=Math.sin(2*Math.PI*k/d)*(c+b*Math.cos(2*Math.PI*f/g)),l=Math.cos(2*Math.PI*k/d)*Math.cos(2*Math.PI*f/g),r=Math.sin(2*Math.PI*f/g),v=Math.sin(2*Math.PI*
k/d)*Math.cos(2*Math.PI*f/g),u=f/g,C=1-k/d,y.push(m,h,n),s.push(l,r,v),w.push(u,C),f<g&&k<d&&(m=f*(d+1)+k,h=(f+1)*(d+1)+k,n=f*(d+1)+(k+1),l=(f+1)*(d+1)+(k+1),A.push(m,h,n),A.push(h,l,n));b={normals:s,uvs:w,indices:A};pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(y,s,w,A));return pc.createMesh(e,y,b)};
pc._createConeData=function(e,a,b,c,d,g){var f,k,m,h,n,l=new pc.Vec3;m=new pc.Vec3;h=new pc.Vec3;var r,v,u=[],C=[],y=[],s=[],w;if(0<b)for(f=0;f<=c;f++)for(k=0;k<=d;k++)theta=2*(k/d)*Math.PI-Math.PI,w=Math.sin(theta),v=Math.cos(theta),r=new pc.Vec3(w*e,-b/2,v*e),n=new pc.Vec3(w*a,b/2,v*a),l.lerp(r,n,f/c),m.sub2(n,r).normalize(),v=new pc.Vec3(v,0,-w),h.cross(v,m).normalize(),u.push(l.x,l.y,l.z),C.push(h.x,h.y,h.z),y.push(k/d,f/c),f<c&&k<d&&(v=f*(d+1)+k,w=f*(d+1)+(k+1),n=(f+1)*(d+1)+k,r=(f+1)*(d+1)+
(k+1),s.push(v,w,n),s.push(w,r,n));if(g){e=Math.floor(d/2);l=b/2;for(b=0;b<=e;b++){theta=0.5*b*Math.PI/e;w=Math.sin(theta);v=Math.cos(theta);for(f=0;f<=d;f++)phi=2*f*Math.PI/d-Math.PI/2,m=Math.sin(phi),g=Math.cos(phi),g*=w,k=v,m*=w,h=1-f/d,n=1-b/e,u.push(g*a,k*a+l,m*a),C.push(g,k,m),y.push(h,n)}r=(c+1)*(d+1);for(b=0;b<e;++b)for(f=0;f<d;++f)v=b*(d+1)+f,w=v+d+1,s.push(r+v+1,r+w,r+v),s.push(r+v+1,r+w+1,r+w);for(b=0;b<=e;b++){theta=0.5*Math.PI+0.5*b*Math.PI/e;w=Math.sin(theta);v=Math.cos(theta);for(f=
0;f<=d;f++)phi=2*f*Math.PI/d-Math.PI/2,m=Math.sin(phi),g=Math.cos(phi),g*=w,k=v,m*=w,h=1-f/d,n=1-b/e,u.push(g*a,k*a-l,m*a),C.push(g,k,m),y.push(h,n)}r=(c+1)*(d+1)+(d+1)*(e+1);for(b=0;b<e;++b)for(f=0;f<d;++f)v=b*(d+1)+f,w=v+d+1,s.push(r+v+1,r+w,r+v),s.push(r+v+1,r+w+1,r+w)}else{r=(c+1)*(d+1);if(0<e)for(f=0;f<d;f++)theta=2*(f/d)*Math.PI,g=Math.sin(theta),k=-b/2,m=Math.cos(theta),h=1-(g+1)/2,n=(m+1)/2,u.push(g*e,k,m*e),C.push(0,-1,0),y.push(h,n),1<f&&s.push(r,r+f,r+f-1);r+=d;if(0<a)for(f=0;f<d;f++)theta=
2*(f/d)*Math.PI,g=Math.sin(theta),k=b/2,m=Math.cos(theta),h=1-(g+1)/2,n=(m+1)/2,u.push(g*a,k,m*a),C.push(0,1,0),y.push(h,n),1<f&&s.push(r,r+f-1,r+f)}return{positions:u,normals:C,uvs:y,indices:s}};
pc.createCylinder=function(e,a){var b=a&&void 0!==a.baseRadius?a.baseRadius:0.5,b=pc._createConeData(b,b,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:20,!1);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(e,b.positions,b)};
pc.createCapsule=function(e,a){var b=a&&void 0!==a.radius?a.radius:0.3,b=pc._createConeData(b,b,(a&&void 0!==a.height?a.height:1)-2*b,a&&void 0!==a.heightSegments?a.heightSegments:1,a&&void 0!==a.sides?a.sides:20,!0);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(e,b.positions,b)};
pc.createCone=function(e,a){var b=pc._createConeData(a&&void 0!==a.baseRadius?a.baseRadius:0.5,a&&void 0!==a.peakRadius?a.peakRadius:0,a&&void 0!==a.height?a.height:1,a&&void 0!==a.heightSegments?a.heightSegments:5,a&&void 0!==a.capSegments?a.capSegments:18,!1);pc.precalculatedTangents&&(b.tangents=pc.calculateTangents(b.positions,b.normals,b.uvs,b.indices));return pc.createMesh(e,b.positions,b)};
pc.createSphere=function(e,a){var b=a&&void 0!==a.radius?a.radius:0.5,c=a&&void 0!==a.latitudeBands?a.latitudeBands:16,d=a&&void 0!==a.longitudeBands?a.longitudeBands:16,g,f,k,m,h,n,l,r,v,u=[],C=[],y=[],s=[];for(f=0;f<=c;f++){g=f*Math.PI/c;k=Math.sin(g);m=Math.cos(g);for(g=0;g<=d;g++)h=2*g*Math.PI/d-Math.PI/2,n=Math.sin(h),h=Math.cos(h),h*=k,l=m,n*=k,r=1-g/d,v=1-f/c,u.push(h*b,l*b,n*b),C.push(h,l,n),y.push(r,v)}for(f=0;f<c;++f)for(g=0;g<d;++g)b=f*(d+1)+g,k=b+d+1,s.push(b+1,k,b),s.push(b+1,k+1,k);
c={normals:C,uvs:y,indices:s};pc.precalculatedTangents&&(c.tangents=pc.calculateTangents(u,C,y,s));return pc.createMesh(e,u,c)};
pc.createPlane=function(e,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec2(0.5,0.5),c=a&&void 0!==a.widthSegments?a.widthSegments:5,d=a&&void 0!==a.lengthSegments?a.lengthSegments:5,g,f,k,m,h,n,l=[],r=[],v=[],u=[];for(g=0;g<=c;g++)for(f=0;f<=d;f++)k=-b.x+2*b.x*g/c,m=-(-b.y+2*b.y*f/d),h=g/c,n=f/d,l.push(k,0,m),r.push(0,1,0),v.push(h,n),g<c&&f<d&&(u.push(f+g*(c+1),f+(g+1)*(c+1),f+g*(c+1)+1),u.push(f+(g+1)*(c+1),f+(g+1)*(c+1)+1,f+g*(c+1)+1));b={normals:r,uvs:v,indices:u};pc.precalculatedTangents&&
(b.tangents=pc.calculateTangents(l,r,v,u));return pc.createMesh(e,l,b)};
pc.createBox=function(e,a){var b=a&&void 0!==a.halfExtents?a.halfExtents:new pc.Vec3(0.5,0.5,0.5),c=a&&void 0!==a.widthSegments?a.widthSegments:1,d=a&&void 0!==a.lengthSegments?a.lengthSegments:1,g=a&&void 0!==a.heightSegments?a.heightSegments:1,f=[new pc.Vec3(-b.x,-b.y,b.z),new pc.Vec3(b.x,-b.y,b.z),new pc.Vec3(b.x,b.y,b.z),new pc.Vec3(-b.x,b.y,b.z),new pc.Vec3(b.x,-b.y,-b.z),new pc.Vec3(-b.x,-b.y,-b.z),new pc.Vec3(-b.x,b.y,-b.z),new pc.Vec3(b.x,b.y,-b.z)],k=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,
2],[5,0,6]],m=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],h=[],n=[],l=[],r=[],b=function(a,b,c){var d,e,g,A,x=h.length/3;for(g=0;g<=b;g++)for(A=0;A<=c;A++){d=new pc.Vec3;e=new pc.Vec3;var z=new pc.Vec3,H=new pc.Vec3;d.lerp(f[k[a][0]],f[k[a][1]],g/b);e.lerp(f[k[a][0]],f[k[a][2]],A/c);z.sub2(e,f[k[a][0]]);H.add2(d,z);d=g/b;e=A/c;h.push(H.x,H.y,H.z);n.push(m[a][0],m[a][1],m[a][2]);l.push(d,e);g<b&&A<c&&(r.push(x+A+g*(b+1),x+A+(g+1)*(b+1),x+A+g*(b+1)+1),r.push(x+A+(g+1)*(b+1),x+A+(g+1)*(b+1)+
1,x+A+g*(b+1)+1))}};b(0,c,g);b(1,c,g);b(2,c,d);b(3,c,d);b(4,d,g);b(5,d,g);c={normals:n,uvs:l,indices:r};pc.precalculatedTangents&&(c.tangents=pc.calculateTangents(h,n,l,r));return pc.createMesh(e,h,c)};pc.extend(pc,function(){var e=function(){this._name="";this._duration=0;this._nodes=[];this._nodeDict={}};e.prototype.getDuration=function(){return this._duration};e.prototype.getName=function(){return this._name};e.prototype.getNode=function(a){return this._nodeDict[a]};e.prototype.getNodes=function(){return this._nodes};e.prototype.setDuration=function(a){this._duration=a};e.prototype.setName=function(a){this._name=a};e.prototype.addNode=function(a){this._nodes.push(a);this._nodeDict[a._name]=a};
return{Animation:e,Key:function(a,b,c,d){this.time=a;this.position=b;this.rotation=c;this.scale=d},Node:function(){this._name="";this._keys=[]}}}());pc.extend(pc,function(){function e(){this._written=!1;this._name="";this._keyFrames=[];this._quat=new pc.Quat;this._pos=new pc.Vec3;this._scale=new pc.Vec3;this._targetNode=null}e.prototype={getTarget:function(){return this._targetNode},setTarget:function(a){this._targetNode=a}};var a=function(a){function c(a){var b=a.getName(),k=new e;k._name=b;d._interpolatedKeys.push(k);d._interpolatedKeyDict[b]=k;d._currKeyIndices[b]=0;a=a.getChildren();for(b=0;b<a.length;b++)c(a[b])}this._animation=null;this._time=
0;this.looping=!0;this._interpolatedKeys=[];this._interpolatedKeyDict={};this._currKeyIndices={};this.graph=null;var d=this;c(a)};a.prototype.addTime=function(a){if(null!==this._animation&&(this._time!==h||this.looping)){var c,d,e,f,k,m=this._animation.getNodes();this._time+=a;var h=this._animation.getDuration();if(this._time>h){this._time=this.looping?0:h;for(h=0;h<m.length;h++)c=m[h],d=c._name,this._currKeyIndices[d]=0}else if(0>this._time){this._time=this.looping?h:0;for(h=0;h<m.length;h++)c=m[h],
d=c._name,this._currKeyIndices[d]=c._keys.length-2}a=0<a?1:-1;for(h=0;h<m.length;h++)if(c=m[h],d=c._name,e=c._keys,c=this._interpolatedKeyDict[d],1===e.length)c._pos.copy(e[0].position),c._quat.copy(e[0].rotation),c._scale(e[0].scale);else for(var n=this._currKeyIndices[d];n<e.length-1&&0<=n;n+=a)if(f=e[n],k=e[n+1],f.time<=this._time&&k.time>=this._time){e=(this._time-f.time)/(k.time-f.time);c._pos.lerp(f.position,k.position,e);c._quat.slerp(f.rotation,k.rotation,e);c._scale.lerp(f.scale,k.scale,
e);c._written=!0;this._currKeyIndices[d]=n;break}}};a.prototype.blend=function(a,c,d){for(var e=this._interpolatedKeys.length,f=0;f<e;f++){var k=a._interpolatedKeys[f],m=c._interpolatedKeys[f],h=this._interpolatedKeys[f];k._written&&m._written?(h._quat.slerp(k._quat,c._interpolatedKeys[f]._quat,d),h._pos.lerp(k._pos,c._interpolatedKeys[f]._pos,d),h._scale.lerp(k._scale,m._scale,d),h._written=!0):k._written?(h._quat.copy(k._quat),h._pos.copy(k._pos),h._scale.copy(k._scale),h._written=!0):m._written&&
(h._quat.copy(m._quat),h._pos.copy(m._pos),h._scale.copy(m._scale),h._written=!0)}};a.prototype.getAnimation=function(){return this._animation};a.prototype.getCurrentTime=function(){return this._time};a.prototype.setCurrentTime=function(a){this._time=a;for(var a=this._interpolatedKeys.length,c=0;c<a;c++)this._currKeyIndices[this._interpolatedKeys[c]._name]=0;this.addTime(0);this.updateGraph()};a.prototype.getNumNodes=function(){return this._interpolatedKeys.length};a.prototype.setAnimation=function(a){this._animation=
a;this.setCurrentTime(0)};a.prototype.setGraph=function(a){var c;if(this.graph=a)for(c=0;c<this._interpolatedKeys.length;c++){var d=a.findByName(this._interpolatedKeys[c]._name);this._interpolatedKeys[c].setTarget(d)}else for(c=0;c<this._interpolatedKeys.length;c++)this._interpolatedKeys[c].setTarget(null)};a.prototype.updateGraph=function(){if(this.graph)for(var a=0;a<this._interpolatedKeys.length;a++){var c=this._interpolatedKeys[a];if(c._written){var d=c.getTarget();d.localPosition.copy(c._pos);
d.localRotation.copy(c._quat);d.localScale.copy(c._scale);d.dirtyLocal=!0;c._written=!1}}};a.prototype.setLooping=function(a){this.looping=a};a.prototype.getLooping=function(){return this.looping};return{Skeleton:a}}());pc.extend(pc,function(){function e(){return!!("undefined"!==typeof AudioContext||"undefined"!==typeof webkitAudioContext)}var a=function(){e()&&("undefined"!==typeof AudioContext?this.context=new AudioContext:"undefined"!==typeof webkitAudioContext&&(this.context=new webkitAudioContext));this.listener=new pc.Listener(this);this.volume=1;this.suspended=!1;pc.events.attach(this)};a.hasAudio=function(){return"undefined"!==typeof Audio};a.hasAudioContext=e;a.isSupported=function(a,c){var d={".ogg":"audio/ogg",
".mp3":"audio/mpeg",".wav":"audio/x-wav"},e=pc.path.getExtension(a);return d[e]?(c||(c=new Audio),""!==c.canPlayType(d[e])):!1};a.prototype={createSound:function(a,c,d){var e=null;pc.Sound?e=new pc.Sound(this,a,c,d):d();return e},playSound:function(a,c){var c=c||{},d=null;pc.Channel&&(d=new pc.Channel(this,a,c),d.play());return d},playSound3d:function(a,c,d){var d=d||{},e=null;pc.Channel3d&&(e=new pc.Channel3d(this,a,d),e.setPosition(c),d.volume&&e.setVolume(d.volume),d.loop&&e.setLoop(d.loop),d.maxDistance&&
e.setMaxDistance(d.maxDistance),d.minDistance&&e.setMinDistance(d.minDistance),d.rollOffFactor&&e.setRollOffFactor(d.rollOffFactor),e.play());return e},getListener:function(){return this.listener},getVolume:function(){return this.volume},setVolume:function(a){this.volume=a;this.fire("volumechange",a)},suspend:function(){this.suspended=!0;this.fire("suspend")},resume:function(){this.suspended=!1;this.fire("resume")}};return{AudioManager:a}}());pc.extend(pc,function(){var e;pc.AudioManager.hasAudioContext()?e=function(a,b,c,d){this.buffer=null;this.isLoaded=!1;pc.AudioManager.isSupported(b,this.audio)?a.context&&pc.net.http.get(b,function(b){a.context.decodeAudioData(b,function(a){this.buffer=a;this.isLoaded=!0;c(this)}.bind(this),d)}.bind(this),{error:d}):setTimeout(function(){d(pc.string.format("Audio format for {0} not supported",b))},0)}:pc.AudioManager.hasAudio()&&(e=function(a,b,c){this.isLoaded=!1;this.audio=new Audio;this.audio.oncanplaythrough=
function(){this.isLoaded||(this.isLoaded=!0,c(this))}.bind(this);this.audio.src=b});return{Sound:e}}());pc.extend(pc,function(){var e=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.orientation=new pc.Mat4;pc.AudioManager.hasAudioContext()&&(this.listener=a.context.listener)};e.prototype={getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.listener&&this.listener.setPosition(a.x,a.y,a.z)},setOrientation:function(a){this.orientation.copy(a);
this.listener&&this.listener.setOrientation(-a.data[8],-a.data[9],-a.data[10],a.data[4],a.data[5],a.data[6])},getOrientation:function(){return this.orientation}};return{Listener:e}}());pc.extend(pc,function(){var e;pc.AudioManager.hasAudioContext()?(e=function(a,b,c){c=c||{};this.volume=void 0===c.volume?1:c.volume;this.loop=void 0===c.loop?!1:c.loop;this.pitch=void 0===c.pitch?1:c.pitch;this.sound=b;this.suspended=this.paused=!1;this.startOffset=this.startTime=0;this.manager=a;this.source=null;this.gain=a.context.createGain()},e.prototype={play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource();this.setVolume(this.volume);this.setLoop(this.loop);
this.setPitch(this.pitch);this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.manager.on("volumechange",this.onManagerVolumeChange,this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this)},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){if(this.source||!this.paused)throw Error("Call pause() before unpausing.");
this._createSource();this.setVolume(this.volume);this.setLoop(this.loop);this.setPitch(this.pitch);this.startTime=this.manager.context.currentTime;this.source.start(0,this.startOffset%this.source.buffer.duration);this.paused=!1},stop:function(){this.source&&(this.source.stop(0),this.source=null);this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setLoop:function(a){this.loop=
a;this.source&&(this.source.loop=a)},setVolume:function(a){this.volume=a;this.gain&&(this.gain.gain.value=a*this.manager.getVolume())},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate.value=a)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=this.sound.buffer;
this.source.connect(this.gain);this.gain.connect(a.destination)}}):pc.AudioManager.hasAudio()?(e=function(a,b,c){this.volume=c.volume||1;this.loop=c.loop||!1;this.sound=b;this.pitch=void 0!==c.pitch?c.pitch:1;this.suspended=this.paused=!1;this.manager=a;this.source=b.audio.cloneNode(!1);this.source.pause()},e.prototype={play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play());this.manager.on("volumechange",this.onManagerVolumeChange,
this);this.manager.on("suspend",this.onManagerSuspend,this);this.manager.on("resume",this.onManagerResume,this)},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause();this.manager.off("volumechange",this.onManagerVolumeChange,this);this.manager.off("suspend",this.onManagerSuspend,this);this.manager.off("resume",this.onManagerResume,this)},setVolume:function(a){this.volume=
a;this.source&&(this.source.volume=a*this.manager.getVolume())},setLoop:function(a){this.loop=a;this.source&&(this.source.loop=a)},setPitch:function(a){this.pitch=a;this.source&&(this.source.playbackRate=a)},getDuration:function(){if(this.source){var a=this.source.duration;if(a===a)return a}return 0},isPlaying:function(){return!this.source.paused}}):(console.warn("No support for 2D audio found"),e=function(){});pc.extend(e.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},
getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}});return{Channel:e}}());pc.extend(pc,function(){var e;if(pc.AudioManager.hasAudioContext())e=function(a){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.panner=a.context.createPanner()},e=pc.inherits(e,pc.Channel),e.prototype=pc.extend(e.prototype,{getPosition:function(){return this.position},setPosition:function(a){this.position.copy(a);this.panner.setPosition(a.x,a.y,a.z)},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a);this.panner.setVelocity(a.x,a.y,a.z)},getMaxDistance:function(){return this.panner.maxDistance},
setMaxDistance:function(a){this.panner.maxDistance=a},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(a){this.panner.refDistance=a},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(a){this.panner.rolloffFactor=a},_createSource:function(){var a=this.manager.context;this.source=a.createBufferSource();this.source.buffer=this.sound.buffer;this.source.connect(this.panner);this.panner.connect(this.gain);this.gain.connect(a.destination)}});
else if(pc.AudioManager.hasAudio()){var a=new pc.Vec3,b;e=pc.inherits(function(){this.position=new pc.Vec3;this.velocity=new pc.Vec3;this.maxDistance=1E4;this.rollOffFactor=this.minDistance=1},pc.Channel);e.prototype=pc.extend(e.prototype,{getPosition:function(){return this.position},setPosition:function(c){this.position.copy(c);if(this.source){var d=this.manager.getListener().getPosition();var c=this.minDistance,e=this.maxDistance,f=this.rollOffFactor;a=a.sub2(d,this.position);b=a.length();b<c?c=
1:b>e?c=0:(d=c+f*(b-c),c=0!==d?c/d:1);d=this.getVolume();this.source.volume=d*c}},getVelocity:function(){return this.velocity},setVelocity:function(a){this.velocity.copy(a)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(a){this.maxDistance=a},getMinDistance:function(){return this.minDistance},setMinDistance:function(a){this.minDistance=a},getRollOffFactor:function(){return this.rolloffFactor},setRollOffFactor:function(a){this.rolloffFactor=a}})}else console.warn("No support for 3D audio found"),
e=function(){};return{Channel3d:e}}());(function(){var e={ACTION_MOUSE:"mouse",ACTION_KEYBOARD:"keyboard",ACTION_GAMEPAD:"gamepad",AXIS_MOUSE_X:"mousex",AXIS_MOUSE_Y:"mousey",AXIS_PAD_L_X:"padlx",AXIS_PAD_L_Y:"padly",AXIS_PAD_R_X:"padrx",AXIS_PAD_R_Y:"padry",AXIS_KEY:"key",EVENT_KEYDOWN:"keydown",EVENT_KEYUP:"keyup",EVENT_MOUSEDOWN:"mousedown",EVENT_MOUSEMOVE:"mousemove",EVENT_MOUSEUP:"mouseup",EVENT_MOUSEWHEEL:"mousewheel",EVENT_TOUCHSTART:"touchstart",EVENT_TOUCHEND:"touchend",EVENT_TOUCHMOVE:"touchmove",EVENT_TOUCHCANCEL:"touchcancel",
KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ENTER:14,KEY_SHIFT:16,KEY_CONTROL:17,KEY_ALT:18,KEY_PAUSE:19,KEY_CAPS_LOCK:20,KEY_ESCAPE:27,KEY_SPACE:32,KEY_PAGE_UP:33,KEY_PAGE_DOWN:34,KEY_END:35,KEY_HOME:36,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_PRINT_SCREEN:44,KEY_INSERT:45,KEY_DELETE:46,KEY_0:48,KEY_1:49,KEY_2:50,KEY_3:51,KEY_4:52,KEY_5:53,KEY_6:54,KEY_7:55,KEY_8:56,KEY_9:57,KEY_SEMICOLON:59,KEY_EQUAL:61,KEY_A:65,KEY_B:66,KEY_C:67,KEY_D:68,KEY_E:69,KEY_F:70,KEY_G:71,KEY_H:72,KEY_I:73,KEY_J:74,
KEY_K:75,KEY_L:76,KEY_M:77,KEY_N:78,KEY_O:79,KEY_P:80,KEY_Q:81,KEY_R:82,KEY_S:83,KEY_T:84,KEY_U:85,KEY_V:86,KEY_W:87,KEY_X:88,KEY_Y:89,KEY_Z:90,KEY_WINDOWS:91,KEY_CONTEXT_MENU:93,KEY_NUMPAD_0:96,KEY_NUMPAD_1:97,KEY_NUMPAD_2:98,KEY_NUMPAD_3:99,KEY_NUMPAD_4:100,KEY_NUMPAD_5:101,KEY_NUMPAD_6:102,KEY_NUMPAD_7:103,KEY_NUMPAD_8:104,KEY_NUMPAD_9:105,KEY_MULTIPLY:106,KEY_ADD:107,KEY_SEPARATOR:108,KEY_SUBTRACT:109,KEY_DECIMAL:110,KEY_DIVIDE:111,KEY_F1:112,KEY_F2:113,KEY_F3:114,KEY_F4:115,KEY_F5:116,KEY_F6:117,
KEY_F7:118,KEY_F8:119,KEY_F9:120,KEY_F10:121,KEY_F11:122,KEY_F12:123,KEY_COMMA:188,KEY_PERIOD:190,KEY_SLASH:191,KEY_OPEN_BRACKET:219,KEY_BACK_SLASH:220,KEY_CLOSE_BRACKET:221,KEY_META:224,MOUSEBUTTON_NONE:-1,MOUSEBUTTON_LEFT:0,MOUSEBUTTON_MIDDLE:1,MOUSEBUTTON_RIGHT:2,PAD_1:0,PAD_2:1,PAD_3:2,PAD_4:3,PAD_FACE_1:0,PAD_FACE_2:1,PAD_FACE_3:2,PAD_FACE_4:3,PAD_L_SHOULDER_1:4,PAD_R_SHOULDER_1:5,PAD_L_SHOULDER_2:6,PAD_R_SHOULDER_2:7,PAD_SELECT:8,PAD_START:9,PAD_L_STICK_BUTTON:10,PAD_R_STICK_BUTTON:11,PAD_UP:12,
PAD_DOWN:13,PAD_LEFT:14,PAD_RIGHT:15,PAD_VENDOR:16,PAD_L_STICK_X:0,PAD_L_STICK_Y:1,PAD_R_STICK_X:2,PAD_R_STICK_Y:3};pc.extend(pc,e);pc.input={};pc.extend(pc.input,e)})();pc.extend(pc,function(){var e=function(a,b){var c={x:0,y:0};if(b){if(b instanceof e)throw Error("Expected MouseEvent");c=a._getTargetCoords(b)}else b={};if(c)this.x=c.x,this.y=c.y;else if(pc.Mouse.isPointerLocked())this.y=this.x=0;else return;this.wheel=b.detail?-1*b.detail:b.wheelDelta?b.wheelDelta/120:0;pc.Mouse.isPointerLocked()?(this.dx=b.movementX||b.webkitMovementX||b.mozMovementX||0,this.dy=b.movementY||b.webkitMovementY||b.mozMovementY||0):(this.dx=this.x-a._lastX,this.dy=this.y-a._lastY);
this.button="mousedown"===b.type||"mouseup"===b.type?b.button:pc.MOUSEBUTTON_NONE;this.buttons=a._buttons.slice(0);this.element=b.target;this.ctrlKey=b.ctrlKey||!1;this.altKey=b.altKey||!1;this.shiftKey=b.shiftKey||!1;this.metaKey=b.metaKey||!1;this.event=b},a=function(a){this._lastY=this._lastX=0;this._buttons=[!1,!1,!1];this._lastbuttons=[!1,!1,!1];this._upHandler=this._handleUp.bind(this);this._downHandler=this._handleDown.bind(this);this._moveHandler=this._handleMove.bind(this);this._wheelHandler=
this._handleWheel.bind(this);this._contextMenuHandler=function(a){a.preventDefault()};this._target=null;this._attached=!1;this.attach(a);pc.events.attach(this)};a.isPointerLocked=function(){return!(!document.pointerLockElement&&!document.mozPointerLockElement&&!document.webkitPointerLockElement)};a.prototype={attach:function(a){this._target=a;this._attached||(this._attached=!0,window.addEventListener("mouseup",this._upHandler,!1),window.addEventListener("mousedown",this._downHandler,!1),window.addEventListener("mousemove",
this._moveHandler,!1),window.addEventListener("mousewheel",this._wheelHandler,!1),window.addEventListener("DOMMouseScroll",this._wheelHandler,!1))},detach:function(){this._attached&&(this._attached=!1,window.removeEventListener("mouseup",this._upHandler),window.removeEventListener("mousedown",this._downHandler),window.removeEventListener("mousemove",this._moveHandler),window.removeEventListener("mousewheel",this._wheelHandler),window.removeEventListener("DOMMouseScroll",this._wheelHandler))},disableContextMenu:function(){this._target&&
this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(a,b){var c=function(){a();document.removeEventListener("pointerlockchange",c)},e=function(){b();document.removeEventListener("pointerlockerror",e)};a&&document.addEventListener("pointerlockchange",c,!1);b&&document.addEventListener("pointerlockerror",e,!1);document.body.requestPointerLock()},
disablePointerLock:function(a){var b=function(){a();document.removeEventListener("pointerlockchange",b)};a&&document.addEventListener("pointerlockchange",b,!1);document.exitPointerLock()},update:function(){this._lastbuttons[0]=this._buttons[0];this._lastbuttons[1]=this._buttons[1];this._lastbuttons[2]=this._buttons[2]},isPressed:function(a){return this._buttons[a]},wasPressed:function(a){return this._buttons[a]&&!this._lastbuttons[a]},wasReleased:function(a){return!this._buttons[a]&&this._lastbuttons[a]},
_handleUp:function(a){this._buttons[a.button]=!1;a=new e(this,a);a.event&&this.fire(pc.EVENT_MOUSEUP,a)},_handleDown:function(a){this._buttons[a.button]=!0;a=new e(this,a);a.event&&this.fire(pc.EVENT_MOUSEDOWN,a)},_handleMove:function(a){a=new e(this,a);a.event&&(this.fire(pc.EVENT_MOUSEMOVE,a),this._lastX=a.x,this._lastY=a.y)},_handleWheel:function(a){a=new e(this,a);a.event&&this.fire(pc.EVENT_MOUSEWHEEL,a)},_getTargetCoords:function(a){var b=this._target.getBoundingClientRect(),c=Math.floor(b.left),
b=Math.floor(b.top);return a.clientX<c||a.clientX>=c+this._target.clientWidth||a.clientY<b||a.clientY>=b+this._target.clientHeight?null:{x:a.clientX-c,y:a.clientY-b}}};if(!("undefined"===typeof navigator||"undefined"===typeof document)){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var b=function(){var a=document.createEvent("CustomEvent");a.initCustomEvent("pointerlockchange",!0,!1,null);document.dispatchEvent(a)},c=function(){var a=document.createEvent("CustomEvent");
a.initCustomEvent("pointerlockerror",!0,!1,null);document.dispatchEvent(a)};document.addEventListener("webkitpointerlockchange",b,!1);document.addEventListener("webkitpointerlocklost",b,!1);document.addEventListener("mozpointerlockchange",b,!1);document.addEventListener("mozpointerlocklost",b,!1);document.addEventListener("webkitpointerlockerror",c,!1);document.addEventListener("mozpointerlockerror",c,!1);Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:
Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock;!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this;navigator.pointer.lock(this,b,c)});document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock;document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=
null,navigator.pointer.unlock())})}return{Mouse:a,MouseEvent:e}}());pc.extend(pc,function(){function e(a){return"string"==typeof a?a.toUpperCase().charCodeAt(0):a}var a=function(a,b){this.key=b.keyCode;this.element=b.target;this.event=b},b={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"},c=function(a,b){b=b||{};this._element=null;this._keyDownHandler=this._handleKeyDown.bind(this);this._keyUpHandler=this._handleKeyUp.bind(this);this._keyPressHandler=this._handleKeyPress.bind(this);pc.events.attach(this);
this._keymap={};this._lastmap={};a&&this.attach(a);this.preventDefault=b.preventDefault||!1;this.stopPropagation=b.stopPropagation||!1};c.prototype.attach=function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("keydown",this._keyDownHandler,!1);this._element.addEventListener("keypress",this._keyPressHandler,!1);this._element.addEventListener("keyup",this._keyUpHandler,!1)};c.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler);
this._element.removeEventListener("keypress",this._keyPressHandler);this._element.removeEventListener("keyup",this._keyUpHandler);this._element=null};c.prototype.toKeyIdentifier=function(a){var a=e(a),c,f;if(c=b[a.toString()])return c;c=a.toString(16).toUpperCase();f=c.length;for(a=0;a<4-f;a++)c="0"+c;return"U+"+c};c.prototype._handleKeyDown=function(b){var c=b.keyCode||b.charCode,c=b.keyIdentifier||this.toKeyIdentifier(c);this._keymap[c]=!0;this.fire("keydown",new a(this,b));this.preventDefault&&
b.preventDefault();this.stopPropagation&&b.stopPropagation()};c.prototype._handleKeyUp=function(b){var c=b.keyCode||b.charCode,c=b.keyIdentifier||this.toKeyIdentifier(c);delete this._keymap[c];this.fire("keyup",new a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&b.stopPropagation()};c.prototype._handleKeyPress=function(b){var c=b.keyCode||b.charCode;b.keyIdentifier||this.toKeyIdentifier(c);this.fire("keypress",new a(this,b));this.preventDefault&&b.preventDefault();this.stopPropagation&&
b.stopPropagation()};c.prototype.update=function(){var a;this._lastmap={};for(a in this._keymap)this._keymap.hasOwnProperty(a)&&(this._lastmap[a]=this._keymap[a])};c.prototype.isPressed=function(a){a=e(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]};c.prototype.wasPressed=function(a){a=e(a);a=this.toKeyIdentifier(a);return!!this._keymap[a]&&!this._lastmap[a]};c.prototype.wasReleased=function(a){a=e(a);a=this.toKeyIdentifier(a);return!this._keymap[a]&&!!this._lastmap[a]};return{Keyboard:c}}());pc.extend(pc,function(){var e=function(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads;this.current=[];this.previous=[];this.deadZone=0.25},a={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),
axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},b={"Product: 0268":"PS3"};e.prototype={update:function(){var a=this.poll(),b,e=a.length;for(b=0;b<e;b++)this.previous[b]=this.current[b],this.current[b]=a[b]},poll:function(){var a=[];if(this.gamepadsSupported){var b=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),e,f=b.length;for(e=0;e<f;e++)b[e]&&a.push({map:this.getMap(b[e]),pad:b[e]})}return a},getMap:function(c){for(var d in b)if(0<=c.id.indexOf(d))return a[b[d]];
return a.DEFAULT},isPressed:function(a,b){return!this.current[a]?!1:this.current[a].pad.buttons[pc[this.current[a].map.buttons[b]]].pressed},wasPressed:function(a,b){if(!this.current[a])return!1;var e=pc[this.current[a].map.buttons[b]];return this.current[a].pad.buttons[e].pressed&&!this.previous[a].pad.buttons[e].pressed},getAxis:function(a,b){if(!this.current[a])return!1;var e=this.current[a].pad.axes[pc[this.current[a].map.axes[b]]];Math.abs(e)<this.deadZone&&(e=0);return e}};return{GamePads:e}}());pc.extend(pc,function(){var e=function(b,d){this.element=d.target;this.event=d;this.touches=[];this.changedTouches=[];if(d){var e,f=d.touches.length;for(e=0;e<f;e++)this.touches.push(new a(d.touches[e]));f=d.changedTouches.length;for(e=0;e<f;e++)this.changedTouches.push(new a(d.changedTouches[e]))}};e.prototype={getTouchById:function(a,b){var e,f=b.length;for(e=0;e<f;e++)if(b[e].id===a)return b[e];return null}};var a=function(a){var b=pc.getTouchTargetCoords(a);this.id=a.identifier;this.x=b.x;this.y=
b.y;this.target=a.target;this.touch=a},b=function(a){this._startHandler=this._handleTouchStart.bind(this);this._endHandler=this._handleTouchEnd.bind(this);this._moveHandler=this._handleTouchMove.bind(this);this._cancelHandler=this._handleTouchCancel.bind(this);this.attach(a);pc.events.attach(this)};b.prototype={attach:function(a){this._element&&this.detach();this._element=a;this._element.addEventListener("touchstart",this._startHandler,!1);this._element.addEventListener("touchend",this._endHandler,
!1);this._element.addEventListener("touchmove",this._moveHandler,!1);this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1));this._element=null},_handleTouchStart:function(a){this.fire("touchstart",
new e(this,a))},_handleTouchEnd:function(a){this.fire("touchend",new e(this,a))},_handleTouchMove:function(a){a.preventDefault();this.fire("touchmove",new e(this,a))},_handleTouchCancel:function(a){this.fire("touchcancel",new e(this,a))}};return{getTouchTargetCoords:function(a){for(var b=0,e=0,f=a.target;!(f instanceof HTMLElement);)f=f.parentNode;do b+=f.offsetLeft-f.scrollLeft,e+=f.offsetTop-f.scrollTop,f=f.offsetParent;while(f);return{x:a.pageX-b,y:a.pageY-e}},TouchDevice:b}}());pc.extend(pc,function(){var e=function(a,b){b=b||{};this._keyboard=b.keyboard||null;this._mouse=b.mouse||null;this._gamepads=b.gamepads||null;this._element=null;this._actions={};this._axes={};this._axesValues={};a&&this.attach(a)};e.prototype.attach=function(a){this._element=a;this._keyboard&&this._keyboard.attach(a);this._mouse&&this._mouse.attach(a)};e.prototype.detach=function(){this._keyboard&&this._keyboard.detach();this._mouse&&this._mouse.detach();this._element=null};e.prototype.disableContextMenu=
function(){this._mouse||this._enableMouse();this._mouse.disableContextMenu()};e.prototype.enableContextMenu=function(){this._mouse||this._enableMouse();this._mouse.enableContextMenu()};e.prototype.update=function(a){this._keyboard&&this._keyboard.update(a);this._mouse&&this._mouse.update(a);this._gamepads&&this._gamepads.update(a);this._axesValues={};for(var b in this._axes)this._axesValues[b]=[]};e.prototype.registerKeys=function(a,b){this._keyboard||this._enableKeyboard();if(this._actions[a])throw Error(pc.string.format("Action: {0} already registered",
a));if(void 0===b)throw Error("Invalid button");b.length||(b=[b]);this._actions[a]?this._actions[a].push({type:pc.ACTION_KEYBOARD,keys:b}):this._actions[a]=[{type:pc.ACTION_KEYBOARD,keys:b}]};e.prototype.registerMouse=function(a,b){this._mouse||this._enableMouse();if(void 0===b)throw Error("Invalid button");this._actions[a]?this._actions[a].push({type:pc.ACTION_MOUSE,button:b}):this._actions[a]=[{type:pc.ACTION_MOUSE,button:-b}]};e.prototype.registerPadButton=function(a,b,c){if(void 0===c)throw Error("Invalid button");
this._actions[a]?this._actions[a].push({type:pc.ACTION_GAMEPAD,button:c,pad:b}):this._actions[a]=[{type:pc.ACTION_GAMEPAD,button:c,pad:b}]};e.prototype.registerAxis=function(a){var b=a.name;this._axes[b]||(this._axes[b]=[]);var c=this._axes[b].push(b),a=a||{};a.pad=a.pad||pc.PAD_1;var d=function(d,e,k,m){switch(e){case "mousex":d._mouse.on(pc.EVENT_MOUSEMOVE,function(a){d._axesValues[b][c]=a.dx/10});break;case "mousey":d._mouse.on(pc.EVENT_MOUSEMOVE,function(a){d._axesValues[b][c]=a.dy/10});break;
case "key":d._axes[b].push(function(){return d._keyboard.isPressed(m)?k:0});break;case "padrx":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,pc.PAD_R_STICK_X)});break;case "padry":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,pc.PAD_R_STICK_Y)});break;case "padlx":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,pc.PAD_L_STICK_X)});break;case "padly":d._axes[b].push(function(){return d._gamepads.getAxis(a.pad,pc.PAD_L_STICK_Y)});break;default:throw Error("Unknown axis");
}};d(this,a.positive,1,a.positiveKey);(a.negativeKey||a.negative!==a.positive)&&d(this,a.negative,-1,a.negativeKey)};e.prototype.isPressed=function(a){if(!this._actions[a])return!1;for(var b,c=0,d=this._actions[a].length,c=0;c<d;++c)switch(b=this._actions[a][c],b.type){case pc.ACTION_KEYBOARD:if(this._keyboard){var e,f=b.keys.length;for(e=0;e<f;e++)if(this._keyboard.isPressed(b.keys[e]))return!0}break;case pc.ACTION_MOUSE:if(this._mouse&&this._mouse.isPressed(b.button))return!0;break;case pc.ACTION_GAMEPAD:if(this._gamepads&&
this._gamepads.isPressed(b.pad,b.button))return!0}return!1};e.prototype.wasPressed=function(a){if(!this._actions[a])return!1;for(var b=0,c=this._actions[a].length,b=0;b<c;++b){var d=this._actions[a][b];switch(d.type){case pc.ACTION_KEYBOARD:if(this._keyboard){var e,f=d.keys.length;for(e=0;e<f;e++)if(this._keyboard.wasPressed(d.keys[e]))return!0}break;case pc.ACTION_MOUSE:if(this._mouse&&this._mouse.wasPressed(d.button))return!0;break;case pc.ACTION_GAMEPAD:if(this._gamepads&&this._gamepads.wasPressed(d.pad,
d.button))return!0}}return!1};e.prototype.getAxis=function(a){var b=0;if(this._axes[a]){var c,d=this._axes[a].length;for(c=0;c<d;c++)if("function"===pc.type(this._axes[a][c])){var e=this._axes[a][c]();Math.abs(e)>Math.abs(b)&&(b=e)}else this._axesValues[a]&&Math.abs(this._axesValues[a][c])>Math.abs(b)&&(b=this._axesValues[a][c])}return b};e.prototype._enableMouse=function(){this._mouse=new pc.Mouse;if(!this._element)throw Error("Controller must be attached to a DOMElement");this._mouse.attach(this._element)};
e.prototype._enableKeyboard=function(){this._keyboard=new pc.Keyboard;if(!this._element)throw Error("Controller must be attached to a DOMElement");this._keyboard.attach(this._element)};return{Controller:e}}());pc.net=function(){return{}}();pc.extend(pc.net,function(){var e=function(){};e.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",BIN:"application/octet-stream"};e.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document"};e.binaryExtensions=[".model",".wav",".ogg",".mp3"];e.prototype={ContentType:e.ContentType,ResponseType:e.ResponseType,
binaryExtensions:e.binaryExtensions,get:function(a,b,c,d){c=c||{};c.success=b;return this.request("GET",a,c,d)},post:function(a,b,c,d,e){d=d||{};d.success=b;d.postdata=c;return this.request("POST",a,d,e)},put:function(a,b,c,d,e){d=d||{};d.success=b;d.postdata=c;return this.request("PUT",a,d,e)},del:function(a,b,c,d){c=c||{};c.success=b;return this.request("DELETE",a,c,d)},request:function(a,b,c,d){var g,f,k,m=!1,c=c||{};null==c.success&&(c.success=function(){});null==c.error&&(c.error=function(){});
null==c.async&&(c.async=!0);null==c.headers&&(c.headers={});if(null!=c.postdata)if(c.postdata instanceof Document)k=c.postdata;else if(c.postdata instanceof FormData)k=c.postdata;else if(c.postdata instanceof Object)switch(k=c.headers["Content-Type"],pc.isDefined(k)||(c.headers["Content-Type"]=e.ContentType.FORM_URLENCODED,k=c.headers["Content-Type"]),k){case e.ContentType.FORM_URLENCODED:k="";f=!0;for(g in c.postdata)c.postdata.hasOwnProperty(g)&&(f?f=!1:k+="&",k+=escape(g)+"="+escape(c.postdata[g]));
break;default:null==k&&(c.headers["Content-Type"]=e.ContentType.JSON),k=JSON.stringify(c.postdata)}else k=c.postdata;d||(d=new XMLHttpRequest);!1===c.cache&&(f=pc.time.now(),g=new pc.URI(b),g.query=g.query?g.query+"&ts="+f:"ts="+f,b=g.toString());c.query&&(g=new pc.URI(b),f=pc.extend(g.getQuery(),c.query),g.setQuery(f),b=g.toString());d.open(a,b,c.async);d.withCredentials=!0;d.responseType=c.responseType||this.guessResponseType(b);for(var h in c.headers)c.headers.hasOwnProperty(h)&&d.setRequestHeader(h,
c.headers[h]);d.onreadystatechange=function(){this.onReadyStateChange(a,b,c,d)}.bind(this);d.onerror=function(){this.onError(a,b,c,d);m=!0}.bind(this);try{d.send(k)}catch(n){m||c.error(d.status,d,n)}return d},guessResponseType:function(a){a=new pc.URI(a);a=pc.path.getExtension(a.path);return 0<=e.binaryExtensions.indexOf(a)?e.ResponseType.ARRAY_BUFFER:e.ResponseType.TEXT},isBinaryContentType:function(a){return 0<=[e.ContentType.WAV,e.ContentType.OGG,e.ContentType.MP3,e.ContentType.BIN].indexOf(a)?
!0:!1},onReadyStateChange:function(a,b,c,d){if(4===d.readyState)switch(d.status){case 0:if("/"!=b[0])this.onSuccess(a,b,c,d);break;case 200:case 201:case 206:case 304:this.onSuccess(a,b,c,d);break;default:this.onError(a,b,c,d)}},onSuccess:function(a,b,c,d){var g;if(a=d.getResponseHeader("Content-Type"))a=a.split(";"),g=a[0].trim(),a[1]&&a[1].trim();g===this.ContentType.JSON||pc.string.endsWith(b,".json")?b=JSON.parse(d.responseText):this.isBinaryContentType(g)?b=d.response:d.responseType===e.ResponseType.ARRAY_BUFFER?
(logWARNING(pc.string.format("responseType: {0} being served with Content-Type: {1}",e.ResponseType.ARRAY_BUFFER,g)),b=d.response):b=d.responseType===e.ResponseType.DOCUMENT||g===this.ContentType.XML?d.responseXML:d.responseText;c.success(b,d.status,d)},onError:function(a,b,c,d){c.error(d.status,d,null)}};e.prototype.delete_=e.prototype.del;return{Http:e,http:new e}}());pc.extend(pc.net,function(){var e=0,a=function(a,c,d,e,f){this.clientId=e;this.endpoint=a;this.redirectUrl=c;this.origin=d;this.scope=f;this.responseType="token";this.accessToken=null;this.OAUTH_IFRAME_ID_BASE="pc-oauth-access-token-"},a=pc.inherits(a,pc.net.Http);a.prototype.refreshAccessToken=function(a){var c=this.OAUTH_IFRAME_ID_BASE+e++,d=function(e){if(e.origin===this.origin){if(e.data.access_token){var g=document.getElementById(c);g&&g.parentNode.removeChild(g);this.accessToken=e.data.access_token;
a(e.data.access_token)}else e.data.error?logERROR(e.data.error):logWARNING("Invalid message posted to Corazon API");window.removeEventListener("message",d)}}.bind(this);window.addEventListener("message",d,!1);var g={client_id:this.clientId,redirect_url:this.redirectUrl,scope:this.scope,response_type:this.responseType},f=new pc.URI(this.endpoint);f.setQuery(g);if(g=document.getElementById(c))throw Error("accessToken request already in progress");g=document.createElement("iframe");g.src=f.toString();
g.id=c;g.style.display="none";document.body.appendChild(g)};a.prototype.request=function(a,c,d,e){d.query=d.query||{};d.query=pc.extend(d.query,{access_token:this.accessToken});return pc.net.OAuth._super.request.call(this,a,c,d,e)};a.prototype.onError=function(a,c,d,e){401==e.status?this.refreshAccessToken(function(f){d.query.access_token=f;this.request(a,c,d,e)}.bind(this)):d.error(e.status,e,null)};return{OAuth:a,oauth:new a}}());pc.extend(pc.net,function(){var e=function(a){this._ws=new WebSocket(a);this._ws.onopen=this._handleOpen.bind(this);this._ws.onerror=this._handleError.bind(this);this._ws.onmessage=this._handleMessage.bind(this);this._ws.onclose=this._handleClose.bind(this)};e.prototype={onopen:null,onerror:null,onmessage:null,get binaryType(){return this._ws.binaryType},set binaryType(a){this._ws.binaryType=a},get readyState(){return this._ws.readyState},get bufferedAmount(){return this._ws.bufferedAmount},get extensions(){return this._ws.extensions},
get protocol(){return this._ws.protocol},_handleOpen:function(){if(this.onopen)this.onopen()},_handleError:function(a){if(this.onerror)this.onerror(a)},_handleMessage:function(a){if(this.onmessage)this.onmessage(a)},_handleClose:function(){if(this.onclose)this.onclose()},send:function(a){this._ws.send(a)}};return{Socket:e}}());pc.script=function(){var e=null,a=null,b={main:function(a){if(e)throw Error("'main' Object already registered");e=a},setLoader:function(b){if(b&&a)throw Error("pc.script already has loader object.");a=b},create:function(a,b){void 0===b&&(b=attributes);this.fire("created",a,b)},attribute:function(){},start:function(){e()}};pc.events.attach(b);return b}();var designer=designer||{};pc.extend(designer,function(){var e=function(){this.exposed={};this.added={};this.scripts={};this.systems=[]};e.prototype={addComponentType:function(){},expose:function(){},add:function(){},scriptexpose:function(){}};return{LinkInterface:e,link:new e}}());pc.extend(designer,function(){var e=function(){this.exposed={};this.added={};this.scripts={};this.systems=[]};e.prototype.addComponentType=function(a){var b=a.id,c,d=this.systems,e=d.length,f=!1;for(c=0;c<e;c++)if(d[c].name===b){f=!0;break}f||this.systems.push({name:b,description:a.description});this.exposed[b]||(this.exposed[b]={})};e.prototype.expose=function(a,b){if(!b.name)throw Error("Missing option 'name'");b.options=b.options||{};if("vector"===b.type)if(b.array=!0,b.defaultValue)switch(b.defaultValue.length){case 2:b.RuntimeType=
pc.Vec2;break;case 3:b.RuntimeType=pc.Vec3;break;case 4:b.RuntimeType=pc.Vec4}else b.RuntimeType=pc.Vec3;else"rgb"===b.type||"rgba"===b.type?(b.array=!0,b.RuntimeType=pc.Color):"curve"===b.type?(b.object=!0,b.RuntimeType=pc.Curve):"curveset"===b.type&&(b.object=!0,b.RuntimeType=pc.CurveSet);this.exposed[a][b.name]||(this.exposed[a][b.name]={});this.exposed[a][b.name]=b};e.prototype.add=function(a){logASSERT(a.system,"Missing option: 'system'");logASSERT(a.variable,"Missing option: 'variable'");this.added[a.system]||
(this.added[a.system]={});this.added[a.system][a.variable]||(this.added[a.system][a.variable]={});this.added[a.system][a.variable]=a};e.prototype.scriptexpose=function(a){this.scripts[a.script]=a};return{LinkInterface:e,link:new e}}());pc.extend(pc,function(){return{ContentFile:function(e){this.packs=e.packs||{};this.appProperties=e.application_properties||{};this.toc=e.toc||{}}}}());pc.extend(pc,function(){return{Pack:function(e){this.hierarchy=e.hierarchy;this.settings=e.settings}}}());pc.extend(pc,function(){var e=function(a,b){b=b||{};pc.log.open();pc.events.attach(this);this._time=0;this._librariesLoaded=!1;this._fillMode=pc.FILLMODE_KEEP_ASPECT;this._resolutionMode=pc.RESOLUTION_FIXED;this.context=this;this.graphicsDevice=new pc.GraphicsDevice(a);this.systems=new pc.ComponentSystemRegistry;this._audioManager=new pc.AudioManager;this.loader=new pc.resources.ResourceLoader;this.scene=new pc.Scene;this.root=new pc.fw.Entity(this);this.assets=new pc.asset.AssetRegistry(this.loader);
this.renderer=new pc.ForwardRenderer(this.graphicsDevice);this.keyboard=b.keyboard||null;this.mouse=b.mouse||null;this.touch=b.touch||null;this.gamepads=b.gamepads||null;this.content=null;this._inTools=!1;this._link=new pc.LiveLink("application");this._link.addDestinationWindow(window);this._link.listen(this._handleMessage.bind(this));!1===b.cache&&(this.loader.cache=!1);b.displayLoader&&new pc.resources.ResourceLoaderDisplay(document.body,this.loader);b.content&&(this.content=b.content,Object.keys(this.content.toc).forEach(function(a){this.assets.addGroup(a,
this.content.toc[a])}.bind(this)));new pc.resources.TextureCache(this.loader);this.loader.registerHandler(pc.resources.JsonRequest,new pc.resources.JsonResourceHandler);this.loader.registerHandler(pc.resources.TextRequest,new pc.resources.TextResourceHandler);this.loader.registerHandler(pc.resources.ImageRequest,new pc.resources.ImageResourceHandler);this.loader.registerHandler(pc.resources.MaterialRequest,new pc.resources.MaterialResourceHandler(this.graphicsDevice,this.assets));this.loader.registerHandler(pc.resources.TextureRequest,
new pc.resources.TextureResourceHandler(this.graphicsDevice,this.assets));this.loader.registerHandler(pc.resources.CubemapRequest,new pc.resources.CubemapResourceHandler(this.graphicsDevice,this.assets));this.loader.registerHandler(pc.resources.ModelRequest,new pc.resources.ModelResourceHandler(this.graphicsDevice,this.assets));this.loader.registerHandler(pc.resources.AnimationRequest,new pc.resources.AnimationResourceHandler);this.loader.registerHandler(pc.resources.PackRequest,new pc.resources.PackResourceHandler(this,
b.depot));this.loader.registerHandler(pc.resources.AudioRequest,new pc.resources.AudioResourceHandler(this._audioManager));this.loader.registerHandler(pc.resources.ScriptRequest,new pc.resources.ScriptResourceHandler(this,b.scriptPrefix));new pc.RigidBodyComponentSystem(this);new pc.CollisionComponentSystem(this);new pc.BallSocketJointComponentSystem(this);new pc.AnimationComponentSystem(this);new pc.ModelComponentSystem(this);new pc.CameraComponentSystem(this);new pc.LightComponentSystem(this);new pc.PackComponentSystem(this);
new pc.SkyboxComponentSystem(this);new pc.ScriptComponentSystem(this);new pc.PickComponentSystem(this);new pc.AudioSourceComponentSystem(this,this._audioManager);new pc.AudioListenerComponentSystem(this,this._audioManager);new pc.ParticleSystemComponentSystem(this);new pc.DesignerComponentSystem(this);this.on("librariesloaded",this.onLibrariesLoaded,this);if(b.libraries&&b.libraries.length){var c=b.libraries.map(function(a){return new pc.resources.ScriptRequest(a)});this.loader.request(c).then(function(){this.fire("librariesloaded",
this);this._librariesLoaded=!0}.bind(this))}else this.fire("librariesloaded",this),this._librariesLoaded=!0;void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this.onVisibilityChange.bind(this),!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this.onVisibilityChange.bind(this),!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this.onVisibilityChange.bind(this),
!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this.onVisibilityChange.bind(this),!1));e._applications[this.graphicsDevice.canvas.id]=this;e._currentApplication=this};e._currentApplication=null;e._applications={};e.getApplication=function(a){return a?e._applications[a]:e._currentApplication};e.prototype={loadFromToc:function(a,b,c,d){this.content||c("No content");var a=this.content.toc[a],b=b||function(){},c=c||function(){},
d=d||function(){},e=a.packs[0],f=function(){this.loader.request(new pc.resources.PackRequest(e)).then(function(a){a=a[0];this.root.addChild(a.hierarchy);pc.ComponentSystem.initialize(a.hierarchy);pc.ComponentSystem.postInitialize(a.hierarchy);if(this.systems.rigidbody&&"undefined"!==typeof Ammo){var c=a.settings.physics.gravity;this.systems.rigidbody.setGravity(c[0],c[1],c[2])}c=a.settings.render.global_ambient;this.scene.ambientLight=new pc.Color(c[0],c[1],c[2]);this.scene.fog=a.settings.render.fog;
c=a.settings.render.fog_color;this.scene.fogColor=new pc.Color(c[0],c[1],c[2]);this.scene.fogStart=a.settings.render.fog_start;this.scene.fogEnd=a.settings.render.fog_end;this.scene.fogDensity=a.settings.render.fog_density;this.scene.gammaCorrection=a.settings.render.gamma_correction;this.scene.toneMapping=a.settings.render.tonemapping;this.scene.exposure=a.settings.render.exposure;a.settings.render.skybox&&(c=this.assets.getAssetById(a.settings.render.skybox),this.scene.skybox=c?c.resource:null);
b(a);this.loader.off("progress",d)}.bind(this),function(a){c(a)}).then(null,function(a){setTimeout(function(){throw a;},0)})}.bind(this),k=function(){var a=this.assets.list(e);this.loader.on("progress",d);a.length?this.assets.load(a).then(function(a){f(a)}):setTimeout(function(){f([])},0)}.bind(this);if(this._librariesLoaded)k();else this.on("librariesloaded",function(){k()})},start:function(){if(this._librariesLoaded)this.tick();else this.on("librariesloaded",function(){this.tick()},this)},update:function(a){pc.ComponentSystem.fixedUpdate(1/
60,this._inTools);pc.ComponentSystem.update(a,this._inTools);pc.ComponentSystem.postUpdate(a,this._inTools);this.fire("update",a);this.controller&&this.controller.update(a);this.mouse&&this.mouse.update(a);this.keyboard&&this.keyboard.update(a);this.gamepads&&this.gamepads.update(a)},render:function(){var a=this.systems.camera.cameras,b=null,c=this.renderer;this.root.syncHierarchy();for(var d=0,e=a.length;d<e;d++)b=a[d],b.frameBegin(),c.render(this.scene,b.camera),b.frameEnd()},tick:function(){e._currentApplication=
this;window.requestAnimationFrame(this.tick.bind(this));var a=window.performance&&window.performance.now?performance.now():Date.now(),b=(a-(this._time||a))/1E3;this._time=a;b=pc.math.clamp(b,0,0.1);this.update(b);this.render()},setCanvasFillMode:function(a,b,c){this._fillMode=a;this.resizeCanvas(b,c)},setCanvasResolution:function(a,b,c){this._resolutionMode=a;a===pc.RESOLUTION_AUTO&&void 0===b&&(b=this.graphicsDevice.canvas.clientWidth,c=this.graphicsDevice.canvas.clientHeight);this.graphicsDevice.resizeCanvas(b,
c)},isFullscreen:function(){return!!document.fullscreenElement},enableFullscreen:function(a,b,c){var a=a||this.graphicsDevice.canvas,d=function(){b();document.removeEventListener("fullscreenchange",d)},e=function(){c();document.removeEventListener("fullscreenerror",e)};b&&document.addEventListener("fullscreenchange",d,!1);c&&document.addEventListener("fullscreenerror",e,!1);a.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT)},disableFullscreen:function(a){var b=function(){a();document.removeEventListener("fullscreenchange",
b)};a&&document.addEventListener("fullscreenchange",b,!1);document.exitFullscreen()},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._audioManager.suspend():this._audioManager.resume()},resizeCanvas:function(a,b){var c=window.innerWidth,d=window.innerHeight;if(navigator.isCocoonJS)a=c,b=d,c=window.devicePixelRatio,this.graphicsDevice.resizeCanvas(a*c,b*c);else{if(this._fillMode===pc.FILLMODE_KEEP_ASPECT){var e=this.graphicsDevice.canvas.width/
this.graphicsDevice.canvas.height;e>c/d?(a=c,b=a/e):(b=d,a=b*e)}else this._fillMode===pc.FILLMODE_FILL_WINDOW&&(a=c,b=d);this.graphicsDevice.canvas.style.width=a+"px";this.graphicsDevice.canvas.style.height=b+"px";this._resolutionMode===pc.RESOLUTION_AUTO&&this.setCanvasResolution(pc.RESOLUTION_AUTO)}return{width:a,height:b}},onLibrariesLoaded:function(){this.systems.rigidbody.onLibraryLoaded();this.systems.collision.onLibraryLoaded()},_handleMessage:function(a){var b;switch(a.type){case pc.LiveLinkMessageType.UPDATE_COMPONENT:this._linkUpdateComponent(a.content.id,
a.content.component,a.content.attribute,a.content.value);break;case pc.LiveLinkMessageType.UPDATE_ENTITY:this._linkUpdateEntity(a.content.id,a.content.components);break;case pc.LiveLinkMessageType.UPDATE_ENTITY_TRANSFORM:this._linkUpdateEntityTransform(a.content.id,a.content.position,a.content.rotation,a.content.scale);break;case pc.LiveLinkMessageType.UPDATE_ENTITY_NAME:b=this.root.findOne("getGuid",a.content.id);b.setName(a.content.name);break;case pc.LiveLinkMessageType.UPDATE_ENTITY_ENABLED:b=
this.root.findOne("getGuid",a.content.id);b.enabled=a.content.enabled;break;case pc.LiveLinkMessageType.REPARENT_ENTITY:this._linkReparentEntity(a.content.id,a.content.newParentId,a.content.index);break;case pc.LiveLinkMessageType.CLOSE_ENTITY:if(b=this.root.findOne("getGuid",a.content.id))logDEBUG(pc.string.format("RT: Removed '{0}' from parent {1}",a.content.id,b.getParent().getGuid())),b.destroy();break;case pc.LiveLinkMessageType.OPEN_PACK:a=this.loader.open(pc.resources.PackRequest,a.content.pack);
b=a.hierarchy;b.__parent?(a=this.root.findByGuid(b.__parent),a.addChild(b)):this.root.addChild(b);break;case pc.LiveLinkMessageType.OPEN_ENTITY:a.content.entity&&(a={application_data:{},hierarchy:a.content.entity},a=this.loader.open(pc.resources.PackRequest,a),b=a.hierarchy,b.__parent?(a=this.root.findByGuid(b.__parent),a.addChild(b)):this.root.addChild(b));break;case pc.LiveLinkMessageType.UPDATE_ASSET:this._linkUpdateAsset(a.content.id,a.content.attribute,a.content.value);break;case pc.LiveLinkMessageType.UPDATE_ASSETCACHE:var c;
for(b in a.content.assets)if(c=this.assets.getAssetById(b)){var d=a.content.assets[b],e;for(e in d)d.hasOwnProperty(e)&&(c[e]=d[e])}else this.assets.createAndAddAsset(b,a.content.assets[b]);for(b in a.content.deleted)(c=this.assets.getAssetById(b))&&this.assets.removeAsset(c);break;case pc.LiveLinkMessageType.UPDATE_PACK_SETTINGS:this._linkUpdatePackSettings(a.content.settings)}},_linkUpdateComponent:function(a,b,c,d){var a=this.root.findOne("getGuid",a),e;a&&(b?a[b]?(e=designer.link.exposed[b][c],
designer&&e?e.RuntimeType?e.RuntimeType===pc.Vec3?a[b][c]=new e.RuntimeType(d[0],d[1],d[2]):e.RuntimeType===pc.Vec4?a[b][c]=new e.RuntimeType(d[0],d[1],d[2],d[3]):e.RuntimeType===pc.Vec2?a[b][c]=new e.RuntimeType(d[0],d[1]):e.RuntimeType===pc.Color?a[b][c]=3===d.length?new e.RuntimeType(d[0],d[1],d[2]):new e.RuntimeType(d[0],d[1],d[2],d[3]):e.RuntimeType===pc.Curve||e.RuntimeType===pc.CurveSet?(a[b][c]=new e.RuntimeType(d.keys),a[b][c].type=d.type):a[b][c]=new e.RuntimeType(d):a[b][c]=d:a[b][c]=d):
logWARNING(pc.string.format("No component system called '{0}' exists",b)):a[c]=d)},_linkUpdateEntityTransform:function(a,b,c,d){if(a=this.root.findByGuid(a))a.setLocalPosition(b[0],b[1],b[2]),a.setLocalEulerAngles(c[0],c[1],c[2]),a.setLocalScale(d[0],d[1],d[2]),a.fire("livelink:updatetransform",b,c,d)},_linkReparentEntity:function(a,b,c){a=this.root.findByGuid(a);b=this.root.findByGuid(b);a.reparent(b,c)},_linkUpdateEntity:function(a,b){var c,d=this.root.findOne("getGuid",a);if(d){var e=this.systems.getComponentSystemOrder(),
f,k=e.length;for(f=0;f<k;f++)c=e[f],b.hasOwnProperty(c)&&this.systems.hasOwnProperty(c)&&(d[c]||this.systems[c].addComponent(d,{}));for(c in this.systems)"gizmo"===c||"pick"===c||this.systems.hasOwnProperty(c)&&!b.hasOwnProperty(c)&&d[c]&&this.systems[c].removeComponent(d)}},_linkUpdateAsset:function(a,b,c){(a=this.assets.getAssetById(a))&&(a[b]=c)},_linkUpdatePackSettings:function(a){var b=a.render.global_ambient;this.scene.ambientLight.set(b[0],b[1],b[2]);this.systems.rigidbody&&"undefined"!==typeof Ammo&&
(b=a.physics.gravity,this.systems.rigidbody.setGravity(b[0],b[1],b[2]));this.scene.fog=a.render.fog;this.scene.fogStart=a.render.fog_start;this.scene.fogEnd=a.render.fog_end;b=a.render.fog_color;this.scene.fogColor=new pc.Color(b[0],b[1],b[2]);this.scene.fogDensity=a.render.fog_density;this.scene.gammaCorrection=a.render.gamma_correction;this.scene.toneMapping=a.render.tonemapping;this.scene.exposure=a.render.exposure;a.render.skybox?(b=this.assets.getAssetById(a.render.skybox))?b.resource?this.scene.skybox=
b.resource:this.assets.load([b]).then(function(a){this.scene.skybox=a[0]}.bind(this),function(){pc.log.error("Could not initialize scene skybox. Missing cubemap asset "+a.render.skybox)}):pc.log.error("Could not initialize scene skybox. Missing cubemap asset "+a.render.skybox):this.scene.skybox=null}};return{FILLMODE_NONE:"NONE",FILLMODE_FILL_WINDOW:"FILL_WINDOW",FILLMODE_KEEP_ASPECT:"KEEP_ASPECT",RESOLUTION_AUTO:"AUTO",RESOLUTION_FIXED:"FIXED",Application:e}}());pc.extend(pc,function(){var e=function(){};e.prototype={add:function(a,b){if(this[a])throw Error(pc.string.format("ComponentSystem name '{0}' already registered or not allowed",a));this[a]=b;b.name=a},remove:function(a){if(!this[a])throw Error(pc.string.format("No ComponentSystem named '{0}' registered",a));delete this[a]},list:function(){var a=Object.keys(this),b={collisionrect:0.5,collisioncircle:0.5};a.sort(function(a,d){var e=b[a]||1,f=b[d]||1;return e<f?-1:e>f?1:0});return a.map(function(a){return this[a]},
this)},getComponentSystemOrder:function(){var a,b=Object.keys(this);a=b.indexOf("collisionrect");b.splice(a,1);b.unshift("collisionrect");a=b.indexOf("collisioncircle");b.splice(a,1);b.unshift("collisioncircle");return b}};return{ComponentSystemRegistry:e}}());pc.extend(pc,function(){var e=function(a){this.app=a;this.dataStore={};this.schema=[];pc.events.attach(this)};pc.extend(e,{initialize:function(a){e.fire("initialize",a)},postInitialize:function(a){e.fire("postInitialize",a)},update:function(a,b){b?e.fire("toolsUpdate",a):e.fire("update",a)},fixedUpdate:function(a){e.fire("fixedUpdate",a)},postUpdate:function(a){e.fire("postUpdate",a)}});e.prototype={get store(){return this.dataStore},addComponent:function(a,b){var c=new this.ComponentType(this,a),
d=new this.DataType,b=b||{};this.dataStore[a.getGuid()]={entity:a,data:d};a[this.id]=c;a.c[this.id]=c;this.initializeComponentData(c,b,[]);this.fire("add",a,c);return c},removeComponent:function(a){var b=this.dataStore[a.getGuid()];this.fire("beforeremove",a,a.c[this.id]);delete this.dataStore[a.getGuid()];delete a[this.id];delete a.c[this.id];this.fire("remove",a,b.data)},cloneComponent:function(a,b){var c=this.dataStore[a.getGuid()];return this.addComponent(b,c.data)},initializeComponentData:function(a,
b,c){b=b||{};c.forEach(function(c){a[c]=void 0!==b[c]?b[c]:a.data[c]},this);if(a.enabled&&a.entity.enabled)a.onEnable()},exposeProperties:function(){designer.link.addComponentType(this);this.schema.forEach(function(a){!1!==a.exposed&&designer.link.expose(this.id,a)}.bind(this))}};pc.events.attach(e);return{ComponentSystem:e}}());pc.extend(pc,function(){var e=function(a,b){this.system=a;this.entity=b;pc.events.attach(this);this.buildAccessors(this.system.schema);this.on("set",function(a,b,e){this.fire("set_"+a,a,b,e)});this.on("set_enabled",this.onSetEnabled,this)};e.prototype={get data(){var a=this.system.store[this.entity.getGuid()];return a?a.data:null},buildAccessors:function(a){a.forEach(function(a){a.readOnly?Object.defineProperty(this,a.name,{get:function(){return this.data[a.name]},configurable:!0}):Object.defineProperty(this,
a.name,{get:function(){return this.data[a.name]},set:function(c){var d=this.data,e=d[a.name];d[a.name]=c;this.fire("set",a.name,e,c)},configurable:!0})}.bind(this))},onSetEnabled:function(a,b,c){if(b!==c&&this.entity.enabled)if(c)this.onEnable();else this.onDisable()},onEnable:function(){},onDisable:function(){}};return{Component:e}}());pc.extend(pc,function(){return{ComponentData:function(){}}}());pc.extend(pc,function(){var e=function(){this.on("set_animations",this.onSetAnimations,this);this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{play:function(a,b){if(this.data.animations[a]){if(this.enabled&&this.entity.enabled){var b=b||0,c=this.data;c.prevAnim=c.currAnim;c.currAnim=a;c.model&&(c.blending=0<b,c.blending?(c.blendTime=b,c.blendTimeRemaining=b,c.fromSkel.setAnimation(c.animations[c.prevAnim]),c.fromSkel.addTime(c.skeleton.getCurrentTime()),
c.toSkel.setAnimation(c.animations[c.currAnim])):c.skeleton.setAnimation(c.animations[c.currAnim]));c.playing=!0}}else console.error(pc.string.format("Trying to play animation '{0}' which doesn't exist",a))},getAnimation:function(a){return this.data.animations[a]},setModel:function(a){var b=this.data;if(a){var c=a.getGraph();b.fromSkel=new pc.Skeleton(c);b.toSkel=new pc.Skeleton(c);b.skeleton=new pc.Skeleton(c);b.skeleton.setLooping(b.loop);b.skeleton.setGraph(c)}b.model=a;b.animations&&(b.currAnim&&
b.animations[b.currAnim])&&this.play(b.currAnim)},loadAnimationAssets:function(a){if(a&&a.length){for(var b={parent:this.entity.getRequest()},c=a.map(function(a){return this.system.app.assets.getAssetById(a)},this),d={},e=[],f=[],k=0,m=c.length;k<m;k++){var h=c[k];h?(h.off("change",this.onAssetChanged,this),h.on("change",this.onAssetChanged,this),h.resource?d[h.name]=h.resource:(e.push(h.name),f.push(new pc.resources.AnimationRequest(h.getFileUrl())))):logERROR(pc.string.format("Trying to load animation component before assets {0} are loaded",
a))}f.length?this.system.app.loader.request(f,b).then(function(a){for(var b=0;b<f.length;b++)d[e[b]]=a[b];this.animations=d}.bind(this)):this.animations=d}},onAssetChanged:function(a,b,c){"resource"===b&&(c?(this.animations[a.name]=c,this.data.currAnim===a.name&&this.data.playing&&(this.data.enabled&&this.entity.enabled)&&this.play(a.name,0)):delete this.animations[a.name])},onSetAnimations:function(){var a=this.data,b=this.entity.model;b&&(b=b.model)&&this.entity.animation.setModel(b);for(var c in a.animations){a.activate&&
(a.enabled&&this.entity.enabled)&&this.play(c,0);break}},onSetAssets:function(a,b,c){if(b&&b.length)for(a=0;a<b.length;a++)if(b[a]){var d=this.system.app.assets.getAssetById(b[a]);d&&d.off("change",this.onAssetChanged,this)}this.loadAnimationAssets(c)},onSetLoop:function(){this.data.skeleton&&this.data.skeleton.setLooping(this.data.loop)},onSetCurrentTime:function(a,b,c){this.data.skeleton.setCurrentTime(c);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()},onEnable:function(){e._super.onEnable.call(this);
if(this.data.activate&&!this.data.currAnim)for(var a in this.data.animations){this.play(a,0);break}}});Object.defineProperties(e.prototype,{currentTime:{get:function(){return this.data.skeleton.getCurrentTime()},set:function(a){this.data.skeleton.setCurrentTime(a);this.data.skeleton.addTime(0);this.data.skeleton.updateGraph()}},duration:{get:function(){return this.data.animations[this.data.currAnim].getDuration()}}});return{AnimationComponent:e}}());pc.extend(pc,function(){var e=function(a){this.id="animation";this.description="Specifies the animation assets that can run on the model specified by the Entity's model Component.";a.systems.add(this.id,this);this.ComponentType=pc.AnimationComponent;this.DataType=pc.AnimationComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the component",type:"boolean",defaultValue:!0},{name:"assets",displayName:"Asset",description:"Animation Asset",type:"asset",options:{max:100,
type:"animation"},defaultValue:[]},{name:"speed",displayName:"Speed Factor",description:"Scale the animation playback speed",type:"number",options:{step:0.1},defaultValue:1},{name:"loop",displayName:"Loop",description:"Loop the animation back to the start on completion",type:"boolean",defaultValue:!0},{name:"activate",displayName:"Activate",description:"Play the configured animation on load",type:"boolean",defaultValue:!0},{name:"animations",exposed:!1},{name:"skeleton",exposed:!1,readOnly:!0},{name:"model",
exposed:!1,readOnly:!0},{name:"prevAnim",exposed:!1,readOnly:!0},{name:"currAnim",exposed:!1,readOnly:!0},{name:"fromSkel",exposed:!1,readOnly:!0},{name:"toSkel",exposed:!1,readOnly:!0},{name:"blending",exposed:!1,readOnly:!0},{name:"blendTime",exposed:!1,readOnly:!0},{name:"blendTimeRemaining",exposed:!1,readOnly:!0},{name:"playing",exposed:!1,readOnly:!0}];this.exposeProperties();this.on("remove",this.onRemove,this);this.on("update",this.onUpdate,this);pc.ComponentSystem.on("update",this.onUpdate,
this)},e=pc.inherits(e,pc.ComponentSystem);pc.extend(e.prototype,{initializeComponentData:function(a,b,c){c=["activate","loop","speed","assets","enabled"];e._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){this.addComponent(b,{});b.animation.data.assets=pc.extend([],a.animation.assets);b.animation.data.speed=a.animation.speed;b.animation.data.loop=a.animation.loop;b.animation.data.activate=a.animation.activate;b.animation.data.enabled=a.animation.enabled;b.animation.animations=
pc.extend({},a.animation.animations)},onRemove:function(a,b){delete b.animation;delete b.skeleton;delete b.fromSkel;delete b.toSkel},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c],e=d.data;e.enabled&&(e.playing&&d.entity.enabled)&&(d=e.skeleton,null!==d&&null!==e.model&&(e.blending?(e.blendTimeRemaining-=a,0>e.blendTimeRemaining&&(e.blendTimeRemaining=0),d.blend(e.fromSkel,e.toSkel,1-e.blendTimeRemaining/e.blendTime)):(d.addTime(a*e.speed),d.getCurrentTime()===
d.getAnimation().getDuration()&&!e.loop&&(e.playing=!1)),e.blending&&0===e.blendTimeRemaining&&(e.blending=!1,d.setAnimation(e.toSkel.getAnimation())),d.updateGraph()))}}});return{AnimationComponentSystem:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.assets=[];this.speed=1;this.enabled=this.activate=this.loop=!0;this.toSkel=this.fromSkel=this.currAnim=this.prevAnim=this.model=this.skeleton=this.animations=null;this.blending=!1;this.blendTimeRemaining=this.blendTime=0;this.playing=!1},pc.ComponentData);return{AnimationComponentData:e}}());pc.extend(pc,function(){var e=function(a){this.id="model";this.description="Renders a 3D model at the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.ModelComponent;this.DataType=pc.ModelComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable rendering of the Model",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"Type of model",type:"enumeration",options:{enumerations:[{name:"Asset",value:"asset"},{name:"Box",
value:"box"},{name:"Capsule",value:"capsule"},{name:"Sphere",value:"sphere"},{name:"Cylinder",value:"cylinder"},{name:"Cone",value:"cone"},{name:"Plane",value:"plane"}]},defaultValue:"asset"},{name:"asset",displayName:"Asset",description:"Model Asset to render",type:"asset",options:{max:1,type:"model"},defaultValue:null,filter:{type:"asset"}},{name:"materialAsset",displayName:"Material",description:"The material of the model",type:"asset",options:{max:1,type:"material"},defaultValue:null,filter:{type:function(){return!1}}},
{name:"castShadows",displayName:"Cast shadows",description:"Occlude light",type:"boolean",defaultValue:!1},{name:"receiveShadows",displayName:"Receive shadows",description:"Receive shadows cast from occluders",type:"boolean",defaultValue:!0},{name:"material",exposed:!1},{name:"model",exposed:!1}];this.exposeProperties();a=a.graphicsDevice;this.box=pc.createBox(a,{halfExtents:new pc.Vec3(0.5,0.5,0.5)});this.capsule=pc.createCapsule(a,{radius:0.5,height:2});this.sphere=pc.createSphere(a,{radius:0.5});
this.cone=pc.createCone(a,{baseRadius:0.5,peakRadius:0,height:1});this.cylinder=pc.createCylinder(a,{radius:0.5,height:1});this.plane=pc.createPlane(a,{halfExtents:new pc.Vec2(0.5,0.5),widthSegments:1,lengthSegments:1});this.defaultMaterial=new pc.PhongMaterial},e=pc.inherits(e,pc.ComponentSystem);pc.extend(e.prototype,{initializeComponentData:function(a,b,c){b.material=this.defaultMaterial;c="material materialAsset asset castShadows receiveShadows type enabled".split(" ");e._super.initializeComponentData.call(this,
a,b,c)},removeComponent:function(a){var b=a.model.data;a.model.asset=null;"asset"!==b.type&&b.model&&(this.app.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null);e._super.removeComponent.call(this,a)},cloneComponent:function(a,b){this.addComponent(b,{});b.model.data.type=a.model.type;b.model.data.materialAsset=a.model.materialAsset;b.model.data.asset=a.model.asset;b.model.data.castShadows=a.model.castShadows;b.model.data.receiveShadows=a.model.receiveShadows;b.model.data.material=
a.model.material;b.model.data.enabled=a.model.enabled;a.model.model&&(b.model.model=a.model.model.clone())}});return{ModelComponentSystem:e}}());pc.extend(pc,function(){var e=function(){this.on("set_type",this.onSetType,this);this.on("set_asset",this.onSetAsset,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_model",this.onSetModel,this);this.on("set_receiveShadows",this.onSetReceiveShadows,this);this.on("set_material",this.onSetMaterial,this);Object.defineProperty(this,"materialAsset",{set:this.setMaterialAsset.bind(this),get:this.getMaterialAsset.bind(this)})},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{setVisible:function(a){console.warn("WARNING: setVisible: Function is deprecated. Set enabled property instead.");
this.enabled=a},loadModelAsset:function(a){var b={parent:this.entity.getRequest()},c=this.system.app.assets.getAssetById(a);c?(c.off("change",this.onAssetChange,this),c.on("change",this.onAssetChange,this),c.resource?(a=c.resource.clone(),this._onModelLoaded(a)):this.system.app.assets.load(c,[],b).then(function(a){this._onModelLoaded(a[0])}.bind(this))):logERROR(pc.string.format("Trying to load model before asset {0} is loaded.",a))},_onModelLoaded:function(a){this.system.app.designer&&a.generateWireframe();
"asset"===this.data.type&&(this.model=a)},onSetType:function(a,b,c){a=this.data;if(c)if(b=null,"asset"===c)null!==this.data.asset?this.loadModelAsset(this.data.asset):this.model=null;else{switch(c){case "box":b=this.system.box;break;case "capsule":b=this.system.capsule;break;case "sphere":b=this.system.sphere;break;case "cone":b=this.system.cone;break;case "cylinder":b=this.system.cylinder;break;case "plane":b=this.system.plane;break;default:throw Error("Invalid model type: "+c);}var c=new pc.GraphNode,
d=new pc.Model;d.graph=c;d.meshInstances=[new pc.MeshInstance(c,b,a.material)];this.system.app.designer&&d.generateWireframe();this.model=d;this.asset=null}},onSetAsset:function(a,b,c){b&&(a=this.system.app.assets.getAssetById(b))&&a.off("change",this.onAssetChange,this);"asset"===this.data.type&&(c?c instanceof pc.asset.Asset?(this.data.asset=c.id,this.loadModelAsset(c.id)):this.loadModelAsset(c):this.model=null)},onSetCastShadows:function(a,b,c){if(a=this.data.model){var b=this.system.app.scene,
d=b.containsModel(a);d&&b.removeModel(a);for(var e=a.meshInstances,f=0;f<e.length;f++)e[f].castShadow=c;d&&b.addModel(a)}},onSetModel:function(a,b,c){b&&(this.system.app.scene.removeModel(b),this.entity.removeChild(b.getGraph()),delete b._entity);if(c){for(var a=this.data,b=c.meshInstances,d=0;d<b.length;d++)b[d].castShadow=a.castShadows,b[d].receiveShadow=a.receiveShadows;this.entity.addChild(c.graph);this.enabled&&this.entity.enabled&&this.system.app.scene.addModel(c);c._entity=this.entity;this.entity.animation&&
this.entity.animation.setModel(c)}},setMaterialAsset:function(a){var a="number"===typeof a||!a?a:a.id,b;if(void 0!==a&&null!==a){var c=this.system.app.assets.getAssetById(a);c?c.resource?this.material=b=c.resource:this.system.app.assets.load(c).then(function(a){this.material=a[0]}.bind(this)):console.error(pc.string.format("Entity '{0}' is trying to load Material Asset {1} which no longer exists. Maybe this model was once a primitive shape?",this.entity.getPath(),a))}b||(b=this.system.defaultMaterial);
this.material=b;b=this.data.materialAsset;this.data.materialAsset=a;this.fire("set","materialAsset",b,a)},getMaterialAsset:function(){return this.system.app.assets.getAssetById(this.data.materialAsset)},onSetMaterial:function(a,b,c){if(c!==b&&(this.data.material=c,this.data.model&&"asset"!==this.data.type)){a=this.data.model.meshInstances;for(b=0;b<a.length;b++)a[b].material=c}},onSetReceiveShadows:function(a,b,c){if(void 0!==c&&(a=this.data,a.model)){a=a.model.meshInstances;for(b=0;b<a.length;b++)a[b].receiveShadow=
c}},onEnable:function(){e._super.onEnable.call(this);var a=this.data.model;a&&(this.system.app.scene.containsModel(a)||this.system.app.scene.addModel(a))},onDisable:function(){e._super.onDisable.call(this);var a=this.data.model;a&&this.system.app.scene.containsModel(a)&&this.system.app.scene.removeModel(a)},onAssetChange:function(a,b,c,d){if("resource"===b)c&&this._onModelLoaded(c);else if("data"===b){b=!1;c=c.mapping;d=d.mapping;if(c&&!d||d&&!c)b=!0;else if(c)if(c&&c.length!==d.length)b=!0;else for(var e=
0;e<c.length;e++)if(c[e].material!==d[e].material){b=!0;break}b&&(a.resource=null,this.system.app.loader.removeFromCache(a.getFileUrl()),this.loadModelAsset(a.id))}}});return{ModelComponent:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.enabled=!0;this.type="asset";this.asset=null;this.castShadows=!1;this.receiveShadows=!0;this.model=this.material=this.materialAsset=null},pc.ComponentData);return{ModelComponentData:e}}());pc.extend(pc,function(){var e=function(a){this.id="skybox";this.description="Renders a skybox in the scene.";a.systems.add(this.id,this);this.ComponentType=pc.SkyboxComponent;this.DataType=pc.SkyboxComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the component",type:"boolean",defaultValue:!0},{name:"posx",displayName:"POSX",description:"URL of the positive X face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negx",
displayName:"NEGX",description:"URL of the negative X face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posy",displayName:"POSY",description:"URL of the positive Y face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negy",displayName:"NEGY",description:"URL of the negative Y face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"posz",displayName:"POSZ",description:"URL of the positive Z face of skybox cubemap",
type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"negz",displayName:"NEGZ",description:"URL of the negative Z face of skybox cubemap",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"model",exposed:!1,readOnly:!0},{name:"assets",exposed:!1,readOnly:!0},{name:"cubemap",exposed:!1}];this.exposeProperties();this.on("remove",this.onRemove,this)},e=pc.inherits(e,pc.ComponentSystem);pc.extend(e.prototype,{initializeComponentData:function(a,b,c){c="enabled posx negx posy negy posz negz cubemap".split(" ");
e._super.initializeComponentData.call(this,a,b,c)},onRemove:function(a,b){b.model&&(this.app.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=null)}});return{SkyboxComponentSystem:e}}());pc.extend(pc,function(){var e=function(){this.on("set",this.onSet,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{onSet:function(b,c,d){function e(b,c){if(!(void 0===c||null===c)){var d=a.indexOf(b),f=this.entity.skybox.assets;this.data.model=null;f[d]=this.system.app.assets.getAssetById(c);if(f[d]){if(this.data.assets=f,f[0]&&f[1]&&f[2]&&f[3]&&f[4]&&f[5]){d=this.data;a:{for(var g=this.entity,h=this.system.app,k=h.graphicsDevice,m=[],w=[],A=[],x,z=0;z<f.length;z++)if(x=f[z])if(x.resource){x=
x.resource.getSource();if(!x){logERROR(pc.string.format("Trying to load skybox component with invalid texture types"));f=void 0;break a}m.push(x)}else A.push(z),w.push(new pc.resources.TextureRequest(x.getFileUrl()));else{logERROR(pc.string.format("Trying to load skybox component before assets are loaded"));f=void 0;break a}var H=new pc.Texture(k,{format:pc.PIXELFORMAT_R8_G8_B8,cubemap:!0});H.minFilter=pc.FILTER_LINEAR_MIPMAP_LINEAR;H.magFilter=pc.FILTER_LINEAR;H.addressU=pc.ADDRESS_CLAMP_TO_EDGE;
H.addressV=pc.ADDRESS_CLAMP_TO_EDGE;w.length?(f={parent:g.getRequest()},h.loader.request(w,f).then(function(a){for(var b=0;b<a.length;b++)m[A[b]]=a[b].getSource();H.setSource(m)})):H.setSource(m);w=new pc.Material;w.updateShader=function(){var a=k.getProgramLibrary().getProgram("skybox",{hdr:!1,gamma:h.scene.gammaCorrection,toneMapping:h.scene.toneMapping});this.setShader(a)};w.updateShader();w.setParameter("texture_cubeMap",H);w.cull=pc.CULLFACE_NONE;f=new pc.GraphNode;g=pc.createBox(k);w=new pc.MeshInstance(f,
g,w);g=new pc.Model;g.graph=f;g.meshInstances=[w];f=g}d.model=f;this.enabled&&this.entity.enabled&&(this.system.app.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))}}else logERROR(pc.string.format("Trying to load skybox component before asset {0} has loaded",c))}}if("cubemap"==b&&d){var b=this.data,f=this.system.app,k=f.graphicsDevice,m=new pc.Material;m.updateShader=function(){var a=k.getProgramLibrary().getProgram("skybox",{hdr:d.hdr,prefiltered:!0,gamma:f.scene.gammaCorrection,
toneMapping:f.scene.toneMapping});this.setShader(a)};m.updateShader();m.setParameter("texture_cubeMap",d);m.cull=pc.CULLFACE_NONE;var c=new pc.GraphNode,h=pc.createBox(k),m=new pc.MeshInstance(c,h,m),h=new pc.Model;h.graph=c;h.meshInstances=[m];b.model=h;this.enabled&&this.entity.enabled&&(this.system.app.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))}else m={posx:function(a,b,c,d){e.call(this,b,d)},negx:function(a,b,c,d){e.call(this,b,d)},posy:function(a,b,c,d){e.call(this,
b,d)},negy:function(a,b,c,d){e.call(this,b,d)},posz:function(a,b,c,d){e.call(this,b,d)},negz:function(a,b,c,d){e.call(this,b,d)}},m[b]&&m[b].call(this,this.entity,b,c,d)},onEnable:function(){e._super.onEnable.call(this);this.data.model&&!this.system.app.scene.containsModel(this.data.model)&&(this.system.app.scene.addModel(this.data.model),this.entity.addChild(this.data.model.graph))},onDisable:function(){e._super.onDisable.call(this);this.data.model&&this.system.app.scene.containsModel(this.data.model)&&
(this.entity.removeChild(this.data.model.graph),this.system.app.scene.removeModel(this.data.model))}});var a="posx negx posy negy posz negz".split(" ");return{SkyboxComponent:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.enabled=!0;this.negz=this.posz=this.negy=this.posy=this.negx=this.posx=null;this.assets=[];this.model=null},pc.ComponentData);return{SkyboxComponentData:e}}());pc.extend(pc,function(){var e=function(a){this.id="camera";this.description="Renders the scene from the location of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.CameraComponent;this.DataType=pc.CameraComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the component",type:"boolean",defaultValue:!0},{name:"clearColorBuffer",displayName:"Clear Color Buffer",description:"Clear color buffer",type:"boolean",defaultValue:!0},{name:"clearColor",
displayName:"Clear Color",description:"Clear Color",type:"rgba",defaultValue:[0.7294117647058823,0.7294117647058823,0.6941176470588235,1],filter:{clearColorBuffer:!0}},{name:"clearDepthBuffer",displayName:"Clear Depth Buffer",description:"Clear depth buffer",type:"boolean",defaultValue:!0},{name:"projection",displayName:"Projection",description:"Projection type of camera",type:"enumeration",options:{enumerations:[{name:"Perspective",value:0},{name:"Orthographic",value:1}]},defaultValue:0},{name:"fov",
displayName:"Field of View",description:"Field of view in Y axis",type:"number",defaultValue:45,options:{min:0,max:90},filter:{projection:0}},{name:"orthoHeight",displayName:"Ortho Height",description:"View window half extent of camera in Y axis",type:"number",defaultValue:100,filter:{projection:1}},{name:"nearClip",displayName:"Near Clip",description:"Near clipping distance",type:"number",defaultValue:0.3,options:{min:1E-4,decimalPrecision:5}},{name:"farClip",displayName:"Far Clip",description:"Far clipping distance",
type:"number",defaultValue:1E3,options:{min:1E-4,decimalPrecision:5}},{name:"priority",displayName:"Priority",description:"Controls which camera will be rendered first. Smaller numbers are rendered first.",type:"number",defaultValue:0},{name:"rect",displayName:"Viewport",description:"Controls where on the screen the camera will be rendered in normalized coordinates.",type:"vector",defaultValue:[0,0,1,1]},{name:"camera",exposed:!1},{name:"aspectRatio",exposed:!1},{name:"model",exposed:!1},{name:"renderTarget",
exposed:!1}];this.exposeProperties();this.cameras=[];this.on("beforeremove",this.onBeforeRemove,this);this.on("remove",this.onRemove,this);pc.ComponentSystem.on("toolsUpdate",this.toolsUpdate,this)},e=pc.inherits(e,pc.ComponentSystem);pc.extend(e.prototype,{initializeComponentData:function(a,b,c){b=b||{};b.clearColor&&"array"===pc.type(b.clearColor)&&(c=b.clearColor,b.clearColor=new pc.Color(c[0],c[1],c[2],c[3]));b.rect&&"array"===pc.type(b.rect)&&(c=b.rect,b.rect=new pc.Vec4(c[0],c[1],c[2],c[3]));
b.activate&&(console.warn("WARNING: activate: Property is deprecated. Set enabled property instead."),b.enabled=b.activate);b.camera=new pc.Camera;b._node=a.entity;b.postEffects=new pc.PostEffectQueue(this.app,a);if(this.app.designer&&this.displayInTools(a.entity)){c=new pc.BasicMaterial;c.color=new pc.Color(1,1,0,1);c.update();var d=new pc.IndexBuffer(this.app.graphicsDevice,pc.INDEXFORMAT_UINT8,24);(new Uint8Array(d.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);d.unlock();var g=
new pc.VertexFormat(this.app.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),f=new pc.VertexBuffer(this.app.graphicsDevice,g,8,pc.BUFFER_DYNAMIC),g=new pc.Mesh;g.vertexBuffer=f;g.indexBuffer[0]=d;g.primitive[0].type=pc.PRIMITIVE_LINES;g.primitive[0].base=0;g.primitive[0].count=d.getNumIndices();g.primitive[0].indexed=!0;d=new pc.Model;d.graph=a.entity;d.meshInstances=[new pc.MeshInstance(d.graph,g,c)];this.app.scene.addModel(d);b.model=d}c="postEffects enabled model camera aspectRatio renderTarget clearColor fov orthoHeight nearClip farClip projection priority clearColorBuffer clearDepthBuffer rect".split(" ");
e._super.initializeComponentData.call(this,a,b,c)},onBeforeRemove:function(a,b){this.removeCamera(b)},onRemove:function(a,b){this.app.designer&&this.displayInTools(a)&&this.app.scene.containsModel(b.model)&&this.app.scene.removeModel(b.model);b.camera=null},toolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].entity;this.displayInTools(c)&&this._updateGfx(c.camera)}},_updateGfx:function(a){if(a.model&&a.model.meshInstances.length){var b=a.model.meshInstances[0].mesh.vertexBuffer,
c=a.camera.getAspectRatio(),d=this.isToolsCamera(a.entity)?0.5:a.nearClip,e=this.isToolsCamera(a.entity)?2:a.farClip,f=a.fov*Math.PI/180,k=a.projection,m;m=k===pc.PROJECTION_PERSPECTIVE?Math.tan(f/2)*d:a.camera.getOrthoHeight();var a=m*c,h=new Float32Array(b.lock());h[0]=a;h[1]=-m;h[2]=-d;h[3]=a;h[4]=m;h[5]=-d;h[6]=-a;h[7]=m;h[8]=-d;h[9]=-a;h[10]=-m;h[11]=-d;k===pc.PROJECTION_PERSPECTIVE&&(m=Math.tan(f/2)*e,a=m*c);h[12]=a;h[13]=-m;h[14]=-e;h[15]=a;h[16]=m;h[17]=-e;h[18]=-a;h[19]=m;h[20]=-e;h[21]=
-a;h[22]=-m;h[23]=-e;b.unlock()}},addCamera:function(a){this.cameras.push(a);this.sortCamerasByPriority();if(this.app.designer&&(a=a.data.model)){var b=this.app.scene;b.containsModel(a)||b.addModel(a)}},removeCamera:function(a){var b=this.cameras.indexOf(a);0<=b&&(this.cameras.splice(b,1),this.sortCamerasByPriority(),this.app.designer&&(a=a.data.model)&&this.app.scene.removeModel(a))},sortCamerasByPriority:function(){this.cameras.sort(function(a,b){return a.priority-b.priority})},isToolsCamera:function(a){return a.hasLabel("pc:designer")},
displayInTools:function(a){return!this.isToolsCamera(a)||"Perspective"===a.getName()}});return{CameraComponentSystem:e}}());pc.extend(pc,function(){var e=function(){this.on("set_aspectRatio",this.onSetAspectRatio,this);this.on("set_camera",this.onSetCamera,this);this.on("set_clearColor",this.onSetClearColor,this);this.on("set_fov",this.onSetFov,this);this.on("set_orthoHeight",this.onSetOrthoHeight,this);this.on("set_nearClip",this.onSetNearClip,this);this.on("set_farClip",this.onSetFarClip,this);this.on("set_projection",this.onSetProjection,this);this.on("set_priority",this.onSetPriority,this);this.on("set_clearColorBuffer",
this.updateClearFlags,this);this.on("set_clearDepthBuffer",this.updateClearFlags,this);this.on("set_renderTarget",this.onSetRenderTarget,this);this.on("set_rect",this.onSetRect,this)},e=pc.inherits(e,pc.Component);Object.defineProperty(e.prototype,"activate",{get:function(){console.warn("WARNING: activate: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: activate: Property is deprecated. Set enabled property instead.");this.enabled=
a}});Object.defineProperty(e.prototype,"projectionMatrix",{get:function(){return this.data.camera.getProjectionMatrix()}});Object.defineProperty(e.prototype,"viewMatrix",{get:function(){return this.data.camera.getWorldTransform().clone().invert()}});Object.defineProperty(e.prototype,"frustum",{get:function(){return this.data.camera.getFrustum()}});pc.extend(e.prototype,{screenToWorld:function(a,b,c,d){var e=this.system.app.graphicsDevice,f=parseInt(e.canvas.clientWidth),e=parseInt(e.canvas.clientHeight);
return this.data.camera.screenToWorld(a,b,c,f,e,d)},worldToScreen:function(a,b){var c=this.system.app.graphicsDevice,d=parseInt(c.canvas.clientWidth),c=parseInt(c.canvas.clientHeight);return this.data.camera.worldToScreen(a,d,c,b)},onSetAspectRatio:function(a,b,c){this.data.camera.setAspectRatio(c)},onSetCamera:function(a,b,c){b&&(b._node=null);c._node=this.entity},onSetClearColor:function(a,b,c){a=this.data.camera.getClearOptions();a.color[0]=c.r;a.color[1]=c.g;a.color[2]=c.b;a.color[3]=c.a},onSetFov:function(a,
b,c){this.data.camera.setFov(c)},onSetOrthoHeight:function(a,b,c){this.data.camera.setOrthoHeight(c)},onSetNearClip:function(a,b,c){this.data.camera.setNearClip(c)},onSetFarClip:function(a,b,c){this.data.camera.setFarClip(c)},onSetProjection:function(a,b,c){this.data.camera.setProjection(c)},onSetPriority:function(){this.system.sortCamerasByPriority()},updateClearFlags:function(){var a=this.data.camera.getClearOptions(),b=0;this.clearColorBuffer&&(b|=pc.CLEARFLAG_COLOR);this.clearDepthBuffer&&(b|=
pc.CLEARFLAG_DEPTH);a.flags=b},onSetRenderTarget:function(a,b,c){this.data.camera.setRenderTarget(c)},onSetRect:function(a,b,c){this.data.camera.setRect(c.data[0],c.data[1],c.data[2],c.data[3]);this._resetAspectRatio()},onEnable:function(){e._super.onEnable.call(this);this.system.addCamera(this);this.postEffects.enable()},onDisable:function(){e._super.onDisable.call(this);this.postEffects.disable();this.system.removeCamera(this)},_resetAspectRatio:function(){var a=this.camera;if(a){var b=this.system.app.graphicsDevice,
c=this.rect,b=b.width*c.z/(b.height*c.w);b!==a.getAspectRatio()&&a.setAspectRatio(b)}},frameBegin:function(){this._resetAspectRatio();this.data.isRendering=!0},frameEnd:function(){this.data.isRendering=!1}});return{CameraComponent:e}}());pc.extend(pc,function(){CameraComponentData=function(){this.clearColor=new pc.Color(0.729411780834198,0.729411780834198,0.6941176652908325,1);this.clearDepthBuffer=this.clearColorBuffer=!0;this.nearClip=0.1;this.farClip=1E3;this.fov=45;this.orthoHeight=100;this.projection=pc.PROJECTION_PERSPECTIVE;this.priority=0;this.rect=new pc.Vec4(0,0,1,1);this.enabled=!0;this.camera=null;this.aspectRatio=16/9;this.postEffects=this.renderTarget=null;this.isRendering=!1};CameraComponentData=pc.inherits(CameraComponentData,
pc.ComponentData);return{CameraComponentData:CameraComponentData}}());pc.extend(pc,function(){var e=function(a){this.id="light";this.description="Enables the Entity to emit light.";a.systems.add(this.id,this);this.ComponentType=pc.LightComponent;this.DataType=pc.LightComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the light",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of the light",type:"enumeration",options:{enumerations:[{name:"Directional",value:"directional"},{name:"Point",
value:"point"},{name:"Spot",value:"spot"}]},defaultValue:"directional"},{name:"color",displayName:"Color",description:"Light Color",type:"rgb",defaultValue:[1,1,1]},{name:"intensity",displayName:"Intensity",description:"The intensity of the light",type:"number",defaultValue:1,options:{min:0,max:10,step:0.05}},{name:"castShadows",displayName:"Cast Shadows",description:"Cast shadows from this light",type:"boolean",defaultValue:!1},{name:"shadowDistance",displayName:"Shadow Distance",description:"Camera distance at which shadows are no longer rendered",
type:"number",options:{min:0,decimalPrecision:5},defaultValue:40,filter:{castShadows:!0,type:"directional"}},{name:"shadowResolution",displayName:"Shadow Resolution",description:"Resolution of shadowmap generated by this light",type:"enumeration",options:{enumerations:[{name:"128",value:128},{name:"256",value:256},{name:"512",value:512},{name:"1024",value:1024},{name:"2048",value:2048}]},defaultValue:1024,filter:{castShadows:!0}},{name:"shadowBias",displayName:"Shadow Bias",description:"Tunes the shadows to reduce rendering artifacts",
type:"number",options:{min:0,max:1,decimalPrecision:5,step:0.01},defaultValue:0.05,filter:{castShadows:!0}},{name:"normalOffsetBias",displayName:"Normal Offset Shadow Bias",description:"Tunes the shadows to reduce rendering artifacts",type:"number",options:{min:0,max:1,decimalPrecision:5,step:0.01},defaultValue:0,filter:{castShadows:!0}},{name:"range",displayName:"Range",description:"The distance from the light where its contribution falls to zero",type:"number",defaultValue:10,options:{min:0},filter:{type:["point",
"spot"]}},{name:"falloffMode",displayName:"Falloff mode",description:"Controls the rate at which a light attentuates from its position",type:"enumeration",options:{enumerations:[{name:"Linear",value:pc.LIGHTFALLOFF_LINEAR},{name:"Inverse squared",value:pc.LIGHTFALLOFF_INVERSESQUARED}]},defaultValue:0,filter:{type:["point","spot"]}},{name:"innerConeAngle",displayName:"Inner Cone Angle",description:"Spotlight inner cone angle",type:"number",defaultValue:40,options:{min:0,max:90},filter:{type:"spot"}},
{name:"outerConeAngle",displayName:"Outer Cone Angle",description:"Spotlight outer cone angle",type:"number",defaultValue:45,options:{min:0,max:90},filter:{type:"spot"}},{name:"light",exposed:!1},{name:"model",exposed:!1}];this.exposeProperties();this.implementations={};this.on("remove",this.onRemove,this);pc.ComponentSystem.on("toolsUpdate",this.toolsUpdate,this)},e=pc.inherits(e,pc.ComponentSystem);pc.extend(e.prototype,{initializeComponentData:function(a,b,c){b.type||(b.type=a.data.type);a.data.type=
b.type;b.color&&"array"===pc.type(b.color)&&(b.color=new pc.Color(b.color[0],b.color[1],b.color[2]));b.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),b.enabled=b.enable);this._createImplementation(b.type).initialize(a,b);c="type light model enabled color intensity range falloffMode innerConeAngle outerConeAngle castShadows shadowDistance shadowResolution shadowBias normalOffsetBias".split(" ");e._super.initializeComponentData.call(this,a,b,c)},_createImplementation:function(a){var b=
this.implementations[a];if(!b){switch(a){case "directional":b=new DirectionalLightImplementation(this);break;case "point":b=new PointLightImplementation(this);break;case "spot":b=new SpotLightImplementation(this);break;default:throw Error("Invalid light type: "+a);}this.implementations[a]=b}return b},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},cloneComponent:function(a,b){var c=a.light;this.addComponent(b,{type:c.type,enabled:c.enabled,color:[c.color.r,c.color.g,c.color.b],intensity:c.intensity,
range:c.range,innerConeAngle:c.innerConeAngle,outerConeAngle:c.outerConeAngle,castShadows:c.castShadows,shadowDistance:c.shadowDistance,shadowResolution:c.shadowResolution,falloffMode:c.falloffMode,shadowBias:c.shadowBias,normalOffsetBias:c.normalOffsetBias})},toolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b].data,d=this.implementations[c.type];d&&d.toolsUpdate(c)}},changeType:function(a,b,c){this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).initialize(a,
a.data)}});LightComponentImplementation=function(a){this.system=a};LightComponentImplementation.prototype={initialize:function(a,b){var c=new pc.Light;c.setType(this._getLightType());c._node=a.entity;this.system.app.scene.addLight(c);this._createDebugShape(a,b,c)},_getLightType:function(){},_createDebugShape:function(a,b,c){var d=this.system.app,b=b||{};b.light=c;d.designer&&(this.mesh=this._createDebugMesh(),this.material||(this.material=this._createDebugMaterial()),c=new pc.Model,c.graph=a.entity,
c.meshInstances=[new pc.MeshInstance(a.entity,this.mesh,this.material)],d.scene.addModel(c),b.model=c)},_createDebugMesh:function(){},_createDebugMaterial:function(){},remove:function(a,b){var c=this.system.app;c.scene.removeModel(b.model);delete b.model;c.scene.removeLight(b.light);c.designer&&(c.scene.removeModel(b.model),delete b.model)},toolsUpdate:function(){}};DirectionalLightImplementation=function(){};DirectionalLightImplementation=pc.inherits(DirectionalLightImplementation,LightComponentImplementation);
DirectionalLightImplementation.prototype=pc.extend(DirectionalLightImplementation.prototype,{_getLightType:function(){return pc.LIGHTTYPE_DIRECTIONAL},_createDebugMesh:function(){if(this.mesh)return this.mesh;var a=this.system.app,b=new pc.VertexFormat(a.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]);vertexData=[0,0,0,0,-8,0,-0.5,-8,0,0.5,-8,0,0.5,-8,0,0,-10,0,0,-10,0,-0.5,-8,0,0,0,-2,0,-8,-2,-0.25,-8,-2,0.25,-8,-2,0.25,-8,-2,0,-10,-2,0,-10,-2,-0.25,-8,
-2,0,0,2,0,-8,2,-0.25,-8,2,0.25,-8,2,0.25,-8,2,0,-10,2,0,-10,2,-0.25,-8,2];var c=(new pc.Mat4).setFromAxisAngle(pc.Vec3.UP,120),d;for(d=0;24>d;d++){var e=new pc.Vec3(vertexData[3*(d+8)],vertexData[3*(d+8)+1],vertexData[3*(d+8)+2]),e=c.transformPoint(e,e);vertexData[3*(d+24)]=e[0];vertexData[3*(d+24)+1]=e[1];vertexData[3*(d+24)+2]=e[2]}a=new pc.VertexBuffer(a.graphicsDevice,b,32);b=new Float32Array(a.lock());for(d=0;d<vertexData.length;d++)b[d]=vertexData[d];a.unlock();d=new pc.Mesh;d.vertexBuffer=
a;d.indexBuffer[0]=null;d.primitive[0].type=pc.PRIMITIVE_LINES;d.primitive[0].base=0;d.primitive[0].count=a.getNumVertices();d.primitive[0].indexed=!1;return d},_createDebugMaterial:function(){var a=new pc.BasicMaterial;a.color=new pc.Color(1,1,0,1);a.update();return a}});PointLightImplementation=function(){};PointLightImplementation=pc.inherits(PointLightImplementation,LightComponentImplementation);PointLightImplementation.prototype=pc.extend(PointLightImplementation.prototype,{_getLightType:function(){return pc.LIGHTTYPE_POINT},
_createDebugMesh:function(){return this.mesh?this.mesh:pc.createSphere(this.system.app.graphicsDevice,{radius:0.1})},_createDebugMaterial:function(){var a=new pc.BasicMaterial;a.color=new pc.Color(1,1,0,1);a.update();return a}});SpotLightImplementation=function(){};SpotLightImplementation=pc.inherits(SpotLightImplementation,LightComponentImplementation);SpotLightImplementation.prototype=pc.extend(SpotLightImplementation.prototype,{_getLightType:function(){return pc.LIGHTTYPE_SPOT},_createDebugMesh:function(){var a=
this.system.app,b=this.indexBuffer;if(!b){var b=new pc.IndexBuffer(a.graphicsDevice,pc.INDEXFORMAT_UINT8,88),c=new Uint8Array(b.lock());c[0]=0;c[1]=1;c[2]=0;c[3]=11;c[4]=0;c[5]=21;c[6]=0;c[7]=31;for(var d=0;40>d;d++)c[2*d+8]=d+1,c[2*d+9]=d+2;b.unlock();this.indexBuffer=b}c=new pc.VertexFormat(a.graphicsDevice,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]);a=new pc.VertexBuffer(a.graphicsDevice,c,42,pc.BUFFER_DYNAMIC);c=new pc.Mesh;c.vertexBuffer=a;c.indexBuffer[0]=b;c.primitive[0].type=
pc.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=b.getNumIndices();c.primitive[0].indexed=!0;return c},_createDebugMaterial:function(){return new pc.BasicMaterial},toolsUpdate:function(a){var b=a.model.meshInstances[0].mesh.vertexBuffer,c=Math.PI*a.outerConeAngle/180,d=a.range,a=-d*Math.cos(c),c=d*Math.sin(c),d=new Float32Array(b.lock());d[0]=0;d[1]=0;d[2]=0;for(var e=b.getNumVertices(),f=0;f<e-1;f++){var k=2*Math.PI*(f/(e-2)),m=c*Math.cos(k),k=c*Math.sin(k);d[3*(f+1)+0]=m;d[3*(f+1)+
1]=a;d[3*(f+1)+2]=k}b.unlock()}});return{LightComponentSystem:e}}());pc.extend(pc,function(){var e=function(){this.on("set_type",this.onSetType,this);this.on("set_color",this.onSetColor,this);this.on("set_intensity",this.onSetIntensity,this);this.on("set_castShadows",this.onSetCastShadows,this);this.on("set_shadowDistance",this.onSetShadowDistance,this);this.on("set_shadowResolution",this.onSetShadowResolution,this);this.on("set_shadowBias",this.onSetShadowBias,this);this.on("set_normalOffsetBias",this.onSetNormalOffsetBias,this);this.on("set_range",this.onSetRange,
this);this.on("set_innerConeAngle",this.onSetInnerConeAngle,this);this.on("set_outerConeAngle",this.onSetOuterConeAngle,this);this.on("set_falloffMode",this.onSetFalloffMode,this)},e=pc.inherits(e,pc.Component);Object.defineProperty(e.prototype,"enable",{get:function(){console.warn("WARNING: enable: Property is deprecated. Query enabled property instead.");return this.enabled},set:function(a){console.warn("WARNING: enable: Property is deprecated. Set enabled property instead.");this.enabled=a}});
pc.extend(e.prototype,{onSetType:function(a,b,c){b!==c&&(this.system.changeType(this,b,c),this.refreshProperties())},refreshProperties:function(){this.onSetCastShadows("castShadows",this.castShadows,this.castShadows);this.onSetColor("color",this.color,this.color);this.onSetIntensity("intensity",this.intensity,this.intensity);this.onSetShadowDistance("shadowDistance",this.shadowDistance,this.shadowDistance);this.onSetShadowResolution("shadowResolution",this.shadowResolution,this.shadowResolution);
this.onSetShadowBias("shadowBias",this.shadowBias,this.shadowBias);this.onSetNormalOffsetBias("normalOffsetBias",this.normalOffsetBias,this.normalOffsetBias);this.onSetRange("range",this.range,this.range);this.onSetInnerConeAngle("innerConeAngle",this.innerConeAngle,this.innerConeAngle);this.onSetOuterConeAngle("outerConeAngle",this.outerConeAngle,this.outerConeAngle);this.onSetFalloffMode("falloffMode",this.falloffMode,this.falloffMode);if(this.enabled&&this.entity.enabled)this.onEnable()},onSetCastShadows:function(a,
b,c){this.light.setCastShadows(c)},onSetColor:function(a,b,c){this.light.setColor(c)},onSetIntensity:function(a,b,c){this.light.setIntensity(c)},onSetShadowDistance:function(a,b,c){"directional"===this.data.type&&this.light.setShadowDistance(c)},onSetShadowResolution:function(a,b,c){this.light.setShadowResolution(c)},onSetShadowBias:function(a,b,c){this.light.setShadowBias(-0.01*c)},onSetNormalOffsetBias:function(a,b,c){this.light.setNormalOffsetBias(c)},onSetRange:function(a,b,c){("point"===this.data.type||
"spot"===this.data.type)&&this.light.setAttenuationEnd(c)},onSetInnerConeAngle:function(a,b,c){"spot"===this.data.type&&this.light.setInnerConeAngle(c)},onSetOuterConeAngle:function(a,b,c){"spot"===this.data.type&&this.light.setOuterConeAngle(c)},onSetFalloffMode:function(a,b,c){("point"===this.data.type||"spot"===this.data.type)&&this.light.setFalloffMode(c)},onEnable:function(){e._super.onEnable.call(this);this.light.setEnabled(!0);var a=this.data.model;if(a){var b=this.system.app.scene;b.containsModel(a)||
b.addModel(a)}},onDisable:function(){e._super.onDisable.call(this);this.light.setEnabled(!1);var a=this.data.model;a&&this.system.app.scene.removeModel(a)}});return{LightComponent:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.type="directional";this.enabled=!0;this.color=new pc.Color(1,1,1);this.intensity=1;this.castShadows=!1;this.shadowDistance=40;this.shadowResolution=1024;this.shadowBias=0.05;this.normalOffsetBias=0;this.range=10;this.innerConeAngle=40;this.outerConeAngle=45;this.falloffMode=pc.LIGHTFALLOFF_LINEAR;this.model=this.light=null},pc.ComponentData);return{LightComponentData:e}}());pc.extend(pc,function(){var e=function(a){this.id="script";this.description="Allows the Entity to run JavaScript fragments to implement custom behavior.";a.systems.add(this.id,this);this.ComponentType=pc.ScriptComponent;this.DataType=pc.ScriptComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled components are not updated",type:"boolean",defaultValue:!0},{name:"scripts",displayName:"URLs",description:"Attach scripts to this Entity",type:"script",defaultValue:[]},{name:"instances",
exposed:!1},{name:"runInTools",description:"Allows scripts to be loaded and executed while in the tools",defaultValue:!1,exposed:!1}];this.exposeProperties();this.instancesWithUpdate=[];this.instancesWithFixedUpdate=[];this.instancesWithPostUpdate=[];this.instancesWithToolsUpdate=[];this.on("beforeremove",this.onBeforeRemove,this);pc.ComponentSystem.on("initialize",this.onInitialize,this);pc.ComponentSystem.on("postInitialize",this.onPostInitialize,this);pc.ComponentSystem.on("update",this.onUpdate,
this);pc.ComponentSystem.on("fixedUpdate",this.onFixedUpdate,this);pc.ComponentSystem.on("postUpdate",this.onPostUpdate,this);pc.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},e=pc.inherits(e,pc.ComponentSystem);pc.extend(e.prototype,{initializeComponentData:function(a,b,c){c=["runInTools","enabled","scripts"];b.scripts&&b.scripts.length&&b.scripts.forEach(function(a){if(a.attributes&&"array"===pc.type(a.attributes)){for(var b={},c=0;c<a.attributes.length;c++)b[a.attributes[c].name]=a.attributes[c];
a.attributes=b}});e._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){var c=this.dataStore[a.getGuid()],c={runInTools:c.data.runInTools,scripts:pc.extend([],c.data.scripts),enabled:c.data.enabled};return this.addComponent(b,c)},onBeforeRemove:function(a,b){b.enabled&&this._disableScriptComponent(b);this._destroyScriptComponent(b)},onInitialize:function(a){this._registerInstances(a);if(a.enabled){a.script&&a.script.enabled&&this._initializeScriptComponent(a.script);var a=
a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.Entity)this.onInitialize(a[b])}},onPostInitialize:function(a){if(a.enabled){a.script&&a.script.enabled&&this._postInitializeScriptComponent(a.script);var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.Entity)this.onPostInitialize(a[b])}},_callInstancesMethod:function(a,b){var c=a.data.instances,d;for(d in c)if(c.hasOwnProperty(d)){var e=c[d].instance;e[b]&&e[b].call(e)}},_initializeScriptComponent:function(a){this._callInstancesMethod(a,
"initialize");a.data.initialized=!0;a.enabled&&a.entity.enabled&&this._enableScriptComponent(a)},_enableScriptComponent:function(a){this._callInstancesMethod(a,"onEnable")},_disableScriptComponent:function(a){this._callInstancesMethod(a,"onDisable")},_destroyScriptComponent:function(a){var b,c=a.data.instances,d;for(d in c)if(c.hasOwnProperty(d)){var e=c[d].instance;e.destroy&&e.destroy();e.update&&(b=this.instancesWithUpdate.indexOf(e),0<=b&&this.instancesWithUpdate.splice(b,1));e.fixedUpdate&&(b=
this.instancesWithFixedUpdate.indexOf(e),0<=b&&this.instancesWithFixedUpdate.splice(b,1));e.postUpdate&&(b=this.instancesWithPostUpdate.indexOf(e),0<=b&&this.instancesWithPostUpdate.splice(b,1));e.toolsUpdate&&(b=this.instancesWithToolsUpdate.indexOf(e),0<=b&&this.instancesWithToolsUpdate.splice(b,1));a.instances[d].instance===a[d]&&delete a[d];delete a.instances[d]}},_postInitializeScriptComponent:function(a){this._callInstancesMethod(a,"postInitialize");a.data.postInitialized=!0},_updateInstances:function(a,
b,c){for(var d,e=0,f=b.length;e<f;e++)(d=b[e])&&(d.entity.script.enabled&&d.entity.enabled)&&d[a].call(d,c)},onUpdate:function(a){this._updateInstances("update",this.instancesWithUpdate,a)},onFixedUpdate:function(a){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,a)},onPostUpdate:function(a){this._updateInstances("postUpdate",this.instancesWithPostUpdate,a)},onToolsUpdate:function(a){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,a)},broadcast:function(a,b){console.warn("DEPRECATED: ScriptComponentSystem.broadcast() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");
var c=pc.makeArray(arguments).slice(2),d,e,f,k=this.store;for(d in k)k.hasOwnProperty(d)&&(e=k[d].data,e.instances[a]&&(f=e.instances[a].instance[b])&&f.apply(e.instances[a].instance,c))},_preRegisterInstance:function(a,b,c,d){if(a.script){a.script.data._instances=a.script.data._instances||{};if(a.script.data._instances[c])throw Error(pc.string.format("Script name collision '{0}'. Scripts from '{1}' and '{2}' {{3}}",c,b,a.script.data._instances[c].url,a.getGuid()));a.script.data._instances[c]={url:b,
name:c,instance:d}}},_registerInstances:function(a){var b,c,d;if(a.script&&a.script.data._instances){a.script.instances=a.script.data._instances;for(d in a.script.instances){b=a.script.instances[d];c=b.instance;pc.events.attach(c);c.update&&this.instancesWithUpdate.push(c);c.fixedUpdate&&this.instancesWithFixedUpdate.push(c);c.postUpdate&&this.instancesWithPostUpdate.push(c);c.toolsUpdate&&this.instancesWithToolsUpdate.push(c);a.script.scripts&&this._createAccessors(a,b);if(a.script[d])throw Error(pc.string.format("Script with name '{0}' is already attached to Script Component",
d));a.script[d]=c}delete a.script.data._instances}a=a.getChildren();c=a.length;for(b=0;b<c;b++)a[b]instanceof pc.Entity&&this._registerInstances(a[b])},_createAccessors:function(a,b){var c,d=a.script.scripts.length,e=b.url;for(c=0;c<d;c++){var f=a.script.scripts[c];if(f.url===e){c=f.attributes;if(f.name&&c){for(var k in c)c.hasOwnProperty(k)&&this._createAccessor(c[k],b);a.script.data.attributes[f.name]=pc.extend({},c)}break}}},_createAccessor:function(a,b){var c=this;c._convertAttributeValue(a);
Object.defineProperty(b.instance,a.name,{get:function(){return a.value},set:function(d){var e=a.value;a.value=d;c._convertAttributeValue(a);b.instance.fire("set",a.name,e,a.value)},configurable:!0})},_updateAccessors:function(a,b){var c,d=a.script.scripts.length,e,f=b.url,k,m;for(c=0;c<d;c++)if(k=a.script,m=k.scripts[c],m.url===f){c=m.name;m=m.attributes;if(c){if(m)for(e in m)m.hasOwnProperty(e)&&this._createAccessor(m[e],b);if(d=k.data.attributes[c])for(e in d)if(f=d[e],e in m){if(m[e].value!==f.value&&
b.instance.onAttributeChanged)b.instance.onAttributeChanged(f.name,f.value,m[e].value)}else delete b.instance[f.name];m?k.data.attributes[c]=pc.extend([],m):delete k.data.attributes[c]}break}},_convertAttributeValue:function(a){"rgb"===a.type||"rgba"===a.type?"array"===pc.type(a.value)&&(a.value=3===a.value.length?new pc.Color(a.value[0],a.value[1],a.value[2]):new pc.Color(a.value[0],a.value[1],a.value[2],a.value[3])):"vector"===a.type&&"array"===pc.type(a.value)&&(a.value=new pc.Vec3(a.value[0],
a.value[1],a.value[2]))}});return{ScriptComponentSystem:e}}());pc.extend(pc,function(){var e=function(){this.on("set_scripts",this.onSetScripts,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{send:function(a,b){console.warn("DEPRECATED: ScriptComponent.send() is deprecated and will be removed soon. Please use: http://developer.playcanvas.com/user-manual/scripting/communication/");var c=pc.makeArray(arguments).slice(2),d=this.entity.script.instances,e;if(d&&d[a]&&(e=d[a].instance[b]))return e.apply(d[a].instance,c)},onEnable:function(){e._super.onEnable.call(this);
this.data.areScriptsLoaded&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){e._super.onDisable.call(this);this.system._disableScriptComponent(this)},onSetScripts:function(a,b,c){if((!this.system._inTools||this.runInTools)&&!this._updateScriptAttributes(b,c))this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),
this.data.areScriptsLoaded=!1,a=c.map(function(a){return a.url}),this._loadFromCache(a)||this._loadScripts(a)},_updateScriptAttributes:function(a,b){var c=!0;if(a.length!==b.length)c=!1;else{var d;len=b.length;for(d=0;d<len;d++)if(a[d].url!==b[d].url){c=!1;break}}if(c)for(var e in this.instances)this.instances.hasOwnProperty(e)&&this.system._updateAccessors(this.entity,this.instances[e]);return c},_loadFromCache:function(a){for(var b=[],c=0,d=a.length;c<d;c++){var e=this.system.app.loader.getFromCache(a[c]);
if(e)b.push(e);else return!1}c=0;for(d=b.length;c<d;c++)if(e=b[c],!0!=e&&e&&this.entity.script&&!this.entity.script.instances[e._pcScriptName]){var f=new e(this.entity);this.system._preRegisterInstance(this.entity,a[c],e._pcScriptName,f)}this.data&&(this.data.areScriptsLoaded=!0);this.system.onInitialize(this.entity);this.system.onPostInitialize(this.entity);return!0},_loadScripts:function(a){var b=a.map(function(a){return new pc.resources.ScriptRequest(a)}),c={parent:this.entity.getRequest()};this.system.app.loader.request(b,
c).then(function(b){b.forEach(function(b,c){if(b&&this.entity.script&&!this.entity.script.instances[b._pcScriptName]){var d=new b(this.entity);this.system._preRegisterInstance(this.entity,a[c],b._pcScriptName,d)}},this);this.data&&(this.data.areScriptsLoaded=!0);c.parent||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity))}.bind(this)).then(null,function(a){setTimeout(function(){throw a;})})}});return{ScriptComponent:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.scripts=[];this.enabled=!0;this.instances={};this._instances={};this.runInTools=!1;this.attributes={};this.areScriptsLoaded=this.postInitialized=this.initialized=!1},pc.ComponentData);return{ScriptComponentData:e}}());pc.extend(pc,function(){var e=function(a){this.id="pack";a.systems.add(this.id,this);this.ComponentType=pc.PackComponent;this.DataType=pc.PackComponentData;this.schema=[]},e=pc.inherits(e,pc.ComponentSystem);return{PackComponentSystem:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){},pc.Component);return{PackComponent:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){},pc.ComponentData);return{PackComponentData:e}}());pc.extend(pc,function(){var e=function(a){this.id="pick";a.systems.add(this.id,this);this.ComponentType=pc.PickComponent;this.DataType=pc.PickComponentData;this.schema=[{name:"layer",exposed:!1},{name:"shapes",exposed:!1},{name:"material",exposed:!1}];this.layers={"default":[]};this.display=!1;this.on("remove",this.onRemove,this)},e=pc.inherits(e,pc.ComponentSystem);pc.extend(e.prototype,{initializeComponentData:function(a,b,c){b.material=new pc.PhongMaterial;c=["material"];e._super.initializeComponentData.call(this,
a,b,c)},onRemove:function(a,b){this.deleteShapes(b.layer,b.shapes)},addShape:function(a,b){void 0===this.layers[a]&&(this.layers[a]=[]);this.layers[a].push(b.model);this.display&&this.app.scene.addModel(b.model)},deleteShapes:function(a,b){for(var c=this.layers[a],d=0;d<b.length;d++){var e=b[d].model,f=c.indexOf(e);-1!==f&&c.splice(f,1);this.display&&this.app.scene.removeModel(e)}},getLayerModels:function(a){return this.layers[a]}});return{PickComponentSystem:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){},pc.Component);pc.extend(e.prototype,{addShape:function(a,b){var c=this.data.material,d=null;switch(a.type){case pc.shape.Type.BOX:d=pc.createBox(this.system.app.graphicsDevice,{halfExtents:a.halfExtents});break;case pc.shape.Type.SPHERE:d=pc.createSphere(this.system.app.graphicsDevice,{radius:a.radius});break;case pc.shape.Type.TORUS:d=pc.createTorus(this.system.app.graphicsDevice,{tubeRadius:a.iradius,ringRadius:a.oradius})}var e=new pc.GraphNode,
c=new pc.MeshInstance(e,d,c);c._entity=this.entity;d=new pc.Model;d.graph=e;d.meshInstances=[c];a={shape:a,shapeName:b,model:d};this.data.shapes.push(a);this.system.addShape(this.data.layer,a)},deleteShapes:function(){this.system.deleteShapes(this.data.layer,this.data.shapes);this.data.shapes=[]}});return{PickComponent:e}}());pc.extend(pc,function(){function e(){this.layer="default";this.shapes=[];this.material=null}e=pc.inherits(e,pc.ComponentData);return{PickComponentData:e}}());pc.extend(pc,function(){var e=function(a,b){this.id="audiosource";this.description="Specifies audio assets that can be played at the position of the Entity.";a.systems.add(this.id,this);this.ComponentType=pc.AudioSourceComponent;this.DataType=pc.AudioSourceComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled audiosource components do not play any sounds",type:"boolean",defaultValue:!0},{name:"assets",displayName:"Assets",description:"Audio assets",type:"asset",options:{max:100,
type:"audio"},defaultValue:[]},{name:"volume",displayName:"Volume",description:"The sound volume",type:"number",options:{max:1,min:0,step:0.1},defaultValue:1},{name:"pitch",displayName:"Pitch",description:"The sound pitch",type:"number",defaultValue:1,options:{min:0.01,step:0.01}},{name:"loop",displayName:"Loop",description:"Set whether sound loops or not",type:"boolean",defaultValue:!1},{name:"activate",displayName:"Activate",description:"Play first audio sample when scene loads",type:"boolean",
defaultValue:!0},{name:"3d",displayName:"3d",description:"3d sounds are positioned in space, and their sound is dependent on listener position/orientation. Non-3d sounds are uniform across space",type:"boolean",defaultValue:!0},{name:"minDistance",displayName:"Min Distance",description:"Distance from listener under which the sound is at full volume",type:"number",defaultValue:1,options:{min:0}},{name:"maxDistance",displayName:"Max Distance",description:"Distance from listener over which the sound cannot be heard",
type:"number",defaultValue:1E4,options:{min:0}},{name:"rollOffFactor",displayName:"Roll-off factor",description:"Strength of the roll off",type:"number",defaultValue:1,options:{min:0}},{name:"sources",exposed:!1,readOnly:!0},{name:"currentSource",exposed:!1,readOnly:!0},{name:"channel",exposed:!1,readOnly:!0}];this.exposeProperties();this.manager=b;this.initialized=!1;pc.ComponentSystem.on("initialize",this.onInitialize,this);pc.ComponentSystem.on("update",this.onUpdate,this)},e=pc.inherits(e,pc.ComponentSystem);
pc.extend(e.prototype,{initializeComponentData:function(a,b,c){c="activate volume pitch loop 3d minDistance maxDistance rollOffFactor enabled assets".split(" ");e._super.initializeComponentData.call(this,a,b,c);a.paused=!(a.enabled&&a.activate)},onInitialize:function(a){a.audiosource&&(a.enabled&&a.audiosource.enabled&&a.audiosource.activate)&&a.audiosource.play(a.audiosource.currentSource);var a=a.getChildren(),b,c=a.length;for(b=0;b<c;b++)if(a[b]instanceof pc.Entity)this.onInitialize(a[b]);this.initialized=
!0},onUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b],d=c.entity,c=c.data;c.enabled&&(d.enabled&&c.channel instanceof pc.Channel3d)&&(d=d.getPosition(),c.channel.setPosition(d))}},setVolume:function(a){this.manager.setVolume(a)}});return{AudioSourceComponentSystem:e}}());pc.extend(pc,function(){var e=function(){this.on("set_assets",this.onSetAssets,this);this.on("set_loop",this.onSetLoop,this);this.on("set_volume",this.onSetVolume,this);this.on("set_pitch",this.onSetPitch,this);this.on("set_minDistance",this.onSetMinDistance,this);this.on("set_maxDistance",this.onSetMaxDistance,this);this.on("set_rollOffFactor",this.onSetRollOffFactor,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{play:function(a){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();
var b,c=this.data;c.sources[a]&&(c.sources[a].isLoaded?(c["3d"]?(b=this.entity.getPosition(),b=this.system.manager.playSound3d(c.sources[a],b,c)):b=this.system.manager.playSound(c.sources[a],c),c.currentSource=a,c.channel=b):logWARNING(pc.string.format("Audio asset '{0}' is not loaded (probably an unsupported format) and will not be played",a)))}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&
(this.channel.stop(),this.channel=null)},onSetAssets:function(a,b,c){var a=[],d,e=c.length;if(b&&b.length)for(d=0;d<b.length;d++)if(b[d]){var f=this.system.app.assets.getAssetById(b[d]);f&&f.off("change",this.onAssetChanged,this)}if(e)for(d=0;d<e;d++)0>b.indexOf(c[d])&&a.push(c[d]);!this.system._inTools&&a.length&&this.loadAudioSourceAssets(a)},onAssetChanged:function(a,b,c){"resource"===b&&this.data.sources&&(this.data.sources[a.name]=c,this.data.currentSource===a.name&&this.channel&&(this.channel.paused?
(this.play(a.name),this.pause()):this.play(a.name)))},onSetLoop:function(a,b,c){b!=c&&this.channel&&this.channel.setLoop(c)},onSetVolume:function(a,b,c){b!=c&&this.channel&&this.channel.setVolume(c)},onSetPitch:function(a,b,c){b!=c&&this.channel&&this.channel.setPitch(c)},onSetMaxDistance:function(a,b,c){b!=c&&this.channel instanceof pc.Channel3d&&this.channel.setMaxDistance(c)},onSetMinDistance:function(a,b,c){b!=c&&this.channel instanceof pc.Channel3d&&this.channel.setMinDistance(c)},onSetRollOffFactor:function(a,
b,c){b!=c&&this.channel instanceof pc.Channel3d&&this.channel.setRollOffFactor(c)},onEnable:function(){e._super.onEnable.call(this);this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){e._super.onDisable.call(this);this.pause()},loadAudioSourceAssets:function(a){var b={parent:this.entity.getRequest()},c=[],d=[],e={},f=null;a.map(function(a){return this.system.app.assets.getAssetById(a)},this).forEach(function(b){b?(f=f||b.name,
b.off("change",this.onAssetChanged,this),b.on("change",this.onAssetChanged,this),b.resource?e[b.name]=b.resource:(c.push(new pc.resources.AudioRequest(b.getFileUrl())),d.push(b.name))):logERROR(pc.string.format("Trying to load audiosource component before assets {0} are loaded",a))}.bind(this));if(c.length)this.system.app.loader.request(c,b).then(function(a){for(var m=0;m<c.length;m++)e[d[m]]=a[m];this.data.sources=e;this.data.currentSource=f;if(!b.parent&&this.enabled&&this.activate&&f)this.onEnable()}.bind(this));
else if(this.data.sources=e,this.data.currentSource=f,this.enabled&&this.activate&&f)this.onEnable()}});return{AudioSourceComponent:e}}());pc.AudioSourceComponentData=function(){this.enabled=!0;this.assets=[];this.activate=!0;this.pitch=this.volume=1;this.loop=!1;this["3d"]=!0;this.minDistance=1;this.maxDistance=1E4;this.rollOffFactor=1;this.paused=!0;this.sources={};this.channel=this.currentSource=null};pc.extend(pc,function(){var e=function(a,b){this.id="audiolistener";this.description="Specifies the location of the listener for 3D audio playback.";a.systems.add(this.id,this);this.ComponentType=pc.AudioListenerComponent;this.DataType=pc.AudioListenerComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Disabled audio listener components do not affect audiosources",type:"boolean",defaultValue:!0}];this.exposeProperties();this.manager=b;this.current=null;pc.ComponentSystem.on("update",
this.onUpdate,this)},e=pc.inherits(e,pc.ComponentSystem);pc.extend(e.prototype,{initializeComponentData:function(a,b,c){c=["enabled"];e._super.initializeComponentData.call(this,a,b,c)},onUpdate:function(){if(this.current){var a=this.current.getPosition();this.manager.listener.setPosition(a);a=this.current.getWorldTransform();this.manager.listener.setOrientation(a)}}});return{AudioListenerComponentSystem:e}}());pc.extend(pc,function(){var e=function(){},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var a=this.system.current.getPosition();this.system.manager.listener.setPosition(a)}},onEnable:function(){e._super.onEnable.call(this);this.setCurrentListener()},onDisable:function(){e._super.onDisable.call(this);this.system.current===this.entity&&(this.system.current=null)}});
return{AudioListenerComponent:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.enabled=!0},pc.ComponentData);return{AudioListenerComponentData:e}}());pc.extend(pc,function(){var e=function(a){a.systems.add("designer",this)},e=pc.inherits(e,pc.ComponentSystem);e.prototype.createComponent=function(a,b){var c=new pc.DesignerComponentData;this.initializeComponent(a,c,b,["fillWindow","width","height"]);return c};return{DesignerComponentSystem:e}}());pc.extend(pc,function(){DesignerComponentData=function(){this.fillWindow=!0;this.width=800;this.height=450};DesignerComponentData=pc.inherits(DesignerComponentData,pc.ComponentData);return{DesignerComponentData:DesignerComponentData}}());pc.extend(pc,{BODYTYPE_STATIC:"static",BODYTYPE_DYNAMIC:"dynamic",BODYTYPE_KINEMATIC:"kinematic",BODYFLAG_STATIC_OBJECT:1,BODYFLAG_KINEMATIC_OBJECT:2,BODYFLAG_NORESPONSE_OBJECT:4,BODYSTATE_ACTIVE_TAG:1,BODYSTATE_ISLAND_SLEEPING:2,BODYSTATE_WANTS_DEACTIVATION:3,BODYSTATE_DISABLE_DEACTIVATION:4,BODYSTATE_DISABLE_SIMULATION:5,BODYGROUP_NONE:0,BODYGROUP_DEFAULT:1,BODYGROUP_DYNAMIC:1,BODYGROUP_STATIC:2,BODYGROUP_KINEMATIC:4,BODYGROUP_ENGINE_1:8,BODYGROUP_TRIGGER:16,BODYGROUP_ENGINE_2:32,BODYGROUP_ENGINE_3:64,
BODYGROUP_USER_1:128,BODYGROUP_USER_2:256,BODYGROUP_USER_3:512,BODYGROUP_USER_4:1024,BODYGROUP_USER_5:2048,BODYGROUP_USER_6:4096,BODYGROUP_USER_7:8192,BODYGROUP_USER_8:16384,BODYMASK_NONE:0,BODYMASK_ALL:65535,BODYMASK_STATIC:2,BODYMASK_NOT_STATIC:65533,BODYMASK_NOT_STATIC_KINEMATIC:65529});pc.extend(pc,function(){new pc.Mat4;new pc.Mat4;new pc.Vec3;new pc.Vec3;new pc.Vec3;var e,a,b={},c={},d=function(a,b,c){this.entity=a;this.point=b;this.normal=c},g=function(a,b,c){0===arguments.length?(this.b=this.a=null,this.localPointA=new pc.Vec3,this.localPointB=new pc.Vec3,this.pointA=new pc.Vec3,this.pointB=new pc.Vec3,this.normal=new pc.Vec3):(this.a=a,this.b=b,this.localPointA=c.localPoint,this.localPointB=c.localPointOther,this.pointA=c.point,this.pointB=c.pointOther,this.normal=c.normal)},
f=function(a,b,c,d,e){0===arguments.length?(this.localPoint=new pc.Vec3,this.localPointOther=new pc.Vec3,this.point=new pc.Vec3,this.pointOther=new pc.Vec3,this.normal=new pc.Vec3):(this.localPoint=a,this.localPointOther=b,this.point=c,this.pointOther=d,this.normal=e)},k=function(a,b){this.other=a;this.contacts=b},m=function(a){this.id="rigidbody";this.description="Adds the entity to the scene's physical simulation.";a.systems.add(this.id,this);this.ComponentType=pc.RigidBodyComponent;this.DataType=
pc.RigidBodyComponentData;this.contactPointPool=new pc.AllocatePool(f,1);this.contactResultPool=new pc.AllocatePool(k,1);this.singleContactResultPool=new pc.AllocatePool(g,1);this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the rigid body",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of body determines how it moves and collides with other bodies. Dynamic is a normal body. Static will never move. Kinematic can be moved in code, but will not respond to collisions.",
type:"enumeration",options:{enumerations:[{name:"Static",value:pc.BODYTYPE_STATIC},{name:"Dynamic",value:pc.BODYTYPE_DYNAMIC},{name:"Kinematic",value:pc.BODYTYPE_KINEMATIC}]},defaultValue:pc.BODYTYPE_STATIC},{name:"mass",displayName:"Mass",description:"The mass of the body",type:"number",options:{min:0,step:1},defaultValue:1,filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"linearDamping",displayName:"Linear Damping",description:"The linear damping applied to the body",type:"number",
options:{min:0,step:1},defaultValue:0,filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"angularDamping",displayName:"Angular Damping",description:"The angular damping applied to the body",type:"number",options:{min:0,step:1},defaultValue:0,filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"linearFactor",displayName:"Linear Factor",description:"The linear factor applied to the linear motion of the body, used to contrain linear movement in each axis",type:"vector",options:{min:0,
step:0.1},defaultValue:[1,1,1],filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"angularFactor",displayName:"Angular Factor",description:"The angular factor applied to the angular motion of the body, used to contrain angular movement in each axis",type:"vector",options:{min:0,step:0.1},defaultValue:[1,1,1],filter:{type:[pc.BODYTYPE_DYNAMIC,pc.BODYTYPE_KINEMATIC]}},{name:"friction",displayName:"Friction",description:"The friction when the body slides along another body",type:"number",
options:{min:0,step:0.01},defaultValue:0.5},{name:"restitution",displayName:"Restitution",description:"The restitution determines the elasticity of collisions. 0 means an object does not bounce at all, a value of 1 will be a perfect reflection",type:"number",options:{min:0,step:0.01},defaultValue:0},{name:"group",displayName:"Group",description:"The collision group this rigidbody belongs to",type:"number",defaultValue:pc.BODYGROUP_STATIC,exposed:!1},{name:"mask",displayName:"Mask",description:"The collision mask this rigidbody uses to collide",
type:"number",defaultValue:pc.BODYMASK_NOT_STATIC,exposed:!1},{name:"body",exposed:!1}];this.exposeProperties();this.maxSubSteps=10;this.fixedTimeStep=1/60;this.on("remove",this.onRemove,this);pc.ComponentSystem.on("update",this.onUpdate,this)},m=pc.inherits(m,pc.ComponentSystem);pc.extend(m.prototype,{onLibraryLoaded:function(){if("undefined"!==typeof Ammo){var b=new Ammo.btDefaultCollisionConfiguration,c=new Ammo.btCollisionDispatcher(b),d=new Ammo.btDbvtBroadphase,f=new Ammo.btSequentialImpulseConstraintSolver;
this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(c,d,f,b);this._ammoGravity=new Ammo.btVector3(0,-9.82,0);this.dynamicsWorld.setGravity(this._ammoGravity);e=new Ammo.btVector3;a=new Ammo.btVector3}else pc.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){b.bodyType&&(b.type=b.bodyType,console.warn("WARNING: rigidbody.bodyType: Property is deprecated. Use type instead."));b.linearFactor&&"array"===pc.type(b.linearFactor)&&(b.linearFactor=new pc.Vec3(b.linearFactor[0],
b.linearFactor[1],b.linearFactor[2]));b.angularFactor&&"array"===pc.type(b.angularFactor)&&(b.angularFactor=new pc.Vec3(b.angularFactor[0],b.angularFactor[1],b.angularFactor[2]));c="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ");m._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){this.addComponent(b,{enabled:a.rigidbody.enabled,mass:a.rigidbody.mass,linearDamping:a.rigidbody.linearDamping,angularDamping:a.rigidbody.angularDamping,
linearFactor:[a.rigidbody.linearFactor.x,a.rigidbody.linearFactor.y,a.rigidbody.linearFactor.z],angularFactor:[a.rigidbody.angularFactor.x,a.rigidbody.angularFactor.y,a.rigidbody.angularFactor.z],friction:a.rigidbody.friction,restitution:a.rigidbody.restitution,type:a.rigidbody.type,group:a.rigidbody.group,mask:a.rigidbody.mask})},onRemove:function(a,b){b.body&&(this.removeBody(b.body),Ammo.destroy(b.body));b.body=null},addBody:function(a,b,c){void 0!==b&&void 0!==c?this.dynamicsWorld.addRigidBody(a,
b,c):this.dynamicsWorld.addRigidBody(a);return a},removeBody:function(a){this.dynamicsWorld.removeRigidBody(a)},addConstraint:function(a){this.dynamicsWorld.addConstraint(a);return a},removeConstraint:function(a){this.dynamicsWorld.removeConstraint(a)},setGravity:function(){var a,b,c;1===arguments.length?(a=arguments[0].x,b=arguments[0].y,c=arguments[0].z):(a=arguments[0],b=arguments[1],c=arguments[2]);this._ammoGravity.setValue(a,b,c);this.dynamicsWorld.setGravity(this._ammoGravity)},raycastFirst:function(b,
c,f){e.setValue(b.x,b.y,b.z);a.setValue(c.x,c.y,c.z);b=new Ammo.ClosestRayResultCallback(e,a);this.dynamicsWorld.rayTest(e,a,b);if(b.hasHit()){var c=b.get_m_collisionObject(),c=Ammo.castObject(c,Ammo.btRigidBody),g=b.get_m_hitPointWorld(),k=b.get_m_hitNormalWorld();c&&f(new d(c.entity,new pc.Vec3(g.x(),g.y(),g.z()),new pc.Vec3(k.x(),k.y(),k.z())))}Ammo.destroy(b)},_storeCollision:function(a,d){var e=!1,f=a.getGuid();b[f]=b[f]||{others:[],entity:a};0>b[f].others.indexOf(d)&&(b[f].others.push(d),e=
!0);c[f]=c[f]||{others:[],entity:a};c[f].others.push(d);return e},_createContactPointFromAmmo:function(a){var b=this.contactPointPool.allocate();b.localPoint.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z());b.localPointOther.set(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z());b.point.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());b.pointOther.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),
a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return b},_createReverseContactPointFromAmmo:function(a){var b=this.contactPointPool.allocate();b.localPointOther.set(a.get_m_localPointA().x(),a.get_m_localPointA().y(),a.get_m_localPointA().z());b.localPoint.set(a.get_m_localPointB().x(),a.get_m_localPointB().y(),a.get_m_localPointB().z());b.pointOther.set(a.getPositionWorldOnA().x(),a.getPositionWorldOnA().y(),a.getPositionWorldOnA().z());
b.point.set(a.getPositionWorldOnB().x(),a.getPositionWorldOnB().y(),a.getPositionWorldOnB().z());b.normal.set(a.get_m_normalWorldOnB().x(),a.get_m_normalWorldOnB().y(),a.get_m_normalWorldOnB().z());return b},_createSingleContactResult:function(a,b,c){var d=this.singleContactResultPool.allocate();d.a=a;d.b=b;d.localPointA=c.localPoint;d.localPointB=c.localPointOther;d.pointA=c.point;d.pointB=c.pointOther;d.normal=c.normal;return d},_createContactResult:function(a,b){var c=this.contactResultPool.allocate();
c.other=a;c.contacts=b;return c},_cleanOldCollisions:function(){for(var a in b)if(b.hasOwnProperty(a)){for(var d=b[a].entity,e=d.collision,f=b[a].others,g=f.length;g--;){var k=f[g];if(!c[a]||0>c[a].others.indexOf(k))f.splice(g,1),e&&k.collision&&(d.rigidbody&&k.rigidbody?e.fire("collisionend",k):d.trigger&&e.fire("triggerleave",k))}0===f.length&&delete b[a]}},onUpdate:function(a){frameContacts=0;this.dynamicsWorld.stepSimulation(a,this.maxSubSteps,this.fixedTimeStep);var b=this.store,d;for(d in b)if(b.hasOwnProperty(d)){var e=
b[d].entity,f=b[d].data;f.body&&(f.body.isActive()&&f.enabled&&e.enabled)&&(f.type===pc.BODYTYPE_DYNAMIC?e.rigidbody.syncBodyToEntity():f.type===pc.BODYTYPE_KINEMATIC&&e.rigidbody._updateKinematic(a))}var a=this.dynamicsWorld.getDispatcher(),b=a.getNumManifolds(),g;c={};for(d=0;d<b;d++){var k=a.getManifoldByIndexInternal(d),m=k.getBody0(),s=k.getBody1(),e=Ammo.castObject(m,Ammo.btRigidBody),f=Ammo.castObject(s,Ammo.btRigidBody),e=e.entity,f=f.entity;if(e&&f){g=m.getCollisionFlags();var w=s.getCollisionFlags(),
A=k.getNumContacts(),x=[],s=[];if(0<A)if(g&pc.BODYFLAG_NORESPONSE_OBJECT||w&pc.BODYFLAG_NORESPONSE_OBJECT){var z=e.collision?e.collision.hasEvent("triggerenter")||e.collision.hasEvent("triggerleave"):!1,m=f.collision?f.collision.hasEvent("triggerenter")||f.collision.hasEvent("triggerleave"):!1;z&&(k=this._storeCollision(e,f))&&e.collision&&!(w&pc.BODYFLAG_NORESPONSE_OBJECT)&&e.collision.fire("triggerenter",f);m&&(k=this._storeCollision(f,e))&&f.collision&&!(g&pc.BODYFLAG_NORESPONSE_OBJECT)&&f.collision.fire("triggerenter",
e)}else if(z=e.collision?e.collision.hasEvent("collisionstart")||e.collision.hasEvent("collisionend")||e.collision.hasEvent("contact"):!1,m=f.collision?f.collision.hasEvent("collisionstart")||f.collision.hasEvent("collisionend")||f.collision.hasEvent("contact"):!1,(w=this.hasEvent("contact"))||z||m){for(g=0;g<A;g++){var H=k.getContactPoint(g),G=this._createContactPointFromAmmo(H),K=null;if(z||m)K=this._createReverseContactPointFromAmmo(H),x.push(G),s.push(K);w&&(H=this._createSingleContactResult(e,
f,G),this.fire("contact",H))}z&&(A=this._createContactResult(f,x),e.collision&&e.collision.fire("contact",A),(k=this._storeCollision(e,f))&&e.collision&&e.collision.fire("collisionstart",A));m&&(s=this._createContactResult(e,s),f.collision&&f.collision.fire("contact",s),(k=this._storeCollision(f,e))&&f.collision&&f.collision.fire("collisionstart",s))}}}this._cleanOldCollisions();this.contactPointPool.freeAll();this.contactResultPool.freeAll();this.singleContactResultPool.freeAll()}});return{RIGIDBODY_TYPE_STATIC:"static",
RIGIDBODY_TYPE_DYNAMIC:"dynamic",RIGIDBODY_TYPE_KINEMATIC:"kinematic",RIGIDBODY_CF_STATIC_OBJECT:1,RIGIDBODY_CF_KINEMATIC_OBJECT:2,RIGIDBODY_CF_NORESPONSE_OBJECT:4,RIGIDBODY_ACTIVE_TAG:1,RIGIDBODY_ISLAND_SLEEPING:2,RIGIDBODY_WANTS_DEACTIVATION:3,RIGIDBODY_DISABLE_DEACTIVATION:4,RIGIDBODY_DISABLE_SIMULATION:5,RigidBodyComponentSystem:m}}());pc.extend(pc,function(){var e,a,b,c,d,g=function(f,g){"undefined"!==typeof Ammo&&!e&&(e=new Ammo.btTransform,a=new Ammo.btVector3,b=new Ammo.btVector3,c=new Ammo.btQuaternion,d=new Ammo.btVector3(0,0,0));this.on("set_mass",this.onSetMass,this);this.on("set_linearDamping",this.onSetLinearDamping,this);this.on("set_angularDamping",this.onSetAngularDamping,this);this.on("set_linearFactor",this.onSetLinearFactor,this);this.on("set_angularFactor",this.onSetAngularFactor,this);this.on("set_friction",this.onSetFriction,
this);this.on("set_restitution",this.onSetRestitution,this);this.on("set_type",this.onSetType,this);this.on("set_group",this.onSetGroupOrMask,this);this.on("set_mask",this.onSetGroupOrMask,this);this.on("set_body",this.onSetBody,this);g.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this);this.system.on("beforeremove",this.onBeforeRemove,this);this._displacement=new pc.Vec3(0,0,0);this._linearVelocity=new pc.Vec3(0,0,0);this._angularVelocity=new pc.Vec3(0,0,0)},g=pc.inherits(g,pc.Component);
Object.defineProperty(g.prototype,"bodyType",{get:function(){console.warn("WARNING: bodyType: Function is deprecated. Query type property instead.");return this.type},set:function(a){console.warn("WARNING: bodyType: Function is deprecated. Set type property instead.");this.type=a}});Object.defineProperty(g.prototype,"linearVelocity",{get:function(){if(this.isKinematic())return this._linearVelocity;if(this.body){var a=this.body.getLinearVelocity();this._linearVelocity.set(a.x(),a.y(),a.z());return this._linearVelocity}},
set:function(b){this.activate();if(this.isKinematic())this._linearVelocity.copy(b);else{var c=this.body;c&&(a.setValue(b.x,b.y,b.z),c.setLinearVelocity(a))}}});Object.defineProperty(g.prototype,"angularVelocity",{get:function(){if(this.isKinematic())return this._angularVelocity;if(this.body){var a=this.body.getAngularVelocity();this._angularVelocity.set(a.x(),a.y(),a.z());return this._angularVelocity}},set:function(b){this.activate();if(this.isKinematic())this._angularVelocity.copy(b);else{var c=
this.body;c&&(a.setValue(b.x,b.y,b.z),c.setAngularVelocity(a))}}});pc.extend(g.prototype,{createBody:function(){var b=this.entity,d;b.collision&&(d=b.collision.shape,b.trigger&&(b.trigger.destroy(),delete b.trigger));if(d){this.body&&(this.system.removeBody(this.body),Ammo.destroy(this.body));var e=this.isStaticOrKinematic(),g=e?0:this.mass,n=new Ammo.btVector3(0,0,0);e||d.calculateLocalInertia(g,n);var e=b.getPosition(),l=b.getRotation();c.setValue(l.x,l.y,l.z,l.w);l=new Ammo.btTransform;l.setIdentity();
l.getOrigin().setValue(e.x,e.y,e.z);l.setRotation(c);e=new Ammo.btDefaultMotionState(l);d=new Ammo.btRigidBodyConstructionInfo(g,e,d,n);d=new Ammo.btRigidBody(d);d.setRestitution(this.restitution);d.setFriction(this.friction);d.setDamping(this.linearDamping,this.angularDamping);g=this.linearFactor;a.setValue(g.x,g.y,g.z);d.setLinearFactor(a);g=this.angularFactor;a.setValue(g.x,g.y,g.z);d.setAngularFactor(a);d.entity=b;this.isKinematic()&&(d.setCollisionFlags(d.getCollisionFlags()|pc.BODYFLAG_KINEMATIC_OBJECT),
d.setActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION));b.rigidbody.body=d;this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){return this.body?this.body.isActive():!1},activate:function(){this.body&&this.body.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var a=this.body;a&&(this.system.addBody(a,this.group,this.mask),this.isKinematic()?(a.forceActivationState(pc.BODYSTATE_DISABLE_DEACTIVATION),
a.activate()):(a.forceActivationState(pc.BODYFLAG_ACTIVE_TAG),this.syncEntityToBody()),this.data.simulationEnabled=!0)}},disableSimulation:function(){var a=this.body;a&&this.data.simulationEnabled&&(this.system.removeBody(a),a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION),this.data.simulationEnabled=!1)},applyForce:function(){var c,e,g,h,n,l;switch(arguments.length){case 1:c=arguments[0].x;e=arguments[0].y;g=arguments[0].z;break;case 2:c=arguments[0].x;e=arguments[0].y;g=arguments[0].z;h=
arguments[1].x;n=arguments[1].y;l=arguments[1].z;break;case 3:c=arguments[0];e=arguments[1];g=arguments[2];break;case 6:c=arguments[0],e=arguments[1],g=arguments[2],h=arguments[3],n=arguments[4],l=arguments[5]}var r=this.body;r&&(r.activate(),a.setValue(c,e,g),void 0!==h?(b.setValue(h,n,l),r.applyForce(a,b)):r.applyForce(a,d))},applyTorque:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0];c=arguments[1];d=arguments[2];
break;default:console.error("ERROR: applyTorque: function takes 1 or 3 arguments");return}var e=this.body;e&&(e.activate(),a.setValue(b,c,d),e.applyTorque(a))},applyImpulse:function(){var c,e,g,h,n,l;switch(arguments.length){case 1:c=arguments[0].x;e=arguments[0].y;g=arguments[0].z;break;case 2:c=arguments[0].x;e=arguments[0].y;g=arguments[0].z;h=arguments[1].x;n=arguments[1].y;l=arguments[1].z;break;case 3:c=arguments[0];e=arguments[1];g=arguments[2];break;case 6:c=arguments[0],e=arguments[1],g=
arguments[2],h=arguments[0],n=arguments[1],l=arguments[2]}var r=this.body;r&&(r.activate(),a.setValue(c,e,g),void 0!==h?(b.setValue(h,n,l),r.applyImpulse(a,b)):r.applyImpulse(a,d))},applyTorqueImpulse:function(){var b,c,d;switch(arguments.length){case 1:b=arguments[0].x;c=arguments[0].y;d=arguments[0].z;break;case 3:b=arguments[0];c=arguments[1];d=arguments[2];break;default:console.error("ERROR: applyTorqueImpulse: function takes 1 or 3 arguments");return}var e=this.body;e&&(e.activate(),a.setValue(b,
c,d),e.applyTorqueImpulse(a))},isStatic:function(){return this.type===pc.BODYTYPE_STATIC},isStaticOrKinematic:function(){return this.type===pc.BODYTYPE_STATIC||this.type===pc.BODYTYPE_KINEMATIC},isKinematic:function(){return this.type===pc.BODYTYPE_KINEMATIC},syncEntityToBody:function(){var a=this.body;if(a){var b=this.entity.getPosition(),d=this.entity.getRotation(),e=a.getWorldTransform();e.getOrigin().setValue(b.x,b.y,b.z);c.setValue(d.x,d.y,d.z,d.w);e.setRotation(c);a.activate()}},syncBodyToEntity:function(){var a=
this.body;if(a.isActive()&&(a=a.getMotionState())){a.getWorldTransform(e);var a=e.getOrigin(),b=e.getRotation();this.entity.setPosition(a.x(),a.y(),a.z());this.entity.setRotation(b.x(),b.y(),b.z(),b.w())}},teleport:function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof pc.Quat?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],
arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2]));this.syncEntityToBody()},_updateKinematic:function(a){this._displacement.copy(this._linearVelocity).scale(a);this.entity.translate(this._displacement);this._displacement.copy(this._angularVelocity).scale(a);this.entity.rotate(this._displacement.x,this._displacement.y,this._displacement.z);if(this.body.getMotionState()){var a=this.entity.getPosition(),b=this.entity.getRotation();e.getOrigin().setValue(a.x,a.y,a.z);c.setValue(b.x,
b.y,b.z,b.w);e.setRotation(c);this.body.getMotionState().setWorldTransform(e)}},onEnable:function(){g._super.onEnable.call(this);this.body||this.createBody();this.enableSimulation()},onDisable:function(){g._super.onDisable.call(this);this.disableSimulation()},onSetMass:function(a,b,c){if(a=this.data.body){(b=this.enabled&&this.entity.enabled)&&this.disableSimulation();var d=new Ammo.btVector3(0,0,0);a.getCollisionShape().calculateLocalInertia(c,d);a.setMassProps(c,d);a.updateInertiaTensor();b&&this.enableSimulation()}},
onSetLinearDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(c,this.data.angularDamping)},onSetAngularDamping:function(a,b,c){(a=this.data.body)&&a.setDamping(this.data.linearDamping,c)},onSetLinearFactor:function(b,c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setLinearFactor(a)},onSetAngularFactor:function(b,c,d){if(b=this.data.body)a.setValue(d.x,d.y,d.z),b.setAngularFactor(a)},onSetFriction:function(a,b,c){(a=this.data.body)&&a.setFriction(c)},onSetRestitution:function(a,b,c){(a=this.data.body)&&
a.setRestitution(c)},onSetType:function(a,b,c){c!==b&&(this.disableSimulation(),c===pc.BODYTYPE_DYNAMIC?(this.data.group=pc.BODYGROUP_DYNAMIC,this.data.mask=pc.BODYMASK_ALL):c===pc.BODYTYPE_KINEMATIC?(this.data.group=pc.BODYGROUP_KINEMATIC,this.data.mask=pc.BODYMASK_ALL):(this.data.group=pc.BODYGROUP_STATIC,this.data.mask=pc.BODYMASK_NOT_STATIC),this.createBody())},onSetGroupOrMask:function(a,b,c){c!==b&&(this.enabled&&this.entity.enabled)&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(){this.body&&
this.data.simulationEnabled&&this.body.activate()},onLiveLinkUpdateTransform:function(){this.syncEntityToBody();this.angularVelocity=this.linearVelocity=pc.Vec3.ZERO},onBeforeRemove:function(a,b){this===b&&(a.off("livelink:updatetransform",this.onLiveLinkUpdateTransform,this),this.system.off("beforeremove",this.onBeforeRemove,this))}});return{RigidBodyComponent:g}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.enabled=!0;this.mass=1;this.angularDamping=this.linearDamping=0;this.linearFactor=new pc.Vec3(1,1,1);this.angularFactor=new pc.Vec3(1,1,1);this.friction=0.5;this.restitution=0;this.type=pc.BODYTYPE_STATIC;this.group=pc.BODYGROUP_STATIC;this.mask=pc.BODYMASK_NOT_STATIC;this.body=null;this.simulationEnabled=!1},pc.ComponentData);return{RigidBodyComponentData:e}}());pc.extend(pc,function(){var e,a,b=function(b,d,g){this.entity=d.entity;this.component=d;this.app=b;"undefined"!==typeof Ammo&&(e=new Ammo.btVector3,a=new Ammo.btQuaternion);this.initialize(g)};b.prototype={initialize:function(b){var d=this.entity;if((b=b.shape)&&"undefined"!==typeof Ammo){d.trigger&&d.trigger.destroy();var g=new Ammo.btVector3(0,0,0);b.calculateLocalInertia(1,g);var f=d.getPosition(),k=d.getRotation();a.setValue(k.x,k.y,k.z,k.w);k=new Ammo.btTransform;k.setIdentity();k.getOrigin().setValue(f.x,
f.y,f.z);k.setRotation(a);f=new Ammo.btDefaultMotionState(k);b=new Ammo.btRigidBodyConstructionInfo(1,f,b,g);this.body=b=new Ammo.btRigidBody(b);b.setRestitution(0);b.setFriction(0);b.setDamping(0,0);e.setValue(0,0,0);b.setLinearFactor(e);b.setAngularFactor(e);b.setCollisionFlags(b.getCollisionFlags()|pc.BODYFLAG_NORESPONSE_OBJECT);b.entity=d;this.component.enabled&&d.enabled&&this.enable()}},destroy:function(){this.body&&this.app.systems.rigidbody.removeBody(this.body)},syncEntityToBody:function(){var b=
this.body;if(b){var d=this.entity.getPosition(),e=this.entity.getRotation(),f=b.getWorldTransform();f.getOrigin().setValue(d.x,d.y,d.z);a.setValue(e.x,e.y,e.z,e.w);f.setRotation(a);b.activate()}},enable:function(){var a=this.body;this.app.systems.rigidbody.addBody(a,pc.BODYGROUP_TRIGGER,pc.BODYMASK_NOT_STATIC^pc.BODYGROUP_TRIGGER);a.forceActivationState(pc.BODYSTATE_ACTIVE_TAG);a.activate()},disable:function(){var a=this.body;this.app.systems.rigidbody.removeBody(a);a.forceActivationState(pc.BODYSTATE_DISABLE_SIMULATION)}};
return{Trigger:b}}());pc.extend(pc,function(){var e=function(a){this.id="collision";this.description="Specifies a collision volume.";a.systems.add(this.id,this);this.ComponentType=pc.CollisionComponent;this.DataType=pc.CollisionComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enables or disables the collision",type:"boolean",defaultValue:!0},{name:"type",displayName:"Type",description:"The type of the collision volume",type:"enumeration",options:{enumerations:[{name:"Box",value:"box"},{name:"Sphere",
value:"sphere"},{name:"Capsule",value:"capsule"},{name:"Cylinder",value:"cylinder"},{name:"Mesh",value:"mesh"}]},defaultValue:"box"},{name:"halfExtents",displayName:"Half Extents",description:"The half-extents of the box",type:"vector",options:{min:0,step:0.1},defaultValue:[0.5,0.5,0.5],filter:{type:"box"}},{name:"radius",displayName:"Radius",description:"The radius of the collision volume",type:"number",options:{min:0,step:0.1},defaultValue:0.5,filter:{type:["sphere","capsule","cylinder"]}},{name:"axis",
displayName:"Axis",description:"Major axis of the volume",type:"enumeration",options:{enumerations:[{name:"X",value:0},{name:"Y",value:1},{name:"Z",value:2}]},defaultValue:1,filter:{type:["capsule","cylinder"]}},{name:"height",displayName:"Height",description:"Height of the volume",type:"number",options:{min:0,step:0.1},defaultValue:2,filter:{type:["capsule","cylinder"]}},{name:"asset",displayName:"Asset",description:"Collision mesh asset",type:"asset",options:{max:1,type:"model"},defaultValue:null,
filter:{type:"mesh"}},{name:"shape",exposed:!1},{name:"model",exposed:!1}];this.exposeProperties();this.implementations={};this.debugRender=!1;this.on("remove",this.onRemove,this);pc.ComponentSystem.on("update",this.onUpdate,this);pc.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this)},e=pc.inherits(e,pc.ComponentSystem);e.prototype=pc.extend(e.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,
b,c){b.type||(b.type=a.data.type);a.data.type=b.type;b.halfExtents&&"array"===pc.type(b.halfExtents)&&(b.halfExtents=new pc.Vec3(b.halfExtents[0],b.halfExtents[1],b.halfExtents[2]));var d=this._createImplementation(b.type);d.beforeInitialize(a,b);c="type halfExtents radius axis height shape model asset enabled".split(" ");e._super.initializeComponentData.call(this.system,a,b,c);d.afterInitialize(a,b)},_createImplementation:function(a){if(void 0===this.implementations[a]){var b;switch(a){case "box":b=
new CollisionBoxSystemImpl(this);break;case "sphere":b=new CollisionSphereSystemImpl(this);break;case "capsule":b=new CollisionCapsuleSystemImpl(this);break;case "cylinder":b=new CollisionCylinderSystemImpl(this);break;case "mesh":b=new CollisionMeshSystemImpl(this);break;default:throw"Invalid collision system type: "+a;}this.implementations[a]=b}return this.implementations[a]},_getImplementation:function(a){return this.implementations[a.collision.data.type]},cloneComponent:function(a,b){return this._getImplementation(a).clone(a,
b)},onRemove:function(a,b){this.implementations[b.type].remove(a,b)},onUpdate:function(){var a,b,c,d=this.store;for(a in d)b=d[a].entity,c=d[a].data,c.enabled&&b.enabled&&!b.rigidbody&&b.trigger&&b.trigger.syncEntityToBody(),this.debugRender&&this.updateDebugShape(b,c,this._getImplementation(b))},updateDebugShape:function(a,b,c){var d=this.app;if(void 0!==c&&c.hasDebugShape){if(b.model)if(d.scene.containsModel(b.model)){if(!b.enabled||!a.enabled)d.root.removeChild(b.model.graph),d.scene.removeModel(b.model)}else a.enabled&&
b.enabled&&(d.scene.addModel(b.model),d.root.addChild(b.model.graph));b.enabled&&a.enabled&&c.updateDebugShape(a,b)}},onTransformChanged:function(a,b,c,d){this.implementations[a.data.type].updateTransform(a,b,c,d)},onToolsUpdate:function(){var a,b,c=this.store;for(a in c)b=c[a].entity,this.updateDebugShape(b,c[a].data,this._getImplementation(b))},setDebugRender:function(a){this.debugRender=a},changeType:function(a,b,c){this.implementations[b].remove(a.entity,a.data);this._createImplementation(c).reset(a,
a.data)},recreatePhysicalShapes:function(a){this.implementations[a.data.type].recreatePhysicalShapes(a)}});CollisionSystemImpl=function(a){this.system=a;this.hasDebugShape=!0};CollisionSystemImpl.prototype={beforeInitialize:function(a,b){b.shape=this.createPhysicalShape(a.entity,b);b.model=new pc.Model;b.model.graph=new pc.GraphNode;b.model.meshInstances=[this.createDebugMesh(b)]},afterInitialize:function(a){this.recreatePhysicalShapes(a);a.data.initialized=!0},reset:function(a,b){this.beforeInitialize(a,
b);this.afterInitialize(a,b)},recreatePhysicalShapes:function(a){var b=a.entity,c=a.data;"undefined"!==typeof Ammo&&(c.shape=this.createPhysicalShape(a.entity,c),b.rigidbody?(b.rigidbody.disableSimulation(),b.rigidbody.createBody()):b.trigger?b.trigger.initialize(c):b.trigger=new pc.Trigger(this.system.app,a,c))},createDebugMesh:function(){},createPhysicalShape:function(){},updateDebugShape:function(){},updateTransform:function(a){a.entity.trigger&&a.entity.trigger.syncEntityToBody()},remove:function(a,
b){var c=this.system.app;a.rigidbody&&a.rigidbody.body&&c.systems.rigidbody.removeBody(a.rigidbody.body);a.trigger&&(a.trigger.destroy(),delete a.trigger);c.scene.containsModel(b.model)&&(c.root.removeChild(b.model.graph),c.scene.removeModel(b.model))},clone:function(a,b){var c=this.system.dataStore[a.getGuid()];return this.system.addComponent(b,{enabled:c.data.enabled,type:c.data.type,halfExtents:[c.data.halfExtents.x,c.data.halfExtents.y,c.data.halfExtents.z],radius:c.data.radius,axis:c.data.axis,
height:c.data.height,asset:c.data.asset,model:c.data.model})}};CollisionBoxSystemImpl=function(){};CollisionBoxSystemImpl=pc.inherits(CollisionBoxSystemImpl,CollisionSystemImpl);CollisionBoxSystemImpl.prototype=pc.extend(CollisionBoxSystemImpl.prototype,{createDebugMesh:function(a){if(!this.mesh){var b=this.system.app.graphicsDevice,c=new pc.VertexFormat(b,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),c=new pc.VertexBuffer(b,c,8);(new Float32Array(c.lock())).set([-0.5,
-0.5,-0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,-0.5]);c.unlock();b=new pc.IndexBuffer(b,pc.INDEXFORMAT_UINT8,24);(new Uint8Array(b.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);b.unlock();var d=new pc.Mesh;d.vertexBuffer=c;d.indexBuffer[0]=b;d.primitive[0].type=pc.PRIMITIVE_LINES;d.primitive[0].base=0;d.primitive[0].count=b.getNumIndices();d.primitive[0].indexed=!0;this.mesh=d}this.material||(c=new pc.BasicMaterial,c.color=new pc.Color(0,
0,1,1),c.update(),this.material=c);return new pc.MeshInstance(a.model.graph,this.mesh,this.material)},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo){var c=b.halfExtents,c=new Ammo.btVector3(c.x,c.y,c.z);return new Ammo.btBoxShape(c)}},updateDebugShape:function(a,b){var c=b.halfExtents,d=c.x,e=c.y,c=c.z,f=b.model.graph;f.setPosition(a.getPosition());f.setRotation(a.getRotation());f.setLocalScale(2*d,2*e,2*c)}});CollisionSphereSystemImpl=function(){};CollisionSphereSystemImpl=pc.inherits(CollisionSphereSystemImpl,
CollisionSystemImpl);CollisionSphereSystemImpl.prototype=pc.extend(CollisionSphereSystemImpl.prototype,{createDebugMesh:function(a){if(!this.mesh){for(var b=this.system.app.graphicsDevice,c=new pc.VertexFormat(b,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),b=new pc.VertexBuffer(b,c,240),c=new Float32Array(b.lock()),d,e=0,f,k=0;3>k;k++){var m=0,h=1,n=2;1===k?(m=1,h=0,n=2):2===k&&(m=0,h=2,n=1);for(d=0;40>d;d++)f=2*Math.PI*(d/40),c[e+m]=0.5*Math.cos(f),c[e+h]=0,c[e+n]=
0.5*Math.sin(f),e+=3,f=2*Math.PI*((d+1)/40),c[e+m]=0.5*Math.cos(f),c[e+h]=0,c[e+n]=0.5*Math.sin(f),e+=3}b.unlock();c=new pc.Mesh;c.vertexBuffer=b;c.primitive[0].type=pc.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=b.getNumVertices();c.primitive[0].indexed=!1;this.mesh=c}this.material||(b=new pc.BasicMaterial,b.color=new pc.Color(0,0,1,1),b.update(),this.material=b);return new pc.MeshInstance(a.model.graph,this.mesh,this.material)},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo)return new Ammo.btSphereShape(b.radius)},
updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());var d=2*b.radius;c.setLocalScale(d,d,d)}});CollisionCapsuleSystemImpl=function(){};CollisionCapsuleSystemImpl=pc.inherits(CollisionCapsuleSystemImpl,CollisionSystemImpl);CollisionCapsuleSystemImpl.prototype=pc.extend(CollisionCapsuleSystemImpl.prototype,{createDebugMesh:function(a){if(a.model&&a.model.meshInstances&&a.model.meshInstances.length)return a.model.meshInstances[0];var b=this.system.app.graphicsDevice,
c=new pc.VertexFormat(b,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),c=new pc.VertexBuffer(b,c,328,pc.BUFFER_DYNAMIC);this.updateCapsuleShape(a,c);b=new pc.Mesh;b.vertexBuffer=c;b.primitive[0].type=pc.PRIMITIVE_LINES;b.primitive[0].base=0;b.primitive[0].count=c.getNumVertices();b.primitive[0].indexed=!1;this.mesh=b;this.material||(c=new pc.BasicMaterial,c.color=new pc.Color(0,0,1,1),c.update(),this.material=c);return new pc.MeshInstance(a.model.graph,b,this.material)},
updateCapsuleShape:function(a,b){var c=void 0!==a.axis?a.axis:1,d=a.radius||0.5,e=Math.max((a.height||2)-2*d,0),f=new Float32Array(b.lock()),k=0,m=1,h=2;0===c?(k=1,m=0,h=2):2===c&&(k=0,m=2,h=1);var n=0,l;for(cap=-1;2>cap;cap+=2){for(c=0;40>c;c++)l=2*Math.PI*(c/40),f[n+k]=d*Math.cos(l),f[n+m]=0.5*cap*e,f[n+h]=d*Math.sin(l),n+=3,l=2*Math.PI*((c+1)/40),f[n+k]=d*Math.cos(l),f[n+m]=0.5*cap*e,f[n+h]=d*Math.sin(l),n+=3;for(c=0;20>c;c++)l=Math.PI*(c/20)+1.5*Math.PI,f[n+k]=0,f[n+m]=cap*(0.5*e+d*Math.cos(l)),
f[n+h]=cap*d*Math.sin(l),n+=3,l=Math.PI*((c+1)/20)+1.5*Math.PI,f[n+k]=0,f[n+m]=cap*(0.5*e+d*Math.cos(l)),f[n+h]=cap*d*Math.sin(l),n+=3;for(c=0;20>c;c++)l=Math.PI*(c/20)+1.5*Math.PI,f[n+k]=cap*d*Math.sin(l),f[n+m]=cap*(0.5*e+d*Math.cos(l)),f[n+h]=0,n+=3,l=Math.PI*((c+1)/20)+1.5*Math.PI,f[n+k]=cap*d*Math.sin(l),f[n+m]=cap*(0.5*e+d*Math.cos(l)),f[n+h]=0,n+=3}for(c=0;4>c;c++)l=2*Math.PI*(c/4),f[n+k]=d*Math.cos(l),f[n+m]=0.5*e,f[n+h]=d*Math.sin(l),n+=3,l=2*Math.PI*(c/4),f[n+k]=d*Math.cos(l),f[n+m]=0.5*
-e,f[n+h]=d*Math.sin(l),n+=3;b.unlock()},createPhysicalShape:function(a,b){var c=null,d=void 0!==b.axis?b.axis:1,e=b.radius||0.5,f=Math.max((b.height||2)-2*e,0);if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btCapsuleShapeX(e,f);break;case 1:c=new Ammo.btCapsuleShape(e,f);break;case 2:c=new Ammo.btCapsuleShapeZ(e,f)}return c},updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());c.setLocalScale(1,1,1)},recreatePhysicalShapes:function(a){if(a.data.model){var b=
this.createDebugMesh(a.data).mesh.vertexBuffer;this.updateCapsuleShape(a.data,b);CollisionCapsuleSystemImpl._super.recreatePhysicalShapes.call(this,a)}}});CollisionCylinderSystemImpl=function(){};CollisionCylinderSystemImpl=pc.inherits(CollisionCylinderSystemImpl,CollisionSystemImpl);CollisionCylinderSystemImpl.prototype=pc.extend(CollisionCylinderSystemImpl.prototype,{createDebugMesh:function(a){if(a.model&&a.model.meshInstances&&a.model.meshInstances.length)return a.model.meshInstances[0];var b=
this.system.app.graphicsDevice,c=new pc.VertexFormat(b,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),c=new pc.VertexBuffer(b,c,168,pc.BUFFER_DYNAMIC);this.updateCylinderShape(a,c);b=new pc.Mesh;b.vertexBuffer=c;b.primitive[0].type=pc.PRIMITIVE_LINES;b.primitive[0].base=0;b.primitive[0].count=c.getNumVertices();b.primitive[0].indexed=!1;this.material||(c=new pc.BasicMaterial,c.color=new pc.Color(0,0,1,1),c.update(),this.material=c);return new pc.MeshInstance(a.model.graph,
b,this.material)},updateCylinderShape:function(a,b){var c=void 0!==a.axis?a.axis:1,d=void 0!==a.radius?a.radius:0.5,e=void 0!==a.height?a.height:1,f=new Float32Array(b.lock()),k=0,m=1,h=2;0===c?(k=1,m=0,h=2):2===c&&(k=0,m=2,h=1);var n=0,l;for(cap=-1;2>cap;cap+=2)for(c=0;40>c;c++)l=2*Math.PI*(c/40),f[n+k]=d*Math.cos(l),f[n+m]=0.5*cap*e,f[n+h]=d*Math.sin(l),n+=3,l=2*Math.PI*((c+1)/40),f[n+k]=d*Math.cos(l),f[n+m]=0.5*cap*e,f[n+h]=d*Math.sin(l),n+=3;for(c=0;4>c;c++)l=2*Math.PI*(c/4),f[n+k]=d*Math.cos(l),
f[n+m]=0.5*e,f[n+h]=d*Math.sin(l),n+=3,l=2*Math.PI*(c/4),f[n+k]=d*Math.cos(l),f[n+m]=0.5*-e,f[n+h]=d*Math.sin(l),n+=3;b.unlock()},createPhysicalShape:function(a,b){var c=null,c=null,d=void 0!==b.axis?b.axis:1,e=void 0!==b.radius?b.radius:0.5,f=void 0!==b.height?b.height:1;if("undefined"!==typeof Ammo)switch(d){case 0:c=new Ammo.btVector3(0.5*f,e,e);c=new Ammo.btCylinderShapeX(c);break;case 1:c=new Ammo.btVector3(e,0.5*f,e);c=new Ammo.btCylinderShape(c);break;case 2:c=new Ammo.btVector3(e,e,0.5*f),
c=new Ammo.btCylinderShapeZ(c)}return c},updateDebugShape:function(a,b){var c=b.model.graph;c.setPosition(a.getPosition());c.setRotation(a.getRotation());c.setLocalScale(1,1,1)},recreatePhysicalShapes:function(a){if(a.data.model){var b=this.createDebugMesh(a.data).mesh.vertexBuffer;this.updateCylinderShape(a.data,b);CollisionCylinderSystemImpl._super.recreatePhysicalShapes.call(this,a)}}});CollisionMeshSystemImpl=function(){this.hasDebugShape=!1};CollisionMeshSystemImpl=pc.inherits(CollisionMeshSystemImpl,
CollisionSystemImpl);CollisionMeshSystemImpl.prototype=pc.extend(CollisionMeshSystemImpl.prototype,{beforeInitialize:function(){},createPhysicalShape:function(a,b){if("undefined"!==typeof Ammo&&b.model){var c=b.model,d=new Ammo.btCompoundShape,e,f;for(e=0;e<c.meshInstances.length;e++){var k=c.meshInstances[e],m=k.mesh,h=m.indexBuffer[pc.RENDERSTYLE_SOLID],n=m.vertexBuffer,l=n.getFormat(),r=l.size/4,v;for(f=0;f<l.elements.length;f++){var u=l.elements[f];u.name===pc.SEMANTIC_POSITION&&(v=new Float32Array(n.lock(),
u.offset))}var h=new Uint16Array(h.lock()),n=m.primitive[0].count/3,l=new Ammo.btVector3,u=new Ammo.btVector3,C=new Ammo.btVector3,y,s,w=m.primitive[0].base,A=new Ammo.btTriangleMesh;for(f=0;f<n;f++)m=h[w+3*f]*r,y=h[w+3*f+1]*r,s=h[w+3*f+2]*r,l.setValue(v[m],v[m+1],v[m+2]),u.setValue(v[y],v[y+1],v[y+2]),C.setValue(v[s],v[s+1],v[s+2]),A.addTriangle(l,u,C,!0);f=new Ammo.btBvhTriangleMeshShape(A,!0);r=k.node.getWorldTransform().getScale();f.setLocalScaling(new Ammo.btVector3(r.x,r.y,r.z));r=k.node.getPosition();
k=k.node.getRotation();h=new Ammo.btTransform;h.setIdentity();h.getOrigin().setValue(r.x,r.y,r.z);r=new Ammo.btQuaternion;r.setValue(k.x,k.y,k.z,k.w);h.setRotation(r);d.addChildShape(h,f)}c=a.getWorldTransform().getScale();e=new Ammo.btVector3;e.setValue(c.x,c.y,c.z);d.setLocalScaling(e);return d}},recreatePhysicalShapes:function(a){var b=a.data;null!==b.asset?this.loadModelAsset(a):(b.model=null,this.doRecreatePhysicalShape(a))},loadModelAsset:function(a){var b=a.data.asset,c=a.data,d={parent:a.entity.getRequest()},
e=this.system.app.assets.getAssetById(b);e?e.resource?(c.model=e.resource,this.doRecreatePhysicalShape(a)):this.system.app.assets.load(e,[],d).then(function(b){c.model=b[0];this.doRecreatePhysicalShape(a)}.bind(this)):logERROR(pc.string.format("Trying to load model before asset {0} is loaded.",b))},doRecreatePhysicalShape:function(a){var b=a.entity,c=a.data;c.model?(c.shape&&Ammo.destroy(c.shape),c.shape=this.createPhysicalShape(b,c),b.rigidbody?b.rigidbody.createBody():b.trigger?b.trigger.initialize(c):
b.trigger=new pc.Trigger(this.system.app,a,c)):this.remove(b,c)},updateTransform:function(a,b,c,d){if(a.shape){var e=a.entity.getWorldTransform().getScale(),f=a.shape.getLocalScaling();(e.x!==f.x()||e.y!==f.y()||e.z!==f.z())&&this.doRecreatePhysicalShape(a)}CollisionMeshSystemImpl._super.updateTransform.call(this,a,b,c,d)}});return{CollisionComponentSystem:e}}());pc.extend(pc,function(){var e=function(a,b){this.on("set_type",this.onSetType,this);this.on("set_halfExtents",this.onSetHalfExtents,this);this.on("set_radius",this.onSetRadius,this);this.on("set_height",this.onSetHeight,this);this.on("set_axis",this.onSetAxis,this);this.on("set_asset",this.onSetAsset,this);b.on("livelink:updatetransform",this.onLiveLinkUpdateTransform,this);a.on("beforeremove",this.onBeforeRemove,this)},e=pc.inherits(e,pc.Component);pc.extend(e.prototype,{onSetType:function(a,b,c){b!==
c&&this.system.changeType(this,b,c)},onSetHalfExtents:function(){this.data.initialized&&"box"===this.data.type&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(){this.data.initialized&&("sphere"===this.data.type||"capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetHeight:function(){this.data.initialized&&("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAxis:function(){this.data.initialized&&
("capsule"===this.data.type||"cylinder"===this.data.type)&&this.system.recreatePhysicalShapes(this)},onSetAsset:function(){this.data.initialized&&"mesh"===this.data.type&&this.system.recreatePhysicalShapes(this)},onEnable:function(){e._super.onEnable.call(this);this.entity.trigger?this.entity.trigger.enable():this.entity.rigidbody&&this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation()},onDisable:function(){e._super.onDisable.call(this);this.entity.trigger?this.entity.trigger.disable():
this.entity.rigidbody&&this.entity.rigidbody.disableSimulation()},onLiveLinkUpdateTransform:function(a,b,c){if(this.enabled&&this.entity.enabled)this.system.onTransformChanged(this,a,b,c)},onBeforeRemove:function(a,b){this===b&&(a.off("livelink:updatetransform",this.onLiveLinkUpdateTransform,this),this.system.off("beforeremove",this.onBeforeRemove,this))}});return{CollisionComponent:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.enabled=!0;this.type="box";this.halfExtents=new pc.Vec3(0.5,0.5,0.5);this.radius=0.5;this.axis=1;this.height=2;this.model=this.shape=this.asset=null;this.initialized=!1},pc.ComponentData);return{CollisionComponentData:e}}());pc.extend(pc,function(){var e=function(a){this.id="ballsocketjoint";a.systems.add(this.id,this);this.ComponentType=pc.BallSocketJointComponent;this.DataType=pc.BallSocketJointComponentData;this.schema=[{name:"pivot",displayName:"Pivot",description:"Local space pivot",type:"vector",options:{min:0,step:0.1},defaultValue:[0,0,0]},{name:"position",displayName:"Position",description:"World space joint position",type:"vector",options:{min:0,step:0.1},defaultValue:[0,0,0]},{name:"tau",displayName:"Tau",
description:"TBD",type:"number",defaultValue:0.001,options:{min:0,max:1}},{name:"damping",displayName:"Damping",description:"Damping",type:"number",defaultValue:1,options:{min:0,max:1}},{name:"impulseClamp",displayName:"Impulse Clamp",description:"Impulse Clamp",type:"number",defaultValue:0,options:{min:0,max:100}},{name:"constraint",exposed:!1}];this.debugRender=!1;this.on("remove",this.onRemove,this);pc.ComponentSystem.on("update",this.onUpdate,this);pc.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,
this)},e=pc.inherits(e,pc.ComponentSystem);e.prototype=pc.extend(e.prototype,{onLibraryLoaded:function(){"undefined"===typeof Ammo&&pc.ComponentSystem.off("update",this.onUpdate,this)},initializeComponentData:function(a,b,c){"undefined"!==typeof Ammo&&a.entity.rigidbody&&(b.pivot&&"array"===pc.type(b.pivot)&&(b.pivot=new pc.Vec3(b.pivot[0],b.pivot[1],b.pivot[2])),b.position&&"array"===pc.type(b.position)&&(b.position=new pc.Vec3(b.position[0],b.position[1],b.position[2])),c=new Ammo.btVector3(b.pivot.x,
b.pivot.y,b.pivot.z),b.constraint=new Ammo.btPoint2PointConstraint(a.entity.rigidbody.body,c),c=b.constraint.getPivotInB(),b.position=[c.x(),c.y(),c.z()],this.app.systems.rigidbody.addConstraint(b.constraint));c="constraint pivot position tau damping impulseClamp".split(" ");e._super.initializeComponentData.call(this,a,b,c)},cloneComponent:function(a,b){return this.addComponent(b,{pivot:[a.ballsocketjoint.pivot.x,a.ballsocketjoint.pivot.y,a.ballsocketjoint.pivot.z],position:[a.ballsocketjoint.position.x,
a.ballsocketjoint.position.y,a.ballsocketjoint.position.z],tau:a.ballsocketjoint.tau,damping:a.ballsocketjoint.damping,impulseClamp:a.ballsocketjoint.impulseClamp})},onRemove:function(a,b){b.constraint&&this.app.systems.rigidbody.removeConstraint(b.constraint)},setDebugRender:function(a){this.debugRender=a},onUpdate:function(){this.debugRender&&this.updateDebugShapes()},onToolsUpdate:function(){this.updateDebugShapes()},updateDebugShapes:function(){var a=this.store,b;for(b in a);}});return{BallSocketJointComponentSystem:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.on("set_pivot",this.onSetPivot,this);this.on("set_position",this.onSetPosition,this);this.on("set_tau",this.onSetTau,this);this.on("set_damping",this.onSetDamping,this);this.on("set_impulseClamp",this.onSetImpulseClamp,this)},pc.Component);pc.extend(e.prototype,{onSetPivot:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&(a=new Ammo.btVector3(c.x,c.y,c.z),this.data.constraint.setPivotA(a))},onSetPosition:function(a,b,c){"undefined"!==
typeof Ammo&&this.data.constraint&&(a=new Ammo.btVector3(c.x,c.y,c.z),this.data.constraint.setPivotB(a))},onSetTau:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_tau(c)},onSetDamping:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_damping(c)},onSetImpulseClamp:function(a,b,c){"undefined"!==typeof Ammo&&this.data.constraint&&this.data.constraint.get_m_setting().set_m_impulseClamp(c)}});
return{BallSocketJointComponent:e}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.pivot=new pc.Vec3(0,0,0);this.position=new pc.Vec3(0,0,0);this.tau=0.3;this.damping=1;this.impulseClamp=0;this.constraint=null},pc.ComponentData);return{BallSocketJointComponentData:e}}());pc.extend(pc,function(){var e=function(a){this.id="particlesystem";this.description="Updates and renders particle system in the scene.";a.systems.add(this.id,this);this.ComponentType=pc.ParticleSystemComponent;this.DataType=pc.ParticleSystemComponentData;this.schema=[{name:"enabled",displayName:"Enabled",description:"Enable or disable the component",type:"boolean",defaultValue:!0},{name:"autoPlay",displayName:"Auto Play",description:"Play automatically on start",type:"boolean",defaultValue:!0},{name:"numParticles",
displayName:"Particle Count",description:"Total number of particles allocated",type:"number",defaultValue:30,options:{min:1,max:4096,step:1}},{name:"lifetime",displayName:"Lifetime",description:"The lifetime of each particle in seconds",type:"number",defaultValue:5,options:{min:0,step:0.01}},{name:"rate",displayName:"Emission Rate",description:"Delay between emission of each particle in seconds",type:"number",defaultValue:0.1,options:{min:0,step:0.01}},{name:"rate2",displayName:"Emission Rate 2",
description:"Defines the random range of Emission Rate",type:"number",defaultValue:0.1,options:{min:0,step:0.01}},{name:"startAngle",displayName:"Start Angle",description:"The starting angle of each particle in degrees",type:"number",defaultValue:0,options:{min:0,step:0.01}},{name:"startAngle2",displayName:"Start Angle 2",description:"Defines the random range of Start Angle",type:"number",defaultValue:0,options:{min:0,step:0.01}},{name:"loop",displayName:"Loop",description:"Enables looping",type:"boolean",
defaultValue:!0},{name:"preWarm",displayName:"Pre Warm",description:"Starts particles in the middle of simulation",type:"boolean",defaultValue:!1,filter:{loop:!0}},{name:"lighting",displayName:"Lighting",description:"Enables particle lighting; Only ambient and directional lights are used",type:"boolean",defaultValue:!1},{name:"halfLambert",displayName:"Half-Lambert",description:"Uses Half-Lambert shading instead of Lambert, for softer lighting.",type:"boolean",defaultValue:!1,filter:{lighting:!0}},
{name:"intensity",displayName:"Color Intensity",description:"Controls the intensity of the colors for each particle",type:"number",defaultValue:1,options:{min:0,max:10,step:0.1}},{name:"depthWrite",displayName:"Depth Write",description:"Enables writing to depth buffer, therefore giving accurate occlusion between particles. Do not use it for semi-transparent particles",type:"boolean",defaultValue:!1},{name:"depthSoftening",displayName:"Depth Softening",description:"Softens particle intersections with scene geometry",
type:"number",defaultValue:0,options:{min:0,max:1,step:0.01}},{name:"sort",displayName:"Sorting Mode",description:"How to sort particles; Any value other than None will force CPU mode",type:"enumeration",options:{enumerations:[{name:"None",value:pc.PARTICLESORT_NONE},{name:"Camera Distance",value:pc.PARTICLESORT_DISTANCE},{name:"Newer First",value:pc.PARTICLESORT_NEWER_FIRST},{name:"Older First",value:pc.PARTICLESORT_OLDER_FIRST}]},defaultValue:0},{name:"blendType",displayName:"Blending Mode",description:"How to blend particles",
type:"enumeration",options:{enumerations:[{name:"Alpha",value:pc.BLEND_NORMAL},{name:"Add",value:pc.BLEND_ADDITIVE},{name:"Multiply",value:pc.BLEND_MULTIPLICATIVE}]},defaultValue:pc.BLEND_NORMAL},{name:"stretch",displayName:"Stretch",description:"Stretch particles in the direction of motion",type:"number",defaultValue:0,options:{min:0,step:0.01}},{name:"alignToMotion",displayName:"Align To Motion",description:"Rotates particles along the direction of motion",type:"boolean",defaultValue:!1},{name:"emitterShape",
displayName:"Emitter Shape",description:"Defines a shape in which particles are allowed to spawn",type:"enumeration",options:{enumerations:[{name:"Box",value:pc.EMITTERSHAPE_BOX},{name:"Sphere",value:pc.EMITTERSHAPE_SPHERE}]},defaultValue:pc.EMITTERSHAPE_BOX},{name:"emitterExtents",displayName:"Emitter Extents",description:"Defines a local box in which particles are allowed to spawn",type:"vector",filter:{emitterShape:pc.EMITTERSHAPE_BOX},defaultValue:[0,0,0]},{name:"emitterRadius",displayName:"Emitter Radius",
description:"Defines radius in which particles are allowed to spawn",type:"number",filter:{emitterShape:pc.EMITTERSHAPE_SPHERE},defaultValue:0},{name:"initialVelocity",displayName:"Initial velocity",description:"Adds initial local velocity with defined length and direction based on spawn shape",type:"number",defaultValue:0,options:{min:0,step:0.1}},{name:"wrap",displayName:"Wrap",description:"Set to true to wrap particles around the camera. Used for infinite atmospheric effect like rain or mist.",
type:"boolean",defaultValue:!1},{name:"wrapBounds",displayName:"Wrap Bounds",description:"AABB around to camera to wrap particles. Used for infinite atmospheric effect like rain or mist.",type:"vector",filter:{wrap:!0},defaultValue:[0,0,0]},{name:"colorMapAsset",displayName:"Color Map",description:"Color map used for each particle, with alpha channel",type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"normalMapAsset",displayName:"Normal Map",description:"Normal map used for each particle",
type:"asset",options:{max:1,type:"texture"},defaultValue:null},{name:"mesh",displayName:"Particle Mesh",description:"Mesh to use as particle; Will be quad, if not set",type:"asset",options:{max:1,type:"model"},defaultValue:null},{name:"localVelocityGraph",displayName:"Local Velocity",description:"Curves that define the local velocity of particles over time.",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,0],[0,0],[0,0]],betweenCurves:!1},options:{curveNames:["X","Y","Z"],secondCurve:"localVelocityGraph2"}},
{name:"localVelocityGraph2",displayName:"Local Velocity 2",description:"Curves that define the range of the Local Velocity",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,0],[0,0],[0,0]]},filter:{always:!1}},{name:"velocityGraph",displayName:"Velocity",description:"Curves that define the world velocity of particles over time.",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,-1],[0,-1],[0,-1]],betweenCurves:!0},options:{curveNames:["X","Y","Z"],secondCurve:"velocityGraph2"}},
{name:"velocityGraph2",displayName:"Velocity 2",description:"Curves that define the range of the Velocity",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,1],[0,1],[0,1]]},options:{curveNames:["X","Y","Z"]},filter:{always:!1}},{name:"rotationSpeedGraph",displayName:"Rotation Speed",description:"Curve that defines how fast particles rotate over time.",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0],betweenCurves:!1},options:{curveNames:["Angle"],secondCurve:"rotationSpeedGraph2",
verticalAxisValue:360},filter:{alignToMotion:!1}},{name:"rotationSpeedGraph2",displayName:"Rotation Speed 2",description:"Curve that defines the range of Rotation Speed",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0]},options:{curveNames:["Angle"],verticalAxisValue:360},filter:{always:!1}},{name:"scaleGraph",displayName:"Scale",description:"Curve that defines the scale of particles over time",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0.1],betweenCurves:!1},options:{curveNames:["Scale"],
verticalAxisValue:1,secondCurve:"scaleGraph2",min:0}},{name:"scaleGraph2",displayName:"Scale 2",description:"Curve that defines the range of Scale",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,0.1]},options:{curveNames:["Scale"],verticalAxisValue:1,min:0},filter:{always:!1}},{name:"colorGraph",displayName:"Color",description:"Curves that define the color of particles over time",type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,1],[0,1],[0,1]],betweenCurves:!1},options:{curveNames:["R",
"G","B"],max:1,min:0}},{name:"colorGraph2",displayName:"Color 2",description:"Curves that define the range of Color",exposed:!1,type:"curveset",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[[0,1,1,1],[0,1,1,1],[0,1,1,1]]},options:{curveNames:["R","G","B"],max:1,min:0}},{name:"alphaGraph",displayName:"Opacity",description:"Curve that defines the opacity of particles over time",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,1],betweenCurves:!1},options:{curveNames:["Opacity"],max:1,min:0,
secondCurve:"alphaGraph2"}},{name:"alphaGraph2",displayName:"Opacity 2",description:"Curve that defines the range of Opacity",type:"curve",defaultValue:{type:pc.CURVE_SMOOTHSTEP,keys:[0,1]},options:{curveNames:["Opacity"],max:1,min:0},filter:{always:!1}},{name:"colorMap",exposed:!1},{name:"normalMap",exposed:!1}];this.exposeProperties();this.propertyTypes={};for(a=0;a<this.schema.length;a++){var b=this.schema[a];this.propertyTypes[b.name]=b.type}this.on("remove",this.onRemove,this);pc.ComponentSystem.on("update",
this.onUpdate,this);pc.ComponentSystem.on("toolsUpdate",this.onToolsUpdate,this);this.debugMesh=this._createDebugMesh();this.debugMaterial=new pc.BasicMaterial;this.debugMaterial.color=new pc.Color(1,0.5,0,1);this.debugMaterial.update()},e=pc.inherits(e,pc.ComponentSystem);pc.extend(e.prototype,{initializeComponentData:function(a,b,c){var c=[],d=this.propertyTypes,g,f;for(f in b)b.hasOwnProperty(f)&&c.push(f),"vector"===d[f]?"array"===pc.type(b[f])&&(b[f]=new pc.Vec3(b[f][0],b[f][1],b[f][2])):"curve"===
d[f]?b[f]instanceof pc.Curve||(g=b[f].type,b[f]=new pc.Curve(b[f].keys),b[f].type=g):"curveset"===d[f]&&!(b[f]instanceof pc.CurveSet)&&(g=b[f].type,b[f]=new pc.CurveSet(b[f].keys),b[f].type=g);e._super.initializeComponentData.call(this,a,b,c);this._inTools&&this._createDebugShape(a)},cloneComponent:function(a,b){for(var c=a.particlesystem.data,d=this.schema,e={},f=0,k=d.length;f<k;f++){var m=d[f],h=c[m.name];h instanceof pc.Vec3||h instanceof pc.Curve||h instanceof pc.CurveSet?(h=h.clone(),e[m.name]=
h):null!==h&&void 0!==h&&(e[m.name]=h)}return this.addComponent(b,e)},onUpdate:function(a){var b=this.store,c;for(c in b)if(b.hasOwnProperty(c)){var d=b[c],e=d.entity,d=d.data;d.enabled&&e.enabled&&(e=d.model.emitter,d.paused||e.addTime(a))}},onToolsUpdate:function(){var a=this.store,b;for(b in a)if(a.hasOwnProperty(b)){var c=a[b];c.data.enabled&&c.entity.enabled&&this._updateDebugShape(c)}},onRemove:function(a,b){b.model&&(this.app.scene.removeModel(b.model),a.removeChild(b.model.getGraph()),b.model=
null)},_createDebugMesh:function(){var a=this.app.graphicsDevice,b=new pc.VertexFormat(a,[{semantic:pc.SEMANTIC_POSITION,components:3,type:pc.ELEMENTTYPE_FLOAT32}]),b=new pc.VertexBuffer(a,b,8);(new Float32Array(b.lock())).set([-0.5,-0.5,-0.5,-0.5,-0.5,0.5,0.5,-0.5,0.5,0.5,-0.5,-0.5,-0.5,0.5,-0.5,-0.5,0.5,0.5,0.5,0.5,0.5,0.5,0.5,-0.5]);b.unlock();a=new pc.IndexBuffer(a,pc.INDEXFORMAT_UINT8,24);(new Uint8Array(a.lock())).set([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]);a.unlock();var c=new pc.Mesh;
c.vertexBuffer=b;c.indexBuffer[0]=a;c.primitive[0].type=pc.PRIMITIVE_LINES;c.primitive[0].base=0;c.primitive[0].count=a.getNumIndices();c.primitive[0].indexed=!0;return c},_createDebugShape:function(a){var b=new pc.GraphNode,c=new pc.Model;c.graph=b;c.meshInstances=[new pc.MeshInstance(b,this.debugMesh,this.debugMaterial)];a.data.debugShape=c;a.data.enabled&&a.entity.enabled&&(this.app.root.addChild(b),this.app.scene.addModel(c));return c},_updateDebugShape:function(a){var b=a.data.emitterExtents,
c=b.x,d=b.y,b=b.z,e=a.entity,a=a.data.debugShape.graph;a.setPosition(e.getPosition());a.setRotation(e.getRotation());a.setLocalScale(2*(c||5E-4),2*(d||5E-4),2*(b||5E-4))}});return{ParticleSystemComponentSystem:e}}());pc.extend(pc,function(){var e="emitterExtents emitterRadius colorMap normalMap loop initialVelocity".split(" "),a="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite depthSoftening sort stretch alignToMotion preWarm emitterShape".split(" "),b="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2".split(" "),c=function(){this.on("set_colorMapAsset",
this.onSetColorMapAsset,this);this.on("set_normalMapAsset",this.onSetNormalMapAsset,this);this.on("set_mesh",this.onSetMesh,this);this.on("set_loop",this.onSetLoop,this);this.on("set_blendType",this.onSetBlendType,this);e.forEach(function(a){this.on("set_"+a,this.onSetSimpleProperty,this)}.bind(this));a.forEach(function(a){this.on("set_"+a,this.onSetComplexProperty,this)}.bind(this));b.forEach(function(a){this.on("set_"+a,this.onSetGraphProperty,this)}.bind(this))},c=pc.inherits(c,pc.Component);pc.extend(c.prototype,
{onSetColorMapAsset:function(a,b,c){c?this._loadAsset(c,function(a){this.colorMap=a}.bind(this)):this.colorMap=null},onSetNormalMapAsset:function(a,b,c){c?this._loadAsset(c,function(a){this.normalMap=a}.bind(this)):this.normalMap=null},_loadAsset:function(a,b){var c=a instanceof pc.asset.Asset?a:this.system.app.assets.getAssetById(a);if(c)if(c.resource)b(c.resource);else{var e={parent:this.entity.getRequest()};this.system.app.assets.load(c,[],e).then(function(a){b(a[0])})}else logERROR(pc.string.format("Trying to load particle system before asset {0} is loaded.",
a))},onSetMesh:function(a,b,c){c?c instanceof pc.asset.Asset||"number"===pc.type(c)?this._loadAsset(c,function(a){this._onMeshChanged(a)}.bind(this)):this._onMeshChanged(c):this._onMeshChanged(null)},_onMeshChanged:function(a){a&&(a=a.meshInstances[0]?a.meshInstances[0].mesh:null);this.data.mesh=a;this.emitter&&(this.emitter.mesh=a,this.emitter.resetMaterial(),this.rebuild())},onSetLoop:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetTime())},onSetBlendType:function(a,b,c){this.emitter&&
(this.emitter[a]=c,this.emitter.material.blendType=c,this.emitter.resetMaterial(),this.rebuild())},onSetSimpleProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.resetMaterial())},onSetComplexProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.reset(),this.emitter.resetMaterial(),this.rebuild())},onSetGraphProperty:function(a,b,c){this.emitter&&(this.emitter[a]=c,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){!this.emitter&&!this.system._inTools&&
(this.emitter=new pc.ParticleEmitter(this.system.app.graphicsDevice,{numParticles:this.data.numParticles,emitterExtents:this.data.emitterExtents,emitterRadius:this.data.emitterRadius,emitterShape:this.data.emitterShape,initialVelocity:this.data.initialVelocity,wrap:this.data.wrap,wrapBounds:this.data.wrapBounds,lifetime:this.data.lifetime,rate:this.data.rate,rate2:this.data.rate2,startAngle:this.data.startAngle,startAngle2:this.data.startAngle2,scaleGraph:this.data.scaleGraph,scaleGraph2:this.data.scaleGraph2,
colorGraph:this.data.colorGraph,colorGraph2:this.data.colorGraph2,alphaGraph:this.data.alphaGraph,alphaGraph2:this.data.alphaGraph2,localVelocityGraph:this.data.localVelocityGraph,localVelocityGraph2:this.data.localVelocityGraph2,velocityGraph:this.data.velocityGraph,velocityGraph2:this.data.velocityGraph2,rotationSpeedGraph:this.data.rotationSpeedGraph,rotationSpeedGraph2:this.data.rotationSpeedGraph2,colorMap:this.data.colorMap,normalMap:this.data.normalMap,loop:this.data.loop,preWarm:this.data.preWarm,
sort:this.data.sort,stretch:this.data.stretch,alignToMotion:this.data.alignToMotion,lighting:this.data.lighting,halfLambert:this.data.halfLambert,intensity:this.data.intensity,depthSoftening:this.data.depthSoftening,scene:this.system.app.scene,mesh:this.data.mesh,depthWrite:this.data.depthWrite,node:this.entity,blendType:this.data.blendType}),this.emitter.meshInstance.node=this.entity,this.psys=new pc.Model,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],
this.data.model=this.psys,this.emitter.psys=this.psys,!this.data.loop&&!this.data.autoPlay&&this.pause());this.data.model&&(this.system.app.scene.containsModel(this.data.model)||this.emitter.colorMap&&this.system.app.scene.addModel(this.data.model));this.data.debugShape&&!this.system.app.scene.containsModel(this.data.debugShape)&&(this.system.app.scene.addModel(this.data.debugShape),this.system.app.root.addChild(this.data.debugShape.graph));c._super.onEnable.call(this)},onDisable:function(){c._super.onDisable.call(this);
this.data.model&&this.system.app.scene.containsModel(this.data.model)&&this.system.app.scene.removeModel(this.data.model);this.data.debugShape&&(this.system.app.root.removeChild(this.data.debugShape.graph),this.system.app.scene.removeModel(this.data.debugShape))},reset:function(){this.stop();this.emitter&&(this.emitter.addTime(1E3),this.emitter.loop=this.data.loop,this.emitter.reset())},stop:function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=
!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=!1;this.emitter&&(this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return this.data.paused?!1:this.emitter&&this.emitter.loop?!0:Date.now()<=this.emitter.endTime},rebuild:function(){var a=this.enabled;this.enabled=!1;this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]);this.enabled=a}});return{ParticleSystemComponent:c}}());pc.extend(pc,function(){var e;e=pc.inherits(function(){this.rate=this.numParticles=1;this.rate2=null;this.startAngle=0;this.startAngle2=null;this.lifetime=50;this.emitterExtents=new pc.Vec3;this.emitterRadius=0;this.emitterShape=pc.EMITTERSHAPE_BOX;this.initialVelocity=0;this.wrapBounds=new pc.Vec3;this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null;this.loop=!0;this.preWarm=!1;this.sort=0;this.mode=pc.PARTICLEMODE_GPU;this.scene=null;this.halfLambert=this.lighting=!1;this.intensity=
1;this.stretch=0;this.alignToMotion=!1;this.depthSoftening=0;this.mesh=null;this.depthWrite=!1;this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null;this.blendType=pc.BLEND_NORMAL;this.model=null;this.enabled=!0;this.paused=!1;this.debugShape=null},pc.ComponentData);return{ParticleSystemComponentData:e}}());pc.extend(pc,function(){var e=function(a){this._destinations=[];this._callbacks={};this._linkid=(a||"")+"-"+pc.guid.create();this._listener=null;this._handler=this._handleMessage.bind(this);window.addEventListener("message",this._handler,!1);pc.livelinks||(pc.livelinks=[]);pc.livelinks.push(this)};e.prototype.detach=function(){this._listener=null;window.removeEventListener("message",this._handler,!1)};e.prototype.addDestinationWindow=function(a){this._destinations.push(a)};e.prototype.removeDestinationWindow=
function(a){var b;for(b=0;b<this._destinations.length;++b)if(this._destinations[b]==a){this._destinations.splice(b,1);break}};e.prototype.send=function(a,b,c){var b=b||function(){},c=c||this._destinations,d,e=c.length,f=[];for(d=0;d<e;d++){var k=c[d];k.closed?f.push(k):this._send(a,b,k,k.location.protocol+"//"+k.location.host)}e=f.length;for(d=0;d<e;d++)this.removeDestinationWindow(f[d])};e.prototype._send=function(a,b,c,d){a.senderid=this._linkid;this._callbacks[a.id]?this._callbacks[a.id].count++:
this._callbacks[a.id]={count:1,callback:b?b.bind(this):function(){}};var e=pc.LiveLinkMessage.serialize(a);c===window?pc.livelinks.forEach(function(a){a._handleMessage({source:window,data:e})}):c.postMessage(e,d)};e.prototype.listen=function(a){if(this._listener)throw Error("LiveLink already listening");this._listener=a};e.prototype._handleMessage=function(a){var b,c;if(b=pc.LiveLinkMessage.deserialize(a.data))b=new pc.LiveLinkMessage(b,a.source),this._linkid!==b.senderid&&(b.type==pc.LiveLinkMessageType.RECEIVED?
b.content.received_from==this._linkid&&(this._callbacks[b.content.id].count--,0===this._callbacks[b.content.id].count&&(this._callbacks[b.content.id].callback(),delete this._callbacks[b.content.id])):this._listener&&(this._listener(b),c=new pc.LiveLinkMessage,c.type=pc.LiveLinkMessageType.RECEIVED,c.content={id:b.id,received_from:b.senderid},this._send(c,null,a.source,a.origin)))};return{LiveLink:e}}());pc.extend(pc,function(){var e=function(a,b){a=a||{};this.type=a.type||pc.LiveLinkMessageType.NO_TYPE;this.content=a.content||{};this.id=a.id||pc.guid.create();this.senderid=a.senderid||null;this.source=b||null};e.register=function(a){pc.LiveLinkMessageType[a]=a};e.serialize=function(a){return JSON.stringify({type:a.type,content:a.content,id:a.id,senderid:a.senderid},function(a){return this[a]instanceof Float32Array?pc.makeArray(this[a]):this[a]})};e.deserialize=function(a){try{return JSON.parse(a)}catch(b){return null}};
return{LiveLinkMessage:e,LiveLinkMessageRegister:{},LiveLinkMessageType:{NO_TYPE:"NO_TYPE",RECEIVED:"RECEIVED"}}}());pc.extend(pc,function(){var e=function(a,b,c,d){this.type=pc.LiveLinkMessageType.UPDATE_COMPONENT;this.content={id:a,component:b,attribute:c,value:d}},e=pc.inherits(e,pc.LiveLinkMessage);pc.LiveLinkMessage.register("UPDATE_COMPONENT");return{LiveLinkUpdateComponentMessage:e}}());pc.extend(pc,function(){var e=function(a,b){this.type=pc.LiveLinkMessageType.UPDATE_ENTITY;this.content={id:a,components:b}},e=pc.inherits(e,pc.LiveLinkMessage);pc.LiveLinkMessage.register("UPDATE_ENTITY");var a=function(a,b,c,d){this.type=pc.LiveLinkMessageType.UPDATE_ENTITY_TRANSFORM;this.content={id:a,position:b,rotation:c,scale:d}},a=pc.inherits(a,pc.LiveLinkMessage);pc.LiveLinkMessage.register("UPDATE_ENTITY_TRANSFORM");var b=function(a,b){this.type=pc.LiveLinkMessageType.UPDATE_ENTITY_NAME;
this.content={id:a,name:b}},b=pc.inherits(b,pc.LiveLinkMessage);pc.LiveLinkMessage.register("UPDATE_ENTITY_NAME");var c=function(a,b){this.type=pc.LiveLinkMessageType.UPDATE_ENTITY_ENABLED;this.content={id:a,enabled:b}},c=pc.inherits(c,pc.LiveLinkMessage);pc.LiveLinkMessage.register("UPDATE_ENTITY_ENABLED");var d=function(a,b,c,d){this.type=pc.LiveLinkMessageType.REPARENT_ENTITY;this.content={id:a,oldParentId:b,newParentId:c,index:d}},d=pc.inherits(d,pc.LiveLinkMessage);pc.LiveLinkMessage.register("REPARENT_ENTITY");
return{LiveLinkUpdateEntityMessage:e,LiveLinkUpdateEntityNameMessage:b,LiveLinkUpdateEntityEnabledMessage:c,LiveLinkUpdateEntityTransformMessage:a,LiveLinkReparentEntityMessage:d}}());pc.extend(pc,function(){var e=function(a){this.type=pc.LiveLinkMessageType.CLOSE_ENTITY;this.content={id:a}},e=pc.inherits(e,pc.LiveLinkMessage);pc.LiveLinkMessage.register("CLOSE_ENTITY");return{LiveLinkCloseEntityMessage:e}}());pc.extend(pc,function(){var e=function(a){this.type=pc.LiveLinkMessageType.OPEN_ENTITY;this.content={entity:a}},e=pc.inherits(e,pc.LiveLinkMessage);pc.LiveLinkMessage.register("OPEN_ENTITY");var a=function(a,c){this.type=pc.LiveLinkMessageType.OPEN_PACK;this.content={pack:pc.extend({},c.getData())};this.content.pack.hierarchy=PCD.model.Entity.toData(a)},a=pc.inherits(a,pc.LiveLinkMessage);pc.LiveLinkMessage.register("OPEN_PACK");return{LiveLinkOpenEntityMessage:e,LiveLinkOpenPackMessage:a}}());pc.extend(pc,function(){var e=function(a,b,c){this.type=pc.LiveLinkMessageType.UPDATE_ASSET;this.content={id:a,attribute:b,value:c}},e=pc.inherits(e,pc.LiveLinkMessage);pc.LiveLinkMessage.register("UPDATE_ASSET");return{LiveLinkUpdateAssetMessage:e}}());pc.extend(pc,function(){var e=function(a){this.type=pc.LiveLinkMessageType.UPDATE_PACK_SETTINGS;this.content={settings:a}},e=pc.inherits(e,pc.LiveLinkMessage);pc.LiveLinkMessage.register("UPDATE_PACK_SETTINGS");return{LiveLinkUpdatePackSettings:e}}());pc.extend(pc,function(){var e=function(a,b){this.type=pc.LiveLinkMessageType.UPDATE_ASSETCACHE;this.content={assets:a,deleted:b}},e=pc.inherits(e,pc.LiveLinkMessage);pc.LiveLinkMessage.register("UPDATE_ASSETCACHE");return{LiveLinkUpdateAssetCacheMessage:e}}());pc.extend(pc,function(){var e=function(a){this._guid=pc.guid.create();this._batchHandle=null;this.c={};this._app=a;a||(this._app=pc.Application.getApplication())||console.error("Couldn't find current application");pc.events.attach(this)},e=pc.inherits(e,pc.GraphNode);e.prototype.addComponent=function(a,b){var c=this._app.systems[a];if(c)if(this.c[a])logERROR(pc.string.format("Entity already has {0} Component",a));else return c.addComponent(this,b);else return logERROR(pc.string.format("System: '{0}' doesn't exist",
a)),null};e.prototype.removeComponent=function(a){var b=this._app.systems[a];b?this.c[a]?b.removeComponent(this):logERROR(pc.string.format("Entity doesn't have {0} Component",a)):logERROR(pc.string.format("System: '{0}' doesn't exist",a))};e.prototype.getGuid=function(){return this._guid};e.prototype.setGuid=function(a){this._guid=a};e.prototype._onHierarchyStateChanged=function(a){pc.Entity._super._onHierarchyStateChanged.call(this,a);var b,c=this.c;for(type in c)if(c.hasOwnProperty(type)&&(b=c[type],
b.enabled))if(a)b.onEnable();else b.onDisable()};e.prototype.setRequest=function(a){this._request=a};e.prototype.getRequest=function(){return this._request};e.prototype.addChild=function(a){if(a instanceof pc.Entity&&this.getRoot().findOne("getGuid",a.getGuid()))throw Error("GUID already exists in graph");pc.GraphNode.prototype.addChild.call(this,a)};e.prototype.findByGuid=function(a){if(this._guid===a)return this;for(var b=0;b<this._children.length;b++)if(this._children[b].findByGuid){var c=this._children[b].findByGuid(a);
if(null!==c)return c}return null};e.prototype.destroy=function(){var a=this.getParent(),b;for(b in this.c)this.c[b].enabled=!1;for(b in this.c)this.c[b].system.removeComponent(this);a&&a.removeChild(this);a=this.getChildren();for(b=a.shift();b;)b instanceof pc.Entity&&b.destroy(),b=a.shift()};e.prototype.clone=function(){var a,b=new pc.Entity(this._app);pc.Entity._super._cloneInternal.call(this,b);for(a in this.c)this.c[a].system.cloneComponent(this,b);for(a=0;a<this.getChildren().length;a++){var c=
this.getChildren()[a];c instanceof pc.Entity&&b.addChild(c.clone())}return b};e.deserialize=function(a){var b=pc.json.parse(a.template),c=pc.json.parse(a.parent),d=pc.json.parse(a.children),e=pc.json.parse(a.transform),f=pc.json.parse(a.components),k=pc.json.parse(a.labels);return{_id:a._id,resource_id:a.resource_id,_rev:a._rev,name:a.name,enabled:a.enabled,labels:k,template:b,parent:c,children:d,transform:e,components:f}};e.serialize=function(a){var b={_id:a._id,resource_id:a.resource_id,name:a.name,
enabled:a.enabled,labels:pc.json.stringify(a.labels),template:pc.json.stringify(a.template),parent:pc.json.stringify(a.parent),children:pc.json.stringify(a.children),transform:pc.json.stringify(a.transform),components:pc.json.stringify(a.components)};a._rev&&(b._rev=a._rev);return b};return{Entity:e}}());pc.resources={};pc.extend(pc.resources,function(){var e=function(){void 0===window.RSVP&&logERROR("Missing RSVP library");this._types={};this._handlers={};this._requests={};this._cache={};this._hashes={};this._canonicals={};this._sequence=this._loaded=this._requested=0;this.cache=!0;pc.events.attach(this)};e.prototype={createFileRequest:function(a,c){return new this._types[c](a)},registerHandler:function(a,c){var d=new a;if(""===d.type)throw Error("ResourceRequests must have a type");this._types[d.type]=a;this._handlers[d.type]=
c;c.setLoader(this)},request:function(a,c){var c=c||{},d=this,e=c.parent;c.cache=d.cache;return new pc.promise.Promise(function(f,k){var m,h;void 0===a.length&&(a=[a]);var n=[],l=[];m=0;for(h=a.length;m<h;m++){var r=d._findExistingRequest(a[m]);r!==a[m]&&(r.data=a[m].data);d._makeCanonical(r);l.push(d._request(r,c));n.push(r);e&&e.children.push(r)}var v=function(a,b){var c=[],e=[];b.forEach(function(a){a.children.forEach(function(a){e.push(a);c.push.apply(c,a.promises)})});c.length?pc.promise.all(c).then(function(){v(a,
e,c)},function(a){k(a)}):(d.fire("complete",a),f(a))};pc.promise.all(l).then(function(a){v(a,n,l)},function(a){k(a)})})},open:function(a,c,d){a=new a;return this._handlers[a.type].open(c,a,d)},registerHash:function(a,c){this._hashes[c]||(this._hashes[c]=a);this._canonicals[a]||(this._canonicals[a]=c)},unregisterHash:function(a){var c=this.getHash(a);c&&(delete this._canonicals[c],delete this._hashes[a])},getHash:function(a){return this._hashes[a]},addToCache:function(a,c){var d=this.getHash(a);d&&
(this._cache[d]=c)},getFromCache:function(a){return(a=this.getHash(a))?this._cache[a]:null},removeFromCache:function(a){if(a=this.getHash(a))delete this._cache[a];else return null},resetProgress:function(){this._loaded=this._requested=0},_request:function(a,c){var d=this,e={};for(key in c)e[key]=c[key];null===a.id&&(a.id=this._sequence++);this.fire("request",a);a.promises.length?a.promises.push(new pc.promise.Promise(function(c){a.promises[0].then(function(e){e=d._postOpen(e,a);c(e)})})):a.promises[0]=
new pc.promise.Promise(function(c,k){var m=d._handlers[a.type];if(m){var h=d.getFromCache(a.canonical);h&&(void 0===a.Type||h instanceof a.Type)?(h=d._postOpen(h,a),c(h)):m.load(a,e).then(function(h){try{var l=d._open(h,a,e);l&&(l=d._postOpen(l,a));c(l)}catch(m){k(m)}},function(c){d.fire("error",a,c);k(c)})}else m="Missing handler for type: "+a.type,d.fire("error",a,m),k(m)});d._requests[a.canonical]=a;this._requested++;return a.promises[a.promises.length-1]},_open:function(a,c,d){return this._handlers[c.type].open(a,
c,d)},_postOpen:function(a,c){this.addToCache(c.canonical,a);a=this._handlers[c.type].clone(a,c);delete this._requests[c.canonical];this._loaded++;this.fire("progress",this._loaded/this._requested);this.fire("load",c,a);return a},_makeCanonical:function(a){var c=this.getHash(a.identifier);a.canonical=c&&this._canonicals[c]?this._canonicals[c]:a.identifier},_findExistingRequest:function(a){var c=this._requests[a.canonical];return c?c.type!==a.type||c.result||a.result?a:c:a}};var a=function(){};a.prototype=
{setLoader:function(a){this._loader=a},load:function(){throw Error("Not implemented");},open:function(){throw Error("Not implemented");},clone:function(a){return a}};return{ResourceLoader:e,ResourceHandler:a,ResourceRequest:function(a,c,d){this.id=null;this.canonical=a;this.alternatives=[];this.promises=[];this.children=[];this.data=c;this.result=d;this.identifier=a}}}());pc.extend(pc.resources,function(){var e=function(a,b){b.on("request",this.handleRequest,this);b.on("load",this.handleLoad,this);b.on("error",this.handleError,this);b.on("progress",this.handleProgress,this);this.addCss();this._element=a;this._domCreate()};e.prototype={addCss:function(){var a=document.createElement("style");document.getElementsByTagName("head")[0].appendChild(a);if(a.styleSheet)a.styleSheet.cssText=".pc-resourceloaderdisplay-root {\n   font-family: sans-serif;\n   font-size: 0.7em;\n   color: #aaa;\n   border-collapse: collapse;\n   position: absolute;\n   top: 10px;\n   left: 10px;\n   background-color: black;\n   opacity: 0.6;\n}\n.pc-resourceloaderdisplay-root td {\n   border: 1px solid #aaa;\n}\n.pc-resourceloaderdisplay-subtable {\n   border-collapse: collapse;\n}";
else{var b=document.createTextNode(".pc-resourceloaderdisplay-root {\n   font-family: sans-serif;\n   font-size: 0.7em;\n   color: #aaa;\n   border-collapse: collapse;\n   position: absolute;\n   top: 10px;\n   left: 10px;\n   background-color: black;\n   opacity: 0.6;\n}\n.pc-resourceloaderdisplay-root td {\n   border: 1px solid #aaa;\n}\n.pc-resourceloaderdisplay-subtable {\n   border-collapse: collapse;\n}");a.appendChild(b)}},handleRequest:function(a){console.warn("request: "+a.id);this._domAddRequest(a)},
handleLoad:function(a){console.warn("load: "+a.id);if(a=document.getElementsByClassName("pc-resourcesloaderdisplay-progress-"+a.id))for(var b=0;b<a.length;b++)a[b].textContent="100%"},handleError:function(a,b){var c=document.getElementsByClassName("pc-resourcesloaderdisplay-progress-"+a.id);if(c)for(var d=0;d<c.length;d++)c[d].textContent=b},handleProgress:function(){},_domCreate:function(){this._rootTable=document.createElement("table");this._rootTable.setAttribute("class","pc-resourceloaderdisplay-root");
this._element.appendChild(this._rootTable)},_domAddRequest:function(a){var b="pc-resourcesloaderdisplay-progress-"+a.id,c=document.createElement("tr"),d=document.createElement("td");d.textContent=a.identifier;a=document.createElement("td");a.className=b;a.textContent="0%";c.appendChild(d);c.appendChild(a);this._rootTable.appendChild(c)},_sanitizeId:function(a){return a.replace(/\//,"").replace(/\./,"")}};return{ResourceLoaderDisplay:e}}());pc.extend(pc.resources,function(){var e=function(a){this.cache={};this.loader=a};e.prototype={getTexture:function(a){return(a=this.loader.getHash(a))&&this.cache[a]?this.cache[a]:null},addTexture:function(a,b){var c=this.loader.getHash(a);c&&(this.cache[c]=b)}};return{TextureCache:e}}());pc.extend(pc.resources,function(){var e;e=pc.inherits(function(){},pc.resources.ResourceHandler);e.prototype.load=function(a){return new pc.promise.Promise(function(c,d){pc.net.http.get(a.canonical,function(a){c(a)},{error:function(){d()}})})};e.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="json";a.prototype.Type=Object;return{JsonResourceHandler:e,JsonRequest:a}}());pc.extend(pc.resources,function(){var e;e=pc.inherits(function(){},pc.resources.ResourceHandler);e.prototype.load=function(a){return new RSVP.Promise(function(c,d){pc.net.http.get(a.canonical,function(a){c(a)},{error:function(){d()}})})};e.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="text";a.prototype.Type=Object;return{TextResourceHandler:e,TextRequest:a}}());pc.extend(pc.resources,function(){var e;e=pc.inherits(function(){},pc.resources.ResourceHandler);e.prototype.load=function(a){return new pc.promise.Promise(function(c,d){var e=new Image;e.onload=function(){c(e)};e.onerror=function(a){d(pc.string.format("Error loading Image from: '{0}'",a.srcElement.src))};e.src=a.canonical})};e.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="image";a.prototype.Type=Image;return{ImageResourceHandler:e,
ImageRequest:a}}());pc.extend(pc.resources,function(){var e={repeat:pc.ADDRESS_REPEAT,clamp:pc.ADDRESS_CLAMP_TO_EDGE,mirror:pc.ADDRESS_MIRRORED_REPEAT},a={nearest:pc.FILTER_NEAREST,linear:pc.FILTER_LINEAR,nearest_mip_nearest:pc.FILTER_NEAREST_MIPMAP_NEAREST,linear_mip_nearest:pc.FILTER_LINEAR_MIPMAP_NEAREST,nearest_mip_linear:pc.FILTER_NEAREST_MIPMAP_LINEAR,linear_mip_linear:pc.FILTER_LINEAR_MIPMAP_LINEAR},b=function(a,b){this._device=a;this._assets=b;this.crossOrigin=void 0},b=pc.inherits(b,pc.resources.ResourceHandler);
b.prototype.load=function(a,b){var c=a.canonical,e=this;return new pc.promise.Promise(function(m,h){var n=pc.path.getExtension(c).toLowerCase();if(".dds"===n||".crn"===n)b=b||{},b.binary=!0,b.directory=pc.path.getDirectory(c),b.crn=".crn"===n,pc.net.http.get(c,function(a){m(a)},{cache:!0,responseType:"arraybuffer"});else if(".jpg"===n||".jpeg"===n||".gif"===n||".png"===n){var l=new Image;void 0!==e.crossOrigin&&(l.crossOrigin=e.crossOrigin);l.onload=function(){m(l)};l.onerror=function(a){h(pc.string.format("Error loading Texture from: '{0}'",
a.srcElement.src))};(n=e._assets.getAssetByUrl(a.canonical))&&n.file&&(c+="?t="+n.file.hash);l.src=c}})};b.prototype.open=function(b,c,f){var k;if(b instanceof Image||b instanceof HTMLImageElement){if(c.result)k=c.result;else if(v=pc.string.endsWith(b.src.toLowerCase(),".jpg")?pc.PIXELFORMAT_R8_G8_B8:pc.PIXELFORMAT_R8_G8_B8_A8,k=new pc.Texture(this._device,{width:b.width,height:b.height,format:v}),(c=this._assets.getAssetByUrl(c.canonical))&&c.data){var m=function(b){void 0!==b.name&&(k.name=b.name);
void 0!==b.addressu&&(k.addressU=e[b.addressu]);void 0!==b.addressV&&(k.addressV=e[b.addressV]);void 0!==b.magfilter&&(k.magFilter=a[b.magfilter]);void 0!==b.minfilter&&(k.minfilter=a[b.minfilter]);void 0!==b.anisotropy&&(k.anisotropy=b.anisotropy)};m(c.data);c.on("change",function(a,b,c){"data"===b&&m(c)},this)}k.setSource(b)}else if(b instanceof ArrayBuffer){if(f.crn){var c=b.byteLength,f=new Uint8Array(b),b=Module._malloc(c),h=Module.HEAPU8;dst32Offset=b/4;for(var n=c%4,l=new Uint32Array(f.buffer,
0,(c-n)/4),r=new Uint32Array(h.buffer),v=0;v<l.length;v++)r[dst32Offset+v]=l[v];for(v=c-n;v<c;v++)h[b+v]=f[v];f=Module._crn_decompress_get_data(b,c);b=Module._crn_decompress_get_size(b,c);b=Module.HEAPU8.buffer.slice(f,f+b)}var u=new Uint32Array(b,0,32),c=u[4],f=u[3],h=Math.max(u[7],1),C=u[21],y=u[22],n=65024===u[28],v=null,r=l=!1;4===u[20]?827611204===C?(v=pc.PIXELFORMAT_DXT1,l=!0):894720068===C?(v=pc.PIXELFORMAT_DXT5,l=!0):116===C&&(v=pc.PIXELFORMAT_RGBA32F,r=!0):32===y&&(v=pc.PIXELFORMAT_R8_G8_B8_A8);
u=Math.round(Math.log2(Math.max(c,f))+1);if(!v||h!==u&&l)return v?console.error("DDS has "+h+" mips, but engine requires "+u+" for DXT format. . Empty texture will be created instead."):console.error("This DDS pixel format is currently unsupported. Empty texture will be created instead."),k=new pc.Texture(this._device,{width:4,height:4,format:pc.PIXELFORMAT_R8_G8_B8});k=new pc.Texture(this._device,{width:c,height:f,format:v,cubemap:n});for(var v=128,u=n?6:1,s,C=827611204===C?8:16,w,y=0;y<u;y++)for(var A=
c,x=f,z=0;z<h;z++)l?(s=Math.floor((A+4-1)/4),w=Math.floor((x+4-1)/4),numBlocks=s*w,s=numBlocks*C):s=4*A*x,w=r?new Float32Array(b,v,s):new Uint8Array(b,v,s),n?(k._levels[z]||(k._levels[z]=[]),k._levels[z][y]=w):k._levels[z]=w,v+=r?4*s:s,A=Math.max(0.5*A,1),x=Math.max(0.5*x,1);k.upload()}return k};var c;c=pc.inherits(function(){},pc.resources.ResourceRequest);c.prototype.type="texture";c.prototype.Type=pc.Texture;return{TextureResourceHandler:b,TextureRequest:c}}());pc.extend(pc.resources,function(){function e(a,b,g,f){if("resource"===b){var b=this.getSource(),k=!1;if(f)for(var f=f.getSource(),m=0;m<b.length;m++)b[m]===f&&(b[m]=g.getSource(),k=!0);k?this.setSource(b):a.off("change",e,this)}}var a=function(a,b){this._device=a;this._assets=b},a=pc.inherits(a,pc.resources.ResourceHandler);a.prototype.load=function(a){var b=null;return b=pc.string.startsWith(a.canonical,"asset://")?new pc.promise.Promise(function(b,d){var e=this._getAssetFromRequest(a);e||d(pc.string.format("Can't load cubemap, asset {0} not found",
a.canonical));this._loadCubemapImages(null,e.data).then(function(a){var c=pc.extend({},e.data);c.images=a;b(c)},function(a){d(a)})}.bind(this)):new pc.promise.Promise(function(b,d){pc.net.http.get(a.canonical,function(e){var m=pc.extend({},e),e=e.textures;if(e.length){var h=[];e.forEach(function(b){var d=pc.path.getBasename(b),b=pc.path.join(pc.path.split(a.canonical)[0],b);h.push(new pc.asset.Asset(d,"texture",{url:b}))});this._assets.load(h).then(function(a){m.images=a.map(function(a){return a.getSource()});
b(m)},function(a){d(a)})}else b(m)}.bind(this),{error:function(){d()}})}.bind(this))};a.prototype.open=function(a,b){var e=null,e=b.result?b.result:new pc.Texture(this._device,{format:pc.PIXELFORMAT_R8_G8_B8,cubemap:!0}),f=a.images;delete a.images;this._updateCubemapData(e,a,f);this._getAssetFromRequest(b).on("change",function(a,b,c){"data"===b&&this._loadCubemapImages(e,c).then(function(a){this._updateCubemapData(e,c,a)}.bind(this))},this);return e};a.prototype._areValidImages=function(a){var b=
a&&6===a.length,e;if(b)for(var f=a[0]?a[0].width:null,k=a[0]?a[0].height:null,m=0;6>m;m++){if(!a[m]){b=!1;break}if(!a[m]instanceof HTMLCanvasElement||!a[m]instanceof HTMLImageElement||!a[m]instanceof HTMLVideoElement){e="Cubemap source is not an instance of HTMLCanvasElement, HTMLImageElement or HTMLVideoElement.";b=!1;break}if(a[m].width!==f||a[m].height!==k){e="Cubemap sources do not all share the same dimensions.";b=!1;break}}e&&alert(e);return b};a.prototype._loadCubemapImages=function(a,b){var e=
this;return new pc.promise.Promise(function(a,c){if(b.textures){for(var m=[],h=0;6>h;h++)if(b.textures[h]){var n=e._assets.getAssetById(b.textures[h]);if(n)m.push(n);else{c(pc.string.format("Could not load cubemap - Texture {0} not found",b.textures[h]));return}}else{a(null);return}e._assets.load(m).then(function(b){a(b.map(function(a){return a.getSource()}))},function(a){c(a)})}else a(null)})};a.prototype._updateCubemapData=function(a,b,g){a.name!==b.name&&(a.name=b.name);a.minFilter!==b.minFilter&&
(a.minFilter=b.minFilter);a.magFilter!==b.magFilter&&(a.magFilter=b.magFilter);a.addressU!==pc.ADDRESS_CLAMP_TO_EDGE&&(a.addressU=pc.ADDRESS_CLAMP_TO_EDGE);a.addressV!==pc.ADDRESS_CLAMP_TO_EDGE&&(a.addressV=pc.ADDRESS_CLAMP_TO_EDGE);a.anisotropy!==b.anisotropy&&(a.anisotropy=b.anisotropy);this._areValidImages(g)&&a.setSource(g);g={};if(b.textures)for(var f=0;6>f;f++)if(b.textures[f]){var k=this._assets.getAssetById(b.textures[f]);k&&(g[k.id]=k)}for(var m in g)g[m].off("change",e,a),g[m].on("change",
e,a)};a.prototype._getAssetFromRequest=function(a){return pc.string.startsWith(a.canonical,"asset://")?this._assets.getAssetById(parseInt(a.canonical.slice(8))):this._assets.getAssetByUrl(a.canonical)};var b;b=pc.inherits(function(){},pc.resources.ResourceRequest);b.prototype.type="cubemap";b.prototype.Type=pc.Texture;return{CubemapResourceHandler:a,CubemapRequest:b}}());pc.extend(pc.resources,function(){var e={points:pc.PRIMITIVE_POINTS,lines:pc.PRIMITIVE_LINES,lineloop:pc.PRIMITIVE_LINELOOP,linestrip:pc.PRIMITIVE_LINESTRIP,triangles:pc.PRIMITIVE_TRIANGLES,trianglestrip:pc.PRIMITIVE_TRISTRIP,trianglefan:pc.PRIMITIVE_TRIFAN},a={int8:pc.ELEMENTTYPE_INT8,uint8:pc.ELEMENTTYPE_UINT8,int16:pc.ELEMENTTYPE_INT16,uint16:pc.ELEMENTTYPE_UINT16,int32:pc.ELEMENTTYPE_INT32,uint32:pc.ELEMENTTYPE_UINT32,float32:pc.ELEMENTTYPE_FLOAT32},b=function(a,b){this._device=a;this._assets=
b},b=pc.inherits(b,pc.resources.ResourceHandler);b.prototype.load=function(a,b){var c=this;if(a.data)for(var e,m=[],h=a.data,n=0;n<h.length;n++)h[n].material&&(e=this._assets.getAssetById(h[n].material))&&m.push(e);return new pc.promise.Promise(function(e,h){var k=a.canonical;b=b||{};b.directory=pc.path.getDirectory(k);pc.net.http.get(k,function(a){m.length?c._assets.load(m).then(function(){e(a)}):e(a)},{cache:b.cache,error:function(a){h(pc.string.format("Error loading model: {0} [{1}]",k,a))}})})};
b.prototype.open=function(a,b,c){c=c||{};c.directory=c.directory||"";c.parent=b;var e=null;1>=a.model.version?logERROR(pc.string.format("Asset: {0}, is an old model format. Upload source assets to re-import.",b.canonical)):2<=a.model.version&&(e=this._loadModelJson(a,b.data,c));return e};b.prototype.clone=function(a){return a.clone()};b.prototype._loadModelJson=function(b,c,f){var k=b.model,m,h,b=[];for(m=0;m<k.nodes.length;m++){var n=k.nodes[m],l=new pc.GraphNode;l.setName(n.name);l.setLocalPosition(n.position[0],
n.position[1],n.position[2]);l.setLocalEulerAngles(n.rotation[0],n.rotation[1],n.rotation[2]);l.setLocalScale(n.scale[0],n.scale[1],n.scale[2]);b.push(l)}for(m=1;m<k.parents.length;m++)b[k.parents[m]].addChild(b[m]);!this._device.supportsBoneTextures&&0<k.skins.length&&(m=this._device.getBoneLimit(),pc.partitionSkin(k,c,m));var r=[],n=[];for(m=0;m<k.skins.length;m++){var v=k.skins[m],l=[];for(h=0;h<v.inverseBindMatrices.length;h++){var u=v.inverseBindMatrices[h];l[h]=new pc.Mat4(u[0],u[1],u[2],u[3],
u[4],u[5],u[6],u[7],u[8],u[9],u[10],u[11],u[12],u[13],u[14],u[15])}v=new pc.Skin(this._device,l,v.boneNames);r.push(v);l=new pc.SkinInstance(v);u=[];for(h=0;h<v.boneNames.length;h++){var C=b[0].findByName(v.boneNames[h]);u.push(C)}l.bones=u;n.push(l)}var v=[],y,l={position:pc.SEMANTIC_POSITION,normal:pc.SEMANTIC_NORMAL,tangent:pc.SEMANTIC_TANGENT,blendWeight:pc.SEMANTIC_BLENDWEIGHT,blendIndices:pc.SEMANTIC_BLENDINDICES,color:pc.SEMANTIC_COLOR,texCoord0:pc.SEMANTIC_TEXCOORD0,texCoord1:pc.SEMANTIC_TEXCOORD1,
texCoord2:pc.SEMANTIC_TEXCOORD2,texCoord3:pc.SEMANTIC_TEXCOORD3,texCoord4:pc.SEMANTIC_TEXCOORD4,texCoord5:pc.SEMANTIC_TEXCOORD5,texCoord6:pc.SEMANTIC_TEXCOORD6,texCoord7:pc.SEMANTIC_TEXCOORD7};for(m=0;m<k.vertices.length;m++){u=k.vertices[m];if(u.position&&u.normal&&u.texCoord0){C=[];for(h=0;h<k.meshes.length;h++)k.meshes[h].vertices===m&&(C=C.concat(k.meshes[h].indices));tangents=pc.calculateTangents(u.position.data,u.normal.data,u.texCoord0.data,C);u.tangent={type:"float32",components:4,data:tangents}}h=
[];for(y in u){var C=u[y],s=C.type;this._device.supportsUnsignedByte||("uint8"===s&&(s="float32"),"int8"===s&&(s="float32"));h.push({semantic:l[y],components:C.components,type:a[s],normalize:!1})}h=new pc.VertexFormat(this._device,h);var s=u.position.data.length/u.position.components,w=new pc.VertexBuffer(this._device,h,s),A=new pc.VertexIterator(w);for(h=0;h<s;h++){for(y in u)switch(C=u[y],C.components){case 1:A.element[l[y]].set(C.data[h]);break;case 2:A.element[l[y]].set(C.data[2*h],C.data[2*h+
1]);break;case 3:A.element[l[y]].set(C.data[3*h],C.data[3*h+1],C.data[3*h+2]);break;case 4:A.element[l[y]].set(C.data[4*h],C.data[4*h+1],C.data[4*h+2],C.data[4*h+3])}A.next()}A.end();v.push(w)}for(m=l=0;m<k.meshes.length;m++)u=k.meshes[m],void 0!==u.indices&&(l+=u.indices.length);s=C=null;w=0;0<l&&(C=new pc.IndexBuffer(this._device,pc.INDEXFORMAT_UINT16,l),s=new Uint16Array(C.lock()));y=[];for(m=0;m<k.meshes.length;m++){u=k.meshes[m];h=u.aabb.min;var A=u.aabb.max,A=new pc.shape.Aabb(new pc.Vec3(0.5*
(A[0]+h[0]),0.5*(A[1]+h[1]),0.5*(A[2]+h[2])),new pc.Vec3(0.5*(A[0]-h[0]),0.5*(A[1]-h[1]),0.5*(A[2]-h[2]))),x=void 0!==u.indices;h=new pc.Mesh;h.vertexBuffer=v[u.vertices];h.indexBuffer[0]=x?C:null;h.primitive[0].type=e[u.type];h.primitive[0].base=x?u.base+w:u.base;h.primitive[0].count=u.count;h.primitive[0].indexed=x;h.skin=void 0!==u.skin?r[u.skin]:null;h.aabb=A;x&&(s.set(u.indices,w),w+=u.indices.length);y.push(h)}0<l&&C.unlock();v=[];u=new pc.PhongMaterial;for(m=0;m<k.meshInstances.length;m++){h=
k.meshInstances[m];l=b[h.node];h=y[h.mesh];(C=this._getMaterial(m,c,f))||(C=u);l=new pc.MeshInstance(l,h,C);if(h.skin){h=r.indexOf(h.skin);if(-1===h)throw Error("Mesh's skin does not appear in skin array.");l.skinInstance=n[h]}v.push(l)}c=new pc.Model;c.graph=b[0];c.meshInstances=v;c.skinInstances=n;c.getGraph().syncHierarchy();return c};b.prototype._getMaterial=function(a,b,c){var e;if(b&&b.length>a)if(b[a].material){if(a=this._assets.getAssetById(b[a].material)){if(!a.resource)return console.error(pc.string.format("Material asset '{0}' is not loaded.",
a.name)),null}else return console.error("Reference to material not in asset list. Try reloading."),null;e=a.resource}else if(b[a].path&&(c=pc.path.split(c.parent.canonical)[0],c=pc.path.join(c,b[a].path),a=this._assets.getAssetByUrl(c)))e=a.resource;return e};var c;c=pc.inherits(function(){},pc.resources.ResourceRequest);c.prototype.type="model";c.prototype.Type=pc.Model;return{ModelResourceHandler:b,ModelRequest:c}}());pc.extend(pc.resources,function(){function e(a,b,g,f){if("resource"===b){b=!1;if(f)for(var k in this)this.hasOwnProperty(k)&&this[k]===f&&(this[k]=g,b=!0);b?this.update():a.off("change",e,this)}}var a=function(a,b){this._assets=b;this._device=a},a=pc.inherits(a,pc.resources.ResourceHandler);a.prototype.load=function(a){var b=null;return b=pc.string.startsWith(a.canonical,"asset://")?new pc.promise.Promise(function(b,d){var e=this._getAssetFromRequest(a);e||d(pc.string("Can't load material, asset %s not found",
a.canonical));b(e.data)}.bind(this)):new pc.promise.Promise(function(b,d){pc.net.http.get(a.canonical,function(d){if("path"===d.mapping_format){var e=this._listReferencedAssets(d),f=[];e.length?(e.forEach(function(b){var d=b.data,e=pc.path.getBasename(d),d=pc.path.join(pc.path.split(a.canonical)[0],d);f.push(new pc.asset.Asset(e,b.type,{url:d}))}),this._assets.load(f).then(function(){b(d)})):b(d)}else b(d)}.bind(this),{error:function(){d()}})}.bind(this))};a.prototype.open=function(a,b){var e=new pc.PhongMaterial;
this._updatePhongMaterial(e,a,b);this._getAssetFromRequest(b).on("change",function(a,c,m){"data"===c&&this._updatePhongMaterial(e,m,b)},this);return e};a.prototype._listReferencedAssets=function(a){return a.parameters.filter(function(a){return("texture"===a.type||"cubemap"===a.type)&&a.data})};a.prototype._updatePhongMaterial=function(a,b,g){var f=[];b.parameters.push({name:"shadingModel",type:"float",data:"blinn"===b.shader?pc.SPECULAR_BLINN:pc.SPECULAR_PHONG});for(var k={},m=0;m<b.parameters.length;m++){var h=
b.parameters[m];if("texture"===h.type&&h.data&&!(h.data instanceof pc.Texture)){var n=this._getTextureAssetFromRegistry(h.data,g);n&&(k[n.id]=n);this._loadTextureParamFromCache(h,n);!(h.data instanceof pc.Texture)&&n&&f.push(this._loadTextureParamPromise(h,n))}else"cubemap"===h.type&&(h.data&&!(h.data instanceof pc.Texture))&&(n=this._getTextureAssetFromRegistry(h.data,g),this._loadCubemapParamFromCache(h,n),!(h.data instanceof pc.Texture)&&n&&f.push(this._loadCubemapParamPromise(h,n)))}for(var l in k)k[l].off("change",
e,a),k[l].on("change",e,a);f.length?pc.promise.all(f).then(function(){a.init(b)},function(e){pc.log.error(e);a.init(b)}):a.init(b)};a.prototype._getTextureAssetFromRegistry=function(a,b){var e=this._assets.getAssetById(a);!e&&b&&(url=pc.path.join(pc.path.split(b.canonical)[0],a),e=this._assets.getAssetByUrl(url));return e};a.prototype._loadTextureParamFromCache=function(a,b){b?b.resource&&(a.data=b.resource):(pc.log.error(pc.string.format("Could not load texture. Asset {0} not found",a.data)),a.data=
null)};a.prototype._loadTextureParamPromise=function(a,b){return this._assets.load(b).then(function(b){a.data=b[0]},function(){a.data=null})};a.prototype._loadCubemapParamFromCache=function(a,b){b?b.resource&&(a.data=b.resource):(pc.log.error(pc.string.format("Could not load cubemap. Asset {0} not found",a.data)),a.data=null)};a.prototype._loadCubemapParamPromise=function(a,b){return this._assets.load(b).then(function(b){a.data=b[0]},function(){a.data=null})};a.prototype._getAssetFromRequest=function(a){return pc.string.startsWith(a.canonical,
"asset://")?this._assets.getAssetById(parseInt(a.canonical.slice(8))):this._assets.getAssetByUrl(a.canonical)};var b;b=pc.inherits(function(){},pc.resources.ResourceRequest);b.prototype.type="material";b.prototype.Type=pc.Material;return{MaterialRequest:b,MaterialResourceHandler:a}}());pc.extend(pc.resources,function(){var e=function(a,c){this._app=a;this._prefix=c||"";this._queue=[];this._pending=[];this._loaded={};this._loading=null;pc.script.on("created",this._onScriptCreated,this)},e=pc.inherits(e,pc.resources.ResourceHandler);e.prototype.load=function(a,c){c=c||{};c.timeout=c.timeout||6E4;c.cache=!0;return new pc.promise.Promise(function(d,e){var f=a.canonical,k=f;c.cache||(k=this._appendTimestampToUrl(k));k=new pc.URI(k);k.path=pc.path.join(this._prefix,k.path);k=k.toString();
this._loaded[f]?!0!==this._loaded[f]?d(this._loaded[f]):d(null):this._loading?this._queue.push({url:k,canonicalUrl:f,success:d,error:e}):this._addScriptTag(k,f,d,e);c.timeout&&setTimeout(function(){this._loaded[f]||e(pc.string.format("Loading script {0} timed out after {1}s",f,c.timeout/1E3))}.bind(this),c.timeout)}.bind(this))};e.prototype.open=function(a){return a};e.prototype._appendTimestampToUrl=function(a){timestamp=Date.now();uri=new pc.URI(a);uri.query=uri.query?uri.query+"&ts="+timestamp:
"ts="+timestamp;return a=uri.toString()};e.prototype._onScriptCreated=function(a,c){this._pending.push({name:a,callback:c})};e.prototype._addScriptTag=function(a,c,d,e){var f=this,k=document.getElementsByTagName("head")[0],m=document.createElement("script");this._loading=m;m.addEventListener("error",function(a){e(pc.string.format("Error loading script from '{0}'",a.target.src))});var h=!1;m.onload=m.onreadystatechange=function(){if(!h&&(!this.readyState||"loaded"==this.readyState||"complete"==this.readyState)){h=
!0;var a=f._pending.shift();if(a){var b=a.callback(f._app);if(b._pcScriptName)throw Error("Attribute _pcScriptName is reserved on ScriptTypes for ResourceLoader use");b._pcScriptName=a.name;f._loaded[c]=b;f._loader.registerHash(c,c);f._loader.addToCache(c,b);d(b)}else f._loaded[c]=!0,f._loader.registerHash(c,c),f._loader.addToCache(c,!0),d(null);f._loading=null;f._queue.length&&(a=f._queue.shift(),f._addScriptTag(a.url,a.canonicalUrl,a.success,a.error))}};m.src=a;k.appendChild(m)};var a;a=pc.inherits(function(){},
pc.resources.ResourceRequest);a.prototype.type="script";return{ScriptResourceHandler:e,ScriptRequest:a}}());pc.extend(pc.resources,function(){var e;e=pc.inherits(function(){},pc.resources.ResourceHandler);e.prototype.load=function(a,c){return new pc.promise.Promise(function(d,e){var f=a.canonical;pc.path.getDirectory(f);pc.net.http.get(f,function(a){try{d(a)}catch(b){e(pc.string.format("An error occured while loading animation from: '{0}'",f))}}.bind(this),{cache:c.cache,error:function(a){e(a)}})})};e.prototype.open=function(a){return this["_loadAnimationV"+a.animation.version](a)};e.prototype._loadAnimationV3=
function(a){var a=a.animation,c=new pc.Animation;c.setName(a.name);c.setDuration(a.duration);for(var d=0;d<a.nodes.length;d++){var e=new pc.Node,f=a.nodes[d];e._name=f.name;for(var k=0;k<f.keys.length;k++){var m=f.keys[k],h=m.time,n=m.pos,l=m.rot,m=m.scale,n=new pc.Vec3(n[0],n[1],n[2]),l=(new pc.Quat).setFromEulerAngles(l[0],l[1],l[2]),m=new pc.Vec3(m[0],m[1],m[2]),h=new pc.Key(h,n,l,m);e._keys.push(h)}c.addNode(e)}return c};e.prototype._loadAnimationV4=function(a){var a=a.animation,c=new pc.Animation;
c.setName(a.name);c.setDuration(a.duration);for(var d=0;d<a.nodes.length;d++){var e=new pc.Node,f=a.nodes[d];e._name=f.name;for(var k=f.defaults.p,m=f.defaults.r,h=f.defaults.s,n=0;n<f.keys.length;n++){var l=f.keys[n],r=l.t,v=k?k:l.p,u=m?m:l.r,l=h?h:l.s,v=new pc.Vec3(v[0],v[1],v[2]),u=(new pc.Quat).setFromEulerAngles(u[0],u[1],u[2]),l=new pc.Vec3(l[0],l[1],l[2]),r=new pc.Key(r,v,u,l);e._keys.push(r)}c.addNode(e)}return c};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type=
"animation";a.prototype.Type=pc.Animation;return{AnimationResourceHandler:e,AnimationRequest:a}}());pc.extend(pc.resources,function(){var e=function(a){this.manager=a},e=pc.inherits(e,pc.resources.ResourceHandler);e.prototype.load=function(a){var c=this;return new pc.promise.Promise(function(d){var e=c.manager.createSound(a.canonical,function(a){d(a)},function(a){logERROR(a);d(e)})})};e.prototype.open=function(a){return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="audio";a.prototype.Type=pc.Sound;return{AudioResourceHandler:e,AudioRequest:a}}());pc.extend(pc.resources,function(){var e=function(a,c){this._app=a;this._depot=c},e=pc.inherits(e,pc.resources.ResourceHandler);e.prototype.load=function(a){return new pc.promise.Promise(function(c,d){var e=a.canonical;e in pc.content.packs?setTimeout(function(){c(pc.content.packs[e])},0):this._depot.packs.getOne(e,function(a){c(a)}.bind(this),function(a){d(a)})}.bind(this))};e.prototype.open=function(a,c){return this.openPack(a,c)};e.prototype.openPack=function(a,c){var d=pc.extend({},a);d.hierarchy=
this.openEntity(d.hierarchy,c);return new pc.Pack(d)};e.prototype.openEntity=function(a,c){var d;d=this.openEntityHierarchy(a,c);d.syncHierarchy();return d=this.openComponentData(d,a,c)};e.prototype.openEntityHierarchy=function(a,c){var d=new pc.Entity(this._app),e=a.position,f=a.rotation,k=a.scale;d.setName(a.name);d.setGuid(a.resource_id);d.setLocalPosition(e[0],e[1],e[2]);d.setLocalEulerAngles(f[0],f[1],f[2]);d.setLocalScale(k[0],k[1],k[2]);d._enabled=void 0!==a.enabled?a.enabled:!0;d._enabledInHierarchy=
d._enabled;a.labels&&a.labels.forEach(function(a){d.addLabel(a)});d.__parent=a.parent;d.__children=a.children;d.name=a.name;d.template=a.template;k=a.children.length;for(e=0;e<k;e++)f=this.openEntityHierarchy(a.children[e],c),d.addChild(f);return d};e.prototype.openComponentData=function(a,c,d){a.setRequest(d);var e=this._app.systems.list(),f,k=e.length;for(f=0;f<k;f++){var m=c.components[e[f].id];m&&this._app.systems[e[f].id].addComponent(a,m)}a.setRequest(null);e=c.children.length;k=a.getChildren();
for(f=0;f<e;f++)k[f]=this.openComponentData(k[f],c.children[f],d);return a};var a;a=pc.inherits(function(){},pc.resources.ResourceRequest);a.prototype.type="pack";a.prototype.Type=pc.Pack;return{PackResourceHandler:e,PackRequest:a}}());pc.asset={};
pc.extend(pc.asset,function(){var e=-1,a=function(a,c,d,g){this._id=++e;this.name=a;this.type=c;this._file=d?{filename:d.filename,size:d.size,hash:d.hash,url:d.url}:null;this._data=g||{};this.resource=null;pc.events.attach(this)};a.prototype={getFileUrl:function(){return!this.file?null:this.file.url}};Object.defineProperty(a.prototype,"id",{get:function(){return this._id},set:function(a){this._id=a;a>e&&(e=a)}});Object.defineProperty(a.prototype,"file",{get:function(){return this._file},set:function(a){var c=
this._file;((this._file=a)&&!c||!a&&c||a&&c&&a.hash!==c.hash)&&this.fire("change",this,"file",a,c)}});Object.defineProperty(a.prototype,"data",{get:function(){return this._data},set:function(a){var c=this._data;this._data=a;a!==c&&this.fire("change",this,"data",a,c)}});return{Asset:a,ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap"}}());pc.extend(pc.asset,function(){var e=function(a){if(!a)throw Error("Must provide a ResourceLoader instance for AssetRegistry");this.loader=a;this._cache={};this._names={};this._urls={};this._groups={}};e.prototype={addGroup:function(a,b){this._groups[a]||(this._groups[a]=[]);for(var c in b.assets){var d=this.getAssetById(c);d?pc.extend(d,b.assets[c]):d=this.createAndAddAsset(c,b.assets[c]);this._groups[a].push(d.id)}},createAndAddAsset:function(a,b){var c=new pc.asset.Asset(b.name,b.type,b.file,b.data);
c.id=parseInt(a);this.addAsset(c);c.file&&this.loader.registerHash(c.file.hash,c.getFileUrl());return c},all:function(){return Object.keys(this._cache).map(function(a){return this.getAssetById(a)},this)},list:function(a){if(a){if(this._groups[a])return this._groups[a].map(function(a){return this.getAssetById(a)},this)}else return Object.keys(this._cache).map(function(a){return this.getAssetById(a)},this)},addAsset:function(a){this._cache[a.id]=a;this._names[a.name]||(this._names[a.name]=[]);this._names[a.name].push(a.id);
a.file&&(this._urls[a.getFileUrl()]=a.id,a.on("change",this._onAssetChanged,this))},removeAsset:function(a){delete this._cache[a.id];delete this._names[a.name];a.file&&(a.off("change",this._onAssetChanged,this),delete this._urls[a.file.url])},_onAssetChanged:function(a,b,c,d){if("file"===b&&(d&&(b=d.url,delete this._urls[b],this.loader.removeFromCache(b),this.loader.unregisterHash(b)),c)){b=a.getFileUrl();this._urls[b]=a.id;this.loader.registerHash(c.hash,b);var e=a.resource;this.load([a]).then(function(b){a.fire("change",
a,"resource",b[0],e)})}},findAll:function(a,b){var c=this,d=this._names[a];return d?(d=d.map(function(a){return c._cache[a]}),b?d.filter(function(a){return a.type===b}):d):[]},find:function(a,b){var c=this.findAll(a,b);return c?c[0]:null},getAssetByResourceId:function(a){console.warn("WARNING: getAssetByResourceId: Function is deprecated. Use getAssetById() instead.");return this._cache[a]},getAssetById:function(a){return this._cache[a]},getAssetByUrl:function(a){return this._cache[this._urls[a]]},
getAssetByName:function(a){console.warn("WARNING: getAssetByName: Function is deprecated. Use find() or findAll() instead.");return this.find(a)},load:function(a,b,c){a&&"array"!==pc.type(a)&&(a=[a]);void 0===c&&(c=b,b=[]);var d=[];a.forEach(function(a,c){this.getAssetById(a.id)||this.addAsset(a);switch(a.type){case pc.asset.ASSET_MODEL:d.push(this._createModelRequest(a));break;case pc.asset.ASSET_TEXTURE:d.push(this._createTextureRequest(a,b[c]));break;case pc.asset.ASSET_CUBEMAP:d.push(this._createCubemapRequest(a,
b[c]));break;case pc.asset.ASSET_MATERIAL:d.push(this._createMaterialRequest(a));break;default:d.push(this._createAssetRequest(a))}},this);return this.loader.request(d.filter(function(a){return null!==a}),c).then(function(b){return new pc.promise.Promise(function(c){var e=0;d.forEach(function(c,d){c&&(a[d].resource=b[e++])});c(b)})},function(a){setTimeout(function(){throw a;},0)})},loadFromUrl:function(a,b){if(!b)throw Error("type required");if("model"===b)return this._loadModel(a);pc.path.getDirectory(a);
var c=pc.path.getBasename(a).replace(".json",""),d=new pc.asset.Asset(c,b,{url:a});return new pc.promise.Promise(function(a){this.load(d).then(function(b){a({resource:b,asset:d})})}.bind(this))},_loadModel:function(a){var b=this,c=pc.path.getDirectory(a),d=pc.path.getBasename(a),e=d.replace(".json",""),d=pc.path.join(c,d.replace(".json",".mapping.json")),f=new pc.asset.Asset(e,"model",{url:a}),k=new pc.asset.Asset(e+".mapping","json",{url:d});return new pc.promise.Promise(function(a){b.load([f,k]).then(function(d){var e=
d[0],d=d[1];f.data=d;var g=[];d.mapping.forEach(function(a){g.push(new pc.asset.Asset(pc.path.getBasename(a.path),"material",{url:pc.path.join(c,a.path)}))});if(g.length)return d=b.load(g),d.then(function(b){for(var c=0,d=e.meshInstances.length;c<d;c++)e.meshInstances[c].material=b[c];a({resource:e,asset:f})}),d;a({resource:e,asset:f})})})},_createAssetRequest:function(a){var b=a.getFileUrl();return b?this.loader.createFileRequest(b,a.type):null},_createModelRequest:function(a){var b=a.getFileUrl();
return new pc.resources.ModelRequest(b,a.data&&a.data.mapping?a.data.mapping:[])},_createTextureRequest:function(a,b){return new pc.resources.TextureRequest(a.getFileUrl(),null,b)},_createCubemapRequest:function(a,b){var c=a.getFileUrl();return c?new pc.resources.CubemapRequest(c,null,b):new pc.resources.CubemapRequest("asset://"+a.id,null,b)},_createMaterialRequest:function(a){var b=a.getFileUrl();return b?new pc.resources.MaterialRequest(b):new pc.resources.MaterialRequest("asset://"+a.id)}};return{AssetRegistry:e}}());!function(e){var a,b,c={},d={};a=function(a,b,d){c[a]={deps:b,callback:d}};b=function(a){function e(b){if("."!==b.charAt(0))return b;for(var b=b.split("/"),c=a.split("/").slice(0,-1),d=0,f=b.length;f>d;d++){var h=b[d];".."===h?c.pop():"."!==h&&c.push(h)}return c.join("/")}if(d[a])return d[a];if(d[a]={},!c[a])throw Error("Could not find module "+a);for(var k,m=c[a],h=m.deps,m=m.callback,n=[],l=0,r=h.length;r>l;l++)n.push("exports"===h[l]?k={}:b(e(h[l])));h=m.apply(this,n);return d[a]=k||h};b.entries=
c;!0;a("rsvp/all-settled",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isArray,n=b.isNonThenable;c["default"]=function(a,b){return new d(function(b){function c(a){return function(b){g(a,{state:"fulfilled",value:b})}}function f(a){return function(b){g(a,{state:"rejected",reason:b})}}function g(a,c){A[a]=c;0===--r&&b(A)}if(!e(a))throw new TypeError("You must pass an array to allSettled.");var k,r=a.length;if(0===r)return void b([]);for(var A=Array(r),x=0;x<a.length;x++)k=
a[x],n(k)?g(x,{state:"fulfilled",value:k}):d.resolve(k).then(c(x),f(x))},b)}});a("rsvp/all",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.all(a,b)}});a("rsvp/asap",["exports"],function(a){function b(){for(var a=0;a<d.length;a++){var c=d[a];(0,c[0])(c[1])}d.length=0}a["default"]=function(a,b){1===d.push([a,b])&&c()};var c,a="undefined"!=typeof window?window:{},a=a.MutationObserver||a.WebKitMutationObserver,d=[];if("undefined"!=typeof process&&"[object process]"===
{}.toString.call(process))a=function(){process.nextTick(b)};else if(a)var e=0,a=new a(b),n=document.createTextNode(""),a=(a.observe(n,{characterData:!0}),function(){n.data=e=++e%2});else a=function(){setTimeout(b,1)};c=a});a("rsvp/config",["./events","exports"],function(a,b){var c={instrument:!1};a["default"].mixin(c);b.config=c;b.configure=function(a,b){return"onerror"===a?void c.on("error",b):2!==arguments.length?c[a]:void(c[a]=b)}});a("rsvp/defer",["./promise","exports"],function(a,b){var c=a["default"];
b["default"]=function(a){var b={};return b.promise=new c(function(a,c){b.resolve=a;b.reject=c},a),b}});a("rsvp/events",["exports"],function(a){function b(a,c){for(var d=0,e=a.length;e>d;d++)if(a[d]===c)return d;return-1}function c(a){var b=a._promiseCallbacks;return b||(b=a._promiseCallbacks={}),b}a["default"]={mixin:function(a){return a.on=this.on,a.off=this.off,a.trigger=this.trigger,a._promiseCallbacks=void 0,a},on:function(a,d){var e,g=c(this);(e=g[a])||(e=g[a]=[]);-1===b(e,d)&&e.push(d)},off:function(a,
d){var e,g,r=c(this);return d?(e=r[a],g=b(e,d),void(-1!==g&&e.splice(g,1))):void(r[a]=[])},trigger:function(a,b){var d;if(d=c(this)[a])for(var e=0;e<d.length;e++)(0,d[e])(b)}}});a("rsvp/filter",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isFunction;c["default"]=function(a,b,c){return d.all(a,c).then(function(a){if(!e(b))throw new TypeError("You must pass a function as filter's second argument.");for(var f=a.length,g=Array(f),k=0;f>k;k++)g[k]=b(a[k]);return d.all(g,c).then(function(b){for(var c=
Array(f),d=0,e=0;f>e;e++)!0===b[e]&&(c[d]=a[e],d++);return c.length=d,c})})}});a("rsvp/hash-settled",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isNonThenable,n=b.keysOf;c["default"]=function(a){return new d(function(b){function c(a){return function(b){g(a,{state:"fulfilled",value:b})}}function f(a){return function(b){g(a,{state:"rejected",reason:b})}}function g(a,c){w[a]=c;0===--x&&b(w)}var k,s,w={},A=n(a),x=A.length;if(0===x)return void b(w);for(var z=0;z<A.length;z++)s=
A[z],k=a[s],e(k)?g(s,{state:"fulfilled",value:k}):d.resolve(k).then(c(s),f(s))})}});a("rsvp/hash",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isNonThenable,n=b.keysOf;c["default"]=function(a){return new d(function(b,c){function f(a){return function(c){w[a]=c;0===--x&&b(w)}}function g(a){x=0;c(a)}var k,s,w={},A=n(a),x=A.length;if(0===x)return void b(w);for(var z=0;z<A.length;z++)s=A[z],k=a[s],e(k)?(w[s]=k,0===--x&&b(w)):d.resolve(k).then(f(s),g)})}});a("rsvp/instrument",
["./config","./utils","exports"],function(a,b,c){var d=a.config,e=b.now;c["default"]=function(a,b,c){try{d.trigger(a,{guid:b._guidKey+b._id,eventName:a,detail:b._detail,childGuid:c&&b._guidKey+c._id,label:b._label,timeStamp:e(),stack:Error(b._label).stack})}catch(f){setTimeout(function(){throw f;},0)}}});a("rsvp/map",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=(b.isArray,b.isFunction);c["default"]=function(a,b,c){return d.all(a,c).then(function(a){if(!e(b))throw new TypeError("You must pass a function as map's second argument.");
for(var f=a.length,g=Array(f),k=0;f>k;k++)g[k]=b(a[k]);return d.all(g,c)})}});a("rsvp/node",["./promise","./utils","exports"],function(a,b,c){var d=a["default"],e=b.isArray;c["default"]=function(a,b){function c(){for(var e=arguments.length,h=Array(e),k=0;e>k;k++)h[k]=arguments[k];var r;return f||g||!b?r=this:(console.warn('Deprecation: RSVP.denodeify() doesn\'t allow setting the "this" binding anymore. Use yourFunction.bind(yourThis) instead.'),r=b),d.all(h).then(function(c){return new d(function(d,
e){c.push(function(){for(var a=arguments.length,c=Array(a),h=0;a>h;h++)c[h]=arguments[h];a=c[0];h=c[1];if(a)e(a);else if(f)d(c.slice(1));else if(g){for(var a={},k=c.slice(1),h=0;h<b.length;h++)c=b[h],a[c]=k[h];d(a)}else d(h)});a.apply(r,c)})})}var f=!0===b,g=e(b);return c.__proto__=a,c}});a("rsvp/promise","./config ./events ./instrument ./utils ./promise/cast ./promise/all ./promise/race ./promise/resolve ./promise/reject exports".split(" "),function(a,b,c,d,e,n,l,r,v,u){function C(){}function y(a,
b){if(!B(a))throw new TypeError("You must pass a resolver function as the first argument to the promise constructor");if(!(this instanceof y))throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.");this._id=E++;this._label=b;this._subscribers=[];I.instrument&&F("created",this);if(C!==a){var c=this,d=function(a){x(c,a)},e=function(a){H(c,a)};try{a(d,e)}catch(f){e(f)}}}function s(a,b){var c,d,e=a._subscribers,f=a._detail;
I.instrument&&F(b===O?"fulfilled":"rejected",a);for(var g=0;g<e.length;g+=3)c=e[g],d=e[g+b],w(b,c,d,f);a._subscribers=null}function w(a,b,c,d){var e,f,g,h,k=B(c);if(k)try{e=c(d),g=!0}catch(m){h=!0,f=m}else e=d,g=!0;A(b,e)||(k&&g?x(b,e):h?H(b,f):a===O?x(b,e):a===P&&H(b,e))}function A(a,b){var c,d=null;try{if(a===b)throw new TypeError("A promises callback cannot return that same promise.");if(D(b)&&(d=b.then,B(d)))return d.call(b,function(d){return c?!0:(c=!0,void(b!==d?x(a,d):z(a,d)))},function(b){return c?
!0:(c=!0,void H(a,b))},"Settle: "+(a._label||" unknown promise")),!0}catch(e){return c?!0:(H(a,e),!0)}return!1}function x(a,b){a===b?z(a,b):A(a,b)||z(a,b)}function z(a,b){a._state===L&&(a._state=J,a._detail=b,I.async(G,a))}function H(a,b){a._state===L&&(a._state=J,a._detail=b,I.async(K,a))}function G(a){s(a,a._state=O)}function K(a){a._onerror&&a._onerror(a._detail);s(a,a._state=P)}var I=a.config,F=(b["default"],c["default"]),D=d.objectOrFunction,B=d.isFunction,a=d.now,e=e["default"],n=n["default"],
l=l["default"],r=r["default"],v=v["default"],a="rsvp_"+a()+"-",E=0;u["default"]=y;y.cast=e;y.all=n;y.race=l;y.resolve=r;y.reject=v;var L=void 0,J=0,O=1,P=2;y.prototype={constructor:y,_id:void 0,_guidKey:a,_label:void 0,_state:void 0,_detail:void 0,_subscribers:void 0,_onerror:function(a){I.trigger("error",a)},then:function(a,b,c){var d=this;this._onerror=null;var e=new this.constructor(C,c);if(this._state){var f=arguments;I.async(function(){w(d._state,e,f[d._state-1],d._detail)})}else{var g=this._subscribers,
h=g.length;g[h]=e;g[h+O]=a;g[h+P]=b}return I.instrument&&F("chained",d,e),e},"catch":function(a,b){return this.then(null,a,b)},"finally":function(a,b){var c=this.constructor;return this.then(function(b){return c.resolve(a()).then(function(){return b})},function(b){return c.resolve(a()).then(function(){throw b;})},b)}}});a("rsvp/promise/all",["../utils","exports"],function(a,b){var c=a.isArray,d=a.isNonThenable;b["default"]=function(a,b){var e=this;return new e(function(b,f){function g(a){return function(c){w[a]=
c;0===--s&&b(w)}}function n(a){s=0;f(a)}if(!c(a))throw new TypeError("You must pass an array to all.");var y,s=a.length,w=Array(s);if(0===s)return void b(w);for(var A=0;A<a.length;A++)y=a[A],d(y)?(w[A]=y,0===--s&&b(w)):e.resolve(y).then(g(A),n)},b)}});a("rsvp/promise/cast",["exports"],function(a){a["default"]=function(a,b){return a&&"object"==typeof a&&a.constructor===this?a:new this(function(b){b(a)},b)}});a("rsvp/promise/race",["../utils","exports"],function(a,b){var c=a.isArray,d=(a.isFunction,
a.isNonThenable);b["default"]=function(a,b){var e,f=this;return new f(function(b,g){function n(a){s&&(s=!1,b(a))}function y(a){s&&(s=!1,g(a))}if(!c(a))throw new TypeError("You must pass an array to race.");for(var s=!0,w=0;w<a.length;w++){if(e=a[w],d(e))return s=!1,void b(e);f.resolve(e).then(n,y)}},b)}});a("rsvp/promise/reject",["exports"],function(a){a["default"]=function(a,b){return new this(function(b,c){c(a)},b)}});a("rsvp/promise/resolve",["exports"],function(a){a["default"]=function(a,b){return a&&
"object"==typeof a&&a.constructor===this?a:new this(function(b){b(a)},b)}});a("rsvp/race",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.race(a,b)}});a("rsvp/reject",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.reject(a,b)}});a("rsvp/resolve",["./promise","exports"],function(a,b){var c=a["default"];b["default"]=function(a,b){return c.resolve(a,b)}});a("rsvp/rethrow",["exports"],function(a){a["default"]=function(a){throw setTimeout(function(){throw a;
}),a;}});a("rsvp/utils",["exports"],function(a){function b(a){return"function"==typeof a||"object"==typeof a&&null!==a}a.objectOrFunction=b;a.isFunction=function(a){return"function"==typeof a};a.isNonThenable=function(a){return!b(a)};a.isArray=Array.isArray?Array.isArray:function(a){return"[object Array]"===Object.prototype.toString.call(a)};a.now=Date.now||function(){return(new Date).getTime()};a.keysOf=Object.keys||function(a){var b=[],c;for(c in a)b.push(c);return b}});a("rsvp","./rsvp/promise ./rsvp/events ./rsvp/node ./rsvp/all ./rsvp/all-settled ./rsvp/race ./rsvp/hash ./rsvp/hash-settled ./rsvp/rethrow ./rsvp/defer ./rsvp/config ./rsvp/map ./rsvp/resolve ./rsvp/reject ./rsvp/filter ./rsvp/asap exports".split(" "),
function(a,b,c,d,e,n,l,r,v,u,C,y,s,w,A,x,z){function H(){G.on.apply(G,arguments)}var a=a["default"],b=b["default"],c=c["default"],d=d["default"],e=e["default"],n=n["default"],l=l["default"],r=r["default"],v=v["default"],u=u["default"],G=C.config,C=C.configure,y=y["default"],s=s["default"],w=w["default"],A=A["default"];if(G.async=x["default"],"undefined"!=typeof window&&"object"==typeof window.__PROMISE_INSTRUMENTATION__){x=window.__PROMISE_INSTRUMENTATION__;C("instrument",!0);for(var K in x)x.hasOwnProperty(K)&&
H(K,x[K])}z.Promise=a;z.EventTarget=b;z.all=d;z.allSettled=e;z.race=n;z.hash=l;z.hashSettled=r;z.rethrow=v;z.defer=u;z.denodeify=c;z.configure=C;z.on=H;z.off=function(){G.off.apply(G,arguments)};z.resolve=s;z.reject=w;z.async=function(a,b){G.async(a,b)};z.map=y;z.filter=A});e.RSVP=b("rsvp")}(window);pc.promise={Promise:window.RSVP.Promise,all:window.RSVP.all};pc.anim={Animation:pc.Animation,Key:pc.Key,Node:pc.Node,Skeleton:pc.Skeleton};pc.audio={AudioManager:pc.AudioManager,Channel:pc.Channel,Channel3d:pc.Channel3d,Listener:pc.Listener,Sound:pc.Sound};
pc.fw={Application:pc.Application,Component:pc.Component,ComponentData:pc.ComponentData,ComponentSystem:pc.ComponentSystem,ContentFile:pc.ContentFile,Entity:pc.Entity,FillMode:{NONE:pc.FILLMODE_NONE,FILL_WINDOW:pc.FILLMODE_FILL_WINDOW,KEEP_ASPECT:pc.FILLMODE_KEEP_ASPECT},LiveLink:pc.LiveLink,LiveLinkCloseEntityMessage:pc.LiveLinkCloseEntityMessage,LiveLinkMessage:pc.LiveLinkMessage,LiveLinkMessageRegister:pc.LiveLinkMessageRegister,LiveLinkMessageType:{CLOSE_ENTITY:"CLOSE_ENTITY",NO_TYPE:"NO_TYPE",
OPEN_ENTITY:"OPEN_ENTITY",OPEN_PACK:"OPEN_PACK",RECEIVED:"RECEIVED",REPARENT_ENTITY:"REPARENT_ENTITY",SELECTION_UPDATED:"SELECTION_UPDATED",UPDATE_ASSET:"UPDATE_ASSET",UPDATE_ASSETCACHE:"UPDATE_ASSETCACHE",UPDATE_COMPONENT:"UPDATE_COMPONENT",UPDATE_ENTITY:"UPDATE_ENTITY",UPDATE_ENTITY_ENABLED:"UPDATE_ENTITY_ENABLED",UPDATE_ENTITY_NAME:"UPDATE_ENTITY_NAME",UPDATE_ENTITY_TRANSFORM:"UPDATE_ENTITY_TRANSFORM",UPDATE_PACK_SETTINGS:"UPDATE_PACK_SETTINGS"},LiveLinkOpenEntityMessage:pc.LiveLinkOpenEntityMessage,
LiveLinkOpenPackMessage:pc.LiveLinkOpenPackMessage,LiveLinkReparentEntityMessage:pc.LiveLinkReparentEntityMessage,LiveLinkUpdateAssetCacheMessage:pc.LiveLinkUpdateAssetCacheMessage,LiveLinkUpdateAssetMessage:pc.LiveLinkUpdateAssetMessage,LiveLinkUpdateComponentMessage:pc.LiveLinkUpdateComponentMessage,LiveLinkUpdateEntityEnabledMessage:pc.LiveLinkUpdateEntityEnabledMessage,LiveLinkUpdateEntityMessage:pc.LiveLinkUpdateEntityMessage,LiveLinkUpdateEntityNameMessage:pc.LiveLinkUpdateEntityNameMessage,
LiveLinkUpdateEntityTransformMessage:pc.LiveLinkUpdateEntityTransformMessage,LiveLinkUpdatePackSettings:pc.LiveLinkUpdatePackSettings,Pack:pc.Pack,ResolutionMode:{AUTO:pc.RESOLUTION_AUTO,FIXED:pc.RESOLUTION_FIXED}};
pc.extend(pc.gfx,{defaultGamma:pc.defaultGamma,defaultTonemapping:pc.defaultTonemapping,drawQuadWithShader:pc.drawQuadWithShader,precalculatedTangents:pc.precalculatedTangents,programlib:pc.programlib,shaderChunks:pc.shaderChunks,ContextCreationError:pc.ContextCreationError,Device:pc.GraphicsDevice,IndexBuffer:pc.IndexBuffer,ProgramLibrary:pc.ProgramLibrary,RenderTarget:pc.RenderTarget,ScopeId:pc.ScopeId,Shader:pc.Shader,ShaderInput:pc.ShaderInput,Texture:pc.Texture,UnsupportedBrowserError:pc.UnsupportedBrowserError,
VertexBuffer:pc.VertexBuffer,VertexFormat:pc.VertexFormat,VertexIterator:pc.VertexIterator});pc.extend(pc.input,{getTouchTargetCoords:pc.getTouchTargetCoords,Controller:pc.Controller,GamePads:pc.GamePads,Keyboard:pc.Keyboard,KeyboardEvent:pc.KeyboardEvent,Mouse:pc.Mouse,MouseEvent:pc.MouseEvent,Touch:pc.Touch,TouchDevice:pc.TouchDevice,TouchEvent:pc.TouchEvent});pc.posteffect={createFullscreenQuad:pc.createFullscreenQuad,drawFullscreenQuad:pc.drawFullscreenQuad,PostEffect:pc.PostEffect,PostEffectQueue:pc.PostEffectQueue};
pc.extend(pc.scene,{partitionSkin:pc.partitionSkin,BasicMaterial:pc.BasicMaterial,DepthMaterial:pc.DepthMaterial,ForwardRenderer:pc.ForwardRenderer,GraphNode:pc.GraphNode,Material:pc.Material,Command:pc.Command,Mesh:pc.Mesh,MeshInstance:pc.MeshInstance,Model:pc.Model,ParticleEmitter:pc.ParticleEmitter,PhongMaterial:pc.PhongMaterial,Picker:pc.Picker,PickMaterial:pc.PickMaterial,Scene:pc.Scene,Skin:pc.Skin,SkinInstance:pc.SkinInstance});
pc.scene.procedural={calculateTangents:pc.calculateTangents,createMesh:pc.createMesh,createTorus:pc.createTorus,createCylinder:pc.createCylinder,createCapsule:pc.createCapsule,createCone:pc.createCone,createSphere:pc.createSphere,createPlane:pc.createPlane,createBox:pc.createBox};pc.scene.Projection={ORTHOGRAPHIC:pc.PROJECTION_ORTHOGRAPHIC,PERSPECTIVE:pc.PROJECTION_PERSPECTIVE};pc.time={now:pc.now,Timer:pc.Timer};
